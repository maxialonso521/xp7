<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>XP7 OS - Sistema Operativo Web</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            user-select: none;
        }

        body {
            background: linear-gradient(135deg, #0f2027, #203a43, #2c5364);
            color: #fff;
            overflow: hidden;
            height: 100vh;
            width: 100vw;
            position: relative;
        }

        #taskbar {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 40px;
            background: rgba(20, 25, 30, 0.95);
            backdrop-filter: blur(10px);
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 10px;
            z-index: 1000;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .taskbar-left {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .taskbar-right {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .start-button {
            background: linear-gradient(135deg, #4CAF50, #45a049);
            border: none;
            color: white;
            padding: 6px 15px;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .start-button:hover {
            background: linear-gradient(135deg, #45a049, #3d8b40);
            transform: translateY(-1px);
            box-shadow: 0 3px 8px rgba(0,0,0,0.2);
        }

        .running-apps {
            display: flex;
            gap: 5px;
        }

        .running-app {
            background: rgba(255, 255, 255, 0.1);
            padding: 4px 10px;
            border-radius: 3px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
            max-width: 120px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .running-app:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .running-app.active {
            background: rgba(76, 175, 80, 0.3);
            border-bottom: 2px solid #4CAF50;
        }

        #system-tray {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 12px;
        }

        .clock, .date {
            padding: 2px 5px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 3px;
        }

        .start-menu {
            position: fixed;
            bottom: 40px;
            left: 10px;
            width: 500px;
            height: 500px;
            background: rgba(25, 30, 35, 0.98);
            backdrop-filter: blur(20px);
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.4);
            z-index: 999;
            display: none;
            overflow: hidden;
            animation: fadeIn 0.2s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .start-menu.active {
            display: block;
        }

        .start-header {
            padding: 20px;
            background: linear-gradient(135deg, rgba(76, 175, 80, 0.2), rgba(69, 160, 73, 0.1));
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .user-icon {
            font-size: 40px;
            background: rgba(255, 255, 255, 0.1);
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .user-name {
            font-size: 18px;
            font-weight: 500;
        }

        .start-content {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            padding: 20px;
            height: calc(100% - 180px);
            overflow-y: auto;
        }

        .start-column h3 {
            margin-bottom: 10px;
            color: #4CAF50;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .start-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 12px;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.2s ease;
            margin-bottom: 5px;
        }

        .start-item:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: translateX(5px);
        }

        .start-icon {
            font-size: 20px;
            width: 24px;
            text-align: center;
        }

        .start-text {
            font-size: 14px;
        }

        .start-footer {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            padding: 15px 20px;
            background: rgba(20, 25, 30, 0.9);
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .search-box {
            display: flex;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 5px;
            overflow: hidden;
        }

        .search-box input {
            flex: 1;
            background: transparent;
            border: none;
            padding: 8px 15px;
            color: white;
            font-size: 14px;
        }

        .search-box input::placeholder {
            color: rgba(255, 255, 255, 0.5);
        }

        .search-box button {
            background: rgba(76, 175, 80, 0.2);
            border: none;
            color: white;
            padding: 8px 15px;
            cursor: pointer;
            transition: background 0.2s ease;
        }

        .search-box button:hover {
            background: rgba(76, 175, 80, 0.3);
        }

        .desktop {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: calc(100% - 40px);
            z-index: 2;
            padding: 20px;
            display: flex;
            flex-wrap: wrap;
            align-content: flex-start;
            gap: 20px;
        }

        .desktop-icon {
            width: 80px;
            height: 80px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            border-radius: 5px;
            transition: all 0.2s ease;
            padding: 10px;
        }

        .desktop-icon:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: scale(1.05);
        }

        .desktop-icon .icon {
            font-size: 32px;
            margin-bottom: 5px;
        }

        .desktop-icon .name {
            font-size: 12px;
            text-align: center;
            word-break: break-word;
        }

        #windows-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 100;
        }

        .window {
            position: absolute;
            min-width: 300px;
            min-height: 200px;
            background: rgba(30, 35, 40, 0.98);
            backdrop-filter: blur(20px);
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.4);
            overflow: hidden;
            pointer-events: all;
            z-index: 101;
            resize: both;
            animation: windowFadeIn 0.2s ease;
        }

        @keyframes windowFadeIn {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }

        .window.maximized {
            resize: none;
        }

        .window-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 15px;
            background: rgba(20, 25, 30, 0.95);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            cursor: move;
            user-select: none;
        }

        .window-title {
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 500;
            font-size: 14px;
        }

        .window-controls {
            display: flex;
            gap: 5px;
        }

        .window-control {
            width: 30px;
            height: 30px;
            border: none;
            border-radius: 3px;
            background: transparent;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }

        .window-control:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .window-control.minimize:hover {
            background: rgba(255, 193, 7, 0.2);
        }

        .window-control.maximize:hover {
            background: rgba(33, 150, 243, 0.2);
        }

        .window-control.close:hover {
            background: rgba(244, 67, 54, 0.2);
        }

        .window-content {
            padding: 15px;
            height: calc(100% - 50px);
            overflow: auto;
        }

        .btn-primary, .btn-secondary, .btn-danger {
            padding: 8px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 14px;
            transition: all 0.2s ease;
        }

        .btn-primary {
            background: linear-gradient(135deg, #4CAF50, #45a049);
            color: white;
        }

        .btn-primary:hover {
            background: linear-gradient(135deg, #45a049, #3d8b40);
            transform: translateY(-1px);
            box-shadow: 0 3px 8px rgba(0,0,0,0.2);
        }

        .btn-secondary {
            background: rgba(33, 150, 243, 0.2);
            color: white;
            border: 1px solid rgba(33, 150, 243, 0.5);
        }

        .btn-secondary:hover {
            background: rgba(33, 150, 243, 0.3);
        }

        .btn-danger {
            background: rgba(244, 67, 54, 0.2);
            color: white;
            border: 1px solid rgba(244, 67, 54, 0.5);
        }

        .btn-danger:hover {
            background: rgba(244, 67, 54, 0.3);
        }

        #notifications {
            position: fixed;
            top: 20px;
            right: 20px;
            width: 300px;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .notification {
            background: rgba(25, 30, 35, 0.95);
            backdrop-filter: blur(10px);
            border-left: 4px solid #4CAF50;
            padding: 15px;
            border-radius: 5px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            animation: slideIn 0.3s ease;
            transform-origin: top right;
        }

        .notification.error {
            border-left-color: #f44336;
        }

        .notification.warning {
            border-left-color: #ff9800;
        }

        .notification.info {
            border-left-color: #2196f3;
        }

        .notification.success {
            border-left-color: #4CAF50;
        }

        .notification-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 5px;
        }

        .notification-title {
            font-weight: 500;
            font-size: 14px;
        }

        .notification-close {
            background: none;
            border: none;
            color: white;
            cursor: pointer;
            font-size: 16px;
            opacity: 0.7;
            transition: opacity 0.2s;
        }

        .notification-close:hover {
            opacity: 1;
        }

        .notification-message {
            font-size: 13px;
            color: rgba(255, 255, 255, 0.8);
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%) scale(0.8);
                opacity: 0;
            }
            to {
                transform: translateX(0) scale(1);
                opacity: 1;
            }
        }

        .loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #0f2027, #203a43);
            z-index: 10000;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: opacity 0.5s ease;
        }

        .loading-content {
            text-align: center;
        }

        .loading-logo {
            font-size: 60px;
            font-weight: bold;
            color: #4CAF50;
            margin-bottom: 20px;
            text-shadow: 0 0 20px rgba(76, 175, 80, 0.5);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        .loading-text {
            font-size: 18px;
            margin-bottom: 30px;
            color: rgba(255, 255, 255, 0.8);
        }

        .loading-bar {
            width: 300px;
            height: 4px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 2px;
            overflow: hidden;
            margin-bottom: 20px;
        }

        .loading-progress {
            height: 100%;
            background: linear-gradient(90deg, #4CAF50, #45a049);
            border-radius: 2px;
            width: 0%;
            animation: loading 2s ease-in-out infinite;
        }

        .loading-version {
            font-size: 14px;
            color: rgba(255, 255, 255, 0.5);
        }

        @keyframes loading {
            0% { width: 0%; }
            50% { width: 100%; }
            100% { width: 0%; }
        }

        .explorer {
            height: 100%;
            display: flex;
            flex-direction: column;
        }

        .explorer-toolbar {
            display: flex;
            gap: 5px;
            padding: 10px;
            background: rgba(255, 255, 255, 0.05);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .explorer-content {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        .explorer-sidebar {
            width: 200px;
            background: rgba(255, 255, 255, 0.05);
            border-right: 1px solid rgba(255, 255, 255, 0.1);
            padding: 10px;
            overflow-y: auto;
        }

        .explorer-main {
            flex: 1;
            padding: 15px;
            overflow-y: auto;
        }

        .file-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 10px;
        }

        .file-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 10px;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.2s ease;
            text-align: center;
        }

        .file-item:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .file-item.selected {
            background: rgba(33, 150, 243, 0.2);
            border: 1px solid rgba(33, 150, 243, 0.5);
        }

        .file-icon {
            font-size: 32px;
            margin-bottom: 5px;
        }

        .file-name {
            font-size: 12px;
            word-break: break-all;
            margin-bottom: 3px;
        }

        .file-info {
            font-size: 10px;
            color: rgba(255, 255, 255, 0.6);
        }

        .package-manager {
            height: 100%;
            display: flex;
            flex-direction: column;
        }

        .pm-header {
            padding: 15px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .pm-header h1 {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 20px;
            margin-bottom: 15px;
        }

        .pm-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .pm-body {
            flex: 1;
            display: flex;
            padding: 15px;
            gap: 20px;
            overflow: hidden;
        }

        .pm-sidebar {
            width: 200px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 5px;
            padding: 15px;
            overflow-y: auto;
        }

        .pm-content {
            flex: 1;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 5px;
            padding: 15px;
            overflow-y: auto;
        }

        .pm-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .pm-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .pm-item:hover {
            background: rgba(255, 255, 255, 0.15);
            transform: translateX(5px);
        }

        .pm-item.active {
            background: rgba(76, 175, 80, 0.2);
            border-left: 3px solid #4CAF50;
        }

        .calculator {
            padding: 20px;
        }

        .calc-display {
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 15px;
            text-align: right;
            font-size: 24px;
            min-height: 60px;
            display: flex;
            align-items: center;
            justify-content: flex-end;
            overflow: hidden;
            font-family: monospace;
        }

        .calc-buttons {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
        }

        .calc-button {
            padding: 15px;
            border: none;
            border-radius: 5px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            font-size: 18px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .calc-button:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .calc-button.operator {
            background: rgba(255, 152, 0, 0.2);
        }

        .calc-button.operator:hover {
            background: rgba(255, 152, 0, 0.3);
        }

        .calc-button.equals {
            background: rgba(76, 175, 80, 0.2);
            grid-column: span 2;
        }

        .calc-button.equals:hover {
            background: rgba(76, 175, 80, 0.3);
        }

        .calc-button.clear {
            background: rgba(244, 67, 54, 0.2);
        }

        .calc-button.clear:hover {
            background: rgba(244, 67, 54, 0.3);
        }

        .editor {
            height: 100%;
            display: flex;
            flex-direction: column;
        }

        .editor-toolbar {
            display: flex;
            gap: 5px;
            padding: 10px;
            background: rgba(255, 255, 255, 0.05);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            flex-wrap: wrap;
        }

        .editor-content {
            flex: 1;
            position: relative;
        }

        #editor-textarea {
            width: 100%;
            height: 100%;
            background: transparent;
            border: none;
            color: white;
            font-family: monospace;
            font-size: 14px;
            padding: 15px;
            resize: none;
            outline: none;
        }

        #context-menu {
            position: fixed;
            background: rgba(30, 35, 40, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 5px 0;
            min-width: 180px;
            z-index: 10001;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            display: none;
            animation: fadeIn 0.2s ease;
        }

        .context-menu-item {
            padding: 10px 15px;
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 14px;
            color: rgba(255, 255, 255, 0.9);
        }

        .context-menu-item:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .context-menu-item.delete {
            color: #f44336;
        }

        .context-menu-item.delete:hover {
            background: rgba(244, 67, 54, 0.1);
        }

        .context-menu-separator {
            height: 1px;
            background: rgba(255, 255, 255, 0.1);
            margin: 5px 0;
        }

        @media (max-width: 768px) {
            .start-menu {
                width: calc(100% - 20px);
                height: 70vh;
            }
            
            .start-content {
                grid-template-columns: 1fr;
            }
            
            .window {
                min-width: 90vw !important;
                min-height: 50vh !important;
                left: 5vw !important;
                top: 5vh !important;
                resize: none;
            }
            
            .pm-body {
                flex-direction: column;
            }
            
            .pm-sidebar {
                width: 100%;
            }
        }

        .fs-selector {
            padding: 20px;
            height: 100%;
            overflow-y: auto;
        }

        .fs-option {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 15px;
            margin: 10px 0;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .fs-option:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: translateX(5px);
        }

        .fs-option.selected {
            background: rgba(76, 175, 80, 0.2);
            border: 2px solid #4CAF50;
        }

        .fs-option-icon {
            font-size: 32px;
        }

        .fs-option-info {
            flex: 1;
        }

        .fs-option-title {
            font-weight: 500;
            font-size: 16px;
            margin-bottom: 5px;
        }

        .fs-option-desc {
            font-size: 12px;
            color: rgba(255, 255, 255, 0.7);
        }

        .fs-status {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 3px;
            font-size: 11px;
            font-weight: bold;
            margin-left: 10px;
        }

        .fs-status.available {
            background: rgba(76, 175, 80, 0.3);
            color: #4CAF50;
        }

        .fs-status.unavailable {
            background: rgba(244, 67, 54, 0.3);
            color: #f44336;
        }

        #custom-cursor {
            position: fixed;
            width: 20px;
            height: 20px;
            border: 2px solid #4CAF50;
            border-radius: 50%;
            pointer-events: none;
            z-index: 10000;
            transform: translate(-50%, -50%);
            transition: transform 0.1s ease, border-color 0.2s ease;
            mix-blend-mode: difference;
        }

        #shader-canvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 0;
            pointer-events: none;
            display: none;
        }

        .resize-handle {
            position: absolute;
            width: 10px;
            height: 10px;
            background: rgba(76, 175, 80, 0.5);
            border-radius: 50%;
            z-index: 102;
            display: none;
        }

        .window:not(.maximized) .resize-handle {
            display: block;
        }

        .resize-handle.nw {
            top: -5px;
            left: -5px;
            cursor: nw-resize;
        }

        .resize-handle.ne {
            top: -5px;
            right: -5px;
            cursor: ne-resize;
        }

        .resize-handle.sw {
            bottom: -5px;
            left: -5px;
            cursor: sw-resize;
        }

        .resize-handle.se {
            bottom: -5px;
            right: -5px;
            cursor: se-resize;
        }

        .resize-handle.n {
            top: -5px;
            left: 50%;
            transform: translateX(-50%);
            cursor: n-resize;
        }

        .resize-handle.s {
            bottom: -5px;
            left: 50%;
            transform: translateX(-50%);
            cursor: s-resize;
        }

        .resize-handle.w {
            left: -5px;
            top: 50%;
            transform: translateY(-50%);
            cursor: w-resize;
        }

        .resize-handle.e {
            right: -5px;
            top: 50%;
            transform: translateY(-50%);
            cursor: e-resize;
        }

        .app-minimized {
            display: none !important;
        }

        .system-modal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(30, 35, 40, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.5);
            z-index: 2000;
            padding: 30px;
            min-width: 300px;
            max-width: 500px;
            animation: fadeIn 0.3s ease;
        }

        .system-modal h2 {
            color: #4CAF50;
            margin-bottom: 15px;
            text-align: center;
        }

        .system-modal p {
            margin-bottom: 20px;
            color: rgba(255, 255, 255, 0.8);
            text-align: center;
        }

        .system-modal-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 20px;
        }

        .drag-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(76, 175, 80, 0.1);
            border: 3px dashed #4CAF50;
            z-index: 9999;
            display: none;
            pointer-events: none;
        }

        .drag-overlay.active {
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            color: #4CAF50;
        }

        .toast {
            position: fixed;
            bottom: 60px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(25, 30, 35, 0.95);
            backdrop-filter: blur(10px);
            padding: 12px 20px;
            border-radius: 5px;
            border-left: 4px solid #4CAF50;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            z-index: 1001;
            animation: slideUp 0.3s ease;
            max-width: 80%;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateX(-50%) translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateX(-50%) translateY(0);
            }
        }

        .progress-bar {
            width: 100%;
            height: 6px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
            overflow: hidden;
            margin: 10px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #4CAF50, #45a049);
            border-radius: 3px;
            width: 0%;
            transition: width 0.3s ease;
        }
    </style>
</head>
<body>
    <div id="shader-canvas"></div>
    
    <div id="taskbar">
        <div class="taskbar-left">
            <button id="start-btn" class="start-button">
                <i class="fas fa-play" style="font-size: 12px;"></i>
                <span>Inicio</span>
            </button>
            <div id="running-apps" class="running-apps"></div>
        </div>
        <div class="taskbar-right">
            <div id="system-tray">
                <span id="volume-icon" title="Volumen">üîä</span>
                <span id="network-icon" title="Red">üåê</span>
                <span id="time" class="clock">00:00</span>
                <span id="date" class="date">01/01/2024</span>
            </div>
        </div>
    </div>
    
    <div id="start-menu" class="start-menu">
        <div class="start-header">
            <div class="user-info">
                <div class="user-icon"><i class="fas fa-user"></i></div>
                <div class="user-name">Usuario XP7</div>
            </div>
        </div>
        <div class="start-content">
            <div class="start-column">
                <h3>Programas</h3>
                <div class="start-item" data-app="explorer">
                    <span class="start-icon"><i class="fas fa-folder"></i></span>
                    <span class="start-text">Explorador</span>
                </div>
                <div class="start-item" data-app="notepad">
                    <span class="start-icon"><i class="fas fa-file-alt"></i></span>
                    <span class="start-text">Bloc de Notas</span>
                </div>
                <div class="start-item" data-app="calculator">
                    <span class="start-icon"><i class="fas fa-calculator"></i></span>
                    <span class="start-text">Calculadora</span>
                </div>
                <div class="start-item" data-app="package-manager">
                    <span class="start-icon"><i class="fas fa-box"></i></span>
                    <span class="start-text">Gestor de Paquetes</span>
                </div>
                <div class="start-item" data-app="act-manager">
                    <span class="start-icon"><i class="fas fa-sync-alt"></i></span>
                    <span class="start-text">Gestor de ACT</span>
                </div>
            </div>
            <div class="start-column">
                <h3>Herramientas</h3>
                <div class="start-item" data-app="storage-manager">
                    <span class="start-icon"><i class="fas fa-hdd"></i></span>
                    <span class="start-text">Storage Manager</span>
                </div>
                <div class="start-item" data-app="file-selector">
                    <span class="start-icon"><i class="fas fa-folder-open"></i></span>
                    <span class="start-text">Selector de Sistema de Archivos</span>
                </div>
                <div class="start-item" data-app="settings">
                    <span class="start-icon"><i class="fas fa-cog"></i></span>
                    <span class="start-text">Configuraci√≥n</span>
                </div>
                <div class="start-item" data-app="terminal">
                    <span class="start-icon"><i class="fas fa-terminal"></i></span>
                    <span class="start-text">Terminal</span>
                </div>
            </div>
            <div class="start-column">
                <h3>Sistema</h3>
                <div class="start-item" data-action="shutdown">
                    <span class="start-icon"><i class="fas fa-power-off"></i></span>
                    <span class="start-text">Apagar</span>
                </div>
                <div class="start-item" data-action="restart">
                    <span class="start-icon"><i class="fas fa-redo"></i></span>
                    <span class="start-text">Reiniciar</span>
                </div>
                <div class="start-item" data-action="logout">
                    <span class="start-icon"><i class="fas fa-sign-out-alt"></i></span>
                    <span class="start-text">Cerrar Sesi√≥n</span>
                </div>
            </div>
        </div>
        <div class="start-footer">
            <div class="search-box">
                <input type="text" id="start-search" placeholder="Buscar programas y archivos...">
                <button id="search-btn"><i class="fas fa-search"></i></button>
            </div>
        </div>
    </div>
    
    <div id="desktop" class="desktop"></div>
    
    <div id="windows-container"></div>
    
    <div id="custom-cursor"></div>
    
    <div id="notifications"></div>
    
    <div id="context-menu">
        <div class="context-menu-item" data-action="open">
            <i class="fas fa-folder-open"></i> Abrir
        </div>
        <div class="context-menu-item" data-action="rename">
            <i class="fas fa-edit"></i> Renombrar
        </div>
        <div class="context-menu-item" data-action="properties">
            <i class="fas fa-info-circle"></i> Propiedades
        </div>
        <div class="context-menu-separator"></div>
        <div class="context-menu-item delete" data-action="delete">
            <i class="fas fa-trash"></i> Eliminar
        </div>
    </div>
    
    <div id="loading-screen" class="loading-screen">
        <div class="loading-content">
            <div class="loading-logo">XP7 OS</div>
            <div class="loading-text">Iniciando sistema...</div>
            <div class="loading-bar">
                <div class="loading-progress"></div>
            </div>
            <div class="loading-version">Versi√≥n 3.0.0</div>
        </div>
    </div>

    <input type="file" id="file-input" style="display: none;" multiple>
    <input type="file" id="act-input" style="display: none;" accept=".act,.json">
    <input type="file" id="pak-input" style="display: none;" accept=".pak,.json">

    <div id="drag-overlay" class="drag-overlay"></div>

    <script>
        // ============================================
        // SISTEMA XP7 OS - COMPLETAMENTE FUNCIONAL
        // Versi√≥n 3.0.0 - ACT y PAK al 100%
        // ============================================

        class XP7System {
            constructor() {
                this.version = '3.0.0';
                this.initialized = false;
                this.windows = new Map();
                this.apps = new Map();  // Apps registradas en el sistema
                this.currentZIndex = 100;
                this.runningApps = new Map();
                this.nextWindowId = 1;
                this.isDragging = false;
                this.isResizing = false;
                this.activeWindow = null;
                
                this.fileSystem = {
                    mode: 'localStorage',
                    directoryHandle: null,
                    structure: {},
                    currentPath: '/',
                    
                    async init() {
                        console.log('üíæ Inicializando sistema de archivos...');
                        
                        // Cargar configuraci√≥n
                        const savedMode = localStorage.getItem('xp7_fs_mode');
                        if (savedMode) {
                            this.mode = savedMode;
                        }
                        
                        // Cargar estructura
                        const savedStructure = localStorage.getItem('xp7_fs_structure');
                        if (savedStructure) {
                            try {
                                this.structure = JSON.parse(savedStructure);
                            } catch (e) {
                                console.error('Error cargando estructura:', e);
                                this.createDefaultStructure();
                            }
                        } else {
                            this.createDefaultStructure();
                        }
                        
                        // Crear directorios base si no existen
                        this.ensureDirectories();
                        this.ensureSystemFiles();
                        
                        console.log('‚úÖ Sistema de archivos inicializado en modo:', this.mode);
                        return true;
                    },
                    
                    createDefaultStructure() {
                        this.structure = {
                            '/': ['System', 'Apps', 'User'],
                            '/System': ['config.json', 'packages.json', 'updates.json'],
                            '/Apps': [],
                            '/User': ['Documents', 'Downloads', 'Desktop', 'Backgrounds'],
                            '/User/Documents': [],
                            '/User/Downloads': [],
                            '/User/Desktop': [],
                            '/User/Backgrounds': []
                        };
                        this.saveStructure();
                    },
                    
                    ensureDirectories() {
                        const requiredDirs = [
                            '/System',
                            '/Apps', 
                            '/User',
                            '/User/Documents',
                            '/User/Downloads',
                            '/User/Desktop',
                            '/User/Backgrounds',
                            '/System/Updates'
                        ];
                        
                        requiredDirs.forEach(dir => {
                            if (!this.structure[dir]) {
                                this.structure[dir] = [];
                            }
                        });
                        this.saveStructure();
                    },
                    
                    ensureSystemFiles() {
                        const systemFiles = {
                            '/System/config.json': JSON.stringify({
                                version: '3.0.0',
                                name: 'XP7 OS',
                                created: new Date().toISOString(),
                                fileSystem: this.mode,
                                status: 'operational',
                                lastBoot: new Date().toISOString()
                            }, null, 2),
                            '/System/packages.json': JSON.stringify([]),
                            '/System/updates.json': JSON.stringify([])
                        };
                        
                        Object.entries(systemFiles).forEach(([path, content]) => {
                            if (!this.fileExists(path)) {
                                this.writeFile(path, content);
                            }
                        });
                    },
                    
                    async enableFileSystemAPI() {
                        if (!('showDirectoryPicker' in window)) {
                            throw new Error('File System API no disponible en tu navegador');
                        }
                        
                        try {
                            const handle = await window.showDirectoryPicker({
                                mode: 'readwrite'
                            });
                            
                            this.mode = 'fileSystem';
                            this.directoryHandle = handle;
                            localStorage.setItem('xp7_fs_mode', 'fileSystem');
                            
                            console.log('‚úÖ File System API activada en directorio:', handle.name);
                            return handle;
                        } catch (error) {
                            console.error('Error accediendo a File System API:', error);
                            throw error;
                        }
                    },
                    
                    async readFile(path) {
                        if (this.mode === 'localStorage') {
                            const key = 'xp7_fs_' + this.normalizePath(path);
                            const content = localStorage.getItem(key);
                            return content;
                        } else {
                            // Modo File System API
                            console.warn('File System API no implementado para lectura');
                            return null;
                        }
                    },
                    
                    async writeFile(path, content) {
                        if (this.mode === 'localStorage') {
                            const key = 'xp7_fs_' + this.normalizePath(path);
                            localStorage.setItem(key, content);
                            
                            // Actualizar estructura
                            const dir = path.substring(0, path.lastIndexOf('/')) || '/';
                            const filename = path.substring(path.lastIndexOf('/') + 1);
                            
                            if (!this.structure[dir]) {
                                this.structure[dir] = [];
                            }
                            
                            if (!this.structure[dir].includes(filename)) {
                                this.structure[dir].push(filename);
                                this.saveStructure();
                            }
                            
                            return true;
                        } else {
                            console.warn('File System API no implementado para escritura');
                            return false;
                        }
                    },
                    
                    fileExists(path) {
                        if (this.mode === 'localStorage') {
                            const key = 'xp7_fs_' + this.normalizePath(path);
                            return localStorage.getItem(key) !== null;
                        }
                        return false;
                    },
                    
                    async listDirectory(path = '/') {
                        const entries = [];
                        const normalizedPath = path.endsWith('/') ? path : path + '/';
                        
                        if (this.mode === 'localStorage') {
                            // Directorios
                            Object.keys(this.structure).forEach(dirPath => {
                                if (dirPath.startsWith(normalizedPath) && dirPath !== path) {
                                    const relPath = dirPath.substring(normalizedPath.length);
                                    if (!relPath.includes('/') && relPath) {
                                        entries.push({
                                            name: relPath,
                                            path: dirPath,
                                            kind: 'directory',
                                            type: 'directory',
                                            icon: 'üìÅ'
                                        });
                                    }
                                }
                            });
                            
                            // Archivos
                            if (this.structure[path]) {
                                this.structure[path].forEach(filename => {
                                    entries.push({
                                        name: filename,
                                        path: path + '/' + filename,
                                        kind: 'file',
                                        type: this.getFileType(filename),
                                        icon: this.getFileIcon(filename),
                                        size: this.getFileSize(path + '/' + filename)
                                    });
                                });
                            }
                        }
                        
                        return entries.sort((a, b) => {
                            if (a.kind === 'directory' && b.kind !== 'directory') return -1;
                            if (a.kind !== 'directory' && b.kind === 'directory') return 1;
                            return a.name.localeCompare(b.name);
                        });
                    },
                    
                    getFileType(filename) {
                        const ext = filename.split('.').pop().toLowerCase();
                        const types = {
                            'txt': 'text', 'js': 'javascript', 'json': 'json',
                            'html': 'html', 'css': 'css', 'pak': 'package',
                            'act': 'update', 'png': 'image', 'jpg': 'image',
                            'jpeg': 'image', 'gif': 'image', 'webp': 'image',
                            'svg': 'image', 'mp3': 'audio', 'mp4': 'video',
                            'pdf': 'document', 'glsl': 'shader', 'frag': 'shader',
                            'vert': 'shader'
                        };
                        return types[ext] || 'unknown';
                    },
                    
                    getFileIcon(filename) {
                        const type = this.getFileType(filename);
                        const icons = {
                            'text': 'üìÑ', 'javascript': 'üìú', 'json': 'üìã',
                            'html': 'üåê', 'css': 'üé®', 'package': 'üì¶',
                            'update': 'üîÑ', 'image': 'üñºÔ∏è', 'audio': 'üéµ',
                            'video': 'üé¨', 'document': 'üìï', 'directory': 'üìÅ',
                            'shader': 'üîÑ', 'unknown': 'üìÑ'
                        };
                        return icons[type] || 'üìÑ';
                    },
                    
                    getFileSize(path) {
                        if (this.mode === 'localStorage') {
                            const key = 'xp7_fs_' + this.normalizePath(path);
                            const content = localStorage.getItem(key);
                            return content ? content.length : 0;
                        }
                        return 0;
                    },
                    
                    normalizePath(path) {
                        return path.replace(/\//g, '_');
                    },
                    
                    saveStructure() {
                        localStorage.setItem('xp7_fs_structure', JSON.stringify(this.structure));
                    },
                    
                    getStorageInfo() {
                        let totalSize = 0;
                        let fileCount = 0;
                        
                        for (let i = 0; i < localStorage.length; i++) {
                            const key = localStorage.key(i);
                            if (key.startsWith('xp7_fs_')) {
                                const value = localStorage.getItem(key);
                                totalSize += key.length + (value ? value.length : 0);
                                fileCount++;
                            }
                        }
                        
                        const maxSize = 5 * 1024 * 1024; // 5MB
                        const usedMB = (totalSize / 1024 / 1024).toFixed(2);
                        const maxMB = (maxSize / 1024 / 1024).toFixed(2);
                        const percentage = ((totalSize / maxSize) * 100).toFixed(1);
                        
                        return {
                            used: totalSize,
                            usedMB: usedMB,
                            max: maxSize,
                            maxMB: maxMB,
                            percentage: percentage,
                            fileCount: fileCount
                        };
                    },
                    
                    async processACTFile(content) {
                        try {
                            const data = JSON.parse(content);
                            
                            if (!data.type || data.type !== 'update') {
                                throw new Error('Archivo .act inv√°lido: debe tener type="update"');
                            }
                            
                            // Validar campos requeridos
                            const requiredFields = ['name', 'version', 'description'];
                            for (const field of requiredFields) {
                                if (!data[field]) {
                                    throw new Error(`Campo requerido faltante: ${field}`);
                                }
                            }
                            
                            const actId = 'act_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                            const updateData = {
                                ...data,
                                id: actId,
                                installed: new Date().toISOString(),
                                status: 'installed'
                            };
                            
                            // Guardar en localStorage
                            localStorage.setItem(`xp7_update_${actId}`, JSON.stringify(updateData));
                            
                            // Guardar en sistema de archivos
                            const fileName = `update_${data.name.replace(/[^a-z0-9]/gi, '_')}_${data.version}.act`;
                            await this.writeFile(`/System/Updates/${fileName}`, content);
                            
                            // Actualizar lista de updates
                            const updatesList = await this.readFile('/System/updates.json');
                            let updates = [];
                            if (updatesList) {
                                updates = JSON.parse(updatesList);
                            }
                            updates.push({
                                id: actId,
                                name: data.name,
                                version: data.version,
                                installed: new Date().toISOString(),
                                file: fileName
                            });
                            await this.writeFile('/System/updates.json', JSON.stringify(updates, null, 2));
                            
                            return {
                                success: true,
                                message: `Actualizaci√≥n "${data.name}" v${data.version} instalada correctamente`,
                                data: updateData
                            };
                        } catch (error) {
                            console.error('Error procesando archivo .act:', error);
                            return {
                                success: false,
                                message: 'Error procesando archivo .act: ' + error.message
                            };
                        }
                    },
                    
                    async processPAKFile(content) {
                        try {
                            const data = JSON.parse(content);
                            
                            if (!data.type || data.type !== 'application') {
                                throw new Error('Archivo .pak inv√°lido: debe tener type="application"');
                            }
                            
                            // Validar campos requeridos
                            const requiredFields = ['name', 'icon', 'content'];
                            for (const field of requiredFields) {
                                if (!data[field]) {
                                    throw new Error(`Campo requerido faltante: ${field}`);
                                }
                            }
                            
                            const appId = data.id || data.name.toLowerCase().replace(/[^a-z0-9]/g, '-');
                            const appData = {
                                id: appId,
                                name: data.name,
                                icon: data.icon,
                                description: data.description || 'Aplicaci√≥n instalada desde paquete .pak',
                                category: data.category || 'Aplicaciones',
                                version: data.version || '1.0.0',
                                author: data.author || 'Desconocido',
                                width: data.width || 600,
                                height: data.height || 400,
                                content: data.content,
                                installed: new Date().toISOString(),
                                type: 'pak'
                            };
                            
                            // Guardar en localStorage
                            localStorage.setItem(`xp7_app_${appId}`, JSON.stringify(appData));
                            
                            // Guardar en sistema de archivos
                            const fileName = `${appId}.pak`;
                            await this.writeFile(`/Apps/${fileName}`, content);
                            
                            // Actualizar lista de paquetes
                            const packagesList = await this.readFile('/System/packages.json');
                            let packages = [];
                            if (packagesList) {
                                packages = JSON.parse(packagesList);
                            }
                            packages.push({
                                id: appId,
                                name: data.name,
                                version: data.version || '1.0.0',
                                installed: new Date().toISOString(),
                                file: fileName
                            });
                            await this.writeFile('/System/packages.json', JSON.stringify(packages, null, 2));
                            
                            return {
                                success: true,
                                message: `Aplicaci√≥n "${data.name}" instalada correctamente`,
                                data: appData
                            };
                        } catch (error) {
                            console.error('Error procesando archivo .pak:', error);
                            return {
                                success: false,
                                message: 'Error procesando archivo .pak: ' + error.message
                            };
                        }
                    },
                    
                    getInstalledUpdates() {
                        const updates = [];
                        for (let i = 0; i < localStorage.length; i++) {
                            const key = localStorage.key(i);
                            if (key.startsWith('xp7_update_')) {
                                try {
                                    const update = JSON.parse(localStorage.getItem(key));
                                    updates.push(update);
                                } catch (e) {
                                    console.warn('Error parsing update:', key, e);
                                }
                            }
                        }
                        return updates;
                    },
                    
                    getInstalledPackages() {
                        const packages = [];
                        for (let i = 0; i < localStorage.length; i++) {
                            const key = localStorage.key(i);
                            if (key.startsWith('xp7_app_')) {
                                try {
                                    const app = JSON.parse(localStorage.getItem(key));
                                    packages.push(app);
                                } catch (e) {
                                    console.warn('Error parsing app:', key, e);
                                }
                            }
                        }
                        return packages;
                    },
                    
                    async deleteUpdate(updateId) {
                        const key = `xp7_update_${updateId}`;
                        if (localStorage.getItem(key)) {
                            localStorage.removeItem(key);
                            
                            // Tambi√©n eliminar del sistema de archivos
                            const updatesList = await this.readFile('/System/updates.json');
                            if (updatesList) {
                                let updates = JSON.parse(updatesList);
                                updates = updates.filter(u => u.id !== updateId);
                                await this.writeFile('/System/updates.json', JSON.stringify(updates, null, 2));
                            }
                            
                            return true;
                        }
                        return false;
                    },
                    
                    async deletePackage(appId) {
                        const key = `xp7_app_${appId}`;
                        if (localStorage.getItem(key)) {
                            localStorage.removeItem(key);
                            
                            // Tambi√©n eliminar del sistema de archivos
                            const packagesList = await this.readFile('/System/packages.json');
                            if (packagesList) {
                                let packages = JSON.parse(packagesList);
                                packages = packages.filter(p => p.id !== appId);
                                await this.writeFile('/System/packages.json', JSON.stringify(packages, null, 2));
                            }
                            
                            return true;
                        }
                        return false;
                    }
                };
                
                // Definir aplicaciones por defecto
                this.defaultApps = {
                    'explorer': {
                        name: 'Explorador de Archivos',
                        icon: 'üìÅ',
                        description: 'Navega y gestiona tus archivos',
                        category: 'Sistema',
                        launch: () => this.openApp('explorer')
                    },
                    'notepad': {
                        name: 'Bloc de Notas',
                        icon: 'üìù',
                        description: 'Editor de texto simple',
                        category: 'Herramientas',
                        launch: () => this.openApp('notepad')
                    },
                    'calculator': {
                        name: 'Calculadora',
                        icon: 'üßÆ',
                        description: 'Calculadora b√°sica',
                        category: 'Herramientas',
                        launch: () => this.openApp('calculator')
                    },
                    'package-manager': {
                        name: 'Gestor de Paquetes',
                        icon: 'üì¶',
                        description: 'Instala y gestiona aplicaciones',
                        category: 'Sistema',
                        launch: () => this.openApp('package-manager')
                    },
                    'storage-manager': {
                        name: 'Storage Manager',
                        icon: 'üíæ',
                        description: 'Gestiona el almacenamiento local',
                        category: 'Sistema',
                        launch: () => this.openApp('storage-manager')
                    },
                    'file-selector': {
                        name: 'Selector de Sistema de Archivos',
                        icon: 'üìÇ',
                        description: 'Selecciona c√≥mo almacenar tus archivos',
                        category: 'Herramientas',
                        launch: () => this.openApp('file-selector')
                    },
                    'settings': {
                        name: 'Configuraci√≥n',
                        icon: '‚öôÔ∏è',
                        description: 'Ajustes del sistema',
                        category: 'Sistema',
                        launch: () => this.openApp('settings')
                    },
                    'terminal': {
                        name: 'Terminal',
                        icon: 'üíª',
                        description: 'Terminal del sistema',
                        category: 'Herramientas',
                        launch: () => this.openApp('terminal')
                    },
                    'act-manager': {
                        name: 'Gestor de ACT',
                        icon: 'üîÑ',
                        description: 'Gestiona archivos de actualizaci√≥n .act',
                        category: 'Sistema',
                        launch: () => this.openApp('act-manager')
                    },
                    'pak-creator': {
                        name: 'Creador de Paquetes',
                        icon: 'üì¶',
                        description: 'Crea archivos .pak para distribuir aplicaciones',
                        category: 'Herramientas',
                        launch: () => this.openApp('pak-creator')
                    }
                };
            }
            
            async init() {
                console.log('üöÄ Iniciando XP7 OS v' + this.version);
                
                try {
                    // Inicializar sistema de archivos
                    await this.fileSystem.init();
                    
                    // Cargar aplicaciones
                    this.loadApps();
                    
                    // Configurar eventos
                    this.setupEvents();
                    
                    // Iniciar reloj
                    this.startClock();
                    
                    // Actualizar escritorio
                    this.updateDesktop();
                    
                    // Simular carga
                    setTimeout(() => {
                        document.getElementById('loading-screen').style.opacity = '0';
                        setTimeout(() => {
                            document.getElementById('loading-screen').style.display = 'none';
                            this.showNotification('XP7 OS', 'Sistema iniciado correctamente', 'success');
                            this.initialized = true;
                            console.log('‚úÖ XP7 OS inicializado correctamente');
                        }, 500);
                    }, 2000);
                    
                } catch (error) {
                    console.error('Error inicializando XP7:', error);
                    this.showNotification('Error', 'Error al iniciar el sistema', 'error');
                }
            }
            
            loadApps() {
                // Cargar apps por defecto
                Object.entries(this.defaultApps).forEach(([id, app]) => {
                    this.apps.set(id, app);
                });
                
                // Cargar apps instaladas desde paquetes
                const installedPackages = this.fileSystem.getInstalledPackages();
                installedPackages.forEach(pkg => {
                    this.apps.set(pkg.id, {
                        name: pkg.name,
                        icon: pkg.icon,
                        description: pkg.description,
                        category: pkg.category || 'Aplicaciones',
                        launch: () => this.openPakApp(pkg)
                    });
                });
                
                console.log(`‚úÖ Cargadas ${this.apps.size} aplicaciones`);
            }
            
            addApp(id, appData) {
                this.apps.set(id, appData);
                this.updateDesktop();
                this.showNotification('Aplicaci√≥n', `"${appData.name}" instalada`, 'success');
            }
            
            removeApp(id) {
                if (this.apps.has(id)) {
                    const appName = this.apps.get(id).name;
                    this.apps.delete(id);
                    this.updateDesktop();
                    this.showNotification('Aplicaci√≥n', `"${appName}" eliminada`, 'info');
                    return true;
                }
                return false;
            }
            
            setupEvents() {
                // Bot√≥n de inicio
                document.getElementById('start-btn').addEventListener('click', (e) => {
                    e.stopPropagation();
                    const menu = document.getElementById('start-menu');
                    menu.classList.toggle('active');
                });
                
                // Cerrar men√∫ al hacer clic fuera
                document.addEventListener('click', (e) => {
                    if (!e.target.closest('#start-menu') && !e.target.closest('#start-btn')) {
                        document.getElementById('start-menu').classList.remove('active');
                    }
                });
                
                // Items del men√∫ inicio
                document.querySelectorAll('.start-item').forEach(item => {
                    item.addEventListener('click', () => {
                        const app = item.dataset.app;
                        const action = item.dataset.action;
                        
                        if (app) {
                            this.openApp(app);
                        } else if (action) {
                            this.handleSystemAction(action);
                        }
                        
                        document.getElementById('start-menu').classList.remove('active');
                    });
                });
                
                // B√∫squeda
                document.getElementById('search-btn').addEventListener('click', () => {
                    this.handleSearch();
                });
                
                document.getElementById('start-search').addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        this.handleSearch();
                    }
                });
                
                // Cursor personalizado
                document.addEventListener('mousemove', (e) => {
                    const cursor = document.getElementById('custom-cursor');
                    cursor.style.left = e.clientX + 'px';
                    cursor.style.top = e.clientY + 'px';
                    
                    // Efectos de hover
                    const target = e.target;
                    if (target.tagName === 'BUTTON' || target.closest('button') || 
                        target.classList.contains('start-item') ||
                        target.classList.contains('window-control') ||
                        target.classList.contains('file-item') ||
                        target.classList.contains('desktop-icon')) {
                        cursor.style.transform = 'translate(-50%, -50%) scale(1.5)';
                        cursor.style.borderColor = '#2196f3';
                    } else {
                        cursor.style.transform = 'translate(-50%, -50%) scale(1)';
                        cursor.style.borderColor = '#4CAF50';
                    }
                });
                
                // Drag and drop para archivos
                document.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    document.getElementById('drag-overlay').classList.add('active');
                });
                
                document.addEventListener('dragleave', (e) => {
                    if (!e.relatedTarget || e.relatedTarget.nodeType === 3) {
                        document.getElementById('drag-overlay').classList.remove('active');
                    }
                });
                
                document.addEventListener('drop', async (e) => {
                    e.preventDefault();
                    document.getElementById('drag-overlay').classList.remove('active');
                    
                    const files = Array.from(e.dataTransfer.files);
                    if (files.length > 0) {
                        await this.handleDroppedFiles(files);
                    }
                });
                
                // Inputs de archivos
                document.getElementById('file-input').addEventListener('change', (e) => {
                    this.handleFileUpload(e.target.files);
                });
                
                document.getElementById('act-input').addEventListener('change', (e) => {
                    this.handleACTUpload(e.target.files[0]);
                });
                
                document.getElementById('pak-input').addEventListener('change', (e) => {
                    this.handlePAKUpload(e.target.files[0]);
                });
                
                // Context menu
                document.addEventListener('contextmenu', (e) => {
                    e.preventDefault();
                    this.showContextMenu(e.clientX, e.clientY);
                });
                
                document.addEventListener('click', () => {
                    document.getElementById('context-menu').style.display = 'none';
                });
            }
            
            updateDesktop() {
                const desktop = document.getElementById('desktop');
                desktop.innerHTML = '';
                
                // Agrupar apps por categor√≠a para mejor organizaci√≥n
                const appsByCategory = {};
                this.apps.forEach((app, id) => {
                    const category = app.category || 'Otros';
                    if (!appsByCategory[category]) {
                        appsByCategory[category] = [];
                    }
                    appsByCategory[category].push({ id, ...app });
                });
                
                // Ordenar categor√≠as
                const categoryOrder = ['Sistema', 'Herramientas', 'Aplicaciones', 'Personalizaci√≥n', 'Otros'];
                const sortedCategories = categoryOrder.filter(cat => appsByCategory[cat]);
                
                sortedCategories.forEach(category => {
                    // Opcional: agregar separador de categor√≠a
                    if (sortedCategories.indexOf(category) > 0) {
                        const spacer = document.createElement('div');
                        spacer.style.width = '100%';
                        spacer.style.height = '20px';
                        desktop.appendChild(spacer);
                    }
                    
                    appsByCategory[category].forEach(app => {
                        const icon = document.createElement('div');
                        icon.className = 'desktop-icon';
                        icon.innerHTML = `
                            <div class="icon">${app.icon}</div>
                            <div class="name">${app.name}</div>
                        `;
                        icon.addEventListener('dblclick', () => {
                            if (app.launch) {
                                app.launch();
                            } else {
                                this.openApp(app.id);
                            }
                        });
                        
                        // Click derecho para men√∫ contextual
                        icon.addEventListener('contextmenu', (e) => {
                            e.preventDefault();
                            e.stopPropagation();
                            this.showAppContextMenu(e.clientX, e.clientY, app);
                        });
                        
                        desktop.appendChild(icon);
                    });
                });
            }
            
            async openApp(appId) {
                console.log(`üì± Abriendo aplicaci√≥n: ${appId}`);
                
                if (!this.apps.has(appId)) {
                    this.showNotification('Error', `Aplicaci√≥n "${appId}" no encontrada`, 'error');
                    return;
                }
                
                const app = this.apps.get(appId);
                
                // Si ya est√° abierta, traer al frente
                if (this.runningApps.has(appId)) {
                    const windowId = this.runningApps.get(appId);
                    const windowEl = document.getElementById(windowId);
                    if (windowEl) {
                        windowEl.style.zIndex = ++this.currentZIndex;
                        this.activeWindow = windowId;
                        this.updateTaskbar();
                        return;
                    }
                }
                
                // Crear ventana seg√∫n el tipo de app
                switch(appId) {
                    case 'explorer':
                        await this.openExplorer();
                        break;
                    case 'notepad':
                        this.openNotepad();
                        break;
                    case 'calculator':
                        this.openCalculator();
                        break;
                    case 'package-manager':
                        this.openPackageManager();
                        break;
                    case 'storage-manager':
                        this.openStorageManager();
                        break;
                    case 'file-selector':
                        this.openFileSelector();
                        break;
                    case 'settings':
                        this.openSettings();
                        break;
                    case 'terminal':
                        this.openTerminal();
                        break;
                    case 'act-manager':
                        this.openACTManager();
                        break;
                    case 'pak-creator':
                        this.openPakCreator();
                        break;
                    default:
                        // App personalizada
                        this.openCustomApp(appId, app);
                }
            }
            
            async openExplorer() {
                const windowId = `window_${this.nextWindowId++}`;
                this.runningApps.set('explorer', windowId);
                
                try {
                    const entries = await this.fileSystem.listDirectory('/');
                    
                    const windowEl = this.createWindow({
                        id: windowId,
                        title: 'Explorador de Archivos',
                        icon: 'üìÅ',
                        width: 800,
                        height: 500,
                        content: `
                            <div class="explorer">
                                <div class="explorer-toolbar">
                                    <button class="btn-primary" id="back-btn" title="Atr√°s">
                                        <i class="fas fa-arrow-left"></i>
                                    </button>
                                    <button class="btn-primary" id="forward-btn" title="Adelante">
                                        <i class="fas fa-arrow-right"></i>
                                    </button>
                                    <button class="btn-primary" id="up-btn" title="Subir">
                                        <i class="fas fa-arrow-up"></i>
                                    </button>
                                    <div style="flex: 1; margin: 0 10px;">
                                        <input type="text" id="path-input" value="/" 
                                               style="width: 100%; background: rgba(255,255,255,0.1); 
                                                      border: none; color: white; padding: 5px 10px; 
                                                      border-radius: 3px; font-family: monospace;">
                                    </div>
                                    <button class="btn-primary" id="refresh-btn" title="Actualizar">
                                        <i class="fas fa-sync-alt"></i>
                                    </button>
                                    <button class="btn-primary" id="new-folder-btn" title="Nueva Carpeta">
                                        <i class="fas fa-folder-plus"></i>
                                    </button>
                                    <button class="btn-primary" id="upload-btn" title="Subir Archivo">
                                        <i class="fas fa-upload"></i>
                                    </button>
                                </div>
                                <div class="explorer-content">
                                    <div class="explorer-sidebar">
                                        <h3 style="margin-bottom: 10px;">Ubicaciones</h3>
                                        <div class="pm-list" id="sidebar-locations">
                                            <div class="pm-item active" data-path="/">
                                                <i class="fas fa-home"></i> Inicio
                                            </div>
                                            <div class="pm-item" data-path="/User/Documents">
                                                <i class="fas fa-file"></i> Documentos
                                            </div>
                                            <div class="pm-item" data-path="/User/Downloads">
                                                <i class="fas fa-download"></i> Descargas
                                            </div>
                                            <div class="pm-item" data-path="/Apps">
                                                <i class="fas fa-box"></i> Aplicaciones
                                            </div>
                                            <div class="pm-item" data-path="/System">
                                                <i class="fas fa-cog"></i> Sistema
                                            </div>
                                        </div>
                                    </div>
                                    <div class="explorer-main">
                                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                            <h3 id="current-path">Archivos en /</h3>
                                            <div style="font-size: 12px; color: rgba(255,255,255,0.6);">
                                                <span id="file-count">${entries.length} items</span>
                                            </div>
                                        </div>
                                        <div class="file-list" id="file-list">
                                            ${entries.map(entry => `
                                                <div class="file-item" data-path="${entry.path}" data-kind="${entry.kind}">
                                                    <div class="file-icon">${entry.icon}</div>
                                                    <div class="file-name">${entry.name}</div>
                                                    <div class="file-info">${entry.kind === 'directory' ? 'Carpeta' : entry.type}</div>
                                                </div>
                                            `).join('')}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `
                    });
                    
                    // Configurar eventos del explorador
                    this.setupExplorerEvents(windowEl);
                    
                } catch (error) {
                    this.showNotification('Error', 'No se pudo abrir el explorador: ' + error.message, 'error');
                }
                
                this.updateTaskbar();
            }
            
            setupExplorerEvents(windowEl) {
                const content = windowEl.querySelector('.window-content');
                let currentPath = '/';
                let pathHistory = ['/'];
                let historyIndex = 0;
                
                async function loadDirectory(path) {
                    try {
                        const entries = await XP7.fileSystem.listDirectory(path);
                        const fileList = content.querySelector('#file-list');
                        const currentPathEl = content.querySelector('#current-path');
                        const pathInput = content.querySelector('#path-input');
                        const fileCount = content.querySelector('#file-count');
                        
                        // Actualizar UI
                        currentPath = path;
                        currentPathEl.textContent = `Archivos en ${path}`;
                        pathInput.value = path;
                        fileCount.textContent = `${entries.length} items`;
                        
                        // Actualizar lista de archivos
                        fileList.innerHTML = entries.map(entry => `
                            <div class="file-item" data-path="${entry.path}" data-kind="${entry.kind}">
                                <div class="file-icon">${entry.icon}</div>
                                <div class="file-name">${entry.name}</div>
                                <div class="file-info">${entry.kind === 'directory' ? 'Carpeta' : entry.type}</div>
                            </div>
                        `).join('');
                        
                        // A√±adir event listeners
                        fileList.querySelectorAll('.file-item').forEach(item => {
                            item.addEventListener('dblclick', async () => {
                                const path = item.dataset.path;
                                const kind = item.dataset.kind;
                                
                                if (kind === 'directory') {
                                    // Actualizar historial
                                    pathHistory = pathHistory.slice(0, historyIndex + 1);
                                    pathHistory.push(path);
                                    historyIndex++;
                                    
                                    await loadDirectory(path);
                                } else {
                                    // Abrir archivo
                                    XP7.showNotification('Explorador', `Abriendo: ${path.split('/').pop()}`, 'info');
                                }
                            });
                            
                            item.addEventListener('click', (e) => {
                                if (e.ctrlKey) {
                                    item.classList.toggle('selected');
                                } else {
                                    fileList.querySelectorAll('.file-item').forEach(i => i.classList.remove('selected'));
                                    item.classList.add('selected');
                                }
                            });
                        });
                        
                        // Actualizar sidebar
                        content.querySelectorAll('.pm-item').forEach(item => {
                            item.classList.remove('active');
                            if (item.dataset.path === path) {
                                item.classList.add('active');
                            }
                        });
                        
                    } catch (error) {
                        XP7.showNotification('Error', 'Error cargando directorio: ' + error.message, 'error');
                    }
                }
                
                // Bot√≥n atr√°s
                content.querySelector('#back-btn').addEventListener('click', () => {
                    if (historyIndex > 0) {
                        historyIndex--;
                        loadDirectory(pathHistory[historyIndex]);
                    }
                });
                
                // Bot√≥n adelante
                content.querySelector('#forward-btn').addEventListener('click', () => {
                    if (historyIndex < pathHistory.length - 1) {
                        historyIndex++;
                        loadDirectory(pathHistory[historyIndex]);
                    }
                });
                
                // Bot√≥n subir
                content.querySelector('#up-btn').addEventListener('click', () => {
                    if (currentPath !== '/') {
                        const parentPath = currentPath.substring(0, currentPath.lastIndexOf('/')) || '/';
                        pathHistory = pathHistory.slice(0, historyIndex + 1);
                        pathHistory.push(parentPath);
                        historyIndex++;
                        loadDirectory(parentPath);
                    }
                });
                
                // Input de ruta
                content.querySelector('#path-input').addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        const newPath = e.target.value;
                        if (newPath && newPath !== currentPath) {
                            pathHistory = pathHistory.slice(0, historyIndex + 1);
                            pathHistory.push(newPath);
                            historyIndex++;
                            loadDirectory(newPath);
                        }
                    }
                });
                
                // Bot√≥n actualizar
                content.querySelector('#refresh-btn').addEventListener('click', () => {
                    loadDirectory(currentPath);
                });
                
                // Bot√≥n nueva carpeta
                content.querySelector('#new-folder-btn').addEventListener('click', async () => {
                    const folderName = prompt('Nombre de la nueva carpeta:');
                    if (folderName) {
                        const newPath = currentPath + (currentPath === '/' ? '' : '/') + folderName;
                        if (!XP7.fileSystem.structure[newPath]) {
                            XP7.fileSystem.structure[newPath] = [];
                            XP7.fileSystem.saveStructure();
                            await loadDirectory(currentPath);
                            XP7.showNotification('Explorador', `Carpeta "${folderName}" creada`, 'success');
                        } else {
                            XP7.showNotification('Error', 'La carpeta ya existe', 'error');
                        }
                    }
                });
                
                // Bot√≥n subir archivo
                content.querySelector('#upload-btn').addEventListener('click', () => {
                    document.getElementById('file-input').click();
                });
                
                // Sidebar
                content.querySelectorAll('.pm-item[data-path]').forEach(item => {
                    item.addEventListener('click', () => {
                        const path = item.dataset.path;
                        if (path !== currentPath) {
                            pathHistory = pathHistory.slice(0, historyIndex + 1);
                            pathHistory.push(path);
                            historyIndex++;
                            loadDirectory(path);
                        }
                    });
                });
                
                // Cargar directorio inicial
                loadDirectory('/');
            }
            
            openNotepad() {
                const windowId = `window_${this.nextWindowId++}`;
                this.runningApps.set('notepad', windowId);
                
                const windowEl = this.createWindow({
                    id: windowId,
                    title: 'Bloc de Notas',
                    icon: 'üìù',
                    width: 600,
                    height: 400,
                    content: `
                        <div class="editor">
                            <div class="editor-toolbar">
                                <button class="btn-primary" id="new-btn" title="Nuevo">
                                    <i class="fas fa-file"></i>
                                </button>
                                <button class="btn-primary" id="open-btn" title="Abrir">
                                    <i class="fas fa-folder-open"></i>
                                </button>
                                <button class="btn-primary" id="save-btn" title="Guardar">
                                    <i class="fas fa-save"></i>
                                </button>
                                <button class="btn-secondary" id="save-as-btn" title="Guardar como">
                                    <i class="fas fa-save"></i> Como
                                </button>
                            </div>
                            <div class="editor-content">
                                <textarea id="notepad-text" placeholder="Escribe aqu√≠..." 
                                          style="width: 100%; height: 100%; background: transparent; 
                                                 color: white; border: none; padding: 10px; 
                                                 font-family: monospace; font-size: 14px; 
                                                 resize: none; outline: none;"></textarea>
                            </div>
                        </div>
                    `
                });
                
                const content = windowEl.querySelector('.window-content');
                const textarea = content.querySelector('#notepad-text');
                
                content.querySelector('#new-btn').addEventListener('click', () => {
                    if (textarea.value && !confirm('¬øDeseas descartar los cambios?')) {
                        return;
                    }
                    textarea.value = '';
                    windowEl.querySelector('.window-title span').textContent = 'Bloc de Notas - Sin t√≠tulo';
                });
                
                content.querySelector('#open-btn').addEventListener('click', () => {
                    document.getElementById('file-input').click();
                });
                
                content.querySelector('#save-btn').addEventListener('click', async () => {
                    const content = textarea.value.trim();
                    if (!content) {
                        this.showNotification('Notepad', 'El documento est√° vac√≠o', 'warning');
                        return;
                    }
                    
                    const fileName = prompt('Nombre del archivo:', 'documento.txt');
                    if (fileName) {
                        await this.fileSystem.writeFile(`/User/Documents/${fileName}`, content);
                        this.showNotification('Notepad', `"${fileName}" guardado`, 'success');
                        windowEl.querySelector('.window-title span').textContent = `Bloc de Notas - ${fileName}`;
                    }
                });
                
                content.querySelector('#save-as-btn').addEventListener('click', async () => {
                    const content = textarea.value.trim();
                    if (!content) {
                        this.showNotification('Notepad', 'El documento est√° vac√≠o', 'warning');
                        return;
                    }
                    
                    const fileName = prompt('Nombre del archivo:', 'documento.txt');
                    if (fileName) {
                        await this.fileSystem.writeFile(`/User/Documents/${fileName}`, content);
                        this.showNotification('Notepad', `"${fileName}" guardado como`, 'success');
                        windowEl.querySelector('.window-title span').textContent = `Bloc de Notas - ${fileName}`;
                    }
                });
                
                this.updateTaskbar();
            }
            
            openCalculator() {
                const windowId = `window_${this.nextWindowId++}`;
                this.runningApps.set('calculator', windowId);
                
                const windowEl = this.createWindow({
                    id: windowId,
                    title: 'Calculadora',
                    icon: 'üßÆ',
                    width: 320,
                    height: 450,
                    content: `
                        <div class="calculator">
                            <div class="calc-display" id="calc-display">0</div>
                            <div class="calc-buttons">
                                <button class="calc-button clear" data-action="clear">C</button>
                                <button class="calc-button" data-action="clear-entry">CE</button>
                                <button class="calc-button" data-action="backspace">‚å´</button>
                                <button class="calc-button operator" data-action="divide">√∑</button>
                                
                                <button class="calc-button" data-number="7">7</button>
                                <button class="calc-button" data-number="8">8</button>
                                <button class="calc-button" data-number="9">9</button>
                                <button class="calc-button operator" data-action="multiply">√ó</button>
                                
                                <button class="calc-button" data-number="4">4</button>
                                <button class="calc-button" data-number="5">5</button>
                                <button class="calc-button" data-number="6">6</button>
                                <button class="calc-button operator" data-action="subtract">‚àí</button>
                                
                                <button class="calc-button" data-number="1">1</button>
                                <button class="calc-button" data-number="2">2</button>
                                <button class="calc-button" data-number="3">3</button>
                                <button class="calc-button operator" data-action="add">+</button>
                                
                                <button class="calc-button" data-number="0" style="grid-column: span 2;">0</button>
                                <button class="calc-button" data-action="decimal">.</button>
                                <button class="calc-button operator" data-action="equals">=</button>
                            </div>
                        </div>
                    `
                });
                
                // L√≥gica de la calculadora
                class Calculator {
                    constructor() {
                        this.currentInput = '0';
                        this.previousInput = '';
                        this.operation = null;
                        this.shouldResetScreen = false;
                        this.display = windowEl.querySelector('#calc-display');
                        this.setupEvents();
                        this.updateDisplay();
                    }
                    
                    setupEvents() {
                        windowEl.querySelectorAll('[data-number]').forEach(btn => {
                            btn.addEventListener('click', () => this.appendNumber(btn.dataset.number));
                        });
                        
                        windowEl.querySelectorAll('[data-action]').forEach(btn => {
                            btn.addEventListener('click', () => {
                                const action = btn.dataset.action;
                                this.handleAction(action);
                            });
                        });
                    }
                    
                    appendNumber(number) {
                        if (this.currentInput === '0' || this.shouldResetScreen) {
                            this.currentInput = number;
                            this.shouldResetScreen = false;
                        } else {
                            this.currentInput += number;
                        }
                        this.updateDisplay();
                    }
                    
                    handleAction(action) {
                        switch(action) {
                            case 'clear':
                                this.clear();
                                break;
                            case 'clear-entry':
                                this.clearEntry();
                                break;
                            case 'backspace':
                                this.backspace();
                                break;
                            case 'decimal':
                                this.addDecimal();
                                break;
                            case 'add':
                            case 'subtract':
                            case 'multiply':
                            case 'divide':
                                this.setOperation(action);
                                break;
                            case 'equals':
                                this.calculate();
                                break;
                        }
                    }
                    
                    clear() {
                        this.currentInput = '0';
                        this.previousInput = '';
                        this.operation = null;
                        this.updateDisplay();
                    }
                    
                    clearEntry() {
                        this.currentInput = '0';
                        this.updateDisplay();
                    }
                    
                    backspace() {
                        if (this.currentInput.length === 1) {
                            this.currentInput = '0';
                        } else {
                            this.currentInput = this.currentInput.slice(0, -1);
                        }
                        this.updateDisplay();
                    }
                    
                    addDecimal() {
                        if (this.shouldResetScreen) {
                            this.currentInput = '0.';
                            this.shouldResetScreen = false;
                        } else if (!this.currentInput.includes('.')) {
                            this.currentInput += '.';
                        }
                        this.updateDisplay();
                    }
                    
                    setOperation(op) {
                        if (this.operation !== null) {
                            this.calculate();
                        }
                        this.previousInput = this.currentInput;
                        this.operation = op;
                        this.shouldResetScreen = true;
                    }
                    
                    calculate() {
                        let computation;
                        const prev = parseFloat(this.previousInput);
                        const current = parseFloat(this.currentInput);
                        
                        if (isNaN(prev) || isNaN(current)) return;
                        
                        switch (this.operation) {
                            case 'add':
                                computation = prev + current;
                                break;
                            case 'subtract':
                                computation = prev - current;
                                break;
                            case 'multiply':
                                computation = prev * current;
                                break;
                            case 'divide':
                                if (current === 0) {
                                    this.currentInput = 'Error';
                                    this.updateDisplay();
                                    return;
                                }
                                computation = prev / current;
                                break;
                            default:
                                return;
                        }
                        
                        this.currentInput = computation.toString();
                        this.operation = null;
                        this.previousInput = '';
                        this.shouldResetScreen = true;
                        this.updateDisplay();
                    }
                    
                    updateDisplay() {
                        this.display.textContent = this.currentInput;
                    }
                }
                
                new Calculator();
                this.updateTaskbar();
            }
            
            openPackageManager() {
                const windowId = `window_${this.nextWindowId++}`;
                this.runningApps.set('package-manager', windowId);
                
                const installedPackages = this.fileSystem.getInstalledPackages();
                
                const windowEl = this.createWindow({
                    id: windowId,
                    title: 'Gestor de Paquetes',
                    icon: 'üì¶',
                    width: 700,
                    height: 500,
                    content: `
                        <div class="package-manager">
                            <div class="pm-header">
                                <h1><i class="fas fa-box"></i> Gestor de Paquetes XP7</h1>
                                <div class="pm-actions">
                                    <button class="btn-primary" id="install-pak-btn">
                                        <i class="fas fa-download"></i> Instalar .PAK
                                    </button>
                                    <button class="btn-secondary" id="refresh-btn">
                                        <i class="fas fa-sync-alt"></i> Actualizar
                                    </button>
                                    <button class="btn-secondary" id="create-pak-btn">
                                        <i class="fas fa-plus"></i> Crear .PAK
                                    </button>
                                </div>
                            </div>
                            <div class="pm-body">
                                <div class="pm-sidebar">
                                    <h3 style="margin-bottom: 15px;">Filtros</h3>
                                    <div class="pm-list">
                                        <div class="pm-item active" data-filter="all">
                                            <i class="fas fa-th"></i> Todos
                                        </div>
                                        <div class="pm-item" data-filter="system">
                                            <i class="fas fa-cog"></i> Sistema
                                        </div>
                                        <div class="pm-item" data-filter="tools">
                                            <i class="fas fa-tools"></i> Herramientas
                                        </div>
                                        <div class="pm-item" data-filter="apps">
                                            <i class="fas fa-app-store"></i> Aplicaciones
                                        </div>
                                        <div class="pm-item" data-filter="custom">
                                            <i class="fas fa-star"></i> Personalizadas
                                        </div>
                                    </div>
                                    
                                    <div style="margin-top: 30px;">
                                        <h3 style="margin-bottom: 10px;">Estad√≠sticas</h3>
                                        <div style="font-size: 12px; color: rgba(255,255,255,0.7);">
                                            <div>Total: <span id="total-count">${installedPackages.length + Object.keys(this.defaultApps).length}</span></div>
                                            <div>Del sistema: <span id="system-count">${Object.keys(this.defaultApps).length}</span></div>
                                            <div>Instaladas: <span id="installed-count">${installedPackages.length}</span></div>
                                        </div>
                                    </div>
                                </div>
                                <div class="pm-content">
                                    <h3 style="margin-bottom: 15px;">Paquetes Instalados</h3>
                                    <div id="packages-container" style="height: calc(100% - 40px); overflow-y: auto;">
                                        ${installedPackages.length === 0 ? `
                                            <div style="text-align: center; padding: 50px; color: rgba(255,255,255,0.5);">
                                                <i class="fas fa-box-open" style="font-size: 48px; margin-bottom: 20px;"></i>
                                                <p>No hay paquetes instalados</p>
                                                <p style="font-size: 12px; margin-top: 10px;">Instala un archivo .pak para comenzar</p>
                                            </div>
                                        ` : installedPackages.map(pkg => `
                                            <div class="pm-item package-item" data-id="${pkg.id}" style="margin-bottom: 10px;">
                                                <div style="display: flex; align-items: center; gap: 15px; width: 100%;">
                                                    <div style="font-size: 32px;">${pkg.icon}</div>
                                                    <div style="flex: 1;">
                                                        <div style="font-weight: 500; font-size: 16px;">${pkg.name}</div>
                                                        <div style="font-size: 12px; color: rgba(255,255,255,0.6); margin-top: 2px;">
                                                            ${pkg.description || 'Sin descripci√≥n'}
                                                            <div style="margin-top: 5px;">
                                                                <span style="background: rgba(76,175,80,0.2); padding: 2px 6px; border-radius: 3px; font-size: 10px;">
                                                                    v${pkg.version || '1.0.0'}
                                                                </span>
                                                                ${pkg.author ? `<span style="margin-left: 5px; font-size: 10px;">por ${pkg.author}</span>` : ''}
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <div style="display: flex; gap: 5px;">
                                                        <button class="btn-secondary launch-btn" data-id="${pkg.id}" 
                                                                style="padding: 5px 10px; font-size: 12px;">
                                                            <i class="fas fa-play"></i>
                                                        </button>
                                                        <button class="btn-danger delete-btn" data-id="${pkg.id}" 
                                                                style="padding: 5px 10px; font-size: 12px;">
                                                            <i class="fas fa-trash"></i>
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>
                            </div>
                        </div>
                    `
                });
                
                // Configurar eventos
                const content = windowEl.querySelector('.window-content');
                
                // Bot√≥n instalar .pak
                content.querySelector('#install-pak-btn').addEventListener('click', () => {
                    document.getElementById('pak-input').click();
                });
                
                // Bot√≥n actualizar
                content.querySelector('#refresh-btn').addEventListener('click', () => {
                    this.showNotification('Paquetes', 'Lista actualizada', 'info');
                });
                
                // Bot√≥n crear .pak
                content.querySelector('#create-pak-btn').addEventListener('click', () => {
                    this.openApp('pak-creator');
                });
                
                // Filtros
                content.querySelectorAll('.pm-item[data-filter]').forEach(item => {
                    item.addEventListener('click', () => {
                        content.querySelectorAll('.pm-item[data-filter]').forEach(i => i.classList.remove('active'));
                        item.classList.add('active');
                        // Aqu√≠ ir√≠a la l√≥gica de filtrado
                    });
                });
                
                // Botones de paquetes
                content.querySelectorAll('.launch-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        const appId = btn.dataset.id;
                        this.openApp(appId);
                    });
                });
                
                content.querySelectorAll('.delete-btn').forEach(btn => {
                    btn.addEventListener('click', async (e) => {
                        e.stopPropagation();
                        const appId = btn.dataset.id;
                        if (confirm(`¬øEliminar la aplicaci√≥n "${appId}"?`)) {
                            const success = await this.fileSystem.deletePackage(appId);
                            if (success) {
                                this.removeApp(appId);
                                windowEl.querySelector('.window-control.close').click();
                                this.openApp('package-manager'); // Recargar
                            }
                        }
                    });
                });
                
                this.updateTaskbar();
            }
            
            openStorageManager() {
                const windowId = `window_${this.nextWindowId++}`;
                this.runningApps.set('storage-manager', windowId);
                
                const storageInfo = this.fileSystem.getStorageInfo();
                
                const windowEl = this.createWindow({
                    id: windowId,
                    title: 'Storage Manager',
                    icon: 'üíæ',
                    width: 700,
                    height: 500,
                    content: `
                        <div style="padding: 20px; height: 100%; overflow-y: auto;">
                            <h2><i class="fas fa-hdd"></i> Storage Manager</h2>
                            <p style="color: rgba(255,255,255,0.7); margin-bottom: 30px;">
                                Gesti√≥n de almacenamiento y sistema de archivos
                            </p>
                            
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 30px;">
                                <div style="padding: 20px; background: rgba(255,255,255,0.05); border-radius: 10px;">
                                    <h3 style="color: #4CAF50; margin-bottom: 15px;">
                                        <i class="fas fa-chart-pie"></i> Uso de Almacenamiento
                                    </h3>
                                    <div style="text-align: center; margin-bottom: 20px;">
                                        <div style="width: 150px; height: 150px; margin: 0 auto 20px; 
                                                    border-radius: 50%; background: conic-gradient(
                                                        #4CAF50 0% ${storageInfo.percentage}%, 
                                                        rgba(255,255,255,0.1) ${storageInfo.percentage}% 100%
                                                    ); display: flex; align-items: center; justify-content: center;">
                                            <div style="width: 100px; height: 100px; background: rgba(30,35,40,0.95); 
                                                        border-radius: 50%; display: flex; align-items: center; 
                                                        justify-content: center; font-size: 24px; font-weight: bold;">
                                                ${storageInfo.percentage}%
                                            </div>
                                        </div>
                                        <div style="font-size: 24px; font-weight: bold; color: #4CAF50;">
                                            ${storageInfo.usedMB} MB
                                        </div>
                                        <div style="font-size: 14px; color: rgba(255,255,255,0.6);">
                                            de ${storageInfo.maxMB} MB utilizados
                                        </div>
                                    </div>
                                    <div style="font-size: 12px; color: rgba(255,255,255,0.7);">
                                        <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                                            <span>Archivos del sistema:</span>
                                            <span>${storageInfo.fileCount}</span>
                                        </div>
                                    </div>
                                </div>
                                
                                <div style="padding: 20px; background: rgba(255,255,255,0.05); border-radius: 10px;">
                                    <h3 style="color: #2196F3; margin-bottom: 15px;">
                                        <i class="fas fa-info-circle"></i> Informaci√≥n del Sistema
                                    </h3>
                                    <div style="display: flex; flex-direction: column; gap: 10px;">
                                        <div>
                                            <div style="font-size: 12px; color: rgba(255,255,255,0.6);">Modo de archivos:</div>
                                            <div style="font-weight: 500;">${this.fileSystem.mode}</div>
                                        </div>
                                        <div>
                                            <div style="font-size: 12px; color: rgba(255,255,255,0.6);">Aplicaciones instaladas:</div>
                                            <div style="font-weight: 500;">${this.apps.size}</div>
                                        </div>
                                        <div>
                                            <div style="font-size: 12px; color: rgba(255,255,255,0.6);">Actualizaciones:</div>
                                            <div style="font-weight: 500;">${this.fileSystem.getInstalledUpdates().length}</div>
                                        </div>
                                        <div>
                                            <div style="font-size: 12px; color: rgba(255,255,255,0.6);">Versi√≥n del sistema:</div>
                                            <div style="font-weight: 500;">${this.version}</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div style="margin-bottom: 30px;">
                                <h3 style="color: #FF9800; margin-bottom: 15px;">
                                    <i class="fas fa-tools"></i> Herramientas
                                </h3>
                                <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 10px;">
                                    <button class="btn-secondary" id="export-btn">
                                        <i class="fas fa-file-export"></i> Exportar Todo
                                    </button>
                                    <button class="btn-secondary" id="import-btn">
                                        <i class="fas fa-file-import"></i> Importar
                                    </button>
                                    <button class="btn-secondary" id="cleanup-btn">
                                        <i class="fas fa-broom"></i> Limpiar Cache
                                    </button>
                                    <button class="btn-secondary" id="backup-btn">
                                        <i class="fas fa-save"></i> Crear Backup
                                    </button>
                                    <button class="btn-danger" id="reset-btn">
                                        <i class="fas fa-trash"></i> Restablecer
                                    </button>
                                </div>
                            </div>
                            
                            <div>
                                <h3 style="color: #9C27B0; margin-bottom: 15px;">
                                    <i class="fas fa-exclamation-triangle"></i> Advertencia
                                </h3>
                                <div style="padding: 15px; background: rgba(255,152,0,0.1); border-radius: 5px; 
                                            border-left: 4px solid #FF9800;">
                                    <p style="color: rgba(255,255,255,0.8); font-size: 14px;">
                                        <i class="fas fa-exclamation-circle"></i> 
                                        Los datos se almacenan en el navegador local. Si limpias el cache del navegador, 
                                        perder√°s todos tus archivos y configuraciones. Exporta regularmente tus datos.
                                    </p>
                                </div>
                            </div>
                        </div>
                    `
                });
                
                // Configurar eventos
                const content = windowEl.querySelector('.window-content');
                
                content.querySelector('#export-btn').addEventListener('click', () => {
                    this.exportAllData();
                });
                
                content.querySelector('#import-btn').addEventListener('click', () => {
                    this.importData();
                });
                
                content.querySelector('#cleanup-btn').addEventListener('click', () => {
                    this.cleanupCache();
                });
                
                content.querySelector('#backup-btn').addEventListener('click', () => {
                    this.createBackup();
                });
                
                content.querySelector('#reset-btn').addEventListener('click', () => {
                    this.resetSystem();
                });
                
                this.updateTaskbar();
            }
            
            openFileSelector() {
                const windowId = `window_${this.nextWindowId++}`;
                this.runningApps.set('file-selector', windowId);
                
                const fsAvailable = 'showDirectoryPicker' in window;
                const isFileSystemMode = this.fileSystem.mode === 'fileSystem';
                
                const windowEl = this.createWindow({
                    id: windowId,
                    title: 'Selector de Sistema de Archivos',
                    icon: 'üìÇ',
                    width: 600,
                    height: 500,
                    content: `
                        <div class="fs-selector">
                            <h2><i class="fas fa-folder-open"></i> Selector de Sistema de Archivos</h2>
                            <p style="color: rgba(255,255,255,0.7); margin-bottom: 30px;">
                                Elige c√≥mo quieres almacenar tus archivos y datos
                            </p>
                            
                            <div class="fs-option ${this.fileSystem.mode === 'localStorage' ? 'selected' : ''}" 
                                 id="option-local" style="cursor: pointer;">
                                <div class="fs-option-icon">
                                    <i class="fas fa-database"></i>
                                </div>
                                <div class="fs-option-info">
                                    <div class="fs-option-title">Local Storage</div>
                                    <div class="fs-option-desc">
                                        Almacena todo en el navegador. Simple pero limitado a 5MB.
                                        Los datos pueden perderse al limpiar el cache.
                                    </div>
                                </div>
                                <span class="fs-status ${this.fileSystem.mode === 'localStorage' ? 'available' : ''}">
                                    ${this.fileSystem.mode === 'localStorage' ? '‚úÖ Activo' : ''}
                                </span>
                            </div>
                            
                            <div class="fs-option ${isFileSystemMode ? 'selected' : ''}" 
                                 id="option-fsapi" style="cursor: pointer; ${!fsAvailable ? 'opacity: 0.6;' : ''}">
                                <div class="fs-option-icon">
                                    <i class="fas fa-folder"></i>
                                </div>
                                <div class="fs-option-info">
                                    <div class="fs-option-title">File System API</div>
                                    <div class="fs-option-desc">
                                        Accede a archivos reales en tu computadora. 
                                        Solo disponible en Chrome/Edge. Mayor capacidad y persistencia.
                                    </div>
                                </div>
                                <span class="fs-status ${fsAvailable ? 'available' : 'unavailable'}">
                                    ${fsAvailable ? (isFileSystemMode ? '‚úÖ Activo' : '‚úÖ Disponible') : '‚ùå No disponible'}
                                </span>
                            </div>
                            
                            <div style="margin-top: 30px; padding: 20px; background: rgba(255,255,255,0.05); border-radius: 10px;">
                                <h3 style="color: #4CAF50; margin-bottom: 15px;">
                                    <i class="fas fa-info-circle"></i> Informaci√≥n Detallada
                                </h3>
                                <div id="fs-details">
                                    <p><strong>Modo actual:</strong> ${this.fileSystem.mode}</p>
                                    ${isFileSystemMode && this.fileSystem.directoryHandle ? 
                                      `<p><strong>Directorio:</strong> ${this.fileSystem.directoryHandle.name}</p>` : ''}
                                    <p><strong>File System API:</strong> ${fsAvailable ? 'Disponible' : 'No disponible'}</p>
                                    <p><strong>Capacidad Local Storage:</strong> 5MB</p>
                                    <p><strong>Archivos almacenados:</strong> ${this.fileSystem.getStorageInfo().fileCount}</p>
                                </div>
                            </div>
                            
                            <div style="margin-top: 30px; display: flex; gap: 10px; justify-content: center;">
                                <button class="btn-primary" id="activate-fs-btn" 
                                        style="min-width: 200px;"
                                        ${!fsAvailable || isFileSystemMode ? 'disabled' : ''}>
                                    <i class="fas fa-rocket"></i> Activar File System API
                                </button>
                                <button class="btn-secondary" id="switch-local-btn"
                                        style="min-width: 200px;"
                                        ${this.fileSystem.mode === 'localStorage' ? 'disabled' : ''}>
                                    <i class="fas fa-exchange-alt"></i> Cambiar a Local Storage
                                </button>
                            </div>
                            
                            ${this.fileSystem.mode === 'localStorage' ? `
                            <div style="margin-top: 30px; padding: 20px; background: rgba(33,150,243,0.1); border-radius: 10px;">
                                <h3 style="color: #2196F3; margin-bottom: 15px;">
                                    <i class="fas fa-exclamation-triangle"></i> Recomendaci√≥n
                                </h3>
                                <p style="color: rgba(255,255,255,0.8); margin-bottom: 15px;">
                                    Te recomendamos usar File System API si tu navegador lo soporta. 
                                    Es m√°s seguro y no tienes l√≠mites de almacenamiento.
                                </p>
                                <div style="display: flex; gap: 10px;">
                                    <button class="btn-secondary" id="export-data-btn">
                                        <i class="fas fa-file-export"></i> Exportar Datos Actuales
                                    </button>
                                    <button class="btn-secondary" id="import-data-btn">
                                        <i class="fas fa-file-import"></i> Importar Datos
                                    </button>
                                </div>
                            </div>
                            ` : ''}
                        </div>
                    `
                });
                
                // Configurar eventos
                const content = windowEl.querySelector('.window-content');
                
                content.querySelector('#activate-fs-btn').addEventListener('click', async () => {
                    try {
                        this.showNotification('File System', 'Selecciona un directorio...', 'info');
                        await this.fileSystem.enableFileSystemAPI();
                        this.showNotification('File System', '¬°Modo File System activado!', 'success');
                        windowEl.querySelector('.window-control.close').click();
                        this.openApp('file-selector'); // Recargar
                    } catch (error) {
                        if (error.name !== 'AbortError') {
                            this.showNotification('Error', 'No se pudo activar: ' + error.message, 'error');
                        }
                    }
                });
                
                content.querySelector('#switch-local-btn').addEventListener('click', () => {
                    if (confirm('¬øCambiar a Local Storage?\n\nLos archivos f√≠sicos permanecer√°n en tu directorio.')) {
                        this.fileSystem.mode = 'localStorage';
                        this.fileSystem.directoryHandle = null;
                        localStorage.setItem('xp7_fs_mode', 'localStorage');
                        this.showNotification('File System', 'Cambiado a Local Storage', 'success');
                        windowEl.querySelector('.window-control.close').click();
                        this.openApp('file-selector'); // Recargar
                    }
                });
                
                if (content.querySelector('#export-data-btn')) {
                    content.querySelector('#export-data-btn').addEventListener('click', () => {
                        this.exportAllData();
                    });
                }
                
                if (content.querySelector('#import-data-btn')) {
                    content.querySelector('#import-data-btn').addEventListener('click', () => {
                        this.importData();
                    });
                }
                
                this.updateTaskbar();
            }
            
            openSettings() {
                const windowId = `window_${this.nextWindowId++}`;
                this.runningApps.set('settings', windowId);
                
                const windowEl = this.createWindow({
                    id: windowId,
                    title: 'Configuraci√≥n',
                    icon: '‚öôÔ∏è',
                    width: 600,
                    height: 500,
                    content: `
                        <div style="padding: 20px; height: 100%; overflow-y: auto;">
                            <h2><i class="fas fa-cog"></i> Configuraci√≥n del Sistema</h2>
                            <p style="color: rgba(255,255,255,0.7); margin-bottom: 30px;">
                                Ajustes y preferencias de XP7 OS
                            </p>
                            
                            <div style="display: grid; gap: 20px;">
                                <div style="padding: 20px; background: rgba(255,255,255,0.05); border-radius: 10px;">
                                    <h3 style="color: #4CAF50; margin-bottom: 15px;">
                                        <i class="fas fa-info-circle"></i> Informaci√≥n del Sistema
                                    </h3>
                                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                                        <div>
                                            <div style="font-size: 12px; color: rgba(255,255,255,0.6);">Versi√≥n:</div>
                                            <div style="font-weight: 500;">${this.version}</div>
                                        </div>
                                        <div>
                                            <div style="font-size: 12px; color: rgba(255,255,255,0.6);">Navegador:</div>
                                            <div style="font-weight: 500;">${navigator.userAgent.split(' ')[0] || 'Unknown'}</div>
                                        </div>
                                        <div>
                                            <div style="font-size: 12px; color: rgba(255,255,255,0.6);">Aplicaciones:</div>
                                            <div style="font-weight: 500;">${this.apps.size}</div>
                                        </div>
                                        <div>
                                            <div style="font-size: 12px; color: rgba(255,255,255,0.6);">Actualizaciones:</div>
                                            <div style="font-weight: 500;">${this.fileSystem.getInstalledUpdates().length}</div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div style="padding: 20px; background: rgba(255,255,255,0.05); border-radius: 10px;">
                                    <h3 style="color: #2196F3; margin-bottom: 15px;">
                                        <i class="fas fa-palette"></i> Apariencia
                                    </h3>
                                    <div style="display: flex; flex-direction: column; gap: 15px;">
                                        <div>
                                            <div style="font-size: 14px; margin-bottom: 5px;">Tema:</div>
                                            <select style="width: 100%; background: rgba(255,255,255,0.1); 
                                                      border: none; color: white; padding: 8px; border-radius: 5px;">
                                                <option value="dark">Oscuro (Predeterminado)</option>
                                                <option value="light">Claro</option>
                                                <option value="auto">Autom√°tico</option>
                                            </select>
                                        </div>
                                        <div>
                                            <div style="font-size: 14px; margin-bottom: 5px;">Tama√±o de fuente:</div>
                                            <input type="range" min="12" max="24" value="16" 
                                                   style="width: 100%;">
                                        </div>
                                    </div>
                                </div>
                                
                                <div style="padding: 20px; background: rgba(255,255,255,0.05); border-radius: 10px;">
                                    <h3 style="color: #FF9800; margin-bottom: 15px;">
                                        <i class="fas fa-tools"></i> Mantenimiento
                                    </h3>
                                    <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 10px;">
                                        <button class="btn-secondary" id="reset-desktop-btn">
                                            <i class="fas fa-desktop"></i> Rest. Escritorio
                                        </button>
                                        <button class="btn-secondary" id="clear-cache-btn">
                                            <i class="fas fa-broom"></i> Limpiar Cache
                                        </button>
                                        <button class="btn-secondary" id="export-config-btn">
                                            <i class="fas fa-save"></i> Exportar Config
                                        </button>
                                        <button class="btn-danger" id="factory-reset-btn">
                                            <i class="fas fa-industry"></i> Rest. F√°brica
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `
                });
                
                // Configurar eventos
                const content = windowEl.querySelector('.window-content');
                
                content.querySelector('#reset-desktop-btn').addEventListener('click', () => {
                    if (confirm('¬øRestablecer iconos del escritorio?')) {
                        this.updateDesktop();
                        this.showNotification('Configuraci√≥n', 'Escritorio restablecido', 'info');
                    }
                });
                
                content.querySelector('#clear-cache-btn').addEventListener('click', () => {
                    if (confirm('¬øLimpiar cache del sistema?')) {
                        let count = 0;
                        for (let i = 0; i < localStorage.length; i++) {
                            const key = localStorage.key(i);
                            if (!key.startsWith('xp7_')) {
                                localStorage.removeItem(key);
                                count++;
                            }
                        }
                        this.showNotification('Configuraci√≥n', `Cache limpiado (${count} items)`, 'info');
                    }
                });
                
                content.querySelector('#export-config-btn').addEventListener('click', () => {
                    this.exportConfiguration();
                });
                
                content.querySelector('#factory-reset-btn').addEventListener('click', () => {
                    if (confirm('‚ö†Ô∏è ¬øRESTABLECIMIENTO DE F√ÅBRICA?\n\nSe eliminar√°n TODOS los datos.\nEsta acci√≥n NO se puede deshacer.')) {
                        localStorage.clear();
                        this.showNotification('Configuraci√≥n', 'Sistema restablecido. Recargando...', 'warning');
                        setTimeout(() => {
                            window.location.reload();
                        }, 2000);
                    }
                });
                
                this.updateTaskbar();
            }
            
            openTerminal() {
                const windowId = `window_${this.nextWindowId++}`;
                this.runningApps.set('terminal', windowId);
                
                const windowEl = this.createWindow({
                    id: windowId,
                    title: 'Terminal',
                    icon: 'üíª',
                    width: 700,
                    height: 500,
                    content: `
                        <div style="height: 100%; display: flex; flex-direction: column; background: #000; 
                                    color: #0f0; font-family: 'Courier New', monospace; font-size: 14px;">
                            <div style="padding: 10px; border-bottom: 1px solid #0f0; display: flex; justify-content: space-between; align-items: center;">
                                <div style="font-weight: bold;">XP7 Terminal v1.0.0</div>
                                <div style="font-size: 12px; color: #0a0;">Type 'help' for commands</div>
                            </div>
                            <div id="terminal-output" style="flex: 1; padding: 10px; overflow-y: auto; white-space: pre-wrap;"></div>
                            <div style="padding: 10px; border-top: 1px solid #0f0; display: flex; align-items: center;">
                                <span style="color: #0f0; margin-right: 10px;">user@xp7:~$</span>
                                <input type="text" id="terminal-input" 
                                       style="flex: 1; background: transparent; border: none; 
                                              color: #0f0; font-family: monospace; font-size: 14px; 
                                              outline: none;" autofocus>
                            </div>
                        </div>
                    `
                });
                
                const content = windowEl.querySelector('.window-content');
                const output = content.querySelector('#terminal-output');
                const input = content.querySelector('#terminal-input');
                
                const commands = {
                    help: 'Available commands:\n' +
                          'help - Show this message\n' +
                          'clear - Clear terminal\n' +
                          'echo [text] - Echo text\n' +
                          'ver - Show system version\n' +
                          'ls - List files\n' +
                          'date - Show date and time\n' +
                          'storage - Show storage info\n' +
                          'apps - List installed apps\n' +
                          'updates - Show installed updates\n' +
                          'mode - Show filesystem mode\n' +
                          'shutdown - Shutdown system\n' +
                          'restart - Restart system',
                    
                    clear: () => {
                        output.innerHTML = '';
                        return '';
                    },
                    
                    echo: (args) => args.join(' '),
                    
                    ver: () => `XP7 OS v${this.version}`,
                    
                    ls: async () => {
                        try {
                            const entries = await this.fileSystem.listDirectory('/');
                            return entries.map(e => `${e.icon} ${e.name}`).join('\n');
                        } catch (error) {
                            return `Error: ${error.message}`;
                        }
                    },
                    
                    date: () => new Date().toString(),
                    
                    storage: () => {
                        const info = this.fileSystem.getStorageInfo();
                        return `Storage: ${info.usedMB} MB / ${info.maxMB} MB (${info.percentage}%)\n` +
                               `Files: ${info.fileCount}\n` +
                               `Mode: ${this.fileSystem.mode}`;
                    },
                    
                    apps: () => {
                        const apps = Array.from(this.apps.values());
                        return apps.map(a => `${a.icon} ${a.name} - ${a.description}`).join('\n');
                    },
                    
                    updates: () => {
                        const updates = this.fileSystem.getInstalledUpdates();
                        return updates.length > 0 ? 
                            updates.map(u => `üîÑ ${u.name} v${u.version}`).join('\n') :
                            'No updates installed';
                    },
                    
                    mode: () => `Filesystem mode: ${this.fileSystem.mode}`,
                    
                    shutdown: () => {
                        this.handleSystemAction('shutdown');
                        return 'Shutting down...';
                    },
                    
                    restart: () => {
                        this.handleSystemAction('restart');
                        return 'Restarting...';
                    }
                };
                
                function addOutput(text) {
                    const div = document.createElement('div');
                    div.textContent = text;
                    output.appendChild(div);
                    output.scrollTop = output.scrollHeight;
                }
                
                async function executeCommand(cmd) {
                    const parts = cmd.trim().split(' ');
                    const command = parts[0].toLowerCase();
                    const args = parts.slice(1);
                    
                    addOutput(`$ ${cmd}`);
                    
                    if (commands[command]) {
                        if (typeof commands[command] === 'function') {
                            if (command === 'ls') {
                                const result = await commands[command]();
                                addOutput(result);
                            } else {
                                addOutput(commands[command](args));
                            }
                        } else {
                            addOutput(commands[command]);
                        }
                    } else if (command) {
                        addOutput(`Command not found: ${command}. Type 'help' for available commands.`);
                    }
                    
                    addOutput('');
                }
                
                // Historial de comandos
                let commandHistory = [];
                let historyIndex = -1;
                
                input.addEventListener('keydown', async (e) => {
                    if (e.key === 'Enter') {
                        const cmd = input.value.trim();
                        if (cmd) {
                            commandHistory.push(cmd);
                            historyIndex = commandHistory.length;
                            await executeCommand(cmd);
                            input.value = '';
                        }
                    } else if (e.key === 'ArrowUp') {
                        e.preventDefault();
                        if (commandHistory.length > 0) {
                            if (historyIndex > 0) historyIndex--;
                            input.value = commandHistory[historyIndex] || '';
                        }
                    } else if (e.key === 'ArrowDown') {
                        e.preventDefault();
                        if (commandHistory.length > 0) {
                            if (historyIndex < commandHistory.length - 1) historyIndex++;
                            input.value = commandHistory[historyIndex] || '';
                        }
                    }
                });
                
                // Mostrar mensaje de bienvenida
                addOutput('XP7 Terminal v1.0.0 - Type "help" for available commands\n');
                
                this.updateTaskbar();
            }
            
            openACTManager() {
                const windowId = `window_${this.nextWindowId++}`;
                this.runningApps.set('act-manager', windowId);
                
                const updates = this.fileSystem.getInstalledUpdates();
                
                const windowEl = this.createWindow({
                    id: windowId,
                    title: 'Gestor de ACT',
                    icon: 'üîÑ',
                    width: 700,
                    height: 500,
                    content: `
                        <div style="padding: 20px; height: 100%; overflow-y: auto;">
                            <h2><i class="fas fa-sync-alt"></i> Gestor de Archivos .ACT</h2>
                            <p style="color: rgba(255,255,255,0.7); margin-bottom: 30px;">
                                Instala y gestiona actualizaciones del sistema
                            </p>
                            
                            <div style="margin-bottom: 30px; padding: 20px; background: rgba(255,255,255,0.05); border-radius: 10px;">
                                <h3 style="color: #4CAF50; margin-bottom: 15px;">
                                    <i class="fas fa-download"></i> Instalar Actualizaci√≥n
                                </h3>
                                <p style="margin-bottom: 15px; color: rgba(255,255,255,0.8);">
                                    Los archivos .ACT contienen actualizaciones del sistema. 
                                    Aseg√∫rate de que sean de fuentes confiables.
                                </p>
                                <div style="display: flex; gap: 10px;">
                                    <button class="btn-primary" id="install-act-btn" style="min-width: 200px;">
                                        <i class="fas fa-file-import"></i> Instalar Archivo .ACT
                                    </button>
                                    <button class="btn-secondary" id="check-updates-btn" style="min-width: 200px;">
                                        <i class="fas fa-cloud-download-alt"></i> Buscar Actualizaciones
                                    </button>
                                </div>
                            </div>
                            
                            <div style="margin-bottom: 30px;">
                                <h3 style="color: #2196F3; margin-bottom: 15px;">
                                    <i class="fas fa-history"></i> Actualizaciones Instaladas
                                </h3>
                                ${updates.length === 0 ? `
                                    <div style="text-align: center; padding: 40px; color: rgba(255,255,255,0.5);">
                                        <i class="fas fa-sync" style="font-size: 48px; margin-bottom: 20px;"></i>
                                        <p>No hay actualizaciones instaladas</p>
                                        <p style="font-size: 12px; margin-top: 10px;">Instala un archivo .act para comenzar</p>
                                    </div>
                                ` : `
                                    <div style="display: flex; flex-direction: column; gap: 10px;">
                                        ${updates.map(update => `
                                            <div class="pm-item" style="margin-bottom: 10px;">
                                                <div style="display: flex; align-items: center; gap: 15px; width: 100%;">
                                                    <div style="font-size: 32px;">
                                                        <i class="fas fa-sync-alt"></i>
                                                    </div>
                                                    <div style="flex: 1;">
                                                        <div style="font-weight: 500; font-size: 16px;">${update.name}</div>
                                                        <div style="font-size: 12px; color: rgba(255,255,255,0.6); margin-top: 2px;">
                                                            ${update.description || 'Sin descripci√≥n'}
                                                            <div style="margin-top: 5px;">
                                                                <span style="background: rgba(33,150,243,0.2); padding: 2px 6px; border-radius: 3px; font-size: 10px;">
                                                                    v${update.version || '1.0.0'}
                                                                </span>
                                                                <span style="margin-left: 10px; font-size: 10px;">
                                                                    Instalado: ${new Date(update.installed).toLocaleDateString()}
                                                                </span>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <div style="display: flex; gap: 5px;">
                                                        <button class="btn-danger delete-update-btn" data-id="${update.id}" 
                                                                style="padding: 5px 10px; font-size: 12px;">
                                                            <i class="fas fa-trash"></i>
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>
                                        `).join('')}
                                    </div>
                                `}
                            </div>
                            
                            <div style="padding: 20px; background: rgba(255,152,0,0.1); border-radius: 10px; border-left: 4px solid #FF9800;">
                                <h3 style="color: #FF9800; margin-bottom: 10px;">
                                    <i class="fas fa-exclamation-triangle"></i> Informaci√≥n Importante
                                </h3>
                                <p style="color: rgba(255,255,255,0.8); font-size: 14px;">
                                    Las actualizaciones .ACT pueden modificar el sistema. 
                                    Solo instala actualizaciones de desarrolladores confiables y 
                                    siempre haz backup de tus datos importantes antes de instalar.
                                </p>
                            </div>
                        </div>
                    `
                });
                
                // Configurar eventos
                const content = windowEl.querySelector('.window-content');
                
                content.querySelector('#install-act-btn').addEventListener('click', () => {
                    document.getElementById('act-input').click();
                });
                
                content.querySelector('#check-updates-btn').addEventListener('click', () => {
                    this.showNotification('ACT Manager', 'Buscando actualizaciones...', 'info');
                    setTimeout(() => {
                        this.showNotification('ACT Manager', 'No hay actualizaciones disponibles', 'info');
                    }, 1500);
                });
                
                content.querySelectorAll('.delete-update-btn').forEach(btn => {
                    btn.addEventListener('click', async () => {
                        const updateId = btn.dataset.id;
                        if (confirm('¬øEliminar esta actualizaci√≥n?')) {
                            const success = await this.fileSystem.deleteUpdate(updateId);
                            if (success) {
                                this.showNotification('ACT Manager', 'Actualizaci√≥n eliminada', 'success');
                                windowEl.querySelector('.window-control.close').click();
                                this.openApp('act-manager'); // Recargar
                            }
                        }
                    });
                });
                
                this.updateTaskbar();
            }
            
            openPakCreator() {
                const windowId = `window_${this.nextWindowId++}`;
                this.runningApps.set('pak-creator', windowId);
                
                const windowEl = this.createWindow({
                    id: windowId,
                    title: 'Creador de Paquetes',
                    icon: 'üì¶',
                    width: 700,
                    height: 600,
                    content: `
                        <div style="padding: 20px; height: 100%; overflow-y: auto;">
                            <h2><i class="fas fa-box-open"></i> Creador de Paquetes .PAK</h2>
                            <p style="color: rgba(255,255,255,0.7); margin-bottom: 30px;">
                                Crea paquetes .pak para distribuir tus aplicaciones
                            </p>
                            
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 30px;">
                                <div style="padding: 20px; background: rgba(255,255,255,0.05); border-radius: 10px;">
                                    <h3 style="color: #4CAF50; margin-bottom: 15px;">
                                        <i class="fas fa-info-circle"></i> Informaci√≥n B√°sica
                                    </h3>
                                    <div style="display: flex; flex-direction: column; gap: 15px;">
                                        <div>
                                            <div style="font-size: 14px; margin-bottom: 5px;">Nombre *</div>
                                            <input type="text" id="pak-name" placeholder="Mi Aplicaci√≥n" 
                                                   style="width: 100%; background: rgba(255,255,255,0.1); 
                                                          border: none; color: white; padding: 8px; border-radius: 5px;">
                                        </div>
                                        <div>
                                            <div style="font-size: 14px; margin-bottom: 5px;">Icono *</div>
                                            <input type="text" id="pak-icon" placeholder="üé®" 
                                                   style="width: 100%; background: rgba(255,255,255,0.1); 
                                                          border: none; color: white; padding: 8px; border-radius: 5px;">
                                        </div>
                                        <div>
                                            <div style="font-size: 14px; margin-bottom: 5px;">Descripci√≥n</div>
                                            <textarea id="pak-description" placeholder="Descripci√≥n de la aplicaci√≥n" 
                                                      style="width: 100%; height: 80px; background: rgba(255,255,255,0.1); 
                                                             border: none; color: white; padding: 8px; border-radius: 5px; 
                                                             resize: vertical;"></textarea>
                                        </div>
                                    </div>
                                </div>
                                
                                <div style="padding: 20px; background: rgba(255,255,255,0.05); border-radius: 10px;">
                                    <h3 style="color: #2196F3; margin-bottom: 15px;">
                                        <i class="fas fa-cog"></i> Configuraci√≥n
                                    </h3>
                                    <div style="display: flex; flex-direction: column; gap: 15px;">
                                        <div>
                                            <div style="font-size: 14px; margin-bottom: 5px;">Autor</div>
                                            <input type="text" id="pak-author" placeholder="Tu Nombre" 
                                                   style="width: 100%; background: rgba(255,255,255,0.1); 
                                                          border: none; color: white; padding: 8px; border-radius: 5px;">
                                        </div>
                                        <div>
                                            <div style="font-size: 14px; margin-bottom: 5px;">Versi√≥n</div>
                                            <input type="text" id="pak-version" value="1.0.0" 
                                                   style="width: 100%; background: rgba(255,255,255,0.1); 
                                                          border: none; color: white; padding: 8px; border-radius: 5px;">
                                        </div>
                                        <div>
                                            <div style="font-size: 14px; margin-bottom: 5px;">Categor√≠a</div>
                                            <select id="pak-category" 
                                                    style="width: 100%; background: rgba(255,255,255,0.1); 
                                                           border: none; color: white; padding: 8px; border-radius: 5px;">
                                                <option value="Aplicaciones">Aplicaciones</option>
                                                <option value="Herramientas">Herramientas</option>
                                                <option value="Sistema">Sistema</option>
                                                <option value="Juegos">Juegos</option>
                                                <option value="Utilidades">Utilidades</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div style="margin-bottom: 30px;">
                                <h3 style="color: #FF9800; margin-bottom: 15px;">
                                    <i class="fas fa-code"></i> Contenido HTML
                                </h3>
                                <textarea id="pak-content" placeholder="Contenido HTML de tu aplicaci√≥n..." 
                                          style="width: 100%; height: 200px; background: rgba(30,30,30,0.8); 
                                                 color: white; border: none; padding: 15px; border-radius: 5px; 
                                                 font-family: monospace; font-size: 14px; resize: vertical;"
                                          spellcheck="false">&lt;div style="padding: 20px;"&gt;
    &lt;h2&gt;Mi Aplicaci√≥n&lt;/h2&gt;
    &lt;p&gt;Esta es mi aplicaci√≥n personalizada para XP7 OS.&lt;/p&gt;
    &lt;button onclick="alert('¬°Hola desde XP7!')" 
            style="background: #4CAF50; color: white; border: none; 
                   padding: 10px 20px; border-radius: 5px; cursor: pointer; 
                   margin-top: 15px;"&gt;
        Haz clic aqu√≠
    &lt;/button&gt;
&lt;/div&gt;</textarea>
                            </div>
                            
                            <div style="display: flex; gap: 10px; justify-content: center;">
                                <button class="btn-primary" id="generate-pak-btn" style="min-width: 200px;">
                                    <i class="fas fa-magic"></i> Generar .PAK
                                </button>
                                <button class="btn-secondary" id="preview-pak-btn" style="min-width: 200px;">
                                    <i class="fas fa-eye"></i> Vista Previa
                                </button>
                                <button class="btn-secondary" id="load-template-btn" style="min-width: 200px;">
                                    <i class="fas fa-file-download"></i> Cargar Plantilla
                                </button>
                            </div>
                            
                            <div id="pak-output" style="margin-top: 30px; display: none;">
                                <h3 style="color: #9C27B0; margin-bottom: 15px;">
                                    <i class="fas fa-file-code"></i> Resultado del Paquete
                                </h3>
                                <pre id="pak-json" style="background: rgba(0,0,0,0.3); padding: 15px; 
                                                          border-radius: 5px; overflow: auto; font-size: 12px; 
                                                          max-height: 200px; font-family: monospace;"></pre>
                                <div style="display: flex; gap: 10px; margin-top: 15px;">
                                    <button class="btn-primary" id="download-pak-btn" style="flex: 1;">
                                        <i class="fas fa-download"></i> Descargar .PAK
                                    </button>
                                    <button class="btn-secondary" id="install-pak-now-btn" style="flex: 1;">
                                        <i class="fas fa-play"></i> Instalar Ahora
                                    </button>
                                </div>
                            </div>
                        </div>
                    `
                });
                
                // Configurar eventos
                const content = windowEl.querySelector('.window-content');
                
                content.querySelector('#generate-pak-btn').addEventListener('click', () => {
                    const pakData = {
                        type: "application",
                        name: content.querySelector('#pak-name').value || "Sin nombre",
                        icon: content.querySelector('#pak-icon').value || "üì±",
                        description: content.querySelector('#pak-description').value || "",
                        author: content.querySelector('#pak-author').value || "",
                        version: content.querySelector('#pak-version').value || "1.0.0",
                        category: content.querySelector('#pak-category').value || "Aplicaciones",
                        width: 600,
                        height: 400,
                        content: content.querySelector('#pak-content').value || "<div></div>",
                        created: new Date().toISOString()
                    };
                    
                    // Validar campos obligatorios
                    if (!pakData.name || !pakData.icon) {
                        this.showNotification('Error', 'Nombre e icono son obligatorios', 'error');
                        return;
                    }
                    
                    // Generar ID
                    pakData.id = pakData.name.toLowerCase()
                        .replace(/[^a-z0-9]/g, '-')
                        .replace(/-+/g, '-')
                        .replace(/^-|-$/g, '');
                    
                    // Mostrar resultado
                    const outputDiv = content.querySelector('#pak-output');
                    const jsonPre = content.querySelector('#pak-json');
                    
                    jsonPre.textContent = JSON.stringify(pakData, null, 2);
                    outputDiv.style.display = 'block';
                    
                    this.showNotification('Paquete', 'Paquete generado correctamente', 'success');
                });
                
                content.querySelector('#download-pak-btn').addEventListener('click', () => {
                    const pakData = JSON.parse(content.querySelector('#pak-json').textContent);
                    const blob = new Blob([JSON.stringify(pakData, null, 2)], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `${pakData.id}.pak`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    
                    URL.revokeObjectURL(url);
                    this.showNotification('Descarga', `Paquete "${pakData.name}" descargado`, 'success');
                });
                
                content.querySelector('#install-pak-now-btn').addEventListener('click', async () => {
                    const pakData = JSON.parse(content.querySelector('#pak-json').textContent);
                    const result = await this.fileSystem.processPAKFile(JSON.stringify(pakData));
                    
                    if (result.success) {
                        this.addApp(pakData.id, {
                            name: pakData.name,
                            icon: pakData.icon,
                            description: pakData.description,
                            category: pakData.category,
                            launch: () => this.openPakApp(pakData)
                        });
                        
                        this.showNotification('Instalaci√≥n', result.message, 'success');
                        windowEl.querySelector('.window-control.close').click();
                    } else {
                        this.showNotification('Error', result.message, 'error');
                    }
                });
                
                content.querySelector('#preview-pak-btn').addEventListener('click', () => {
                    const contentHTML = content.querySelector('#pak-content').value;
                    const previewWindow = this.createWindow({
                        id: `preview_${Date.now()}`,
                        title: 'Vista Previa',
                        icon: 'üëÅÔ∏è',
                        width: 600,
                        height: 400,
                        content: contentHTML || '<div style="padding:20px;"><p>No hay contenido para previsualizar</p></div>'
                    });
                });
                
                content.querySelector('#load-template-btn').addEventListener('click', () => {
                    const template = {
                        name: "Mi Aplicaci√≥n Personalizada",
                        icon: "üé®",
                        description: "Una aplicaci√≥n personalizada para XP7 OS",
                        author: "Desarrollador XP7",
                        version: "1.0.0",
                        category: "Aplicaciones",
                        content: `<div style="padding: 20px;">
    <h2>¬°Bienvenido a mi aplicaci√≥n!</h2>
    <p>Esta es una aplicaci√≥n personalizada creada con el Creador de Paquetes.</p>
    <div style="margin-top: 20px;">
        <button onclick="alert('¬°Hola desde XP7!')" 
                style="background: #4CAF50; color: white; border: none; 
                       padding: 10px 20px; border-radius: 5px; cursor: pointer;">
            Haz clic aqu√≠
        </button>
    </div>
    <div style="margin-top: 20px; font-size: 12px; color: rgba(255,255,255,0.6);">
        <p>Caracter√≠sticas:</p>
        <ul style="margin-left: 20px;">
            <li>Interfaz personalizada</li>
            <li>F√°cil de distribuir</li>
            <li>Compatible con XP7 OS</li>
        </ul>
    </div>
</div>`
                    };
                    
                    content.querySelector('#pak-name').value = template.name;
                    content.querySelector('#pak-icon').value = template.icon;
                    content.querySelector('#pak-description').value = template.description;
                    content.querySelector('#pak-author').value = template.author;
                    content.querySelector('#pak-version').value = template.version;
                    content.querySelector('#pak-category').value = template.category;
                    content.querySelector('#pak-content').value = template.content;
                    
                    this.showNotification('Plantilla', 'Plantilla cargada', 'info');
                });
                
                this.updateTaskbar();
            }
            
            openCustomApp(appId, appData) {
                const windowId = `window_${this.nextWindowId++}`;
                this.runningApps.set(appId, windowId);
                
                const windowEl = this.createWindow({
                    id: windowId,
                    title: appData.name,
                    icon: appData.icon,
                    width: appData.width || 600,
                    height: appData.height || 400,
                    content: appData.content || `
                        <div style="padding: 20px; text-align: center;">
                            <div style="font-size: 48px; margin-bottom: 20px;">${appData.icon}</div>
                            <h2>${appData.name}</h2>
                            <p style="color: rgba(255,255,255,0.7); margin-top: 10px;">
                                ${appData.description || 'Aplicaci√≥n personalizada'}
                            </p>
                            ${appData.author ? `<p style="margin-top: 20px; font-size: 12px; color: rgba(255,255,255,0.5);">Autor: ${appData.author}</p>` : ''}
                        </div>
                    `
                });
                
                this.updateTaskbar();
            }
            
            openPakApp(pakData) {
                this.openCustomApp(pakData.id, pakData);
            }
            
            createWindow(options) {
                const windowEl = document.createElement('div');
                windowEl.className = 'window';
                windowEl.id = options.id;
                windowEl.style.width = options.width + 'px';
                windowEl.style.height = options.height + 'px';
                windowEl.style.left = options.left || '50px';
                windowEl.style.top = options.top || '50px';
                windowEl.style.zIndex = this.currentZIndex++;
                
                windowEl.innerHTML = `
                    <div class="window-header">
                        <div class="window-title">
                            <span>${options.icon || 'üíª'}</span>
                            <span>${options.title || 'Ventana'}</span>
                        </div>
                        <div class="window-controls">
                            <button class="window-control minimize" title="Minimizar">
                                <i class="fas fa-window-minimize"></i>
                            </button>
                            <button class="window-control maximize" title="Maximizar">
                                <i class="fas fa-window-maximize"></i>
                            </button>
                            <button class="window-control close" title="Cerrar">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>
                    <div class="window-content">${options.content || ''}</div>
                `;
                
                document.getElementById('windows-container').appendChild(windowEl);
                this.windows.set(options.id, windowEl);
                this.activeWindow = options.id;
                
                // Configurar eventos de la ventana
                this.setupWindowEvents(windowEl, options);
                
                return windowEl;
            }
            
            setupWindowEvents(windowEl, options) {
                const header = windowEl.querySelector('.window-header');
                const minimizeBtn = windowEl.querySelector('.minimize');
                const maximizeBtn = windowEl.querySelector('.maximize');
                const closeBtn = windowEl.querySelector('.close');
                
                let isDragging = false;
                let dragOffset = { x: 0, y: 0 };
                let originalSize = { width: options.width, height: options.height };
                let originalPosition = { left: windowEl.style.left, top: windowEl.style.top };
                
                // Hacer activa al hacer clic
                windowEl.addEventListener('mousedown', () => {
                    windowEl.style.zIndex = this.currentZIndex++;
                    this.activeWindow = windowEl.id;
                    this.updateTaskbar();
                });
                
                // Arrastrar
                header.addEventListener('mousedown', (e) => {
                    isDragging = true;
                    dragOffset = {
                        x: e.clientX - windowEl.offsetLeft,
                        y: e.clientY - windowEl.offsetTop
                    };
                    windowEl.style.zIndex = this.currentZIndex++;
                    this.activeWindow = windowEl.id;
                    this.updateTaskbar();
                });
                
                document.addEventListener('mousemove', (e) => {
                    if (isDragging) {
                        windowEl.style.left = (e.clientX - dragOffset.x) + 'px';
                        windowEl.style.top = (e.clientY - dragOffset.y) + 'px';
                    }
                });
                
                document.addEventListener('mouseup', () => {
                    isDragging = false;
                });
                
                // Minimizar
                minimizeBtn.addEventListener('click', () => {
                    windowEl.classList.add('app-minimized');
                    this.updateTaskbar();
                });
                
                // Maximizar/Restaurar
                maximizeBtn.addEventListener('click', () => {
                    if (windowEl.classList.contains('maximized')) {
                        windowEl.classList.remove('maximized');
                        windowEl.style.width = originalSize.width + 'px';
                        windowEl.style.height = originalSize.height + 'px';
                        windowEl.style.left = originalPosition.left;
                        windowEl.style.top = originalPosition.top;
                    } else {
                        windowEl.classList.add('maximized');
                        originalSize = {
                            width: windowEl.offsetWidth,
                            height: windowEl.offsetHeight
                        };
                        originalPosition = {
                            left: windowEl.style.left,
                            top: windowEl.style.top
                        };
                        windowEl.style.width = 'calc(100vw - 20px)';
                        windowEl.style.height = 'calc(100vh - 60px)';
                        windowEl.style.left = '10px';
                        windowEl.style.top = '10px';
                    }
                });
                
                // Cerrar
                closeBtn.addEventListener('click', () => {
                    // Eliminar de running apps
                    const appId = Array.from(this.runningApps.entries())
                        .find(([id, winId]) => winId === windowEl.id)?.[0];
                    if (appId) {
                        this.runningApps.delete(appId);
                    }
                    
                    // Eliminar ventana
                    windowEl.remove();
                    this.windows.delete(windowEl.id);
                    this.updateTaskbar();
                });
            }
            
            updateTaskbar() {
                const runningAppsEl = document.getElementById('running-apps');
                runningAppsEl.innerHTML = '';
                
                this.runningApps.forEach((windowId, appId) => {
                    if (this.apps.has(appId)) {
                        const app = this.apps.get(appId);
                        const windowEl = this.windows.get(windowId);
                        const isActive = this.activeWindow === windowId;
                        const isMinimized = windowEl?.classList.contains('app-minimized');
                        
                        const appEl = document.createElement('div');
                        appEl.className = `running-app ${isActive ? 'active' : ''} ${isMinimized ? 'minimized' : ''}`;
                        appEl.title = app.name;
                        appEl.innerHTML = `
                            <span style="margin-right: 5px;">${app.icon}</span>
                            <span>${app.name}</span>
                        `;
                        
                        appEl.addEventListener('click', () => {
                            const win = this.windows.get(windowId);
                            if (win) {
                                if (win.classList.contains('app-minimized')) {
                                    win.classList.remove('app-minimized');
                                }
                                win.style.zIndex = this.currentZIndex++;
                                this.activeWindow = windowId;
                                this.updateTaskbar();
                            }
                        });
                        
                        runningAppsEl.appendChild(appEl);
                    }
                });
            }
            
            showNotification(title, message, type = 'info') {
                const notifications = document.getElementById('notifications');
                const id = 'notification-' + Date.now();
                
                const notification = document.createElement('div');
                notification.className = `notification ${type}`;
                notification.id = id;
                
                notification.innerHTML = `
                    <div class="notification-header">
                        <span class="notification-title">${title}</span>
                        <button class="notification-close" onclick="this.parentElement.parentElement.remove()">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div class="notification-message">${message}</div>
                `;
                
                notifications.appendChild(notification);
                
                // Auto-remove after 5 seconds
                setTimeout(() => {
                    if (document.getElementById(id)) {
                        document.getElementById(id).remove();
                    }
                }, 5000);
            }
            
            showContextMenu(x, y) {
                const menu = document.getElementById('context-menu');
                menu.style.left = x + 'px';
                menu.style.top = y + 'px';
                menu.style.display = 'block';
            }
            
            showAppContextMenu(x, y, app) {
                // Similar a showContextMenu pero espec√≠fico para apps
                this.showContextMenu(x, y);
            }
            
            handleSystemAction(action) {
                switch(action) {
                    case 'shutdown':
                        this.shutdown();
                        break;
                    case 'restart':
                        this.restart();
                        break;
                    case 'logout':
                        this.logout();
                        break;
                }
            }
            
            shutdown() {
                if (confirm('¬øEst√°s seguro de que quieres apagar el sistema?')) {
                    this.showNotification('Sistema', 'Apagando XP7 OS...', 'info');
                    setTimeout(() => {
                        document.body.innerHTML = `
                            <div style="display: flex; align-items: center; justify-content: center; 
                                        height: 100vh; background: #000; color: #4CAF50; font-size: 24px;">
                                <i class="fas fa-power-off" style="margin-right: 15px;"></i>
                                Sistema Apagado
                            </div>
                        `;
                    }, 1000);
                }
            }
            
            restart() {
                if (confirm('¬øEst√°s seguro de que quieres reiniciar el sistema?')) {
                    this.showNotification('Sistema', 'Reiniciando XP7 OS...', 'info');
                    setTimeout(() => {
                        window.location.reload();
                    }, 1000);
                }
            }
            
            logout() {
                if (confirm('¬øEst√°s seguro de que quieres cerrar sesi√≥n?')) {
                    this.showNotification('Sistema', 'Cerrando sesi√≥n...', 'info');
                    setTimeout(() => {
                        // Solo limpiar datos de sesi√≥n, mantener archivos
                        const keysToKeep = [];
                        for (let i = 0; i < localStorage.length; i++) {
                            const key = localStorage.key(i);
                            if (key.startsWith('xp7_fs_') || key.startsWith('xp7_app_') || key.startsWith('xp7_update_')) {
                                keysToKeep.push(key);
                            }
                        }
                        
                        // Guardar datos importantes
                        const importantData = {};
                        keysToKeep.forEach(key => {
                            importantData[key] = localStorage.getItem(key);
                        });
                        
                        // Limpiar todo
                        localStorage.clear();
                        
                        // Restaurar datos importantes
                        Object.keys(importantData).forEach(key => {
                            localStorage.setItem(key, importantData[key]);
                        });
                        
                        window.location.reload();
                    }, 1000);
                }
            }
            
            startClock() {
                const updateTime = () => {
                    const now = new Date();
                    const timeEl = document.getElementById('time');
                    const dateEl = document.getElementById('date');
                    
                    timeEl.textContent = now.toLocaleTimeString('es-ES', { 
                        hour: '2-digit', 
                        minute: '2-digit' 
                    });
                    
                    dateEl.textContent = now.toLocaleDateString('es-ES');
                };
                
                updateTime();
                setInterval(updateTime, 1000);
            }
            
            handleSearch() {
                const query = document.getElementById('start-search').value.toLowerCase().trim();
                if (!query) return;
                
                // Buscar en apps
                const results = [];
                this.apps.forEach((app, id) => {
                    if (app.name.toLowerCase().includes(query) || 
                        app.description.toLowerCase().includes(query)) {
                        results.push(app);
                    }
                });
                
                if (results.length > 0) {
                    this.showNotification('B√∫squeda', `Encontradas ${results.length} aplicaciones`, 'info');
                    // Podr√≠a abrir una ventana con resultados
                } else {
                    this.showNotification('B√∫squeda', 'No se encontraron resultados', 'warning');
                }
                
                document.getElementById('start-search').value = '';
            }
            
            async handleFileUpload(files) {
                for (const file of files) {
                    const reader = new FileReader();
                    reader.onload = async (event) => {
                        const fileName = file.name;
                        const filePath = `/User/Downloads/${fileName}`;
                        await this.fileSystem.writeFile(filePath, event.target.result);
                    };
                    reader.readAsText(file);
                }
                
                this.showNotification('Archivos', `${files.length} archivo(s) subido(s)`, 'success');
            }
            
            async handleDroppedFiles(files) {
                const actFiles = Array.from(files).filter(f => f.name.endsWith('.act'));
                const pakFiles = Array.from(files).filter(f => f.name.endsWith('.pak'));
                const otherFiles = Array.from(files).filter(f => !f.name.endsWith('.act') && !f.name.endsWith('.pak'));
                
                if (actFiles.length > 0) {
                    for (const file of actFiles) {
                        await this.processACTFile(file);
                    }
                }
                
                if (pakFiles.length > 0) {
                    for (const file of pakFiles) {
                        await this.processPAKFile(file);
                    }
                }
                
                if (otherFiles.length > 0) {
                    await this.handleFileUpload(otherFiles);
                }
            }
            
            async processACTFile(file) {
                const reader = new FileReader();
                reader.onload = async (event) => {
                    const result = await this.fileSystem.processACTFile(event.target.result);
                    if (result.success) {
                        this.showNotification('ACT Manager', result.message, 'success');
                        // Recargar ACT Manager si est√° abierto
                        if (this.runningApps.has('act-manager')) {
                            const windowId = this.runningApps.get('act-manager');
                            const windowEl = this.windows.get(windowId);
                            if (windowEl) {
                                windowEl.querySelector('.window-control.close').click();
                                this.openApp('act-manager');
                            }
                        }
                    } else {
                        this.showNotification('Error', result.message, 'error');
                    }
                };
                reader.readAsText(file);
            }
            
            async processPAKFile(file) {
                const reader = new FileReader();
                reader.onload = async (event) => {
                    const result = await this.fileSystem.processPAKFile(event.target.result);
                    if (result.success) {
                        this.addApp(result.data.id, {
                            name: result.data.name,
                            icon: result.data.icon,
                            description: result.data.description,
                            category: result.data.category,
                            launch: () => this.openPakApp(result.data)
                        });
                        
                        this.showNotification('Paquetes', result.message, 'success');
                        // Recargar Package Manager si est√° abierto
                        if (this.runningApps.has('package-manager')) {
                            const windowId = this.runningApps.get('package-manager');
                            const windowEl = this.windows.get(windowId);
                            if (windowEl) {
                                windowEl.querySelector('.window-control.close').click();
                                this.openApp('package-manager');
                            }
                        }
                    } else {
                        this.showNotification('Error', result.message, 'error');
                    }
                };
                reader.readAsText(file);
            }
            
            async handleACTUpload(file) {
                if (file) {
                    await this.processACTFile(file);
                }
            }
            
            async handlePAKUpload(file) {
                if (file) {
                    await this.processPAKFile(file);
                }
            }
            
            exportAllData() {
                try {
                    const exportData = {};
                    for (let i = 0; i < localStorage.length; i++) {
                        const key = localStorage.key(i);
                        if (key.startsWith('xp7_')) {
                            exportData[key] = localStorage.getItem(key);
                        }
                    }
                    
                    const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `xp7-backup-${new Date().toISOString().split('T')[0]}.json`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    
                    URL.revokeObjectURL(url);
                    this.showNotification('Exportaci√≥n', 'Todos los datos exportados', 'success');
                } catch (error) {
                    this.showNotification('Error', 'No se pudo exportar: ' + error.message, 'error');
                }
            }
            
            importData() {
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = '.json';
                
                input.addEventListener('change', async (e) => {
                    const file = e.target.files[0];
                    if (!file) return;
                    
                    const reader = new FileReader();
                    reader.onload = async (event) => {
                        try {
                            const importData = JSON.parse(event.target.result);
                            let importedCount = 0;
                            
                            Object.keys(importData).forEach(key => {
                                if (key.startsWith('xp7_')) {
                                    localStorage.setItem(key, importData[key]);
                                    importedCount++;
                                }
                            });
                            
                            this.showNotification('Importaci√≥n', `${importedCount} items importados. Recargando...`, 'success');
                            setTimeout(() => {
                                window.location.reload();
                            }, 2000);
                        } catch (error) {
                            this.showNotification('Error', 'Formato de archivo inv√°lido', 'error');
                        }
                    };
                    
                    reader.readAsText(file);
                });
                
                input.click();
            }
            
            cleanupCache() {
                if (confirm('¬øLimpiar cache del sistema?\n\nEsto eliminar√° datos temporales pero mantendr√° tus archivos.')) {
                    let count = 0;
                    for (let i = 0; i < localStorage.length; i++) {
                        const key = localStorage.key(i);
                        if (key.startsWith('xp7_cache_') || key.startsWith('xp7_temp_')) {
                            localStorage.removeItem(key);
                            count++;
                        }
                    }
                    this.showNotification('Limpieza', `Cache limpiado (${count} items)`, 'info');
                }
            }
            
            createBackup() {
                this.exportAllData();
            }
            
            resetSystem() {
                if (confirm('‚ö†Ô∏è ¬øRestablecer sistema?\n\nSe eliminar√°n configuraciones pero se mantendr√°n los archivos.')) {
                    const keysToKeep = [];
                    for (let i = 0; i < localStorage.length; i++) {
                        const key = localStorage.key(i);
                        if (key.startsWith('xp7_fs_')) {
                            keysToKeep.push(key);
                        }
                    }
                    
                    // Guardar datos de archivos
                    const fileData = {};
                    keysToKeep.forEach(key => {
                        fileData[key] = localStorage.getItem(key);
                    });
                    
                    // Limpiar todo
                    localStorage.clear();
                    
                    // Restaurar archivos
                    Object.keys(fileData).forEach(key => {
                        localStorage.setItem(key, fileData[key]);
                    });
                    
                    this.showNotification('Sistema', 'Sistema restablecido. Recargando...', 'warning');
                    setTimeout(() => {
                        window.location.reload();
                    }, 2000);
                }
            }
            
            exportConfiguration() {
                const config = {
                    version: this.version,
                    fileSystem: {
                        mode: this.fileSystem.mode,
                        structure: this.fileSystem.structure
                    },
                    apps: Array.from(this.apps.entries()).map(([id, app]) => ({
                        id,
                        name: app.name,
                        icon: app.icon,
                        category: app.category
                    })),
                    settings: {
                        lastBackup: new Date().toISOString()
                    }
                };
                
                const blob = new Blob([JSON.stringify(config, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                
                const a = document.createElement('a');
                a.href = url;
                a.download = `xp7-config-${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                
                URL.revokeObjectURL(url);
                this.showNotification('Configuraci√≥n', 'Configuraci√≥n exportada', 'success');
            }
            
            showToast(message, type = 'info') {
                const toast = document.createElement('div');
                toast.className = `toast ${type}`;
                toast.textContent = message;
                document.body.appendChild(toast);
                
                setTimeout(() => {
                    toast.remove();
                }, 3000);
            }
        }

        // Inicializar el sistema
        const XP7 = new XP7System();

        // Iniciar cuando el DOM est√© cargado
        document.addEventListener('DOMContentLoaded', () => {
            XP7.init();
        });

        // Exponer XP7 globalmente para depuraci√≥n
        window.XP7 = XP7;
    </script>
</body>
</html>
