<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>XP7 OS - Sistema Completo</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <style>
        /* ============ ESTILOS PRINCIPALES ============ */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            user-select: none;
        }

        body {
            background: linear-gradient(135deg, #0f2027, #203a43, #2c5364);
            color: #fff;
            overflow: hidden;
            height: 100vh;
            width: 100vw;
            position: relative;
        }

        /* ============ EFECTOS CRT ============ */
        .crt-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 9998;
            opacity: 0;
            transition: opacity 0.5s ease;
        }

        .crt-overlay.active {
            opacity: 1;
        }

        .crt-overlay::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: repeating-linear-gradient(
                0deg,
                rgba(0, 0, 0, 0.15) 0px,
                transparent 1px,
                transparent 2px,
                rgba(0, 0, 0, 0.15) 3px
            );
            animation: scanlines 8s linear infinite;
        }

        .crt-overlay::after {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: radial-gradient(ellipse at center, transparent 0%, rgba(0, 0, 0, 0.3) 100%);
        }

        @keyframes scanlines {
            0% { transform: translateY(0); }
            100% { transform: translateY(10px); }
        }

        /* ============ CANVAS 3D Y SHADERS ============ */
        #three-canvas, #shader-canvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.5s ease;
        }

        #three-canvas.active, #shader-canvas.active {
            opacity: 0.4;
        }

        #shader-canvas {
            z-index: 0;
        }

        .wallpaper-layer {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 0;
            background-size: cover;
            background-position: center;
            transition: opacity 0.5s ease;
        }

        /* ============ TASKBAR ============ */
        #taskbar {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 40px;
            background: rgba(20, 25, 30, 0.95);
            backdrop-filter: blur(10px);
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 10px;
            z-index: 1000;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .taskbar-left {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .taskbar-right {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .start-button {
            background: linear-gradient(135deg, #4CAF50, #45a049);
            border: none;
            color: white;
            padding: 6px 15px;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .start-button:hover {
            background: linear-gradient(135deg, #45a049, #3d8b40);
            transform: translateY(-1px);
            box-shadow: 0 3px 8px rgba(0,0,0,0.2);
        }

        .running-apps {
            display: flex;
            gap: 5px;
        }

        .running-app {
            background: rgba(255, 255, 255, 0.1);
            padding: 4px 10px;
            border-radius: 3px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
            max-width: 120px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .running-app:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .running-app.active {
            background: rgba(76, 175, 80, 0.3);
            border-bottom: 2px solid #4CAF50;
        }

        #system-tray {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 12px;
        }

        .clock, .date {
            padding: 2px 5px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 3px;
        }

        /* ============ START MENU ============ */
        .start-menu {
            position: fixed;
            bottom: 40px;
            left: 10px;
            width: 500px;
            height: 500px;
            background: rgba(25, 30, 35, 0.98);
            backdrop-filter: blur(20px);
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.4);
            z-index: 999;
            display: none;
            overflow: hidden;
            animation: fadeIn 0.2s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .start-menu.active {
            display: block;
        }

        .start-header {
            padding: 20px;
            background: linear-gradient(135deg, rgba(76, 175, 80, 0.2), rgba(69, 160, 73, 0.1));
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .user-icon {
            font-size: 40px;
            background: rgba(255, 255, 255, 0.1);
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .user-name {
            font-size: 18px;
            font-weight: 500;
        }

        .start-content {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            padding: 20px;
            height: calc(100% - 180px);
            overflow-y: auto;
        }

        .start-column h3 {
            margin-bottom: 10px;
            color: #4CAF50;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .start-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 12px;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.2s ease;
            margin-bottom: 5px;
        }

        .start-item:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: translateX(5px);
        }

        .start-icon {
            font-size: 20px;
            width: 24px;
            text-align: center;
        }

        .start-text {
            font-size: 14px;
        }

        .start-footer {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            padding: 15px 20px;
            background: rgba(20, 25, 30, 0.9);
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .search-box {
            display: flex;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 5px;
            overflow: hidden;
        }

        .search-box input {
            flex: 1;
            background: transparent;
            border: none;
            padding: 8px 15px;
            color: white;
            font-size: 14px;
        }

        .search-box input::placeholder {
            color: rgba(255, 255, 255, 0.5);
        }

        .search-box button {
            background: rgba(76, 175, 80, 0.2);
            border: none;
            color: white;
            padding: 8px 15px;
            cursor: pointer;
            transition: background 0.2s ease;
        }

        .search-box button:hover {
            background: rgba(76, 175, 80, 0.3);
        }

        /* ============ DESKTOP ============ */
        .desktop {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: calc(100% - 40px);
            z-index: 2;
            padding: 20px;
            display: grid;
            grid-template-columns: repeat(auto-fill, 80px);
            grid-auto-rows: 80px;
            gap: 20px;
            align-content: start;
        }

        .desktop-icon {
            width: 80px;
            height: 80px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            border-radius: 8px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            padding: 10px;
            position: relative;
        }

        .desktop-icon:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: scale(1.1) translateY(-5px);
            z-index: 10;
        }

        .desktop-icon:hover::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: calc(100% + 10px);
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 12px;
            white-space: nowrap;
            z-index: 1000;
            pointer-events: none;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
        }

        .desktop-icon .icon {
            font-size: 32px;
            margin-bottom: 5px;
        }

        .desktop-icon .name {
            font-size: 11px;
            text-align: center;
            word-break: break-word;
            line-height: 1.2;
            max-height: 28px;
            overflow: hidden;
            text-overflow: ellipsis;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
        }

        /* Badges para iconos */
        .icon-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: #f44336;
            color: white;
            font-size: 10px;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            z-index: 11;
        }

        .icon-badge.pak {
            background: #667eea;
        }

        .icon-badge.act {
            background: #f5576c;
        }

        .icon-badge.new {
            background: #FF5722;
            animation: badge-pulse 2s infinite;
        }

        @keyframes badge-pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.2); }
        }

        /* ============ VENTANAS ============ */
        #windows-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 100;
        }

        .window {
            position: absolute;
            min-width: 300px;
            min-height: 200px;
            background: rgba(30, 35, 40, 0.98);
            backdrop-filter: blur(20px);
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.4);
            overflow: hidden;
            pointer-events: all;
            z-index: 101;
            animation: windowFadeIn 0.2s ease;
        }

        @keyframes windowFadeIn {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }

        .window.maximized {
            resize: none;
        }

        .window-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 15px;
            background: rgba(20, 25, 30, 0.95);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            cursor: move;
            user-select: none;
        }

        .window-title {
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 500;
            font-size: 14px;
        }

        .window-controls {
            display: flex;
            gap: 5px;
        }

        .window-control {
            width: 30px;
            height: 30px;
            border: none;
            border-radius: 3px;
            background: transparent;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }

        .window-control:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .window-control.minimize:hover {
            background: rgba(255, 193, 7, 0.2);
        }

        .window-control.maximize:hover {
            background: rgba(33, 150, 243, 0.2);
        }

        .window-control.close:hover {
            background: rgba(244, 67, 54, 0.2);
        }

        .window-content {
            padding: 15px;
            height: calc(100% - 50px);
            overflow: auto;
        }

        /* ============ BOTONES ============ */
        .btn-primary, .btn-secondary, .btn-danger {
            padding: 8px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 5px;
            font-size: 14px;
            transition: all 0.2s ease;
        }

        .btn-primary {
            background: linear-gradient(135deg, #4CAF50, #45a049);
            color: white;
        }

        .btn-primary:hover {
            background: linear-gradient(135deg, #45a049, #3d8b40);
            transform: translateY(-1px);
            box-shadow: 0 3px 8px rgba(0,0,0,0.2);
        }

        .btn-secondary {
            background: rgba(33, 150, 243, 0.2);
            color: white;
            border: 1px solid rgba(33, 150, 243, 0.5);
        }

        .btn-secondary:hover {
            background: rgba(33, 150, 243, 0.3);
        }

        .btn-danger {
            background: rgba(244, 67, 54, 0.2);
            color: white;
            border: 1px solid rgba(244, 67, 54, 0.5);
        }

        .btn-danger:hover {
            background: rgba(244, 67, 54, 0.3);
        }

        /* ============ NOTIFICACIONES ============ */
        #notifications {
            position: fixed;
            top: 20px;
            right: 20px;
            width: 300px;
            z-index: 10001;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .notification {
            background: rgba(25, 30, 35, 0.95);
            backdrop-filter: blur(10px);
            border-left: 4px solid #4CAF50;
            padding: 15px;
            border-radius: 5px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            animation: slideIn 0.3s ease;
            transform-origin: top right;
        }

        .notification.error {
            border-left-color: #f44336;
        }

        .notification.warning {
            border-left-color: #ff9800;
        }

        .notification.info {
            border-left-color: #2196F3;
        }

        .notification.success {
            border-left-color: #4CAF50;
        }

        .notification-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 5px;
        }

        .notification-title {
            font-weight: 500;
            font-size: 14px;
        }

        .notification-close {
            background: none;
            border: none;
            color: white;
            cursor: pointer;
            font-size: 16px;
            opacity: 0.7;
            transition: opacity 0.2s;
        }

        .notification-close:hover {
            opacity: 1;
        }

        .notification-message {
            font-size: 13px;
            color: rgba(255, 255, 255, 0.8);
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%) scale(0.8);
                opacity: 0;
            }
            to {
                transform: translateX(0) scale(1);
                opacity: 1;
            }
        }

        /* ============ LOADING SCREEN ============ */
        .loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #0a1929, #0c2b4b);
            z-index: 10000;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: opacity 0.5s ease;
        }

        .loading-content {
            text-align: center;
        }

        .loading-logo {
            font-size: 60px;
            font-weight: bold;
            color: #4CAF50;
            margin-bottom: 20px;
            text-shadow: 0 0 20px rgba(76, 175, 80, 0.5);
            animation: logo-float 3s ease-in-out infinite;
        }

        @keyframes logo-float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        .loading-text {
            font-size: 18px;
            margin-bottom: 30px;
            color: rgba(255, 255, 255, 0.8);
        }

        .loading-bar {
            width: 300px;
            height: 4px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 2px;
            overflow: hidden;
            margin: 0 auto 20px;
        }

        .loading-progress {
            height: 100%;
            background: linear-gradient(90deg, #4CAF50, #45a049);
            border-radius: 2px;
            width: 0%;
            animation: loading 2s ease-in-out infinite;
        }

        .loading-version {
            font-size: 14px;
            color: rgba(255, 255, 255, 0.5);
        }

        @keyframes loading {
            0% { width: 0%; }
            50% { width: 100%; }
            100% { width: 0%; }
        }

        /* ============ EXPLORER ============ */
        .explorer {
            height: 100%;
            display: flex;
            flex-direction: column;
        }

        .explorer-toolbar {
            display: flex;
            gap: 5px;
            padding: 10px;
            background: rgba(255, 255, 255, 0.05);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .explorer-content {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        .explorer-sidebar {
            width: 200px;
            background: rgba(255, 255, 255, 0.05);
            border-right: 1px solid rgba(255, 255, 255, 0.1);
            padding: 10px;
            overflow-y: auto;
        }

        .explorer-main {
            flex: 1;
            padding: 15px;
            overflow-y: auto;
        }

        .file-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 10px;
        }

        .file-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 10px;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.2s ease;
            text-align: center;
            position: relative;
        }

        .file-item:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .file-item.selected {
            background: rgba(33, 150, 243, 0.2);
            border: 1px solid rgba(33, 150, 243, 0.5);
        }

        .file-icon {
            font-size: 32px;
            margin-bottom: 5px;
        }

        .file-name {
            font-size: 12px;
            word-break: break-all;
            margin-bottom: 3px;
            max-height: 32px;
            overflow: hidden;
            text-overflow: ellipsis;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
        }

        .file-info {
            font-size: 10px;
            color: rgba(255, 255, 255, 0.6);
        }

        /* ============ PACKAGE MANAGER ============ */
        .pm-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.2s ease;
            margin-bottom: 10px;
        }

        .pm-item:hover {
            background: rgba(255, 255, 255, 0.15);
            transform: translateX(5px);
        }

        .pm-item.active {
            background: rgba(76, 175, 80, 0.2);
            border-left: 3px solid #4CAF50;
        }

        /* ============ DRAG & DROP ============ */
        .drag-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(76, 175, 80, 0.1);
            border: 3px dashed #4CAF50;
            z-index: 9999;
            display: none;
            pointer-events: none;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            color: #4CAF50;
        }

        .drag-overlay.active {
            display: flex;
        }

        /* ============ STORAGE SELECTOR ============ */
        .storage-selector {
            padding: 20px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            margin: 20px 0;
        }

        .storage-option {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 15px;
            margin: 10px 0;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .storage-option:hover {
            background: rgba(255, 255, 255, 0.15);
            transform: translateX(5px);
        }

        .storage-option.active {
            background: rgba(76, 175, 80, 0.2);
            border: 2px solid #4CAF50;
        }

        .storage-option .icon {
            font-size: 32px;
        }

        .storage-option .info {
            flex: 1;
        }

        .storage-option .name {
            font-weight: 500;
            margin-bottom: 5px;
        }

        .storage-option .desc {
            font-size: 12px;
            color: rgba(255, 255, 255, 0.7);
        }

        .storage-option .status {
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
        }

        .storage-option .status.active {
            background: rgba(76, 175, 80, 0.3);
            color: #4CAF50;
        }

        /* ============ INDEXEDDB BROWSER ============ */
        .idb-browser {
            height: 100%;
            display: flex;
            flex-direction: column;
        }

        .idb-toolbar {
            padding: 10px;
            background: rgba(255, 255, 255, 0.05);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            gap: 10px;
        }

        .idb-content {
            flex: 1;
            display: flex;
            overflow: hidden;
        }

        .idb-sidebar {
            width: 250px;
            background: rgba(0, 0, 0, 0.2);
            border-right: 1px solid rgba(255, 255, 255, 0.1);
            overflow-y: auto;
            padding: 15px;
        }

        .idb-main {
            flex: 1;
            padding: 15px;
            overflow-y: auto;
        }

        .idb-store {
            padding: 10px;
            margin: 5px 0;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .idb-store:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .idb-store.active {
            background: rgba(33, 150, 243, 0.2);
            border-left: 3px solid #2196F3;
        }

        /* ============ ACT PERSISTENCE INDICATOR ============ */
        .act-indicator {
            position: fixed;
            top: 10px;
            right: 10px;
            background: rgba(76, 175, 80, 0.9);
            color: white;
            padding: 8px 12px;
            border-radius: 20px;
            font-size: 12px;
            z-index: 9999;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* ============ RESPONSIVE ============ */
        @media (max-width: 768px) {
            .start-menu {
                width: calc(100% - 20px);
                height: 70vh;
            }
            
            .start-content {
                grid-template-columns: 1fr;
            }
            
            .window {
                min-width: 90vw !important;
                min-height: 50vh !important;
                left: 5vw !important;
                top: 5vh !important;
            }
            
            .explorer-content {
                flex-direction: column;
            }

            .explorer-sidebar {
                width: 100%;
                border-right: none;
                border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            }
            
            .desktop {
                grid-template-columns: repeat(auto-fill, 70px);
                grid-auto-rows: 70px;
                gap: 15px;
                padding: 15px;
            }
            
            .desktop-icon {
                width: 70px;
                height: 70px;
            }
            
            .desktop-icon .icon {
                font-size: 28px;
            }
            
            .desktop-icon .name {
                font-size: 10px;
            }
        }
    </style>
</head>
<body>
    <!-- ============ ELEMENTOS VISUALES ============ -->
    <div class="wallpaper-layer" id="wallpaper"></div>
    <canvas id="shader-canvas"></canvas>
    <canvas id="three-canvas"></canvas>
    <div class="crt-overlay" id="crt-overlay"></div>
    
    <!-- ============ ACT PERSISTENCE INDICATOR ============ -->
    <div id="act-indicator" class="act-indicator" style="display: none;">
        <span>üîÑ</span>
        <span id="act-count">0 ACTs</span>
    </div>
    
    <!-- ============ TASKBAR ============ -->
    <div id="taskbar">
        <div class="taskbar-left">
            <button id="start-btn" class="start-button">
                <i class="fas fa-play" style="font-size: 12px;"></i>
                <span>Inicio</span>
            </button>
            <div id="running-apps" class="running-apps"></div>
        </div>
        <div class="taskbar-right">
            <div id="system-tray">
                <span id="volume-icon" title="Volumen">üîä</span>
                <span id="network-icon" title="Red">üåê</span>
                <span id="time" class="clock">00:00</span>
                <span id="date" class="date">01/01/2024</span>
            </div>
        </div>
    </div>
    
    <!-- ============ START MENU ============ -->
    <div id="start-menu" class="start-menu">
        <div class="start-header">
            <div class="user-info">
                <div class="user-icon"><i class="fas fa-user"></i></div>
                <div class="user-name">Usuario XP7</div>
            </div>
        </div>
        <div class="start-content">
            <div class="start-column">
                <h3>Programas</h3>
                <div class="start-item" data-app="explorer">
                    <span class="start-icon">üìÅ</span>
                    <span class="start-text">Explorador</span>
                </div>
                <div class="start-item" data-app="notepad">
                    <span class="start-icon">üìù</span>
                    <span class="start-text">Bloc de Notas</span>
                </div>
                <div class="start-item" data-app="calculator">
                    <span class="start-icon">üßÆ</span>
                    <span class="start-text">Calculadora</span>
                </div>
                <div class="start-item" data-app="package-manager">
                    <span class="start-icon">üì¶</span>
                    <span class="start-text">Gestor de Paquetes</span>
                </div>
                <div class="start-item" data-app="act-manager">
                    <span class="start-icon">üîÑ</span>
                    <span class="start-text">Gestor de ACT</span>
                </div>
            </div>
            <div class="start-column">
                <h3>Herramientas</h3>
                <div class="start-item" data-app="storage-manager">
                    <span class="start-icon">üíæ</span>
                    <span class="start-text">Storage Manager</span>
                </div>
                <div class="start-item" data-app="file-selector">
                    <span class="start-icon">üìÇ</span>
                    <span class="start-text">File Selector</span>
                </div>
                <div class="start-item" data-app="terminal">
                    <span class="start-icon">üíª</span>
                    <span class="start-text">Terminal</span>
                </div>
                <div class="start-item" data-app="visual-settings">
                    <span class="start-icon">üé®</span>
                    <span class="start-text">Visual Settings</span>
                </div>
                <div class="start-item" data-app="wallpaper-changer">
                    <span class="start-icon">üñºÔ∏è</span>
                    <span class="start-text">Fondos</span>
                </div>
            </div>
            <div class="start-column">
                <h3>Sistema</h3>
                <div class="start-item" data-app="settings">
                    <span class="start-icon">‚öôÔ∏è</span>
                    <span class="start-text">Configuraci√≥n</span>
                </div>
                <div class="start-item" data-app="dev-studio">
                    <span class="start-icon">üíª</span>
                    <span class="start-text">Dev Studio</span>
                </div>
                <div class="start-item" data-action="restart">
                    <span class="start-icon"><i class="fas fa-redo"></i></span>
                    <span class="start-text">Reiniciar</span>
                </div>
            </div>
        </div>
        <div class="start-footer">
            <div class="search-box">
                <input type="text" id="start-search" placeholder="Buscar...">
                <button id="search-btn"><i class="fas fa-search"></i></button>
            </div>
        </div>
    </div>
    
    <!-- ============ DESKTOP ============ -->
    <div id="desktop" class="desktop"></div>
    
    <!-- ============ VENTANAS ============ -->
    <div id="windows-container"></div>
    
    <!-- ============ NOTIFICACIONES ============ -->
    <div id="notifications"></div>

    <!-- ============ DRAG & DROP ============ -->
    <div id="drag-overlay" class="drag-overlay">
        <div>
            <i class="fas fa-upload" style="font-size:48px;margin-bottom:20px;"></i>
            <div>Suelta archivos aqu√≠ para instalar</div>
        </div>
    </div>
    
    <!-- ============ LOADING SCREEN ============ -->
    <div id="loading-screen" class="loading-screen">
        <div class="loading-content">
            <div class="loading-logo">XP7 OS</div>
            <div class="loading-text">Sistema Completo con IndexedDB</div>
            <div class="loading-bar">
                <div class="loading-progress"></div>
            </div>
            <div class="loading-version">v5.0.0 Ultimate Edition</div>
        </div>
    </div>

    <!-- ============ INPUTS DE ARCHIVO OCULTOS ============ -->
    <input type="file" id="file-input" style="display:none;" multiple>
    <input type="file" id="act-input" style="display:none;" accept=".act,.json">
    <input type="file" id="pak-input" style="display:none;" accept=".pak,.json">

    <!-- ============ SCRIPT PRINCIPAL ============ -->
    <script>
        // ============================================
        // XP7 OS COMPLETO - SISTEMA CON INDEXEDDB
        // ============================================

        class XP7Complete {
            constructor() {
                this.version = '5.0.0';
                this.windows = new Map();
                this.apps = new Map();
                this.currentZIndex = 100;
                this.runningApps = new Map();
                this.nextWindowId = 1;
                this.activeWindow = null;
                
                // Configuraci√≥n visual
                this.visualSettings = {
                    crtEffect: false,
                    shaderEffect: false,
                    threeDEffect: false,
                    currentWallpaper: 'gradient1'
                };
                
                // Fondos de pantalla
                this.wallpapers = {
                    gradient1: 'linear-gradient(135deg, #0f2027, #203a43, #2c5364)',
                    gradient2: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
                    gradient3: 'linear-gradient(135deg, #f093fb 0%, #f5576c 100%)',
                    gradient4: 'linear-gradient(135deg, #4facfe 0%, #00f2fe 100%)',
                    gradient5: 'linear-gradient(135deg, #43e97b 0%, #38f9d7 100%)',
                    gradient6: 'linear-gradient(135deg, #fa709a 0%, #fee140 100%)',
                    matrix: 'radial-gradient(circle at center, #001100 0%, #003300 100%)',
                    vaporwave: 'linear-gradient(135deg, #ff6ec7, #7c6cff, #00d4ff)',
                    sunset: 'linear-gradient(135deg, #ff512f 0%, #dd2476 50%, #9b59b6 100%)'
                };
                
                // Sistema de archivos con IndexedDB
                this.fileSystem = {
                    mode: 'indexedDB', // 'localStorage' o 'indexedDB'
                    db: null,
                    structure: {},
                    
                    async init() {
                        console.log('üíæ Iniciando sistema de archivos...');
                        
                        // Cargar configuraci√≥n
                        const savedMode = localStorage.getItem('xp7_fs_mode');
                        if (savedMode) this.mode = savedMode;
                        
                        // Inicializar seg√∫n el modo
                        if (this.mode === 'indexedDB') {
                            await this.initIndexedDB();
                        } else {
                            await this.initLocalStorage();
                        }
                        
                        console.log(`‚úÖ Sistema de archivos listo (${this.mode})`);
                        return true;
                    },
                    
                    async initIndexedDB() {
                        return new Promise((resolve, reject) => {
                            const request = indexedDB.open('XP7FileSystem', 3);
                            
                            request.onerror = () => {
                                console.warn('IndexedDB no disponible, usando localStorage');
                                this.mode = 'localStorage';
                                this.initLocalStorage().then(resolve).catch(reject);
                            };
                            
                            request.onsuccess = (event) => {
                                this.db = event.target.result;
                                this.loadStructureFromIndexedDB().then(resolve);
                            };
                            
                            request.onupgradeneeded = (event) => {
                                const db = event.target.result;
                                
                                // Crear store para archivos
                                if (!db.objectStoreNames.contains('files')) {
                                    const store = db.createObjectStore('files', { keyPath: 'path' });
                                    store.createIndex('directory', 'directory', { unique: false });
                                }
                                
                                // Crear store para estructura
                                if (!db.objectStoreNames.contains('structure')) {
                                    db.createObjectStore('structure', { keyPath: 'path' });
                                }
                                
                                // Crear store para metadatos
                                if (!db.objectStoreNames.contains('metadata')) {
                                    db.createObjectStore('metadata', { keyPath: 'key' });
                                }
                            };
                        });
                    },
                    
                    async loadStructureFromIndexedDB() {
                        return new Promise((resolve, reject) => {
                            const transaction = this.db.transaction(['structure'], 'readonly');
                            const store = transaction.objectStore('structure');
                            const request = store.getAll();
                            
                            request.onsuccess = () => {
                                if (request.result.length > 0) {
                                    this.structure = {};
                                    request.result.forEach(item => {
                                        this.structure[item.path] = item.contents;
                                    });
                                } else {
                                    this.createDefaultStructure();
                                    this.saveStructureToIndexedDB();
                                }
                                resolve();
                            };
                            
                            request.onerror = () => {
                                this.createDefaultStructure();
                                resolve();
                            };
                        });
                    },
                    
                    async saveStructureToIndexedDB() {
                        return new Promise((resolve, reject) => {
                            const transaction = this.db.transaction(['structure'], 'readwrite');
                            const store = transaction.objectStore('structure');
                            
                            // Limpiar store
                            store.clear();
                            
                            // Guardar cada directorio
                            Object.entries(this.structure).forEach(([path, contents]) => {
                                store.put({ path, contents });
                            });
                            
                            transaction.oncomplete = resolve;
                            transaction.onerror = reject;
                        });
                    },
                    
                    async initLocalStorage() {
                        const savedStructure = localStorage.getItem('xp7_fs_structure');
                        if (savedStructure) {
                            try {
                                this.structure = JSON.parse(savedStructure);
                            } catch (e) {
                                this.createDefaultStructure();
                            }
                        } else {
                            this.createDefaultStructure();
                        }
                        
                        this.ensureDirectories();
                        this.ensureSystemFiles();
                    },
                    
                    createDefaultStructure() {
                        this.structure = {
                            '/': ['System', 'Apps', 'User'],
                            '/System': ['config.json', 'packages.json', 'updates.json'],
                            '/Apps': [],
                            '/User': ['Documents', 'Downloads', 'Desktop', 'Projects'],
                            '/User/Documents': [],
                            '/User/Downloads': [],
                            '/User/Desktop': [],
                            '/User/Projects': []
                        };
                        this.saveStructure();
                    },
                    
                    ensureDirectories() {
                        const requiredDirs = ['/System', '/Apps', '/User', '/User/Documents', 
                                            '/User/Downloads', '/User/Desktop', '/User/Projects'];
                        requiredDirs.forEach(dir => {
                            if (!this.structure[dir]) this.structure[dir] = [];
                        });
                        this.saveStructure();
                    },
                    
                    ensureSystemFiles() {
                        const systemFiles = {
                            '/System/config.json': JSON.stringify({
                                version: '5.0.0',
                                name: 'XP7 OS Ultimate',
                                created: new Date().toISOString(),
                                storageMode: this.mode
                            }, null, 2),
                            '/System/packages.json': '[]',
                            '/System/updates.json': '[]'
                        };
                        
                        Object.entries(systemFiles).forEach(([path, content]) => {
                            if (!this.fileExists(path)) {
                                this.writeFile(path, content);
                            }
                        });
                    },
                    
                    async readFile(path) {
                        if (this.mode === 'indexedDB') {
                            return new Promise((resolve, reject) => {
                                const transaction = this.db.transaction(['files'], 'readonly');
                                const store = transaction.objectStore('files');
                                const request = store.get(path);
                                
                                request.onsuccess = () => {
                                    if (request.result) {
                                        resolve(request.result.content);
                                    } else {
                                        resolve(null);
                                    }
                                };
                                
                                request.onerror = () => reject(request.error);
                            });
                        } else {
                            const key = 'xp7_fs_' + this.normalizePath(path);
                            return localStorage.getItem(key);
                        }
                    },
                    
                    async writeFile(path, content) {
                        const dir = path.substring(0, path.lastIndexOf('/')) || '/';
                        const filename = path.substring(path.lastIndexOf('/') + 1);
                        
                        if (this.mode === 'indexedDB') {
                            return new Promise((resolve, reject) => {
                                const transaction = this.db.transaction(['files', 'structure'], 'readwrite');
                                const fileStore = transaction.objectStore('files');
                                const structureStore = transaction.objectStore('structure');
                                
                                // Guardar archivo
                                fileStore.put({
                                    path: path,
                                    content: content,
                                    directory: dir,
                                    name: filename,
                                    size: content.length,
                                    modified: new Date().toISOString(),
                                    type: this.getFileType(filename)
                                });
                                
                                // Actualizar estructura
                                structureStore.get(dir).onsuccess = (event) => {
                                    const dirData = event.target.result || { path: dir, contents: [] };
                                    if (!dirData.contents.includes(filename)) {
                                        dirData.contents.push(filename);
                                        structureStore.put(dirData);
                                    }
                                };
                                
                                transaction.oncomplete = () => {
                                    // Actualizar estructura en memoria
                                    if (!this.structure[dir]) this.structure[dir] = [];
                                    if (!this.structure[dir].includes(filename)) {
                                        this.structure[dir].push(filename);
                                    }
                                    resolve(true);
                                };
                                
                                transaction.onerror = () => reject(transaction.error);
                            });
                        } else {
                            const key = 'xp7_fs_' + this.normalizePath(path);
                            localStorage.setItem(key, content);
                            
                            if (!this.structure[dir]) this.structure[dir] = [];
                            if (!this.structure[dir].includes(filename)) {
                                this.structure[dir].push(filename);
                                this.saveStructure();
                            }
                            
                            return true;
                        }
                    },
                    
                    fileExists(path) {
                        if (this.mode === 'indexedDB') {
                            // Para IndexedDB, verificamos en la estructura
                            const dir = path.substring(0, path.lastIndexOf('/')) || '/';
                            const filename = path.substring(path.lastIndexOf('/') + 1);
                            return this.structure[dir] && this.structure[dir].includes(filename);
                        } else {
                            const key = 'xp7_fs_' + this.normalizePath(path);
                            return localStorage.getItem(key) !== null;
                        }
                    },
                    
                    async listDirectory(path = '/') {
                        const entries = [];
                        
                        // Directorios
                        Object.keys(this.structure).forEach(dirPath => {
                            if (dirPath.startsWith(path + '/') && dirPath !== path) {
                                const relPath = dirPath.substring(path.length + 1);
                                if (!relPath.includes('/')) {
                                    entries.push({
                                        name: relPath,
                                        path: dirPath,
                                        kind: 'directory',
                                        type: 'directory',
                                        icon: 'üìÅ'
                                    });
                                }
                            }
                        });
                        
                        // Archivos
                        if (this.structure[path]) {
                            for (const filename of this.structure[path]) {
                                if (this.mode === 'indexedDB') {
                                    // Obtener metadatos de IndexedDB
                                    try {
                                        const fileData = await this.getFileMetadata(path + '/' + filename);
                                        entries.push({
                                            name: filename,
                                            path: path + '/' + filename,
                                            kind: 'file',
                                            type: fileData?.type || this.getFileType(filename),
                                            icon: this.getFileIcon(filename),
                                            size: fileData?.size || 0,
                                            modified: fileData?.modified || new Date().toISOString()
                                        });
                                    } catch (e) {
                                        entries.push({
                                            name: filename,
                                            path: path + '/' + filename,
                                            kind: 'file',
                                            type: this.getFileType(filename),
                                            icon: this.getFileIcon(filename),
                                            size: 0
                                        });
                                    }
                                } else {
                                    entries.push({
                                        name: filename,
                                        path: path + '/' + filename,
                                        kind: 'file',
                                        type: this.getFileType(filename),
                                        icon: this.getFileIcon(filename),
                                        size: this.getFileSize(path + '/' + filename)
                                    });
                                }
                            }
                        }
                        
                        return entries.sort((a, b) => {
                            if (a.kind === 'directory' && b.kind !== 'directory') return -1;
                            if (a.kind !== 'directory' && b.kind === 'directory') return 1;
                            return a.name.localeCompare(b.name);
                        });
                    },
                    
                    async getFileMetadata(path) {
                        if (this.mode !== 'indexedDB') return null;
                        
                        return new Promise((resolve, reject) => {
                            const transaction = this.db.transaction(['files'], 'readonly');
                            const store = transaction.objectStore('files');
                            const request = store.get(path);
                            
                            request.onsuccess = () => resolve(request.result);
                            request.onerror = () => resolve(null);
                        });
                    },
                    
                    getFileType(filename) {
                        const ext = filename.split('.').pop().toLowerCase();
                        const types = {
                            'txt': 'text', 'js': 'javascript', 'json': 'json',
                            'html': 'html', 'css': 'css', 'pak': 'package',
                            'act': 'update', 'png': 'image', 'jpg': 'image',
                            'md': 'markdown', 'pdf': 'document', 'zip': 'archive'
                        };
                        return types[ext] || 'unknown';
                    },
                    
                    getFileIcon(filename) {
                        const type = this.getFileType(filename);
                        const icons = {
                            'text': 'üìÑ', 'javascript': 'üìú', 'json': 'üìã',
                            'html': 'üåê', 'css': 'üé®', 'package': 'üì¶',
                            'update': 'üîÑ', 'image': 'üñºÔ∏è', 'directory': 'üìÅ',
                            'markdown': 'üìù', 'document': 'üìÑ', 'archive': 'üì¶',
                            'unknown': 'üìÑ'
                        };
                        return icons[type] || 'üìÑ';
                    },
                    
                    getFileSize(path) {
                        if (this.mode === 'indexedDB') {
                            return 0; // Se obtiene del metadata
                        } else {
                            const key = 'xp7_fs_' + this.normalizePath(path);
                            const content = localStorage.getItem(key);
                            return content ? content.length : 0;
                        }
                    },
                    
                    normalizePath(path) {
                        return path.replace(/\//g, '_').replace(/^_/, '');
                    },
                    
                    saveStructure() {
                        if (this.mode === 'localStorage') {
                            localStorage.setItem('xp7_fs_structure', JSON.stringify(this.structure));
                        }
                    },
                    
                    getStorageInfo() {
                        if (this.mode === 'indexedDB') {
                            return {
                                mode: 'IndexedDB',
                                used: 'Variable',
                                max: 'Variable',
                                fileCount: Object.values(this.structure).flat().length
                            };
                        } else {
                            let totalSize = 0;
                            let fileCount = 0;
                            
                            for (let i = 0; i < localStorage.length; i++) {
                                const key = localStorage.key(i);
                                if (key.startsWith('xp7_fs_')) {
                                    const value = localStorage.getItem(key);
                                    totalSize += key.length + (value ? value.length : 0);
                                    fileCount++;
                                }
                            }
                            
                            const maxSize = 5 * 1024 * 1024;
                            const usedMB = (totalSize / 1024 / 1024).toFixed(2);
                            const maxMB = (maxSize / 1024 / 1024).toFixed(2);
                            const percentage = ((totalSize / maxSize) * 100).toFixed(1);
                            
                            return {
                                mode: 'LocalStorage',
                                used: totalSize,
                                usedMB: usedMB,
                                max: maxSize,
                                maxMB: maxMB,
                                percentage: percentage,
                                fileCount: fileCount
                            };
                        }
                    },
                    
                    async switchMode(newMode) {
                        if (newMode === this.mode) return true;
                        
                        if (newMode === 'indexedDB' && this.mode === 'localStorage') {
                            // Migrar de localStorage a IndexedDB
                            await this.migrateToIndexedDB();
                        } else if (newMode === 'localStorage' && this.mode === 'indexedDB') {
                            // Migrar de IndexedDB a localStorage
                            await this.migrateToLocalStorage();
                        }
                        
                        this.mode = newMode;
                        localStorage.setItem('xp7_fs_mode', newMode);
                        return true;
                    },
                    
                    async migrateToIndexedDB() {
                        console.log('üîÑ Migrando a IndexedDB...');
                        
                        // Primero inicializar IndexedDB
                        await this.initIndexedDB();
                        
                        // Migrar archivos de localStorage
                        for (let i = 0; i < localStorage.length; i++) {
                            const key = localStorage.key(i);
                            if (key.startsWith('xp7_fs_')) {
                                const path = key.replace('xp7_fs_', '').replace(/_/g, '/');
                                const content = localStorage.getItem(key);
                                await this.writeFile(path, content);
                            }
                        }
                        
                        console.log('‚úÖ Migraci√≥n a IndexedDB completada');
                    },
                    
                    async migrateToLocalStorage() {
                        console.log('üîÑ Migrando a localStorage...');
                        // Implementar si es necesario
                        console.warn('Migraci√≥n a localStorage no implementada');
                    },
                    
                    // ============ SISTEMA DE ACTs CON PERSISTENCIA MEJORADA ============
                    async processACTFile(content, fileName = '') {
                        try {
                            console.log('üì¶ Procesando ACT...');
                            const data = JSON.parse(content);
                            
                            // Validar estructura b√°sica
                            if (!data.type || data.type !== 'update') {
                                throw new Error('ACT inv√°lido: type debe ser "update"');
                            }
                            
                            if (!data.name || !data.version) {
                                throw new Error('ACT inv√°lido: faltan campos requeridos');
                            }
                            
                            // Generar ID √∫nico
                            const actId = 'act_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                            
                            // Crear objeto ACT completo
                            const updateData = {
                                ...data,
                                id: actId,
                                installed: new Date().toISOString(),
                                status: 'installed',
                                active: true,
                                fileName: fileName,
                                checksum: this.generateChecksum(content)
                            };
                            
                            // Guardar en almacenamiento persistente
                            await this.saveACTToStorage(actId, updateData);
                            
                            // Guardar archivo en sistema de archivos
                            const saveName = `update_${data.name.replace(/[^a-z0-9]/gi, '_')}_${data.version}.act`;
                            await this.writeFile(`/System/${saveName}`, content);
                            
                            // Ejecutar acciones
                            if (data.actions && Array.isArray(data.actions)) {
                                for (const action of data.actions) {
                                    await this.executeACTAction(action, updateData);
                                }
                            }
                            
                            // Actualizar registro de ACTs
                            await this.updateACTRegistry();
                            
                            return {
                                success: true,
                                message: `ACT "${data.name}" v${data.version} instalado`,
                                data: updateData
                            };
                            
                        } catch (error) {
                            console.error('‚ùå Error procesando ACT:', error);
                            return {
                                success: false,
                                message: 'Error: ' + error.message
                            };
                        }
                    },
                    
                    async saveACTToStorage(actId, actData) {
                        // Guardar en ambos sistemas para persistencia
                        const key = `xp7_update_${actId}`;
                        
                        // LocalStorage (siempre)
                        localStorage.setItem(key, JSON.stringify(actData));
                        
                        // IndexedDB (si est√° activo)
                        if (this.mode === 'indexedDB' && this.db) {
                            try {
                                const transaction = this.db.transaction(['files'], 'readwrite');
                                const store = transaction.objectStore('files');
                                await store.put({
                                    path: `/System/ACTs/${actId}.json`,
                                    content: JSON.stringify(actData),
                                    directory: '/System/ACTs',
                                    name: `${actId}.json`,
                                    size: JSON.stringify(actData).length,
                                    modified: new Date().toISOString(),
                                    type: 'json'
                                });
                            } catch (e) {
                                console.warn('No se pudo guardar ACT en IndexedDB:', e);
                            }
                        }
                    },
                    
                    generateChecksum(str) {
                        let hash = 0;
                        for (let i = 0; i < str.length; i++) {
                            const char = str.charCodeAt(i);
                            hash = ((hash << 5) - hash) + char;
                            hash = hash & hash;
                        }
                        return hash.toString(16);
                    },
                    
                    async executeACTAction(action, actData) {
                        try {
                            console.log(`‚ñ∂Ô∏è Ejecutando: ${action.type}`);
                            
                            switch(action.type) {
                                case 'injectCSS':
                                    if (action.content) {
                                        const styleId = `act_style_${actData.id}`;
                                        let style = document.getElementById(styleId);
                                        if (!style) {
                                            style = document.createElement('style');
                                            style.id = styleId;
                                            document.head.appendChild(style);
                                        }
                                        style.textContent = action.content;
                                    }
                                    break;
                                    
                                case 'executeCode':
                                    if (action.code) {
                                        try {
                                            const func = new Function(action.code);
                                            func();
                                        } catch (e) {
                                            console.error('Error ejecutando c√≥digo:', e);
                                        }
                                    }
                                    break;
                                    
                                case 'addApp':
                                    if (action.appId && action.appData) {
                                        if (window.XP7 && window.XP7.addApp) {
                                            window.XP7.addApp(action.appId, action.appData);
                                        }
                                    }
                                    break;
                                    
                                case 'showNotification':
                                    if (action.title && action.message) {
                                        if (window.XP7 && window.XP7.showNotification) {
                                            window.XP7.showNotification(
                                                action.title,
                                                action.message,
                                                action.type || 'info'
                                            );
                                        }
                                    }
                                    break;
                            }
                            
                        } catch (error) {
                            console.error('Error ejecutando acci√≥n:', error);
                        }
                    },
                    
                    async updateACTRegistry() {
                        // Actualizar contador de ACTs activos
                        const acts = this.getInstalledUpdates();
                        const activeActs = acts.filter(act => act.active !== false);
                        
                        // Actualizar indicador
                        const indicator = document.getElementById('act-indicator');
                        if (indicator) {
                            const countEl = document.getElementById('act-count');
                            countEl.textContent = `${activeActs.length} ACTs`;
                            indicator.style.display = 'flex';
                        }
                        
                        // Guardar registro
                        localStorage.setItem('xp7_active_acts', JSON.stringify(activeActs.map(a => a.id)));
                    },
                    
                    getInstalledUpdates() {
                        const updates = [];
                        
                        // Buscar en localStorage
                        for (let i = 0; i < localStorage.length; i++) {
                            const key = localStorage.key(i);
                            if (key.startsWith('xp7_update_')) {
                                try {
                                    const update = JSON.parse(localStorage.getItem(key));
                                    updates.push(update);
                                } catch (e) {
                                    console.warn('Error parseando update:', key);
                                }
                            }
                        }
                        
                        return updates;
                    },
                    
                    async deleteUpdate(updateId) {
                        // Eliminar de localStorage
                        localStorage.removeItem(`xp7_update_${updateId}`);
                        
                        // Eliminar de IndexedDB si existe
                        if (this.mode === 'indexedDB' && this.db) {
                            try {
                                const transaction = this.db.transaction(['files'], 'readwrite');
                                const store = transaction.objectStore('files');
                                await store.delete(`/System/ACTs/${updateId}.json`);
                            } catch (e) {
                                // Ignorar error si no existe
                            }
                        }
                        
                        // Actualizar registro
                        await this.updateACTRegistry();
                        return true;
                    },
                    
                    // ============ SISTEMA DE PAKs ============
                    async processPAKFile(content, fileName = '') {
                        try {
                            console.log('üì¶ Procesando PAK...');
                            const data = JSON.parse(content);
                            
                            if (!data.type || data.type !== 'application') {
                                throw new Error('PAK inv√°lido: type debe ser "application"');
                            }
                            
                            if (!data.name || !data.content) {
                                throw new Error('PAK inv√°lido: faltan campos requeridos');
                            }
                            
                            const appId = data.id || data.name.toLowerCase().replace(/[^a-z0-9]/g, '-');
                            const appData = {
                                id: appId,
                                name: data.name,
                                icon: data.icon || 'üì±',
                                description: data.description || 'Aplicaci√≥n PAK',
                                category: data.category || 'Aplicaciones',
                                version: data.version || '1.0.0',
                                author: data.author || 'Desconocido',
                                width: data.width || 600,
                                height: data.height || 400,
                                content: data.content,
                                installed: new Date().toISOString(),
                                type: 'pak',
                                fileName: fileName,
                                checksum: this.generateChecksum(content)
                            };
                            
                            // Guardar en almacenamiento
                            localStorage.setItem(`xp7_app_${appId}`, JSON.stringify(appData));
                            
                            // Guardar archivo
                            const saveName = `${appId}.pak`;
                            await this.writeFile(`/Apps/${saveName}`, content);
                            
                            // Registrar en el sistema
                            if (window.XP7) {
                                window.XP7.addApp(appId, {
                                    name: appData.name,
                                    icon: appData.icon,
                                    description: appData.description,
                                    category: appData.category,
                                    launch: () => window.XP7.openPakApp(appData)
                                });
                            }
                            
                            return {
                                success: true,
                                message: `PAK "${data.name}" instalado`,
                                data: appData
                            };
                            
                        } catch (error) {
                            console.error('‚ùå Error procesando PAK:', error);
                            return {
                                success: false,
                                message: 'Error: ' + error.message
                            };
                        }
                    },
                    
                    getInstalledPackages() {
                        const packages = [];
                        for (let i = 0; i < localStorage.length; i++) {
                            const key = localStorage.key(i);
                            if (key.startsWith('xp7_app_')) {
                                try {
                                    const app = JSON.parse(localStorage.getItem(key));
                                    packages.push(app);
                                } catch (e) {
                                    console.warn('Error parseando app:', key);
                                }
                            }
                        }
                        return packages;
                    },
                    
                    async deletePackage(appId) {
                        localStorage.removeItem(`xp7_app_${appId}`);
                        return true;
                    }
                };
                
                // Registry de ACTs para persistencia
                this.actRegistry = {
                    acts: new Map(),
                    
                    init() {
                        this.loadAllACTs();
                        this.setupPersistence();
                        this.updateIndicator();
                    },
                    
                    loadAllACTs() {
                        this.acts.clear();
                        
                        // Cargar de localStorage
                        for (let i = 0; i < localStorage.length; i++) {
                            const key = localStorage.key(i);
                            if (key.startsWith('xp7_update_')) {
                                try {
                                    const act = JSON.parse(localStorage.getItem(key));
                                    this.acts.set(act.id || key, {
                                        ...act,
                                        loaded: true,
                                        timestamp: Date.now()
                                    });
                                } catch (e) {
                                    console.warn('Error cargando ACT:', key, e);
                                }
                            }
                        }
                        
                        console.log(`üì¶ Registry: ${this.acts.size} ACTs cargados`);
                    },
                    
                    setupPersistence() {
                        // Interceptar localStorage para detectar cambios
                        const originalSetItem = localStorage.setItem;
                        localStorage.setItem = function(key, value) {
                            originalSetItem.apply(this, arguments);
                            
                            if (key.startsWith('xp7_update_')) {
                                setTimeout(() => {
                                    if (window.XP7 && window.XP7.actRegistry) {
                                        window.XP7.actRegistry.loadAllACTs();
                                        window.XP7.actRegistry.updateIndicator();
                                    }
                                }, 100);
                            }
                        };
                    },
                    
                    updateIndicator() {
                        const indicator = document.getElementById('act-indicator');
                        const countEl = document.getElementById('act-count');
                        
                        if (indicator && countEl) {
                            const activeActs = Array.from(this.acts.values()).filter(a => a.active !== false);
                            countEl.textContent = `${activeActs.length} ACTs`;
                            indicator.style.display = activeActs.length > 0 ? 'flex' : 'none';
                        }
                    },
                    
                    getACTs() {
                        return Array.from(this.acts.values());
                    },
                    
                    hasACT(actName) {
                        return Array.from(this.acts.values()).some(act => 
                            act.name === actName || act.id === actName
                        );
                    }
                };
                
                this.loadVisualSettings();
                this.registerDefaultApps();
            }
            
            async init() {
                console.log('üöÄ XP7 OS Ultimate v' + this.version);
                
                await this.fileSystem.init();
                this.actRegistry.init();
                this.loadInstalledApps();
                this.setupEvents();
                this.startClock();
                this.updateDesktop();
                this.initThreeJS();
                this.initShaderCanvas();
                this.applyVisualSettings();
                
                setTimeout(() => {
                    document.getElementById('loading-screen').style.opacity = '0';
                    setTimeout(() => {
                        document.getElementById('loading-screen').style.display = 'none';
                        this.showNotification('XP7 OS Ultimate', 'Sistema listo con IndexedDB üöÄ', 'success');
                        this.showNotification('ACT Registry', `${this.actRegistry.acts.size} ACTs detectados`, 'info');
                    }, 500);
                }, 2000);
            }
            
            registerDefaultApps() {
                const defaultApps = {
                    'explorer': {
                        name: 'Explorador',
                        icon: 'üìÅ',
                        description: 'Explorador de archivos',
                        category: 'Sistema',
                        launch: () => this.openExplorer()
                    },
                    'notepad': {
                        name: 'Bloc de Notas',
                        icon: 'üìù',
                        description: 'Editor de texto',
                        category: 'Herramientas',
                        launch: () => this.openNotepad()
                    },
                    'calculator': {
                        name: 'Calculadora',
                        icon: 'üßÆ',
                        description: 'Calculadora b√°sica',
                        category: 'Herramientas',
                        launch: () => this.openCalculator()
                    },
                    'package-manager': {
                        name: 'Gestor de Paquetes',
                        icon: 'üì¶',
                        description: 'Gestionar PAKs',
                        category: 'Sistema',
                        launch: () => this.openPackageManager()
                    },
                    'act-manager': {
                        name: 'Gestor de ACT',
                        icon: 'üîÑ',
                        description: 'Gestionar ACTs',
                        category: 'Sistema',
                        launch: () => this.openACTManager()
                    },
                    'storage-manager': {
                        name: 'Storage Manager',
                        icon: 'üíæ',
                        description: 'Gestionar almacenamiento',
                        category: 'Sistema',
                        launch: () => this.openStorageManager()
                    },
                    'file-selector': {
                        name: 'File Selector',
                        icon: 'üìÇ',
                        description: 'Selector de sistema de archivos',
                        category: 'Herramientas',
                        launch: () => this.openFileSelector()
                    },
                    'terminal': {
                        name: 'Terminal',
                        icon: 'üíª',
                        description: 'Terminal del sistema',
                        category: 'Herramientas',
                        launch: () => this.openTerminal()
                    },
                    'visual-settings': {
                        name: 'Visual Settings',
                        icon: 'üé®',
                        description: 'Efectos visuales',
                        category: 'Personalizaci√≥n',
                        launch: () => this.openVisualSettings()
                    },
                    'wallpaper-changer': {
                        name: 'Fondos de Pantalla',
                        icon: 'üñºÔ∏è',
                        description: 'Cambiar fondo',
                        category: 'Personalizaci√≥n',
                        launch: () => this.openWallpaperChanger()
                    },
                    'settings': {
                        name: 'Configuraci√≥n',
                        icon: '‚öôÔ∏è',
                        description: 'Configuraci√≥n del sistema',
                        category: 'Sistema',
                        launch: () => this.openSettings()
                    },
                    'dev-studio': {
                        name: 'Dev Studio',
                        icon: 'üíª',
                        description: 'Herramientas de desarrollo',
                        category: 'Desarrollo',
                        launch: () => this.openDevStudio()
                    }
                };
                
                Object.entries(defaultApps).forEach(([id, app]) => {
                    this.apps.set(id, app);
                });
            }
            
            loadInstalledApps() {
                const packages = this.fileSystem.getInstalledPackages();
                packages.forEach(pkg => {
                    this.apps.set(pkg.id, {
                        name: pkg.name,
                        icon: pkg.icon,
                        description: pkg.description,
                        category: pkg.category || 'Aplicaciones',
                        launch: () => this.openPakApp(pkg)
                    });
                });
                
                console.log(`üì± Apps cargadas: ${this.apps.size}`);
            }
            
            addApp(id, appData) {
                if (typeof appData === 'string') {
                    try {
                        appData = JSON.parse(appData);
                    } catch(e) {
                        appData = { name: id, icon: 'üì±', description: 'App', category: 'Apps' };
                    }
                }
                
                if (!appData.launch) {
                    appData.launch = () => {
                        const winId = 'window_' + this.nextWindowId++;
                        this.runningApps.set(id, winId);
                        this.createWindow({
                            id: winId,
                            title: appData.name || id,
                            icon: appData.icon || 'üì±',
                            width: 400,
                            height: 300,
                            content: `<div style="padding:20px;text-align:center;"><h2>${appData.name || id}</h2><p>${appData.description || ''}</p></div>`
                        });
                    };
                }
                
                this.apps.set(id, appData);
                this.updateDesktop();
                this.showNotification('App', `"${appData.name}" instalada`, 'success');
            }
            
            openPakApp(pakData) {
                const windowId = `window_${this.nextWindowId++}`;
                this.runningApps.set(pakData.id, windowId);
                
                this.createWindow({
                    id: windowId,
                    title: pakData.name,
                    icon: pakData.icon,
                    width: pakData.width || 600,
                    height: pakData.height || 400,
                    content: pakData.content || `<div style="padding:20px;"><h2>${pakData.name}</h2><p>${pakData.description}</p></div>`
                });
            }
            
            // ============ APLICACIONES COMPLETAS ============
            
            async openExplorer() {
                const windowId = `window_${this.nextWindowId++}`;
                this.runningApps.set('explorer', windowId);
                
                const entries = await this.fileSystem.listDirectory('/');
                
                const windowEl = this.createWindow({
                    id: windowId,
                    title: 'Explorador de Archivos',
                    icon: 'üìÅ',
                    width: 800,
                    height: 500,
                    content: `
                        <div class="explorer">
                            <div class="explorer-toolbar">
                                <button class="btn-primary" id="back-btn" title="Atr√°s"><i class="fas fa-arrow-left"></i></button>
                                <button class="btn-primary" id="up-btn" title="Subir"><i class="fas fa-arrow-up"></i></button>
                                <input type="text" id="path-input" value="/" style="flex:1;margin:0 10px;padding:5px;background:rgba(255,255,255,0.1);border:none;color:white;border-radius:3px;">
                                <button class="btn-primary" id="refresh-btn" title="Actualizar"><i class="fas fa-sync-alt"></i></button>
                                <button class="btn-primary" id="new-folder-btn" title="Nueva carpeta"><i class="fas fa-folder-plus"></i></button>
                                <button class="btn-primary" id="upload-btn" title="Subir archivos"><i class="fas fa-upload"></i></button>
                            </div>
                            <div class="explorer-content">
                                <div class="explorer-sidebar">
                                    <h3 style="margin-bottom:10px;font-size:14px;">Ubicaciones</h3>
                                    <div class="pm-item active" data-path="/"><i class="fas fa-home"></i> Inicio</div>
                                    <div class="pm-item" data-path="/User/Documents"><i class="fas fa-file"></i> Documentos</div>
                                    <div class="pm-item" data-path="/User/Downloads"><i class="fas fa-download"></i> Descargas</div>
                                    <div class="pm-item" data-path="/User/Desktop"><i class="fas fa-desktop"></i> Escritorio</div>
                                    <div class="pm-item" data-path="/Apps"><i class="fas fa-box"></i> Aplicaciones</div>
                                    <div class="pm-item" data-path="/System"><i class="fas fa-cog"></i> Sistema</div>
                                </div>
                                <div class="explorer-main">
                                    <h3 id="current-path">Archivos en /</h3>
                                    <div class="file-list" id="file-list">
                                        ${entries.map(entry => `
                                            <div class="file-item" data-path="${entry.path}" data-kind="${entry.kind}">
                                                <div class="file-icon">${entry.icon}</div>
                                                <div class="file-name">${entry.name}</div>
                                                <div class="file-info">${entry.kind === 'directory' ? 'Carpeta' : entry.type}</div>
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>
                            </div>
                        </div>
                    `
                });
                
                const content = windowEl.querySelector('.window-content');
                
                content.querySelector('#upload-btn').addEventListener('click', () => {
                    document.getElementById('file-input').click();
                });
                
                content.querySelector('#refresh-btn').addEventListener('click', async () => {
                    const pathInput = content.querySelector('#path-input');
                    const currentPath = pathInput.value;
                    await this.refreshExplorer(content, currentPath);
                });
                
                content.querySelector('#new-folder-btn').addEventListener('click', async () => {
                    const pathInput = content.querySelector('#path-input');
                    const currentPath = pathInput.value;
                    const name = prompt('Nombre de la nueva carpeta:');
                    if (name) {
                        const newPath = currentPath + '/' + name;
                        this.fileSystem.structure[newPath] = [];
                        this.fileSystem.saveStructure();
                        await this.refreshExplorer(content, currentPath);
                    }
                });
                
                content.querySelectorAll('.pm-item').forEach(item => {
                    item.addEventListener('click', async () => {
                        const path = item.dataset.path;
                        await this.refreshExplorer(content, path);
                        
                        // Actualizar items activos
                        content.querySelectorAll('.pm-item').forEach(i => i.classList.remove('active'));
                        item.classList.add('active');
                    });
                });
                
                content.querySelectorAll('.file-item').forEach(item => {
                    item.addEventListener('dblclick', async () => {
                        const path = item.dataset.path;
                        const kind = item.dataset.kind;
                        
                        if (kind === 'directory') {
                            await this.refreshExplorer(content, path);
                        } else {
                            // Abrir archivo
                            const contentText = await this.fileSystem.readFile(path);
                            if (contentText) {
                                this.openNotepadWithContent(path, contentText);
                            }
                        }
                    });
                });
            }
            
            async refreshExplorer(content, path) {
                const entries = await this.fileSystem.listDirectory(path);
                
                content.querySelector('#path-input').value = path;
                content.querySelector('#current-path').textContent = `Archivos en ${path}`;
                
                const fileList = content.querySelector('#file-list');
                fileList.innerHTML = entries.map(entry => `
                    <div class="file-item" data-path="${entry.path}" data-kind="${entry.kind}">
                        <div class="file-icon">${entry.icon}</div>
                        <div class="file-name">${entry.name}</div>
                        <div class="file-info">${entry.kind === 'directory' ? 'Carpeta' : entry.type}</div>
                    </div>
                `).join('');
                
                // Re-a√±adir eventos
                fileList.querySelectorAll('.file-item').forEach(item => {
                    item.addEventListener('dblclick', async () => {
                        const path = item.dataset.path;
                        const kind = item.dataset.kind;
                        
                        if (kind === 'directory') {
                            await this.refreshExplorer(content, path);
                        } else {
                            const contentText = await this.fileSystem.readFile(path);
                            if (contentText) {
                                this.openNotepadWithContent(path, contentText);
                            }
                        }
                    });
                });
            }
            
            openNotepad() {
                this.openNotepadWithContent('', '');
            }
            
            openNotepadWithContent(filename, content) {
                const windowId = `window_${this.nextWindowId++}`;
                this.runningApps.set('notepad', windowId);
                
                const windowEl = this.createWindow({
                    id: windowId,
                    title: filename ? `Bloc de Notas - ${filename}` : 'Bloc de Notas',
                    icon: 'üìù',
                    width: 600,
                    height: 400,
                    content: `
                        <div class="explorer">
                            <div class="explorer-toolbar">
                                <button class="btn-primary" id="new-btn"><i class="fas fa-file"></i> Nuevo</button>
                                <button class="btn-primary" id="save-btn"><i class="fas fa-save"></i> Guardar</button>
                                <button class="btn-secondary" id="open-btn"><i class="fas fa-folder-open"></i> Abrir</button>
                            </div>
                            <textarea id="notepad-text" placeholder="Escribe aqu√≠..." style="width:100%;height:calc(100% - 50px);background:rgba(0,0,0,0.2);color:white;border:none;padding:10px;font-family:monospace;font-size:14px;resize:none;outline:none;">${content}</textarea>
                            <input type="hidden" id="current-file" value="${filename}">
                        </div>
                    `
                });
                
                const contentEl = windowEl.querySelector('.window-content');
                const textarea = contentEl.querySelector('#notepad-text');
                const currentFileInput = contentEl.querySelector('#current-file');
                
                contentEl.querySelector('#new-btn').addEventListener('click', () => {
                    if (confirm('¬øCrear nuevo documento?')) {
                        textarea.value = '';
                        currentFileInput.value = '';
                        windowEl.querySelector('.window-title-text').textContent = 'Bloc de Notas';
                    }
                });
                
                contentEl.querySelector('#save-btn').addEventListener('click', async () => {
                    const text = textarea.value;
                    let filename = currentFileInput.value;
                    
                    if (!filename) {
                        filename = prompt('Nombre del archivo:', 'documento.txt');
                        if (!filename) return;
                    }
                    
                    await this.fileSystem.writeFile(`/User/Documents/${filename}`, text);
                    currentFileInput.value = filename;
                    windowEl.querySelector('.window-title-text').textContent = `Bloc de Notas - ${filename}`;
                    this.showNotification('Guardado', `"${filename}" guardado`, 'success');
                });
                
                contentEl.querySelector('#open-btn').addEventListener('click', () => {
                    // Implementar selector de archivos
                    this.showNotification('Abrir', 'Use el Explorador para abrir archivos', 'info');
                });
            }
            
            openCalculator() {
                const windowId = `window_${this.nextWindowId++}`;
                this.runningApps.set('calculator', windowId);
                
                const windowEl = this.createWindow({
                    id: windowId,
                    title: 'Calculadora',
                    icon: 'üßÆ',
                    width: 320,
                    height: 450,
                    content: `
                        <div style="padding:20px;">
                            <div id="calc-display" style="background:rgba(255,255,255,0.1);padding:15px;border-radius:5px;margin-bottom:15px;text-align:right;font-size:24px;min-height:60px;font-family:monospace;overflow:auto;">0</div>
                            <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:8px;">
                                <button class="btn-danger" data-action="clear" style="grid-column:span 2;">C</button>
                                <button class="btn-secondary" data-action="backspace">‚å´</button>
                                <button class="btn-secondary" data-action="divide">√∑</button>
                                <button class="btn-secondary" data-number="7">7</button>
                                <button class="btn-secondary" data-number="8">8</button>
                                <button class="btn-secondary" data-number="9">9</button>
                                <button class="btn-secondary" data-action="multiply">√ó</button>
                                <button class="btn-secondary" data-number="4">4</button>
                                <button class="btn-secondary" data-number="5">5</button>
                                <button class="btn-secondary" data-number="6">6</button>
                                <button class="btn-secondary" data-action="subtract">‚àí</button>
                                <button class="btn-secondary" data-number="1">1</button>
                                <button class="btn-secondary" data-number="2">2</button>
                                <button class="btn-secondary" data-number="3">3</button>
                                <button class="btn-secondary" data-action="add">+</button>
                                <button class="btn-secondary" data-number="0" style="grid-column:span 2;">0</button>
                                <button class="btn-secondary" data-action="decimal">.</button>
                                <button class="btn-primary" data-action="equals">=</button>
                            </div>
                        </div>
                    `
                });
                
                const display = windowEl.querySelector('#calc-display');
                let currentInput = '0';
                let previousInput = '';
                let operation = null;
                let shouldReset = false;
                
                function updateDisplay() {
                    display.textContent = currentInput;
                    display.scrollLeft = display.scrollWidth;
                }
                
                windowEl.querySelectorAll('[data-number]').forEach(btn => {
                    btn.addEventListener('click', () => {
                        if (shouldReset || currentInput === '0') {
                            currentInput = btn.dataset.number;
                            shouldReset = false;
                        } else {
                            currentInput += btn.dataset.number;
                        }
                        updateDisplay();
                    });
                });
                
                windowEl.querySelectorAll('[data-action]').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const action = btn.dataset.action;
                        
                        switch(action) {
                            case 'clear':
                                currentInput = '0';
                                previousInput = '';
                                operation = null;
                                break;
                            case 'backspace':
                                if (currentInput.length > 1) {
                                    currentInput = currentInput.slice(0, -1);
                                } else {
                                    currentInput = '0';
                                }
                                break;
                            case 'decimal':
                                if (!currentInput.includes('.')) {
                                    currentInput += '.';
                                }
                                break;
                            case 'add':
                            case 'subtract':
                            case 'multiply':
                            case 'divide':
                                if (previousInput && operation) {
                                    // Calcular resultado anterior
                                    const prev = parseFloat(previousInput);
                                    const current = parseFloat(currentInput);
                                    let result = 0;
                                    
                                    switch(operation) {
                                        case 'add': result = prev + current; break;
                                        case 'subtract': result = prev - current; break;
                                        case 'multiply': result = prev * current; break;
                                        case 'divide': result = current !== 0 ? prev / current : 0; break;
                                    }
                                    
                                    previousInput = result.toString();
                                } else {
                                    previousInput = currentInput;
                                }
                                operation = action;
                                shouldReset = true;
                                break;
                            case 'equals':
                                if (operation && previousInput) {
                                    const prev = parseFloat(previousInput);
                                    const current = parseFloat(currentInput);
                                    let result = 0;
                                    
                                    switch(operation) {
                                        case 'add': result = prev + current; break;
                                        case 'subtract': result = prev - current; break;
                                        case 'multiply': result = prev * current; break;
                                        case 'divide': result = current !== 0 ? prev / current : 0; break;
                                    }
                                    
                                    currentInput = result.toString();
                                    operation = null;
                                    previousInput = '';
                                    shouldReset = true;
                                }
                                break;
                        }
                        
                        updateDisplay();
                    });
                });
                
                updateDisplay();
            }
            
            openPackageManager() {
                const windowId = `window_${this.nextWindowId++}`;
                this.runningApps.set('package-manager', windowId);
                
                const packages = this.fileSystem.getInstalledPackages();
                
                const windowEl = this.createWindow({
                    id: windowId,
                    title: 'Gestor de Paquetes',
                    icon: 'üì¶',
                    width: 700,
                    height: 500,
                    content: `
                        <div style="padding:20px;height:100%;overflow-y:auto;">
                            <h2><i class="fas fa-box"></i> Gestor de Paquetes</h2>
                            <p style="color:rgba(255,255,255,0.7);margin-bottom:20px;">
                                Gestiona tus aplicaciones PAK instaladas
                            </p>
                            
                            <div style="margin-bottom:20px;">
                                <button class="btn-primary" id="install-pak-btn">
                                    <i class="fas fa-download"></i> Instalar PAK
                                </button>
                                <button class="btn-secondary" id="refresh-pak-btn">
                                    <i class="fas fa-sync-alt"></i> Actualizar
                                </button>
                            </div>
                            
                            <h3 style="color:#4CAF50;margin-bottom:15px;">
                                Paquetes Instalados (${packages.length})
                            </h3>
                            
                            <div id="packages-list">
                                ${packages.length === 0 ? `
                                    <div style="text-align:center;padding:40px;color:rgba(255,255,255,0.5);">
                                        <i class="fas fa-box-open" style="font-size:48px;margin-bottom:20px;"></i>
                                        <p>No hay paquetes instalados</p>
                                        <p style="font-size:12px;margin-top:10px;">Instala archivos .pak para agregar aplicaciones</p>
                                    </div>
                                ` : packages.map(pkg => `
                                    <div class="pm-item" style="margin-bottom:10px;">
                                        <div style="font-size:32px;">${pkg.icon}</div>
                                        <div style="flex:1;">
                                            <div style="font-weight:500;">${pkg.name}</div>
                                            <div style="font-size:12px;color:rgba(255,255,255,0.6);">
                                                ${pkg.description || 'Sin descripci√≥n'}
                                                <span style="background:rgba(76,175,80,0.2);padding:2px 6px;border-radius:3px;font-size:10px;margin-left:10px;">
                                                    v${pkg.version || '1.0.0'}
                                                </span>
                                            </div>
                                        </div>
                                        <button class="btn-danger delete-pak-btn" data-id="${pkg.id}" style="padding:5px 10px;font-size:12px;">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    `
                });
                
                const content = windowEl.querySelector('.window-content');
                
                content.querySelector('#install-pak-btn').addEventListener('click', () => {
                    document.getElementById('pak-input').click();
                });
                
                content.querySelector('#refresh-pak-btn').addEventListener('click', () => {
                    windowEl.querySelector('.window-control.close').click();
                    this.openPackageManager();
                });
                
                content.querySelectorAll('.delete-pak-btn').forEach(btn => {
                    btn.addEventListener('click', async () => {
                        const appId = btn.dataset.id;
                        const pkg = packages.find(p => p.id === appId);
                        if (pkg && confirm(`¬øEliminar "${pkg.name}"?`)) {
                            await this.fileSystem.deletePackage(appId);
                            this.apps.delete(appId);
                            this.updateDesktop();
                            windowEl.querySelector('.window-control.close').click();
                            this.openPackageManager();
                            this.showNotification('Paquete', 'Paquete eliminado', 'info');
                        }
                    });
                });
            }
            
            openACTManager() {
                const windowId = `window_${this.nextWindowId++}`;
                this.runningApps.set('act-manager', windowId);
                
                const updates = this.fileSystem.getInstalledUpdates();
                
                const windowEl = this.createWindow({
                    id: windowId,
                    title: 'Gestor de ACT',
                    icon: 'üîÑ',
                    width: 750,
                    height: 550,
                    content: `
                        <div style="padding:20px;height:100%;overflow-y:auto;">
                            <h2><i class="fas fa-sync-alt"></i> Gestor de ACT</h2>
                            <div style="display:flex;align-items:center;gap:10px;margin-bottom:20px;">
                                <span style="color:rgba(255,255,255,0.7);">
                                    ${updates.length} ACTs instalados
                                </span>
                                <span id="act-registry-count" style="background:rgba(76,175,80,0.2);padding:2px 8px;border-radius:10px;font-size:12px;">
                                    Registry: ${this.actRegistry.acts.size}
                                </span>
                            </div>
                            
                            <div style="margin-bottom:20px;padding:15px;background:rgba(76,175,80,0.1);border-radius:8px;">
                                <h3 style="color:#4CAF50;margin-bottom:10px;">
                                    <i class="fas fa-download"></i> Instalar ACT
                                </h3>
                                <div style="display:flex;gap:10px;align-items:center;">
                                    <button class="btn-primary" id="install-act-btn" style="padding:10px 20px;">
                                        <i class="fas fa-file-import"></i> Seleccionar Archivo ACT
                                    </button>
                                    <button class="btn-secondary" id="scan-acts-btn" style="padding:10px 20px;">
                                        <i class="fas fa-search"></i> Buscar ACTs Perdidos
                                    </button>
                                </div>
                            </div>
                            
                            <h3 style="color:#2196F3;margin-bottom:15px;">
                                <i class="fas fa-history"></i> ACTs Instalados
                            </h3>
                            
                            ${updates.length === 0 ? `
                                <div style="text-align:center;padding:40px;color:rgba(255,255,255,0.5);">
                                    <i class="fas fa-sync" style="font-size:48px;margin-bottom:20px;"></i>
                                    <p>No hay ACTs instalados</p>
                                    <p style="font-size:12px;margin-top:10px;">Instala archivos .act para actualizar el sistema</p>
                                </div>
                            ` : `
                                <div id="act-list" style="display:flex;flex-direction:column;gap:10px;">
                                    ${updates.map(update => `
                                        <div class="pm-item" style="position:relative;">
                                            <div style="font-size:32px;">${update.icon || 'üîÑ'}</div>
                                            <div style="flex:1;">
                                                <div style="font-weight:500;">${update.name}</div>
                                                <div style="font-size:12px;color:rgba(255,255,255,0.6);">
                                                    ${update.description || 'Sin descripci√≥n'}
                                                    <span style="background:rgba(33,150,243,0.2);padding:2px 6px;border-radius:3px;font-size:10px;margin-left:10px;">
                                                        v${update.version || '1.0.0'}
                                                    </span>
                                                    ${update.active === false ? `<span style="background:rgba(244,67,54,0.2);padding:2px 6px;border-radius:3px;font-size:10px;margin-left:5px;">INACTIVO</span>` : ''}
                                                </div>
                                            </div>
                                            <div style="display:flex;gap:5px;">
                                                <button class="btn-secondary view-act-btn" data-id="${update.id}" style="padding:5px 10px;font-size:12px;">
                                                    <i class="fas fa-eye"></i>
                                                </button>
                                                <button class="btn-danger delete-act-btn" data-id="${update.id}" style="padding:5px 10px;font-size:12px;">
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                            </div>
                                            ${update.checksum ? `
                                                <div style="position:absolute;top:5px;right:5px;background:rgba(0,0,0,0.5);color:rgba(255,255,255,0.5);font-size:8px;padding:1px 3px;border-radius:2px;">
                                                    ${update.checksum.substring(0, 6)}
                                                </div>
                                            ` : ''}
                                        </div>
                                    `).join('')}
                                </div>
                            `}
                            
                            <div style="margin-top:30px;padding:15px;background:rgba(255,255,255,0.05);border-radius:8px;">
                                <h4 style="color:#FF9800;margin-bottom:10px;">Estado del Sistema</h4>
                                <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;font-size:12px;">
                                    <div>
                                        <span style="color:rgba(255,255,255,0.6);">ACTs en Registry:</span><br>
                                        <strong id="registry-count">${this.actRegistry.acts.size}</strong>
                                    </div>
                                    <div>
                                        <span style="color:rgba(255,255,255,0.6);">ACTs en Storage:</span><br>
                                        <strong id="storage-count">${updates.length}</strong>
                                    </div>
                                </div>
                                <button class="btn-primary" id="refresh-stats" style="margin-top:10px;padding:8px 15px;font-size:12px;">
                                    <i class="fas fa-sync-alt"></i> Actualizar Estad√≠sticas
                                </button>
                            </div>
                        </div>
                    `
                });
                
                const content = windowEl.querySelector('.window-content');
                
                content.querySelector('#install-act-btn').addEventListener('click', () => {
                    document.getElementById('act-input').click();
                });
                
                content.querySelector('#scan-acts-btn').addEventListener('click', () => {
                    this.scanForLostACTs();
                    content.querySelector('#scan-acts-btn').innerHTML = '<i class="fas fa-spinner fa-spin"></i> Escaneando...';
                    setTimeout(() => {
                        windowEl.querySelector('.window-control.close').click();
                        this.openACTManager();
                    }, 1500);
                });
                
                content.querySelectorAll('.view-act-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const actId = btn.dataset.id;
                        const updates = this.fileSystem.getInstalledUpdates();
                        const act = updates.find(u => u.id === actId);
                        if (act) {
                            this.showACTDetails(act);
                        }
                    });
                });
                
                content.querySelectorAll('.delete-act-btn').forEach(btn => {
                    btn.addEventListener('click', async () => {
                        const actId = btn.dataset.id;
                        const updates = this.fileSystem.getInstalledUpdates();
                        const act = updates.find(u => u.id === actId);
                        
                        if (act && confirm(`¬øEliminar ACT "${act.name}"?`)) {
                            await this.fileSystem.deleteUpdate(actId);
                            this.actRegistry.loadAllACTs();
                            windowEl.querySelector('.window-control.close').click();
                            this.openACTManager();
                            this.showNotification('ACT', 'ACT eliminado', 'info');
                        }
                    });
                });
                
                content.querySelector('#refresh-stats').addEventListener('click', () => {
                    const updates = this.fileSystem.getInstalledUpdates();
                    content.querySelector('#registry-count').textContent = this.actRegistry.acts.size;
                    content.querySelector('#storage-count').textContent = updates.length;
                    content.querySelector('#act-registry-count').textContent = `Registry: ${this.actRegistry.acts.size}`;
                });
            }
            
            scanForLostACTs() {
                console.log('üîç Escaneando ACTs perdidos...');
                let recovered = 0;
                
                // Buscar en localStorage
                for (let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i);
                    const value = localStorage.getItem(key);
                    
                    if (value && value.includes('"type":"update"') && !key.startsWith('xp7_update_')) {
                        try {
                            const data = JSON.parse(value);
                            if (data.type === 'update' && data.name) {
                                // Verificar si ya est√° registrado
                                const exists = Array.from(this.actRegistry.acts.values())
                                    .some(act => act.name === data.name);
                                
                                if (!exists) {
                                    // Registrar con prefijo correcto
                                    const newKey = 'xp7_update_recovered_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                                    localStorage.setItem(newKey, value);
                                    recovered++;
                                    console.log('‚úÖ ACT recuperado:', data.name);
                                }
                            }
                        } catch (e) {
                            // No es JSON v√°lido
                        }
                    }
                }
                
                if (recovered > 0) {
                    this.actRegistry.loadAllACTs();
                    this.showNotification('ACTs Recuperados', `${recovered} ACTs recuperados`, 'success');
                } else {
                    this.showNotification('Escaneo', 'No se encontraron ACTs perdidos', 'info');
                }
            }
            
            showACTDetails(act) {
                const windowId = `act_details_${Date.now()}`;
                
                this.createWindow({
                    id: windowId,
                    title: `ACT: ${act.name}`,
                    icon: act.icon || 'üîÑ',
                    width: 500,
                    height: 450,
                    content: `
                        <div style="padding:20px;">
                            <div style="text-align:center;margin-bottom:20px;">
                                <div style="font-size:48px;margin-bottom:10px;">${act.icon || 'üîÑ'}</div>
                                <h2>${act.name}</h2>
                                <div style="color:#4CAF50;font-weight:500;">v${act.version || '1.0.0'}</div>
                            </div>
                            
                            <div style="margin-bottom:15px;padding:15px;background:rgba(255,255,255,0.05);border-radius:8px;">
                                <strong>üìù Descripci√≥n:</strong><br>
                                ${act.description || 'Sin descripci√≥n'}
                            </div>
                            
                            <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:20px;">
                                <div style="padding:10px;background:rgba(255,255,255,0.05);border-radius:5px;">
                                    <small>Autor</small><br>
                                    <strong>${act.author || 'Desconocido'}</strong>
                                </div>
                                <div style="padding:10px;background:rgba(255,255,255,0.05);border-radius:5px;">
                                    <small>Acciones</small><br>
                                    <strong>${act.actions ? act.actions.length : '0'}</strong>
                                </div>
                                <div style="padding:10px;background:rgba(255,255,255,0.05);border-radius:5px;">
                                    <small>Instalado</small><br>
                                    <strong>${act.installed ? new Date(act.installed).toLocaleDateString() : 'N/A'}</strong>
                                </div>
                                <div style="padding:10px;background:rgba(255,255,255,0.05);border-radius:5px;">
                                    <small>Estado</small><br>
                                    <strong style="color:${act.active === false ? '#f44336' : '#4CAF50'}">
                                        ${act.active === false ? 'Inactivo' : 'Activo'}
                                    </strong>
                                </div>
                            </div>
                            
                            ${act.checksum ? `
                                <div style="padding:10px;background:rgba(0,0,0,0.3);border-radius:5px;margin-bottom:20px;">
                                    <small>Checksum:</small><br>
                                    <code style="font-size:10px;word-break:break-all;">${act.checksum}</code>
                                </div>
                            ` : ''}
                            
                            <div style="text-align:center;">
                                <button class="btn-primary" onclick="this.closest('.window-control.close')?.click()" style="padding:10px 20px;">
                                    Cerrar
                                </button>
                            </div>
                        </div>
                    `
                });
            }
            
            openStorageManager() {
                const windowId = `window_${this.nextWindowId++}`;
                this.runningApps.set('storage-manager', windowId);
                
                const storageInfo = this.fileSystem.getStorageInfo();
                const isIndexedDB = this.fileSystem.mode === 'indexedDB';
                
                this.createWindow({
                    id: windowId,
                    title: 'Storage Manager',
                    icon: 'üíæ',
                    width: 600,
                    height: 500,
                    content: `
                        <div style="padding:20px;">
                            <h2><i class="fas fa-hdd"></i> Storage Manager</h2>
                            <p style="color:rgba(255,255,255,0.7);margin-bottom:30px;">
                                Gestiona el almacenamiento del sistema
                            </p>
                            
                            <div class="storage-selector">
                                <h3 style="color:#4CAF50;margin-bottom:15px;">Modo de Almacenamiento</h3>
                                
                                <div class="storage-option ${isIndexedDB ? 'active' : ''}" data-mode="indexedDB">
                                    <div class="icon">üóÉÔ∏è</div>
                                    <div class="info">
                                        <div class="name">IndexedDB</div>
                                        <div class="desc">Base de datos en navegador (m√°s capacidad)</div>
                                    </div>
                                    <div class="status ${isIndexedDB ? 'active' : ''}">
                                        ${isIndexedDB ? 'ACTIVO' : 'INACTIVO'}
                                    </div>
                                </div>
                                
                                <div class="storage-option ${!isIndexedDB ? 'active' : ''}" data-mode="localStorage">
                                    <div class="icon">üì¶</div>
                                    <div class="info">
                                        <div class="name">LocalStorage</div>
                                        <div class="desc">Almacenamiento simple (5MB m√°ximo)</div>
                                    </div>
                                    <div class="status ${!isIndexedDB ? 'active' : ''}">
                                        ${!isIndexedDB ? 'ACTIVO' : 'INACTIVO'}
                                    </div>
                                </div>
                            </div>
                            
                            <div style="margin:30px 0;padding:20px;background:rgba(255,255,255,0.05);border-radius:10px;">
                                <h3 style="color:#4CAF50;margin-bottom:15px;">Estad√≠sticas</h3>
                                <div style="text-align:center;">
                                    <div style="font-size:24px;font-weight:bold;color:#4CAF50;">
                                        ${isIndexedDB ? 'IndexedDB' : 'LocalStorage'}
                                    </div>
                                    <div style="font-size:14px;color:rgba(255,255,255,0.6);margin-top:10px;">
                                        ${isIndexedDB ? 
                                            `${storageInfo.fileCount} archivos en el sistema` : 
                                            `${storageInfo.usedMB} MB de ${storageInfo.maxMB} MB utilizados`
                                        }
                                    </div>
                                    ${!isIndexedDB ? `
                                        <div style="width:200px;height:10px;background:rgba(255,255,255,0.1);border-radius:5px;margin:20px auto;overflow:hidden;">
                                            <div style="height:100%;background:#4CAF50;width:${storageInfo.percentage}%;"></div>
                                        </div>
                                        <div style="font-size:12px;color:rgba(255,255,255,0.6);">
                                            ${storageInfo.percentage}% utilizado
                                        </div>
                                    ` : ''}
                                </div>
                            </div>
                            
                            <div style="display:grid;grid-template-columns:1fr 1fr;gap:15px;">
                                <button class="btn-primary" id="switch-storage">
                                    <i class="fas fa-exchange-alt"></i> Cambiar Modo
                                </button>
                                <button class="btn-secondary" id="export-data">
                                    <i class="fas fa-file-export"></i> Exportar Todo
                                </button>
                                <button class="btn-secondary" id="view-idb">
                                    <i class="fas fa-database"></i> Ver IndexedDB
                                </button>
                                <button class="btn-danger" id="reset-storage">
                                    <i class="fas fa-trash"></i> Limpiar
                                </button>
                            </div>
                        </div>
                    `
                });
                
                const windowEl = document.getElementById(windowId);
                const content = windowEl.querySelector('.window-content');
                
                content.querySelector('#switch-storage').addEventListener('click', async () => {
                    const newMode = isIndexedDB ? 'localStorage' : 'indexedDB';
                    if (confirm(`¬øCambiar a modo ${newMode}?`)) {
                        try {
                            await this.fileSystem.switchMode(newMode);
                            this.showNotification('Storage', `Cambiado a ${newMode}`, 'success');
                            windowEl.querySelector('.window-control.close').click();
                            this.openStorageManager();
                        } catch (error) {
                            this.showNotification('Error', error.message, 'error');
                        }
                    }
                });
                
                content.querySelector('#export-data').addEventListener('click', () => {
                    this.exportAllData();
                });
                
                content.querySelector('#view-idb').addEventListener('click', () => {
                    this.openIndexedDBBrowser();
                });
                
                content.querySelector('#reset-storage').addEventListener('click', () => {
                    if (confirm('¬øLimpiar todo el almacenamiento?\n¬°Esta acci√≥n no se puede deshacer!')) {
                        this.resetStorage();
                    }
                });
            }
            
            async exportAllData() {
                try {
                    const data = {
                        apps: [],
                        updates: [],
                        files: {},
                        structure: this.fileSystem.structure,
                        config: {
                            version: this.version,
                            exportDate: new Date().toISOString(),
                            storageMode: this.fileSystem.mode
                        }
                    };
                    
                    // Apps
                    for (let i = 0; i < localStorage.length; i++) {
                        const key = localStorage.key(i);
                        if (key.startsWith('xp7_app_')) {
                            data.apps.push(JSON.parse(localStorage.getItem(key)));
                        }
                    }
                    
                    // Updates
                    for (let i = 0; i < localStorage.length; i++) {
                        const key = localStorage.key(i);
                        if (key.startsWith('xp7_update_')) {
                            data.updates.push(JSON.parse(localStorage.getItem(key)));
                        }
                    }
                    
                    // Archivos del sistema
                    if (this.fileSystem.mode === 'localStorage') {
                        for (let i = 0; i < localStorage.length; i++) {
                            const key = localStorage.key(i);
                            if (key.startsWith('xp7_fs_')) {
                                const path = key.replace('xp7_fs_', '').replace(/_/g, '/');
                                data.files[path] = localStorage.getItem(key);
                            }
                        }
                    }
                    
                    const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `xp7_export_${new Date().getTime()}.json`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                    
                    this.showNotification('Exportaci√≥n', 'Datos exportados correctamente', 'success');
                } catch (error) {
                    this.showNotification('Error', 'Error exportando datos', 'error');
                }
            }
            
            openIndexedDBBrowser() {
                const windowId = `window_${this.nextWindowId++}`;
                
                this.createWindow({
                    id: windowId,
                    title: 'IndexedDB Browser',
                    icon: 'üóÉÔ∏è',
                    width: 800,
                    height: 500,
                    content: `
                        <div class="idb-browser">
                            <div class="idb-toolbar">
                                <button class="btn-primary" id="idb-refresh">
                                    <i class="fas fa-sync-alt"></i> Actualizar
                                </button>
                                <button class="btn-secondary" id="idb-clear">
                                    <i class="fas fa-trash"></i> Limpiar Todo
                                </button>
                            </div>
                            <div class="idb-content">
                                <div class="idb-sidebar">
                                    <h3 style="margin-bottom:15px;color:#4CAF50;">Stores</h3>
                                    <div id="idb-stores"></div>
                                </div>
                                <div class="idb-main">
                                    <div id="idb-data">
                                        <div style="text-align:center;padding:40px;color:rgba(255,255,255,0.5);">
                                            <i class="fas fa-database" style="font-size:48px;margin-bottom:20px;"></i>
                                            <p>Selecciona un store para ver los datos</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `
                });
                
                this.refreshIDBBrowser(windowId);
            }
            
            async refreshIDBBrowser(windowId) {
                const windowEl = document.getElementById(windowId);
                const storesEl = windowEl.querySelector('#idb-stores');
                const dataEl = windowEl.querySelector('#idb-data');
                
                if (!this.fileSystem.db) {
                    storesEl.innerHTML = '<div style="color:#f44336;">IndexedDB no disponible</div>';
                    return;
                }
                
                try {
                    const stores = Array.from(this.fileSystem.db.objectStoreNames);
                    storesEl.innerHTML = stores.map(store => `
                        <div class="idb-store" data-store="${store}">
                            <i class="fas fa-table"></i> ${store}
                        </div>
                    `).join('');
                    
                    // Eventos para stores
                    storesEl.querySelectorAll('.idb-store').forEach(item => {
                        item.addEventListener('click', async () => {
                            storesEl.querySelectorAll('.idb-store').forEach(i => i.classList.remove('active'));
                            item.classList.add('active');
                            
                            const storeName = item.dataset.store;
                            await this.showStoreData(storeName, dataEl);
                        });
                    });
                    
                    // Eventos para botones
                    windowEl.querySelector('#idb-refresh').addEventListener('click', () => {
                        this.refreshIDBBrowser(windowId);
                    });
                    
                    windowEl.querySelector('#idb-clear').addEventListener('click', () => {
                        if (confirm('¬øLimpiar toda la base de datos?\n¬°Esta acci√≥n no se puede deshacer!')) {
                            this.clearIndexedDB();
                            this.refreshIDBBrowser(windowId);
                        }
                    });
                    
                } catch (error) {
                    console.error('Error accediendo a IndexedDB:', error);
                }
            }
            
            async showStoreData(storeName, dataEl) {
                try {
                    const transaction = this.fileSystem.db.transaction([storeName], 'readonly');
                    const store = transaction.objectStore(storeName);
                    const request = store.getAll();
                    
                    request.onsuccess = () => {
                        const data = request.result;
                        dataEl.innerHTML = `
                            <h3 style="color:#4CAF50;margin-bottom:15px;">
                                <i class="fas fa-table"></i> ${storeName} (${data.length} registros)
                            </h3>
                            <div style="max-height:400px;overflow-y:auto;">
                                <table style="width:100%;border-collapse:collapse;">
                                    <thead style="background:rgba(255,255,255,0.1);">
                                        <tr>
                                            <th style="padding:8px;text-align:left;font-size:12px;">Clave</th>
                                            <th style="padding:8px;text-align:left;font-size:12px;">Tama√±o</th>
                                            <th style="padding:8px;text-align:left;font-size:12px;">Acciones</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${data.map(item => `
                                            <tr style="border-bottom:1px solid rgba(255,255,255,0.1);">
                                                <td style="padding:8px;font-size:12px;">
                                                    <code style="background:rgba(0,0,0,0.3);padding:2px 4px;border-radius:2px;">${item.path || item.key || 'N/A'}</code>
                                                </td>
                                                <td style="padding:8px;font-size:12px;">
                                                    ${JSON.stringify(item).length} bytes
                                                </td>
                                                <td style="padding:8px;">
                                                    <button class="btn-secondary view-data" data-data='${JSON.stringify(item).replace(/'/g, "\\'")}' style="padding:3px 8px;font-size:10px;">
                                                        <i class="fas fa-eye"></i>
                                                    </button>
                                                </td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                        `;
                        
                        // Eventos para ver datos
                        dataEl.querySelectorAll('.view-data').forEach(btn => {
                            btn.addEventListener('click', () => {
                                const data = JSON.parse(btn.dataset.data);
                                this.showDataViewer(data);
                            });
                        });
                    };
                    
                } catch (error) {
                    dataEl.innerHTML = `<div style="color:#f44336;">Error: ${error.message}</div>`;
                }
            }
            
            showDataViewer(data) {
                const windowId = `data_viewer_${Date.now()}`;
                
                this.createWindow({
                    id: windowId,
                    title: 'Vista de Datos',
                    icon: 'üìã',
                    width: 600,
                    height: 500,
                    content: `
                        <div style="padding:20px;height:100%;display:flex;flex-direction:column;">
                            <h3 style="color:#4CAF50;margin-bottom:15px;">
                                <i class="fas fa-code"></i> Datos JSON
                            </h3>
                            <textarea id="data-view" style="flex:1;background:rgba(0,0,0,0.3);color:white;border:none;padding:15px;font-family:monospace;font-size:12px;resize:none;border-radius:5px;outline:none;">
${JSON.stringify(data, null, 2)}
                            </textarea>
                            <div style="margin-top:15px;display:flex;gap:10px;">
                                <button class="btn-primary" id="copy-data">
                                    <i class="fas fa-copy"></i> Copiar
                                </button>
                                <button class="btn-secondary" id="close-viewer">
                                    <i class="fas fa-times"></i> Cerrar
                                </button>
                            </div>
                        </div>
                    `
                });
                
                const windowEl = document.getElementById(windowId);
                const textarea = windowEl.querySelector('#data-view');
                
                windowEl.querySelector('#copy-data').addEventListener('click', () => {
                    textarea.select();
                    document.execCommand('copy');
                    this.showNotification('Copiado', 'Datos copiados al portapapeles', 'success');
                });
                
                windowEl.querySelector('#close-viewer').addEventListener('click', () => {
                    windowEl.querySelector('.window-control.close').click();
                });
            }
            
            async clearIndexedDB() {
                try {
                    const request = indexedDB.deleteDatabase('XP7FileSystem');
                    request.onsuccess = () => {
                        this.showNotification('IndexedDB', 'Base de datos eliminada', 'success');
                        location.reload();
                    };
                    request.onerror = (error) => {
                        this.showNotification('Error', 'Error eliminando IndexedDB', 'error');
                    };
                } catch (error) {
                    this.showNotification('Error', error.message, 'error');
                }
            }
            
            resetStorage() {
                // Confirmar antes de eliminar todo
                if (confirm('¬øEST√ÅS SEGURO?\n\nSe eliminar√°n todos los datos:\n- Apps instaladas\n- ACTs\n- Archivos del sistema\n\nEsta acci√≥n es IRREVERSIBLE.')) {
                    // Limpiar localStorage
                    localStorage.clear();
                    
                    // Limpiar IndexedDB si existe
                    if (this.fileSystem.db) {
                        indexedDB.deleteDatabase('XP7FileSystem');
                    }
                    
                    // Recargar la p√°gina
                    location.reload();
                }
            }
            
            openFileSelector() {
                const windowId = `window_${this.nextWindowId++}`;
                
                this.createWindow({
                    id: windowId,
                    title: 'File Selector',
                    icon: 'üìÇ',
                    width: 600,
                    height: 400,
                    content: `
                        <div style="padding:20px;">
                            <h2><i class="fas fa-folder-open"></i> File Selector</h2>
                            <p style="color:rgba(255,255,255,0.7);margin-bottom:20px;">
                                Selecciona archivos para procesar
                            </p>
                            
                            <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px;">
                                <div style="text-align:center;padding:30px;background:rgba(76,175,80,0.1);border-radius:10px;cursor:pointer;" id="select-act">
                                    <div style="font-size:48px;margin-bottom:15px;">üîÑ</div>
                                    <div style="font-weight:500;">Seleccionar ACT</div>
                                    <div style="font-size:12px;color:rgba(255,255,255,0.6);margin-top:5px;">
                                        Archivos .act, .json
                                    </div>
                                </div>
                                
                                <div style="text-align:center;padding:30px;background:rgba(33,150,243,0.1);border-radius:10px;cursor:pointer;" id="select-pak">
                                    <div style="font-size:48px;margin-bottom:15px;">üì¶</div>
                                    <div style="font-weight:500;">Seleccionar PAK</div>
                                    <div style="font-size:12px;color:rgba(255,255,255,0.6);margin-top:5px;">
                                        Archivos .pak, .json
                                    </div>
                                </div>
                            </div>
                            
                            <div style="margin-top:30px;padding:20px;background:rgba(255,255,255,0.05);border-radius:10px;">
                                <h3 style="color:#4CAF50;margin-bottom:10px;">Arrastrar y Soltar</h3>
                                <div id="drop-zone" style="border:2px dashed #4CAF50;padding:30px;text-align:center;border-radius:5px;cursor:pointer;">
                                    <i class="fas fa-upload" style="font-size:36px;margin-bottom:10px;color:#4CAF50;"></i>
                                    <div>Arrastra archivos aqu√≠</div>
                                    <div style="font-size:12px;color:rgba(255,255,255,0.6);margin-top:5px;">
                                        ACTs (.act, .json) o PAKs (.pak, .json)
                                    </div>
                                </div>
                            </div>
                        </div>
                    `
                });
                
                const windowEl = document.getElementById(windowId);
                
                windowEl.querySelector('#select-act').addEventListener('click', () => {
                    document.getElementById('act-input').click();
                });
                
                windowEl.querySelector('#select-pak').addEventListener('click', () => {
                    document.getElementById('pak-input').click();
                });
                
                const dropZone = windowEl.querySelector('#drop-zone');
                dropZone.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    dropZone.style.borderColor = '#45a049';
                    dropZone.style.background = 'rgba(76,175,80,0.2)';
                });
                
                dropZone.addEventListener('dragleave', () => {
                    dropZone.style.borderColor = '#4CAF50';
                    dropZone.style.background = 'transparent';
                });
                
                dropZone.addEventListener('drop', async (e) => {
                    e.preventDefault();
                    dropZone.style.borderColor = '#4CAF50';
                    dropZone.style.background = 'transparent';
                    
                    const files = e.dataTransfer.files;
                    await this.processDroppedFiles(files);
                    windowEl.querySelector('.window-control.close').click();
                });
            }
            
            async processDroppedFiles(files) {
                for (const file of files) {
                    const reader = new FileReader();
                    
                    reader.onload = async (e) => {
                        const content = e.target.result;
                        let result;
                        
                        if (file.name.endsWith('.act') || file.name.endsWith('.json')) {
                            result = await this.fileSystem.processACTFile(content, file.name);
                        } else if (file.name.endsWith('.pak')) {
                            result = await this.fileSystem.processPAKFile(content, file.name);
                        } else {
                            result = {
                                success: false,
                                message: `Tipo de archivo no soportado: ${file.name}`
                            };
                        }
                        
                        this.showNotification(
                            result.success ? '√âxito' : 'Error',
                            result.message,
                            result.success ? 'success' : 'error'
                        );
                    };
                    
                    reader.readAsText(file);
                }
            }
            
            openTerminal() {
                const windowId = `window_${this.nextWindowId++}`;
                this.runningApps.set('terminal', windowId);
                
                const windowEl = this.createWindow({
                    id: windowId,
                    title: 'Terminal XP7',
                    icon: 'üíª',
                    width: 700,
                    height: 400,
                    content: `
                        <div style="height:100%;display:flex;flex-direction:column;">
                            <div style="padding:15px;background:rgba(0,0,0,0.8);border-bottom:1px solid rgba(255,255,255,0.1);">
                                <div style="display:flex;align-items:center;gap:10px;">
                                    <i class="fas fa-terminal" style="color:#4CAF50;"></i>
                                    <span>Terminal XP7 v5.0.0</span>
                                </div>
                            </div>
                            <div id="terminal-output" style="flex:1;background:rgba(0,0,0,0.9);color:#4CAF50;font-family:monospace;font-size:12px;padding:15px;overflow-y:auto;">
                                <div>XP7 Terminal v5.0.0 Ultimate Edition</div>
                                <div>Type "help" for available commands</div>
                                <br>
                                <div id="terminal-lines"></div>
                                <div style="display:flex;align-items:center;">
                                    <span style="color:#4CAF50;">$</span>
                                    <input type="text" id="terminal-input" style="flex:1;background:transparent;border:none;color:#4CAF50;padding:5px 10px;font-family:monospace;font-size:12px;outline:none;" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false">
                                </div>
                            </div>
                        </div>
                    `
                });
                
                const input = windowEl.querySelector('#terminal-input');
                const output = windowEl.querySelector('#terminal-lines');
                const container = windowEl.querySelector('#terminal-output');
                
                const commands = {
                    help: () => {
                        return `
                            Available commands:<br>
                            <span style="color:#2196F3">help</span> - Show this help<br>
                            <span style="color:#2196F3">clear</span> - Clear terminal<br>
                            <span style="color:#2196F3">ls</span> - List files<br>
                            <span style="color:#2196F3">echo [text]</span> - Echo text<br>
                            <span style="color:#2196F3">date</span> - Show current date<br>
                            <span style="color:#2196F3">system</span> - System info<br>
                            <span style="color:#2196F3">apps</span> - List installed apps<br>
                            <span style="color:#2196F3">acts</span> - List ACTs<br>
                            <span style="color:#2196F3">storage</span> - Storage info<br>
                            <span style="color:#2196F3">restart</span> - Restart system<br>
                        `;
                    },
                    clear: () => {
                        output.innerHTML = '';
                        return '';
                    },
                    ls: async () => {
                        const entries = await this.fileSystem.listDirectory('/');
                        return entries.map(e => `${e.icon} ${e.name}`).join('<br>');
                    },
                    echo: (args) => {
                        return args.join(' ');
                    },
                    date: () => {
                        return new Date().toString();
                    },
                    system: () => {
                        return `
                            XP7 OS Ultimate v5.0.0<br>
                            Storage: ${this.fileSystem.mode}<br>
                            Apps: ${this.apps.size}<br>
                            ACTs: ${this.actRegistry.acts.size}<br>
                            Windows: ${this.windows.size}<br>
                        `;
                    },
                    apps: () => {
                        return Array.from(this.apps.values())
                            .map(a => `‚Ä¢ ${a.name} (${a.category})`)
                            .join('<br>');
                    },
                    acts: () => {
                        return Array.from(this.actRegistry.acts.values())
                            .map(a => `‚Ä¢ ${a.name} v${a.version || '1.0.0'}`)
                            .join('<br>');
                    },
                    storage: () => {
                        const info = this.fileSystem.getStorageInfo();
                        return `
                            Mode: ${info.mode}<br>
                            Files: ${info.fileCount}<br>
                            ${info.percentage ? `Used: ${info.usedMB}MB / ${info.maxMB}MB (${info.percentage}%)` : ''}
                        `;
                    },
                    restart: () => {
                        setTimeout(() => location.reload(), 1000);
                        return 'Restarting system...';
                    }
                };
                
                function addLine(text) {
                    output.innerHTML += `<div>${text}</div>`;
                    container.scrollTop = container.scrollHeight;
                }
                
                input.addEventListener('keypress', async (e) => {
                    if (e.key === 'Enter') {
                        const cmd = input.value.trim();
                        input.value = '';
                        
                        addLine(`<span style="color:#4CAF50">$</span> ${cmd}`);
                        
                        if (!cmd) return;
                        
                        const parts = cmd.split(' ');
                        const command = parts[0].toLowerCase();
                        const args = parts.slice(1);
                        
                        if (commands[command]) {
                            try {
                                const result = await commands[command](args);
                                if (result) addLine(result);
                            } catch (error) {
                                addLine(`<span style="color:#f44336">Error: ${error.message}</span>`);
                            }
                        } else {
                            addLine(`<span style="color:#f44336">Command not found: ${command}</span>`);
                        }
                    }
                });
                
                input.focus();
                addLine('Terminal ready. Type "help" for commands.');
            }
            
            openVisualSettings() {
                const windowId = `window_${this.nextWindowId++}`;
                
                this.createWindow({
                    id: windowId,
                    title: 'Visual Settings',
                    icon: 'üé®',
                    width: 600,
                    height: 500,
                    content: `
                        <div style="padding:20px;">
                            <h2><i class="fas fa-palette"></i> Visual Settings</h2>
                            <p style="color:rgba(255,255,255,0.7);margin-bottom:30px;">
                                Personaliza los efectos visuales del sistema
                            </p>
                            
                            <div style="margin-bottom:30px;">
                                <h3 style="color:#4CAF50;margin-bottom:15px;">Efectos Visuales</h3>
                                <div style="display:flex;flex-direction:column;gap:15px;">
                                    <div style="display:flex;justify-content:space-between;align-items:center;">
                                        <div>
                                            <div style="font-weight:500;">Efecto CRT</div>
                                            <div style="font-size:12px;color:rgba(255,255,255,0.6);">
                                                Efecto de pantalla antigua con l√≠neas de escaneo
                                            </div>
                                        </div>
                                        <label class="switch">
                                            <input type="checkbox" id="crt-toggle" ${this.visualSettings.crtEffect ? 'checked' : ''}>
                                            <span class="slider"></span>
                                        </label>
                                    </div>
                                    
                                    <div style="display:flex;justify-content:space-between;align-items:center;">
                                        <div>
                                            <div style="font-weight:500;">Efecto Shader</div>
                                            <div style="font-size:12px;color:rgba(255,255,255,0.6);">
                                                Efectos de fragment shader en tiempo real
                                            </div>
                                        </div>
                                        <label class="switch">
                                            <input type="checkbox" id="shader-toggle" ${this.visualSettings.shaderEffect ? 'checked' : ''}>
                                            <span class="slider"></span>
                                        </label>
                                    </div>
                                    
                                    <div style="display:flex;justify-content:space-between;align-items:center;">
                                        <div>
                                            <div style="font-weight:500;">3D Effect</div>
                                            <div style="font-size:12px;color:rgba(255,255,255,0.6);">
                                                Gr√°ficos 3D en tiempo real con Three.js
                                            </div>
                                        </div>
                                        <label class="switch">
                                            <input type="checkbox" id="3d-toggle" ${this.visualSettings.threeDEffect ? 'checked' : ''}>
                                            <span class="slider"></span>
                                        </label>
                                    </div>
                                </div>
                            </div>
                            
                            <div>
                                <h3 style="color:#4CAF50;margin-bottom:15px;">Intensidad de Efectos</h3>
                                <div style="margin-bottom:15px;">
                                    <label style="display:block;margin-bottom:5px;">Opacidad:</label>
                                    <input type="range" id="effect-opacity" min="0" max="100" value="40" style="width:100%;">
                                    <div style="text-align:right;font-size:12px;color:rgba(255,255,255,0.6);">
                                        <span id="opacity-value">40%</span>
                                    </div>
                                </div>
                            </div>
                            
                            <div style="margin-top:30px;display:flex;gap:10px;">
                                <button class="btn-primary" id="save-visual">
                                    <i class="fas fa-save"></i> Guardar
                                </button>
                                <button class="btn-secondary" id="reset-visual">
                                    <i class="fas fa-undo"></i> Restablecer
                                </button>
                            </div>
                        </div>
                    `
                });
                
                const windowEl = document.getElementById(windowId);
                
                // Agregar estilos para switches
                const style = document.createElement('style');
                style.textContent = `
                    .switch {
                        position: relative;
                        display: inline-block;
                        width: 50px;
                        height: 24px;
                    }
                    .switch input {
                        opacity: 0;
                        width: 0;
                        height: 0;
                    }
                    .slider {
                        position: absolute;
                        cursor: pointer;
                        top: 0;
                        left: 0;
                        right: 0;
                        bottom: 0;
                        background-color: rgba(255,255,255,0.1);
                        transition: .4s;
                        border-radius: 24px;
                    }
                    .slider:before {
                        position: absolute;
                        content: "";
                        height: 16px;
                        width: 16px;
                        left: 4px;
                        bottom: 4px;
                        background-color: white;
                        transition: .4s;
                        border-radius: 50%;
                    }
                    input:checked + .slider {
                        background-color: #4CAF50;
                    }
                    input:checked + .slider:before {
                        transform: translateX(26px);
                    }
                `;
                windowEl.querySelector('.window-content').appendChild(style);
                
                // Eventos
                const opacitySlider = windowEl.querySelector('#effect-opacity');
                const opacityValue = windowEl.querySelector('#opacity-value');
                
                opacitySlider.addEventListener('input', () => {
                    opacityValue.textContent = `${opacitySlider.value}%`;
                    this.updateEffectOpacity(opacitySlider.value);
                });
                
                windowEl.querySelector('#save-visual').addEventListener('click', () => {
                    this.visualSettings.crtEffect = windowEl.querySelector('#crt-toggle').checked;
                    this.visualSettings.shaderEffect = windowEl.querySelector('#shader-toggle').checked;
                    this.visualSettings.threeDEffect = windowEl.querySelector('#3d-toggle').checked;
                    
                    this.saveVisualSettings();
                    this.applyVisualSettings();
                    
                    this.showNotification('Configuraci√≥n', 'Configuraci√≥n visual guardada', 'success');
                });
                
                windowEl.querySelector('#reset-visual').addEventListener('click', () => {
                    if (confirm('¬øRestablecer configuraci√≥n visual?')) {
                        this.visualSettings = {
                            crtEffect: false,
                            shaderEffect: false,
                            threeDEffect: false,
                            currentWallpaper: 'gradient1'
                        };
                        this.saveVisualSettings();
                        this.applyVisualSettings();
                        windowEl.querySelector('.window-control.close').click();
                        this.openVisualSettings();
                    }
                });
            }
            
            updateEffectOpacity(value) {
                const opacity = value / 100;
                const canvas3d = document.getElementById('three-canvas');
                const canvasShader = document.getElementById('shader-canvas');
                
                if (canvas3d && canvas3d.classList.contains('active')) {
                    canvas3d.style.opacity = opacity;
                }
                if (canvasShader && canvasShader.classList.contains('active')) {
                    canvasShader.style.opacity = opacity;
                }
            }
            
            openWallpaperChanger() {
                const windowId = `window_${this.nextWindowId++}`;
                
                this.createWindow({
                    id: windowId,
                    title: 'Fondos de Pantalla',
                    icon: 'üñºÔ∏è',
                    width: 700,
                    height: 500,
                    content: `
                        <div style="padding:20px;">
                            <h2><i class="fas fa-image"></i> Fondos de Pantalla</h2>
                            <p style="color:rgba(255,255,255,0.7);margin-bottom:30px;">
                                Selecciona un fondo de pantalla para el escritorio
                            </p>
                            
                            <div style="display:grid;grid-template-columns:repeat(3, 1fr);gap:20px;">
                                ${Object.entries(this.wallpapers).map(([id, gradient], index) => `
                                    <div class="wallpaper-preview ${id === this.visualSettings.currentWallpaper ? 'selected' : ''}" 
                                         data-id="${id}"
                                         style="
                                             background: ${gradient};
                                             height: 120px;
                                             border-radius: 10px;
                                             cursor: pointer;
                                             display: flex;
                                             align-items: center;
                                             justify-content: center;
                                             border: 2px solid ${id === this.visualSettings.currentWallpaper ? '#4CAF50' : 'transparent'};
                                             transition: all 0.3s ease;
                                         ">
                                        <div style="
                                             background: rgba(0,0,0,0.5);
                                             padding: 8px 15px;
                                             border-radius: 20px;
                                             font-size: 12px;
                                             font-weight: 500;
                                             backdrop-filter: blur(10px);
                                         ">
                                            ${id}
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                            
                            <div style="margin-top:30px;padding:20px;background:rgba(255,255,255,0.05);border-radius:10px;">
                                <h3 style="color:#4CAF50;margin-bottom:15px;">Fondo Actual</h3>
                                <div id="current-wallpaper-display" 
                                     style="
                                         background: ${this.wallpapers[this.visualSettings.currentWallpaper]};
                                         height: 80px;
                                         border-radius: 10px;
                                         margin-bottom: 15px;
                                     ">
                                </div>
                                <button class="btn-primary" id="apply-wallpaper" style="width:100%;padding:10px;">
                                    <i class="fas fa-check"></i> Aplicar Fondo Seleccionado
                                </button>
                            </div>
                        </div>
                    `
                });
                
                const windowEl = document.getElementById(windowId);
                
                windowEl.querySelectorAll('.wallpaper-preview').forEach(preview => {
                    preview.addEventListener('click', () => {
                        windowEl.querySelectorAll('.wallpaper-preview').forEach(p => {
                            p.style.borderColor = 'transparent';
                            p.classList.remove('selected');
                        });
                        preview.style.borderColor = '#4CAF50';
                        preview.classList.add('selected');
                        
                        const display = windowEl.querySelector('#current-wallpaper-display');
                        display.style.background = preview.style.background;
                    });
                });
                
                windowEl.querySelector('#apply-wallpaper').addEventListener('click', () => {
                    const selected = windowEl.querySelector('.wallpaper-preview.selected');
                    if (selected) {
                        const wallpaperId = selected.dataset.id;
                        this.visualSettings.currentWallpaper = wallpaperId;
                        this.saveVisualSettings();
                        this.applyWallpaper();
                        this.showNotification('Fondo', `Fondo cambiado a "${wallpaperId}"`, 'success');
                    }
                });
            }
            
            openSettings() {
                const windowId = `window_${this.nextWindowId++}`;
                
                this.createWindow({
                    id: windowId,
                    title: 'Configuraci√≥n del Sistema',
                    icon: '‚öôÔ∏è',
                    width: 600,
                    height: 500,
                    content: `
                        <div style="padding:20px;">
                            <h2><i class="fas fa-cog"></i> Configuraci√≥n del Sistema</h2>
                            <p style="color:rgba(255,255,255,0.7);margin-bottom:30px;">
                                Configura los par√°metros principales del sistema
                            </p>
                            
                            <div style="display:flex;flex-direction:column;gap:25px;">
                                <div>
                                    <h3 style="color:#4CAF50;margin-bottom:15px;">Sistema</h3>
                                    <div style="background:rgba(255,255,255,0.05);padding:15px;border-radius:10px;">
                                        <div style="display:flex;justify-content:space-between;margin-bottom:10px;">
                                            <span>Versi√≥n del Sistema:</span>
                                            <span style="color:#4CAF50;font-weight:500;">v${this.version}</span>
                                        </div>
                                        <div style="display:flex;justify-content:space-between;margin-bottom:10px;">
                                            <span>Modo de Almacenamiento:</span>
                                            <span style="color:#4CAF50;font-weight:500;">${this.fileSystem.mode}</span>
                                        </div>
                                        <div style="display:flex;justify-content:space-between;margin-bottom:10px;">
                                            <span>Apps Instaladas:</span>
                                            <span style="color:#4CAF50;font-weight:500;">${this.apps.size}</span>
                                        </div>
                                        <div style="display:flex;justify-content:space-between;">
                                            <span>ACTs Activos:</span>
                                            <span style="color:#4CAF50;font-weight:500;">${this.actRegistry.acts.size}</span>
                                        </div>
                                    </div>
                                </div>
                                
                                <div>
                                    <h3 style="color:#4CAF50;margin-bottom:15px;">Aspecto</h3>
                                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;">
                                        <button class="btn-secondary" id="open-visual-settings">
                                            <i class="fas fa-palette"></i> Efectos Visuales
                                        </button>
                                        <button class="btn-secondary" id="open-wallpaper">
                                            <i class="fas fa-image"></i> Fondos
                                        </button>
                                    </div>
                                </div>
                                
                                <div>
                                    <h3 style="color:#4CAF50;margin-bottom:15px;">Mantenimiento</h3>
                                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;">
                                        <button class="btn-secondary" id="export-settings">
                                            <i class="fas fa-file-export"></i> Exportar Datos
                                        </button>
                                        <button class="btn-secondary" id="clear-cache">
                                            <i class="fas fa-broom"></i> Limpiar Cache
                                        </button>
                                        <button class="btn-danger" id="factory-reset" style="grid-column:span 2;">
                                            <i class="fas fa-skull-crossbones"></i> Restablecer F√°brica
                                        </button>
                                    </div>
                                </div>
                                
                                <div>
                                    <h3 style="color:#4CAF50;margin-bottom:15px;">Acerca de</h3>
                                    <div style="background:rgba(255,255,255,0.05);padding:15px;border-radius:10px;text-align:center;">
                                        <div style="font-size:24px;color:#4CAF50;margin-bottom:10px;">XP7 OS Ultimate</div>
                                        <div>v${this.version} - Sistema Operativo Web</div>
                                        <div style="font-size:12px;color:rgba(255,255,255,0.6);margin-top:10px;">
                                            Desarrollado con HTML5, CSS3 y JavaScript
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `
                });
                
                const windowEl = document.getElementById(windowId);
                
                windowEl.querySelector('#open-visual-settings').addEventListener('click', () => {
                    windowEl.querySelector('.window-control.close').click();
                    this.openVisualSettings();
                });
                
                windowEl.querySelector('#open-wallpaper').addEventListener('click', () => {
                    windowEl.querySelector('.window-control.close').click();
                    this.openWallpaperChanger();
                });
                
                windowEl.querySelector('#export-settings').addEventListener('click', () => {
                    this.exportAllData();
                });
                
                windowEl.querySelector('#clear-cache').addEventListener('click', () => {
                    if (confirm('¬øLimpiar cache del sistema?\nSe eliminar√°n datos temporales.')) {
                        // Eliminar datos temporales espec√≠ficos
                        const tempKeys = [];
                        for (let i = 0; i < localStorage.length; i++) {
                            const key = localStorage.key(i);
                            if (key.includes('_temp') || key.includes('_cache')) {
                                tempKeys.push(key);
                            }
                        }
                        
                        tempKeys.forEach(key => localStorage.removeItem(key));
                        this.showNotification('Cache', 'Cache limpiado', 'success');
                    }
                });
                
                windowEl.querySelector('#factory-reset').addEventListener('click', () => {
                    this.resetStorage();
                });
            }
            
            openDevStudio() {
                const windowId = `window_${this.nextWindowId++}`;
                
                this.createWindow({
                    id: windowId,
                    title: 'Dev Studio',
                    icon: 'üíª',
                    width: 800,
                    height: 600,
                    content: `
                        <div style="height:100%;display:flex;flex-direction:column;">
                            <div style="padding:15px;background:rgba(30,35,40,0.95);border-bottom:1px solid rgba(255,255,255,0.1);">
                                <div style="display:flex;gap:10px;">
                                    <button class="btn-primary" id="dev-new"><i class="fas fa-file"></i> Nuevo</button>
                                    <button class="btn-primary" id="dev-save"><i class="fas fa-save"></i> Guardar</button>
                                    <button class="btn-secondary" id="dev-run"><i class="fas fa-play"></i> Ejecutar</button>
                                    <button class="btn-secondary" id="dev-template"><i class="fas fa-code"></i> Plantilla</button>
                                </div>
                            </div>
                            <div style="flex:1;display:flex;">
                                <div style="width:200px;background:rgba(0,0,0,0.2);border-right:1px solid rgba(255,255,255,0.1);padding:15px;">
                                    <h4 style="color:#4CAF50;margin-bottom:10px;">Templates</h4>
                                    <div style="display:flex;flex-direction:column;gap:5px;">
                                        <button class="dev-template" data-type="act">üì¶ ACT Template</button>
                                        <button class="dev-template" data-type="pak">üì± PAK Template</button>
                                        <button class="dev-template" data-type="css">üé® CSS Template</button>
                                        <button class="dev-template" data-type="app">üì± App Template</button>
                                    </div>
                                    <h4 style="color:#4CAF50;margin-top:20px;margin-bottom:10px;">Proyectos</h4>
                                    <div id="dev-projects"></div>
                                </div>
                                <div style="flex:1;display:flex;flex-direction:column;">
                                    <div style="padding:10px;background:rgba(0,0,0,0.3);border-bottom:1px solid rgba(255,255,255,0.1);">
                                        <input type="text" id="dev-filename" placeholder="nombre_del_archivo.act" style="width:100%;background:transparent;border:none;color:white;padding:5px;outline:none;">
                                    </div>
                                    <textarea id="dev-editor" style="flex:1;background:rgba(0,0,0,0.8);color:#4CAF50;font-family:monospace;font-size:14px;padding:15px;border:none;resize:none;outline:none;" placeholder="Escribe tu c√≥digo aqu√≠..."></textarea>
                                </div>
                            </div>
                            <div id="dev-output" style="height:100px;background:rgba(0,0,0,0.9);border-top:1px solid rgba(255,255,255,0.1);padding:10px;font-family:monospace;font-size:12px;color:#4CAF50;overflow-y:auto;"></div>
                        </div>
                    `
                });
                
                const windowEl = document.getElementById(windowId);
                const editor = windowEl.querySelector('#dev-editor');
                const output = windowEl.querySelector('#dev-output');
                const filenameInput = windowEl.querySelector('#dev-filename');
                
                // Templates
                const templates = {
                    act: JSON.stringify({
                        type: "update",
                        name: "Mi ACT",
                        version: "1.0.0",
                        description: "Descripci√≥n de mi ACT",
                        author: "Yo",
                        actions: [
                            {
                                type: "showNotification",
                                title: "¬°Hola!",
                                message: "Este ACT se ha instalado correctamente",
                                type: "success"
                            },
                            {
                                type: "injectCSS",
                                content: "/* Tu CSS aqu√≠ */"
                            }
                        ]
                    }, null, 2),
                    
                    pak: JSON.stringify({
                        type: "application",
                        name: "Mi App",
                        version: "1.0.0",
                        description: "Mi primera aplicaci√≥n PAK",
                        author: "Yo",
                        icon: "üì±",
                        width: 600,
                        height: 400,
                        content: "<div style='padding:20px;text-align:center;'><h1>¬°Hola Mundo!</h1><p>Esta es mi primera app PAK</p></div>"
                    }, null, 2),
                    
                    css: `/* CSS Template */
body {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
}

.window {
    background: rgba(255, 255, 255, 0.1);
    backdrop-filter: blur(20px);
}

.btn-primary {
    background: linear-gradient(135deg, #667eea, #764ba2);
}`,
                    
                    app: JSON.stringify({
                        name: "Mi App",
                        icon: "üì±",
                        description: "Descripci√≥n de mi app",
                        category: "Aplicaciones",
                        launch: function() {
                            alert("¬°Hola desde mi app!");
                        }
                    }, null, 2)
                };
                
                // Cargar proyectos guardados
                this.loadDevProjects(windowEl);
                
                // Eventos
                windowEl.querySelector('#dev-new').addEventListener('click', () => {
                    editor.value = '';
                    filenameInput.value = 'nuevo.act';
                    output.innerHTML = '';
                });
                
                windowEl.querySelector('#dev-save').addEventListener('click', async () => {
                    const content = editor.value;
                    const filename = filenameInput.value || 'sin_nombre.act';
                    
                    await this.fileSystem.writeFile(`/User/Projects/${filename}`, content);
                    this.loadDevProjects(windowEl);
                    
                    output.innerHTML = `<span style="color:#4CAF50">‚úì</span> Guardado como ${filename}`;
                });
                
                windowEl.querySelector('#dev-run').addEventListener('click', async () => {
                    const content = editor.value;
                    const filename = filenameInput.value || 'temp.act';
                    
                    try {
                        output.innerHTML = '<span style="color:#FF9800">‚ñ∂Ô∏è Ejecutando...</span>';
                        
                        if (filename.endsWith('.act')) {
                            const result = await this.fileSystem.processACTFile(content, filename);
                            output.innerHTML = `<span style="color:${result.success ? '#4CAF50' : '#f44336'}">${result.success ? '‚úì' : '‚úó'}</span> ${result.message}`;
                        } else if (filename.endsWith('.pak')) {
                            const result = await this.fileSystem.processPAKFile(content, filename);
                            output.innerHTML = `<span style="color:${result.success ? '#4CAF50' : '#f44336'}">${result.success ? '‚úì' : '‚úó'}</span> ${result.message}`;
                        } else {
                            output.innerHTML = '<span style="color:#f44336">‚úó Tipo de archivo no soportado</span>';
                        }
                    } catch (error) {
                        output.innerHTML = `<span style="color:#f44336">‚úó Error: ${error.message}</span>`;
                    }
                });
                
                windowEl.querySelector('#dev-template').addEventListener('click', () => {
                    editor.value = templates.act;
                    filenameInput.value = 'template.act';
                });
                
                windowEl.querySelectorAll('.dev-template').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const type = btn.dataset.type;
                        editor.value = templates[type] || '';
                        filenameInput.value = `template.${type}`;
                    });
                });
                
                // Mejoras del editor
                editor.addEventListener('keydown', (e) => {
                    if (e.key === 'Tab') {
                        e.preventDefault();
                        const start = editor.selectionStart;
                        const end = editor.selectionEnd;
                        editor.value = editor.value.substring(0, start) + '    ' + editor.value.substring(end);
                        editor.selectionStart = editor.selectionEnd = start + 4;
                    }
                });
            }
            
            async loadDevProjects(windowEl) {
                const projectsEl = windowEl.querySelector('#dev-projects');
                
                try {
                    const entries = await this.fileSystem.listDirectory('/User/Projects');
                    projectsEl.innerHTML = entries.map(entry => `
                        <div class="file-item" style="padding:5px;margin:2px 0;cursor:pointer;" data-path="${entry.path}">
                            <div style="display:flex;align-items:center;gap:5px;">
                                <span>${entry.icon}</span>
                                <span style="font-size:12px;">${entry.name}</span>
                            </div>
                        </div>
                    `).join('');
                    
                    // Eventos para proyectos
                    projectsEl.querySelectorAll('.file-item').forEach(item => {
                        item.addEventListener('click', async () => {
                            const path = item.dataset.path;
                            const content = await this.fileSystem.readFile(path);
                            if (content) {
                                const editor = windowEl.querySelector('#dev-editor');
                                const filenameInput = windowEl.querySelector('#dev-filename');
                                editor.value = content;
                                filenameInput.value = path.split('/').pop();
                            }
                        });
                    });
                } catch (error) {
                    projectsEl.innerHTML = '<div style="color:rgba(255,255,255,0.5);font-size:12px;">Sin proyectos</div>';
                }
            }
            
            // ============ SISTEMA DE VENTANAS ============
            
            createWindow(options) {
                const windowId = options.id;
                
                const windowEl = document.createElement('div');
                windowEl.className = 'window';
                windowEl.id = windowId;
                windowEl.style.width = options.width + 'px';
                windowEl.style.height = options.height + 'px';
                windowEl.style.left = options.left || '100px';
                windowEl.style.top = options.top || '100px';
                windowEl.style.zIndex = ++this.currentZIndex;
                
                windowEl.innerHTML = `
                    <div class="window-header">
                        <div class="window-title">
                            <span class="window-title-icon">${options.icon || 'üì±'}</span>
                            <span class="window-title-text">${options.title}</span>
                        </div>
                        <div class="window-controls">
                            <button class="window-control minimize">
                                <i class="fas fa-window-minimize"></i>
                            </button>
                            <button class="window-control maximize">
                                <i class="fas fa-window-maximize"></i>
                            </button>
                            <button class="window-control close">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>
                    <div class="window-content">${options.content}</div>
                `;
                
                document.getElementById('windows-container').appendChild(windowEl);
                this.windows.set(windowId, windowEl);
                this.bringToFront(windowId);
                this.setupWindowEvents(windowEl);
                
                return windowEl;
            }
            
            setupWindowEvents(windowEl) {
                const header = windowEl.querySelector('.window-header');
                const minimizeBtn = windowEl.querySelector('.minimize');
                const maximizeBtn = windowEl.querySelector('.maximize');
                const closeBtn = windowEl.querySelector('.close');
                
                let isDragging = false;
                let dragOffset = { x: 0, y: 0 };
                let originalSize = null;
                let originalPosition = null;
                
                header.addEventListener('mousedown', (e) => {
                    if (e.target.closest('.window-control')) return;
                    
                    isDragging = true;
                    dragOffset.x = e.clientX - windowEl.offsetLeft;
                    dragOffset.y = e.clientY - windowEl.offsetTop;
                    this.bringToFront(windowEl.id);
                });
                
                document.addEventListener('mousemove', (e) => {
                    if (!isDragging) return;
                    
                    windowEl.style.left = (e.clientX - dragOffset.x) + 'px';
                    windowEl.style.top = (e.clientY - dragOffset.y) + 'px';
                });
                
                document.addEventListener('mouseup', () => {
                    isDragging = false;
                });
                
                minimizeBtn.addEventListener('click', () => {
                    const content = windowEl.querySelector('.window-content');
                    const header = windowEl.querySelector('.window-header');
                    
                    if (content.style.display === 'none') {
                        content.style.display = 'block';
                        header.style.borderBottom = '1px solid rgba(255, 255, 255, 0.1)';
                    } else {
                        content.style.display = 'none';
                        header.style.borderBottom = 'none';
                    }
                });
                
                maximizeBtn.addEventListener('click', () => {
                    if (windowEl.classList.contains('maximized')) {
                        windowEl.classList.remove('maximized');
                        windowEl.style.width = originalSize.width + 'px';
                        windowEl.style.height = originalSize.height + 'px';
                        windowEl.style.left = originalPosition.left + 'px';
                        windowEl.style.top = originalPosition.top + 'px';
                    } else {
                        originalSize = {
                            width: windowEl.offsetWidth,
                            height: windowEl.offsetHeight
                        };
                        originalPosition = {
                            left: windowEl.offsetLeft,
                            top: windowEl.offsetTop
                        };
                        
                        windowEl.classList.add('maximized');
                        windowEl.style.width = 'calc(100% - 40px)';
                        windowEl.style.height = 'calc(100% - 80px)';
                        windowEl.style.left = '20px';
                        windowEl.style.top = '20px';
                    }
                    this.bringToFront(windowEl.id);
                });
                
                closeBtn.addEventListener('click', () => {
                    this.closeWindow(windowEl.id);
                });
                
                windowEl.addEventListener('mousedown', () => {
                    this.bringToFront(windowEl.id);
                });
            }
            
            bringToFront(windowId) {
                const windowEl = this.windows.get(windowId);
                if (windowEl) {
                    windowEl.style.zIndex = ++this.currentZIndex;
                    this.activeWindow = windowId;
                    this.updateRunningApps();
                }
            }
            
            closeWindow(windowId) {
                const windowEl = this.windows.get(windowId);
                if (windowEl) {
                    windowEl.remove();
                    this.windows.delete(windowId);
                    
                    // Encontrar y eliminar de runningApps
                    for (const [appId, winId] of this.runningApps.entries()) {
                        if (winId === windowId) {
                            this.runningApps.delete(appId);
                            break;
                        }
                    }
                    
                    this.updateRunningApps();
                }
            }
            
            updateRunningApps() {
                const container = document.getElementById('running-apps');
                container.innerHTML = '';
                
                for (const [appId, windowId] of this.runningApps.entries()) {
                    const app = this.apps.get(appId);
                    if (app) {
                        const appEl = document.createElement('div');
                        appEl.className = 'running-app';
                        if (this.activeWindow === windowId) {
                            appEl.classList.add('active');
                        }
                        appEl.textContent = app.name;
                        appEl.addEventListener('click', () => {
                            const windowEl = this.windows.get(windowId);
                            if (windowEl) {
                                this.bringToFront(windowId);
                                // Asegurarse de que la ventana sea visible
                                if (windowEl.style.display === 'none') {
                                    windowEl.style.display = 'block';
                                }
                            }
                        });
                        container.appendChild(appEl);
                    }
                }
            }
            
            // ============ SISTEMA DE NOTIFICACIONES ============
            
            showNotification(title, message, type = 'info') {
                const notifications = document.getElementById('notifications');
                const notificationId = 'notification_' + Date.now();
                
                const notification = document.createElement('div');
                notification.className = `notification ${type}`;
                notification.id = notificationId;
                notification.innerHTML = `
                    <div class="notification-header">
                        <div class="notification-title">${title}</div>
                        <button class="notification-close">&times;</button>
                    </div>
                    <div class="notification-message">${message}</div>
                `;
                
                notifications.appendChild(notification);
                
                notification.querySelector('.notification-close').addEventListener('click', () => {
                    this.removeNotification(notificationId);
                });
                
                setTimeout(() => {
                    this.removeNotification(notificationId);
                }, 5000);
            }
            
            removeNotification(id) {
                const notification = document.getElementById(id);
                if (notification) {
                    notification.style.animation = 'slideIn 0.3s ease reverse';
                    setTimeout(() => {
                        if (notification.parentNode) {
                            notification.parentNode.removeChild(notification);
                        }
                    }, 300);
                }
            }
            
            // ============ SISTEMA DE ESCRITORIO ============
            
            updateDesktop() {
                const desktop = document.getElementById('desktop');
                desktop.innerHTML = '';
                
                // Agrupar apps por categor√≠as
                const appsByCategory = {};
                Array.from(this.apps.entries()).forEach(([id, app]) => {
                    const category = app.category || 'Otros';
                    if (!appsByCategory[category]) {
                        appsByCategory[category] = [];
                    }
                    appsByCategory[category].push({ id, ...app });
                });
                
                // Ordenar categor√≠as
                const categories = ['Sistema', 'Aplicaciones', 'Herramientas', 'Personalizaci√≥n', 'Desarrollo', 'Otros'];
                
                // A√±adir iconos al escritorio
                categories.forEach(category => {
                    if (appsByCategory[category]) {
                        appsByCategory[category].forEach(app => {
                            const iconEl = document.createElement('div');
                            iconEl.className = 'desktop-icon';
                            iconEl.dataset.app = app.id;
                            iconEl.dataset.tooltip = app.description || app.name;
                            
                            let badge = '';
                            if (app.id === 'package-manager' && this.fileSystem.getInstalledPackages().length > 0) {
                                badge = `<span class="icon-badge pak">${this.fileSystem.getInstalledPackages().length}</span>`;
                            } else if (app.id === 'act-manager' && this.actRegistry.acts.size > 0) {
                                badge = `<span class="icon-badge act">${this.actRegistry.acts.size}</span>`;
                            }
                            
                            iconEl.innerHTML = `
                                ${badge}
                                <div class="icon">${app.icon}</div>
                                <div class="name">${app.name}</div>
                            `;
                            
                            iconEl.addEventListener('click', () => {
                                app.launch();
                            });
                            
                            desktop.appendChild(iconEl);
                        });
                    }
                });
            }
            
            // ============ RELOJ Y FECHA ============
            
            startClock() {
                this.updateClock();
                setInterval(() => this.updateClock(), 1000);
            }
            
            updateClock() {
                const now = new Date();
                const time = now.toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' });
                const date = now.toLocaleDateString('es-ES');
                
                document.getElementById('time').textContent = time;
                document.getElementById('date').textContent = date;
            }
            
            // ============ CONFIGURACI√ìN VISUAL ============
            
            loadVisualSettings() {
                const saved = localStorage.getItem('xp7_visual_settings');
                if (saved) {
                    try {
                        this.visualSettings = JSON.parse(saved);
                    } catch (e) {
                        console.warn('Error cargando configuraci√≥n visual:', e);
                    }
                }
            }
            
            saveVisualSettings() {
                localStorage.setItem('xp7_visual_settings', JSON.stringify(this.visualSettings));
            }
            
            applyVisualSettings() {
                // CRT Effect
                const crtOverlay = document.getElementById('crt-overlay');
                if (this.visualSettings.crtEffect) {
                    crtOverlay.classList.add('active');
                } else {
                    crtOverlay.classList.remove('active');
                }
                
                // Shader Effect
                const shaderCanvas = document.getElementById('shader-canvas');
                if (this.visualSettings.shaderEffect) {
                    shaderCanvas.classList.add('active');
                } else {
                    shaderCanvas.classList.remove('active');
                }
                
                // 3D Effect
                const threeCanvas = document.getElementById('three-canvas');
                if (this.visualSettings.threeDEffect) {
                    threeCanvas.classList.add('active');
                } else {
                    threeCanvas.classList.remove('active');
                }
                
                // Wallpaper
                this.applyWallpaper();
            }
            
            applyWallpaper() {
                const wallpaper = document.getElementById('wallpaper');
                const gradient = this.wallpapers[this.visualSettings.currentWallpaper];
                if (gradient) {
                    wallpaper.style.background = gradient;
                }
            }
            
            // ============ THREE.JS Y SHADERS ============
            
            initThreeJS() {
                if (!this.visualSettings.threeDEffect) return;
                
                const canvas = document.getElementById('three-canvas');
                const renderer = new THREE.WebGLRenderer({ 
                    canvas, 
                    alpha: true,
                    antialias: true 
                });
                renderer.setSize(window.innerWidth, window.innerHeight);
                
                const scene = new THREE.Scene();
                const camera = new THREE.PerspectiveCamera(
                    75, 
                    window.innerWidth / window.innerHeight, 
                    0.1, 
                    1000
                );
                camera.position.z = 5;
                
                const geometry = new THREE.TorusKnotGeometry(1, 0.3, 100, 16);
                const material = new THREE.MeshBasicMaterial({
                    color: 0x4CAF50,
                    wireframe: true,
                    transparent: true,
                    opacity: 0.3
                });
                
                const torus = new THREE.Mesh(geometry, material);
                scene.add(torus);
                
                function animate() {
                    requestAnimationFrame(animate);
                    torus.rotation.x += 0.01;
                    torus.rotation.y += 0.005;
                    renderer.render(scene, camera);
                }
                
                animate();
                
                window.addEventListener('resize', () => {
                    camera.aspect = window.innerWidth / window.innerHeight;
                    camera.updateProjectionMatrix();
                    renderer.setSize(window.innerWidth, window.innerHeight);
                });
            }
            
            initShaderCanvas() {
                if (!this.visualSettings.shaderEffect) return;
                
                const canvas = document.getElementById('shader-canvas');
                const ctx = canvas.getContext('2d');
                canvas.width = window.innerWidth;
                canvas.height = window.innerHeight;
                
                let time = 0;
                
                function draw() {
                    if (!ctx || !canvas.classList.contains('active')) return;
                    
                    time += 0.01;
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                    
                    // Efecto de part√≠culas
                    for (let i = 0; i < 50; i++) {
                        const x = (Math.sin(time * 0.5 + i) * 0.5 + 0.5) * canvas.width;
                        const y = (Math.cos(time * 0.3 + i) * 0.5 + 0.5) * canvas.height;
                        const size = Math.sin(time + i) * 5 + 10;
                        
                        ctx.beginPath();
                        ctx.arc(x, y, size, 0, Math.PI * 2);
                        ctx.fillStyle = `rgba(76, 175, 80, ${Math.sin(time + i) * 0.1 + 0.1})`;
                        ctx.fill();
                    }
                    
                    requestAnimationFrame(draw);
                }
                
                draw();
                
                window.addEventListener('resize', () => {
                    canvas.width = window.innerWidth;
                    canvas.height = window.innerHeight;
                });
            }
            
            // ============ EVENTOS DEL SISTEMA ============
            
            setupEvents() {
                // Bot√≥n de inicio
                document.getElementById('start-btn').addEventListener('click', () => {
                    const menu = document.getElementById('start-menu');
                    menu.classList.toggle('active');
                });
                
                // Cerrar men√∫ al hacer clic fuera
                document.addEventListener('click', (e) => {
                    const menu = document.getElementById('start-menu');
                    const startBtn = document.getElementById('start-btn');
                    
                    if (menu.classList.contains('active') && 
                        !menu.contains(e.target) && 
                        !startBtn.contains(e.target)) {
                        menu.classList.remove('active');
                    }
                });
                
                // Items del men√∫ de inicio
                document.querySelectorAll('.start-item[data-app]').forEach(item => {
                    item.addEventListener('click', () => {
                        const appId = item.dataset.app;
                        const app = this.apps.get(appId);
                        if (app) {
                            app.launch();
                            document.getElementById('start-menu').classList.remove('active');
                        }
                    });
                });
                
                // Reiniciar sistema
                document.querySelector('.start-item[data-action="restart"]').addEventListener('click', () => {
                    if (confirm('¬øReiniciar el sistema?')) {
                        location.reload();
                    }
                });
                
                // Drag & Drop para archivos
                const dragOverlay = document.getElementById('drag-overlay');
                
                document.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    dragOverlay.classList.add('active');
                });
                
                document.addEventListener('dragleave', (e) => {
                    if (e.clientX <= 0 || e.clientY <= 0 || 
                        e.clientX >= window.innerWidth || e.clientY >= window.innerHeight) {
                        dragOverlay.classList.remove('active');
                    }
                });
                
                document.addEventListener('drop', async (e) => {
                    e.preventDefault();
                    dragOverlay.classList.remove('active');
                    
                    const files = e.dataTransfer.files;
                    if (files.length > 0) {
                        await this.processDroppedFiles(files);
                    }
                });
                
                // Inputs de archivos
                document.getElementById('file-input').addEventListener('change', (e) => {
                    // Implementar subida de archivos
                    console.log('Archivos seleccionados:', e.target.files);
                });
                
                document.getElementById('act-input').addEventListener('change', async (e) => {
                    const file = e.target.files[0];
                    if (file) {
                        const reader = new FileReader();
                        reader.onload = async (e) => {
                            const result = await this.fileSystem.processACTFile(e.target.result, file.name);
                            this.showNotification(
                                result.success ? 'ACT Instalado' : 'Error',
                                result.message,
                                result.success ? 'success' : 'error'
                            );
                        };
                        reader.readAsText(file);
                    }
                    e.target.value = '';
                });
                
                document.getElementById('pak-input').addEventListener('change', async (e) => {
                    const file = e.target.files[0];
                    if (file) {
                        const reader = new FileReader();
                        reader.onload = async (e) => {
                            const result = await this.fileSystem.processPAKFile(e.target.result, file.name);
                            this.showNotification(
                                result.success ? 'PAK Instalado' : 'Error',
                                result.message,
                                result.success ? 'success' : 'error'
                            );
                        };
                        reader.readAsText(file);
                    }
                    e.target.value = '';
                });
                
                // Buscar en men√∫ inicio
                document.getElementById('start-search').addEventListener('input', (e) => {
                    const search = e.target.value.toLowerCase();
                    const items = document.querySelectorAll('.start-item');
                    
                    items.forEach(item => {
                        const text = item.textContent.toLowerCase();
                        if (text.includes(search)) {
                            item.style.display = 'flex';
                        } else {
                            item.style.display = 'none';
                        }
                    });
                });
            }
            
            // ============ UTILIDADES ============
            
            // Exponer m√©todos p√∫blicos al global scope
            exposeToGlobal() {
                window.XP7 = {
                    showNotification: (title, message, type) => this.showNotification(title, message, type),
                    addApp: (id, appData) => this.addApp(id, appData),
                    openPakApp: (pakData) => this.openPakApp(pakData),
                    actRegistry: this.actRegistry
                };
            }
        }
        
        // ============ INICIALIZACI√ìN ============
        
        document.addEventListener('DOMContentLoaded', async () => {
            const xp7 = new XP7Complete();
            xp7.exposeToGlobal();
            await xp7.init();
        });
        (function(){
  // Espera a que el DOM est√© listo
  function onReady(fn) {
    if (document.readyState !== 'loading') fn();
    else document.addEventListener('DOMContentLoaded', fn);
  }

  // Inicializa un contenedor de app
  function initAppContainer(container) {
    if (!container) return;
    container.style.position = 'relative';
    container.style.overflow = 'hidden';
    container.style.width = container.getAttribute('data-width') || '600px';
    container.style.height = container.getAttribute('data-height') || '400px';
    container.style.display = 'flex';
    container.style.flexDirection = 'column';
    container.style.alignItems = 'center';
    container.style.justifyContent = 'flex-start';
  }

  // Detecta todas las apps en la p√°gina
  function initApps() {
    const apps = document.querySelectorAll('.pak-app');
    apps.forEach(app => {
      initAppContainer(app);
      // Si el app tiene script inline, lo eval√∫a
      const scripts = app.querySelectorAll('script');
      scripts.forEach(s => {
        try {
          new Function(s.innerHTML)();
        } catch(e) {
          console.error('Error ejecutando script de la app:', e);
        }
      });
    });
  }

  // Observa si se agregan apps din√°micamente
  function observeDynamicApps() {
    const observer = new MutationObserver(muts => {
      muts.forEach(m => {
        m.addedNodes.forEach(n => {
          if (n.classList && n.classList.contains('pak-app')) {
            initAppContainer(n);
            const scripts = n.querySelectorAll('script');
            scripts.forEach(s => { try { new Function(s.innerHTML)(); } catch(e){ console.error(e); } });
          }
        });
      });
    });
    observer.observe(document.body, { childList: true, subtree: true });
  }

  // Ejecutar todo
  onReady(() => {
    initApps();
    observeDynamicApps();
    console.log('‚úÖ Universal App Render Helper activo');
  });

})();
    </script>
</body>
</html>
