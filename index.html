<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy" content="script-src 'self' 'unsafe-inline' 'unsafe-eval' https://cdnjs.cloudflare.com/ajax/libs/; style-src 'self' 'unsafe-inline' https://cdnjs.cloudflare.com/ajax/libs/;">
    <title>XP7 OS - Sistema Operativo Web</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background: linear-gradient(135deg, #0f2027, #203a43, #2c5364);
            color: #fff;
            overflow: hidden;
            height: 100vh;
            width: 100vw;
            position: relative;
        }

        #pixi-background {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1;
        }

        #taskbar {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 40px;
            background: rgba(20, 25, 30, 0.9);
            backdrop-filter: blur(10px);
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 10px;
            z-index: 1000;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .taskbar-left {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .taskbar-right {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .start-button {
            background: linear-gradient(135deg, #4CAF50, #45a049);
            border: none;
            color: white;
            padding: 6px 15px;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .start-button:hover {
            background: linear-gradient(135deg, #45a049, #3d8b40);
            transform: translateY(-1px);
        }

        .running-apps {
            display: flex;
            gap: 5px;
        }

        .running-app {
            background: rgba(255, 255, 255, 0.1);
            padding: 4px 10px;
            border-radius: 3px;
            font-size: 12px;
            cursor: pointer;
            transition: background 0.2s ease;
        }

        .running-app:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        #system-tray {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 12px;
        }

        .clock, .date {
            padding: 2px 5px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 3px;
        }

        .start-menu {
            position: fixed;
            bottom: 40px;
            left: 10px;
            width: 500px;
            height: 500px;
            background: rgba(25, 30, 35, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            z-index: 999;
            display: none;
            overflow: hidden;
        }

        .start-menu.active {
            display: block;
        }

        .start-header {
            padding: 20px;
            background: linear-gradient(135deg, rgba(76, 175, 80, 0.2), rgba(69, 160, 73, 0.1));
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .user-icon {
            font-size: 40px;
            background: rgba(255, 255, 255, 0.1);
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .user-name {
            font-size: 18px;
            font-weight: 500;
        }

        .start-content {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            padding: 20px;
            height: calc(100% - 180px);
        }

        .start-column h3 {
            margin-bottom: 10px;
            color: #4CAF50;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .start-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 12px;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.2s ease;
            margin-bottom: 5px;
        }

        .start-item:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: translateX(5px);
        }

        .start-icon {
            font-size: 20px;
        }

        .start-text {
            font-size: 14px;
        }

        .start-footer {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            padding: 15px 20px;
            background: rgba(20, 25, 30, 0.9);
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .search-box {
            display: flex;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 5px;
            overflow: hidden;
        }

        .search-box input {
            flex: 1;
            background: transparent;
            border: none;
            padding: 8px 15px;
            color: white;
            font-size: 14px;
        }

        .search-box input::placeholder {
            color: rgba(255, 255, 255, 0.5);
        }

        .search-box button {
            background: rgba(76, 175, 80, 0.2);
            border: none;
            color: white;
            padding: 8px 15px;
            cursor: pointer;
            transition: background 0.2s ease;
        }

        .search-box button:hover {
            background: rgba(76, 175, 80, 0.3);
        }

        .desktop {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: calc(100% - 40px);
            z-index: 2;
            padding: 20px;
            display: flex;
            flex-wrap: wrap;
            align-content: flex-start;
            gap: 20px;
        }

        .desktop-icon {
            width: 80px;
            height: 80px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            border-radius: 5px;
            transition: all 0.2s ease;
            padding: 10px;
        }

        .desktop-icon:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: scale(1.05);
        }

        .desktop-icon .icon {
            font-size: 32px;
            margin-bottom: 5px;
        }

        .desktop-icon .name {
            font-size: 12px;
            text-align: center;
            word-break: break-word;
        }

        #windows-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 100;
        }

        .window {
            position: absolute;
            min-width: 300px;
            min-height: 200px;
            background: rgba(30, 35, 40, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            overflow: hidden;
            pointer-events: all;
            z-index: 101;
        }

        .window-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 15px;
            background: rgba(20, 25, 30, 0.9);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            cursor: move;
            user-select: none;
        }

        .window-title {
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 500;
        }

        .window-controls {
            display: flex;
            gap: 5px;
        }

        .window-control {
            width: 30px;
            height: 30px;
            border: none;
            border-radius: 3px;
            background: transparent;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.2s ease;
        }

        .window-control:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .window-control.minimize:hover {
            background: rgba(255, 193, 7, 0.2);
        }

        .window-control.maximize:hover {
            background: rgba(33, 150, 243, 0.2);
        }

        .window-control.close:hover {
            background: rgba(244, 67, 54, 0.2);
        }

        .window-content {
            padding: 15px;
            height: calc(100% - 50px);
            overflow: auto;
        }

        .btn-primary, .btn-secondary, .btn-danger {
            padding: 8px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 14px;
            transition: all 0.2s ease;
        }

        .btn-primary {
            background: linear-gradient(135deg, #4CAF50, #45a049);
            color: white;
        }

        .btn-primary:hover {
            background: linear-gradient(135deg, #45a049, #3d8b40);
            transform: translateY(-1px);
        }

        .btn-secondary {
            background: rgba(33, 150, 243, 0.2);
            color: white;
            border: 1px solid rgba(33, 150, 243, 0.5);
        }

        .btn-secondary:hover {
            background: rgba(33, 150, 243, 0.3);
        }

        .btn-danger {
            background: rgba(244, 67, 54, 0.2);
            color: white;
            border: 1px solid rgba(244, 67, 54, 0.5);
        }

        .btn-danger:hover {
            background: rgba(244, 67, 54, 0.3);
        }

        #notifications {
            position: fixed;
            top: 20px;
            right: 20px;
            width: 300px;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .notification {
            background: rgba(25, 30, 35, 0.95);
            backdrop-filter: blur(10px);
            border-left: 4px solid #4CAF50;
            padding: 15px;
            border-radius: 5px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            animation: slideIn 0.3s ease;
            transform-origin: top right;
        }

        .notification.error {
            border-left-color: #f44336;
        }

        .notification.warning {
            border-left-color: #ff9800;
        }

        .notification.info {
            border-left-color: #2196f3;
        }

        .notification.success {
            border-left-color: #4CAF50;
        }

        .notification-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 5px;
        }

        .notification-title {
            font-weight: 500;
            font-size: 14px;
        }

        .notification-close {
            background: none;
            border: none;
            color: white;
            cursor: pointer;
            font-size: 16px;
        }

        .notification-message {
            font-size: 13px;
            color: rgba(255, 255, 255, 0.8);
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%) scale(0.8);
                opacity: 0;
            }
            to {
                transform: translateX(0) scale(1);
                opacity: 1;
            }
        }

        .loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #0f2027, #203a43);
            z-index: 10000;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .loading-content {
            text-align: center;
        }

        .loading-logo {
            font-size: 60px;
            font-weight: bold;
            color: #4CAF50;
            margin-bottom: 20px;
            text-shadow: 0 0 20px rgba(76, 175, 80, 0.5);
        }

        .loading-text {
            font-size: 18px;
            margin-bottom: 30px;
            color: rgba(255, 255, 255, 0.8);
        }

        .loading-bar {
            width: 300px;
            height: 4px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 2px;
            overflow: hidden;
            margin-bottom: 20px;
        }

        .loading-progress {
            height: 100%;
            background: linear-gradient(90deg, #4CAF50, #45a049);
            border-radius: 2px;
            width: 0%;
            animation: loading 2s ease-in-out infinite;
        }

        .loading-version {
            font-size: 14px;
            color: rgba(255, 255, 255, 0.5);
        }

        @keyframes loading {
            0% { width: 0%; }
            50% { width: 100%; }
            100% { width: 0%; }
        }

        .explorer {
            height: 100%;
            display: flex;
            flex-direction: column;
        }

        .explorer-toolbar {
            display: flex;
            gap: 5px;
            padding: 10px;
            background: rgba(255, 255, 255, 0.05);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .explorer-content {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        .explorer-sidebar {
            width: 200px;
            background: rgba(255, 255, 255, 0.05);
            border-right: 1px solid rgba(255, 255, 255, 0.1);
            padding: 10px;
            overflow-y: auto;
        }

        .explorer-main {
            flex: 1;
            padding: 15px;
            overflow-y: auto;
        }

        .file-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 10px;
        }

        .file-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 10px;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.2s ease;
            text-align: center;
        }

        .file-item:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .file-icon {
            font-size: 32px;
            margin-bottom: 5px;
        }

        .file-name {
            font-size: 12px;
            word-break: break-all;
        }

        .file-info {
            font-size: 10px;
            color: rgba(255, 255, 255, 0.6);
        }

        .package-manager {
            height: 100%;
            display: flex;
            flex-direction: column;
        }

        .pm-header {
            padding: 15px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .pm-header h1 {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 20px;
            margin-bottom: 15px;
        }

        .pm-actions {
            display: flex;
            gap: 10px;
        }

        .pm-body {
            flex: 1;
            display: flex;
            padding: 15px;
            gap: 20px;
        }

        .pm-sidebar {
            width: 200px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 5px;
            padding: 15px;
        }

        .pm-content {
            flex: 1;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 5px;
            padding: 15px;
            overflow-y: auto;
        }

        .pm-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .pm-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .pm-item:hover {
            background: rgba(255, 255, 255, 0.15);
            transform: translateX(5px);
        }

        .pm-item.active {
            background: rgba(76, 175, 80, 0.2);
            border-left: 3px solid #4CAF50;
        }

        .calculator {
            padding: 20px;
        }

        .calc-display {
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 15px;
            text-align: right;
            font-size: 24px;
            min-height: 60px;
            display: flex;
            align-items: center;
            justify-content: flex-end;
            overflow: hidden;
        }

        .calc-buttons {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
        }

        .calc-button {
            padding: 15px;
            border: none;
            border-radius: 5px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            font-size: 18px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .calc-button:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .calc-button.operator {
            background: rgba(255, 152, 0, 0.2);
        }

        .calc-button.operator:hover {
            background: rgba(255, 152, 0, 0.3);
        }

        .calc-button.equals {
            background: rgba(76, 175, 80, 0.2);
            grid-column: span 2;
        }

        .calc-button.equals:hover {
            background: rgba(76, 175, 80, 0.3);
        }

        .calc-button.clear {
            background: rgba(244, 67, 54, 0.2);
        }

        .calc-button.clear:hover {
            background: rgba(244, 67, 54, 0.3);
        }

        .editor {
            height: 100%;
            display: flex;
            flex-direction: column;
        }

        .editor-toolbar {
            display: flex;
            gap: 5px;
            padding: 10px;
            background: rgba(255, 255, 255, 0.05);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .editor-content {
            flex: 1;
            position: relative;
        }

        #editor-textarea {
            width: 100%;
            height: 100%;
            background: transparent;
            border: none;
            color: white;
            font-family: monospace;
            font-size: 14px;
            padding: 15px;
            resize: none;
            outline: none;
        }

        #context-menu {
            position: fixed;
            background: rgba(30, 35, 40, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 5px 0;
            min-width: 180px;
            z-index: 10001;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            display: none;
            animation: slideIn 0.2s ease;
        }

        .context-menu-item {
            padding: 10px 15px;
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 14px;
            color: rgba(255, 255, 255, 0.9);
        }

        .context-menu-item:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .context-menu-item.delete {
            color: #f44336;
        }

        .context-menu-item.delete:hover {
            background: rgba(244, 67, 54, 0.1);
        }

        .context-menu-separator {
            height: 1px;
            background: rgba(255, 255, 255, 0.1);
            margin: 5px 0;
        }

        @media (max-width: 768px) {
            .start-menu {
                width: calc(100% - 20px);
                height: 70vh;
            }
            
            .start-content {
                grid-template-columns: 1fr;
            }
            
            .window {
                min-width: 90vw !important;
                min-height: 50vh !important;
                left: 5vw !important;
                top: 5vh !important;
            }
        }

        .fs-selector {
            padding: 20px;
        }

        .fs-option {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 15px;
            margin: 10px 0;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .fs-option:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: translateX(5px);
        }

        .fs-option.selected {
            background: rgba(76, 175, 80, 0.2);
            border: 2px solid #4CAF50;
        }

        .fs-option-icon {
            font-size: 32px;
        }

        .fs-option-info {
            flex: 1;
        }

        .fs-option-title {
            font-weight: 500;
            font-size: 16px;
            margin-bottom: 5px;
        }

        .fs-option-desc {
            font-size: 12px;
            color: rgba(255, 255, 255, 0.7);
        }

        .fs-status {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 3px;
            font-size: 11px;
            font-weight: bold;
            margin-left: 10px;
        }

        .fs-status.available {
            background: rgba(76, 175, 80, 0.3);
            color: #4CAF50;
        }

        .fs-status.unavailable {
            background: rgba(244, 67, 54, 0.3);
            color: #f44336;
        }

        #custom-cursor {
            position: fixed;
            width: 20px;
            height: 20px;
            border: 2px solid #4CAF50;
            border-radius: 50%;
            pointer-events: none;
            z-index: 10000;
            transform: translate(-50%, -50%);
            transition: transform 0.1s ease;
            mix-blend-mode: difference;
        }

        #shader-canvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 0;
            pointer-events: none;
            display: none;
        }
    </style>
</head>
<body>
    <div id="pixi-background"></div>
    
    <div id="taskbar">
        <div class="taskbar-left">
            <button id="start-btn" class="start-button">
                <span>‚ñ∂ Inicio</span>
                <span class="start-arrow">‚ñº</span>
            </button>
            <div id="running-apps" class="running-apps"></div>
        </div>
        <div class="taskbar-right">
            <div id="system-tray">
                <span id="volume-icon">üîä</span>
                <span id="network-icon">üåê</span>
                <span id="time" class="clock">00:00</span>
                <span id="date" class="date">01/01/2024</span>
            </div>
        </div>
    </div>
    
    <div id="start-menu" class="start-menu">
        <div class="start-header">
            <div class="user-info">
                <div class="user-icon">üë§</div>
                <div class="user-name">Usuario XP7</div>
            </div>
        </div>
        <div class="start-content">
            <div class="start-column">
                <h3>Programas</h3>
                <div class="start-item" data-app="explorer">
                    <span class="start-icon">üìÅ</span>
                    <span class="start-text">Explorador</span>
                </div>
                <div class="start-item" data-app="notepad">
                    <span class="start-icon">üìù</span>
                    <span class="start-text">Bloc de Notas</span>
                </div>
                <div class="start-item" data-app="calculator">
                    <span class="start-icon">üßÆ</span>
                    <span class="start-text">Calculadora</span>
                </div>
                <div class="start-item" data-app="package-manager">
                    <span class="start-icon">üì¶</span>
                    <span class="start-text">Gestor de Paquetes</span>
                </div>
                <div class="start-item" data-app="act-manager">
                    <span class="start-icon">üîÑ</span>
                    <span class="start-text">Gestor de ACT</span>
                </div>
            </div>
            <div class="start-column">
                <h3>Herramientas</h3>
                <div class="start-item" data-app="storage-manager">
                    <span class="start-icon">üíæ</span>
                    <span class="start-text">Storage Manager</span>
                </div>
                <div class="start-item" data-app="file-selector">
                    <span class="start-icon">üìÇ</span>
                    <span class="start-text">Selector de Sistema de Archivos</span>
                </div>
                <div class="start-item" data-app="settings">
                    <span class="start-icon">‚öôÔ∏è</span>
                    <span class="start-text">Configuraci√≥n</span>
                </div>
                <div class="start-item" data-app="terminal">
                    <span class="start-icon">üíª</span>
                    <span class="start-text">Terminal</span>
                </div>
            </div>
            <div class="start-column">
                <h3>Sistema</h3>
                <div class="start-item" data-action="shutdown">
                    <span class="start-icon">‚èª</span>
                    <span class="start-text">Apagar</span>
                </div>
                <div class="start-item" data-action="restart">
                    <span class="start-icon">‚Üª</span>
                    <span class="start-text">Reiniciar</span>
                </div>
                <div class="start-item" data-action="logout">
                    <span class="start-icon">üë§</span>
                    <span class="start-text">Cerrar Sesi√≥n</span>
                </div>
            </div>
            <!-- Se a√±adir√° din√°micamente la categor√≠a Personalizaci√≥n -->
        </div>
        <div class="start-footer">
            <div class="search-box">
                <input type="text" placeholder="Buscar programas y archivos...">
                <button>üîç</button>
            </div>
        </div>
    </div>
    
    <div id="desktop" class="desktop"></div>
    
    <div id="windows-container"></div>
    
    <div id="custom-cursor"></div>
    
    <div id="notifications"></div>
    
    <div id="context-menu">
        <div class="context-menu-item" data-action="open">
            <span>üìÇ</span> Abrir
        </div>
        <div class="context-menu-item" data-action="rename">
            <span>‚úèÔ∏è</span> Renombrar
        </div>
        <div class="context-menu-item" data-action="properties">
            <span>üìã</span> Propiedades
        </div>
        <div class="context-menu-separator"></div>
        <div class="context-menu-item delete" data-action="delete">
            <span>üóëÔ∏è</span> Eliminar
        </div>
    </div>
    
    <div id="loading-screen" class="loading-screen">
        <div class="loading-content">
            <div class="loading-logo">XP7</div>
            <div class="loading-text">Iniciando sistema...</div>
            <div class="loading-bar">
                <div class="loading-progress"></div>
            </div>
            <div class="loading-version">Versi√≥n 3.0.0</div>
        </div>
    </div>

    <input type="file" id="file-input" style="display: none;">

    <script>
        // ============================================
        // SISTEMA XP7 COMPLETAMENTE CORREGIDO
        // ============================================

        const XP7 = {
            version: '3.0.0',
            initialized: false,
            windows: [],
            apps: {},
            currentZIndex: 100,
            
            fileSystem: {
                mode: 'localStorage',
                directoryHandle: null,
                structure: {},
                currentPath: '/',
                
                async init() {
                    console.log('üíæ Inicializando sistema de archivos...');
                    
                    const savedMode = localStorage.getItem('xp7_fs_mode');
                    if (savedMode === 'fileSystem') {
                        this.mode = 'localStorage'; // Corregido: si es fileSystem pero no est√° disponible, usar localStorage
                    } else if (savedMode) {
                        this.mode = savedMode;
                    }
                    
                    const savedStructure = localStorage.getItem('xp7_fs_structure');
                    if (savedStructure) {
                        this.structure = JSON.parse(savedStructure);
                    } else {
                        this.structure = {
                            '/': ['System', 'Apps', 'User'],
                            '/System': ['config.json', 'packages.json', 'updates.json'],
                            '/Apps': [],
                            '/User': ['Documents', 'Downloads', 'Desktop', 'Backgrounds'],
                            '/User/Documents': [],
                            '/User/Downloads': [],
                            '/User/Desktop': [],
                            '/User/Backgrounds': []
                        };
                        this.saveStructure();
                    }
                    
                    // Asegurar directorio de Updates
                    if (!this.structure['/System/Updates']) {
                        this.structure['/System/Updates'] = [];
                        this.saveStructure();
                    }
                    
                    this.ensureSystemFiles();
                    console.log('‚úÖ Sistema de archivos inicializado en modo:', this.mode);
                },
                
                async enableFileSystemAPI() {
                    if (!('showDirectoryPicker' in window)) {
                        throw new Error('File System API no disponible en tu navegador');
                    }
                    
                    try {
                        const handle = await window.showDirectoryPicker({
                            mode: 'readwrite'
                        });
                        
                        this.mode = 'fileSystem';
                        this.directoryHandle = handle;
                        localStorage.setItem('xp7_fs_mode', 'fileSystem');
                        
                        console.log('‚úÖ File System API activada en directorio:', handle.name);
                        return handle;
                    } catch (error) {
                        console.error('Error accediendo a File System API:', error);
                        throw error;
                    }
                },
                
                async readFile(path) {
                    if (this.mode === 'localStorage') {
                        const key = 'xp7_fs_' + path.replace(/\//g, '_');
                        return localStorage.getItem(key);
                    } else if (this.mode === 'fileSystem') {
                        return null;
                    }
                },
                
                async writeFile(path, content) {
                    if (this.mode === 'localStorage') {
                        const key = 'xp7_fs_' + path.replace(/\//g, '_');
                        localStorage.setItem(key, content);
                        
                        const dir = path.substring(0, path.lastIndexOf('/')) || '/';
                        const file = path.substring(path.lastIndexOf('/') + 1);
                        
                        if (!this.structure[dir]) {
                            this.structure[dir] = [];
                        }
                        
                        if (!this.structure[dir].includes(file)) {
                            this.structure[dir].push(file);
                            this.saveStructure();
                        }
                        
                        return true;
                    } else if (this.mode === 'fileSystem') {
                        return false;
                    }
                },
                
                async createDirectory(path) {
                    if (this.mode === 'localStorage') {
                        if (!this.structure[path]) {
                            this.structure[path] = [];
                            this.saveStructure();
                            return true;
                        }
                        return false;
                    } else if (this.mode === 'fileSystem') {
                        return false;
                    }
                },
                
                async listDirectory(path = '/') {
                    const entries = [];
                    
                    if (this.mode === 'localStorage') {
                        Object.keys(this.structure).forEach(dir => {
                            if (dir.startsWith(path) && dir !== path) {
                                const subPath = dir.substring(path === '/' ? 1 : path.length + 1);
                                if (!subPath.includes('/')) {
                                    entries.push({
                                        name: subPath,
                                        kind: 'directory',
                                        type: 'directory',
                                        icon: 'üìÅ'
                                    });
                                }
                            }
                        });
                        
                        if (this.structure[path]) {
                            this.structure[path].forEach(fileName => {
                                if (!fileName.includes('/')) {
                                    entries.push({
                                        name: fileName,
                                        kind: 'file',
                                        type: this.getFileType(fileName),
                                        icon: this.getFileIcon(fileName)
                                    });
                                }
                            });
                        }
                    }
                    
                    return entries;
                },
                
                saveStructure() {
                    localStorage.setItem('xp7_fs_structure', JSON.stringify(this.structure));
                },
                
                ensureSystemFiles() {
                    const systemFiles = {
                        '/System/config.json': JSON.stringify({
                            version: XP7.version,
                            name: 'XP7 OS',
                            created: new Date().toISOString(),
                            fileSystem: this.mode,
                            status: 'operational'
                        }, null, 2),
                        '/System/packages.json': '[]',
                        '/System/updates.json': '[]'
                    };
                    
                    Object.entries(systemFiles).forEach(([path, content]) => {
                        this.writeFile(path, content).catch(console.error);
                    });
                },
                
                getFileType(filename) {
                    const ext = filename.split('.').pop().toLowerCase();
                    const types = {
                        'txt': 'text', 'js': 'javascript', 'json': 'json',
                        'html': 'html', 'css': 'css', 'pak': 'package',
                        'act': 'update', 'png': 'image', 'jpg': 'image',
                        'jpeg': 'image', 'gif': 'image', 'webp': 'image',
                        'svg': 'image', 'mp3': 'audio', 'mp4': 'video',
                        'pdf': 'document', 'glsl': 'shader', 'frag': 'shader',
                        'vert': 'shader'
                    };
                    return types[ext] || 'unknown';
                },
                
                getFileIcon(filename) {
                    const type = this.getFileType(filename);
                    const icons = {
                        'text': 'üìÑ', 'javascript': 'üìú', 'json': 'üìã',
                        'html': 'üåê', 'css': 'üé®', 'package': 'üì¶',
                        'update': 'üîÑ', 'image': 'üñºÔ∏è', 'audio': 'üéµ',
                        'video': 'üé¨', 'document': 'üìï', 'directory': 'üìÅ',
                        'shader': 'üîÑ', 'unknown': 'üìÑ'
                    };
                    return icons[type] || 'üìÑ';
                },
                
                getStorageInfo() {
                    let totalSize = 0;
                    let fileCount = 0;
                    
                    for (let i = 0; i < localStorage.length; i++) {
                        const key = localStorage.key(i);
                        if (key.startsWith('xp7_fs_')) {
                            const value = localStorage.getItem(key);
                            totalSize += key.length + (value ? value.length : 0);
                            fileCount++;
                        }
                    }
                    
                    const maxSize = 5 * 1024 * 1024;
                    const usedMB = (totalSize / 1024 / 1024).toFixed(2);
                    const maxMB = (maxSize / 1024 / 1024).toFixed(2);
                    const percentage = ((totalSize / maxSize) * 100).toFixed(1);
                    
                    return {
                        used: totalSize,
                        usedMB: usedMB,
                        max: maxSize,
                        maxMB: maxMB,
                        percentage: percentage,
                        fileCount: fileCount
                    };
                },
                
                exportFileSystem() {
                    const exportData = {};
                    
                    for (let i = 0; i < localStorage.length; i++) {
                        const key = localStorage.key(i);
                        if (key.startsWith('xp7_fs_')) {
                            const path = key.substring(7).replace(/_/g, '/');
                            exportData[path] = localStorage.getItem(key);
                        }
                    }
                    
                    return JSON.stringify(exportData, null, 2);
                },
                
                importFileSystem(jsonData) {
                    try {
                        const data = JSON.parse(jsonData);
                        
                        Object.keys(data).forEach(path => {
                            const key = 'xp7_fs_' + path.replace(/\//g, '_');
                            localStorage.setItem(key, data[path]);
                        });
                        
                        this.rebuildStructure();
                        return true;
                    } catch (error) {
                        console.error('Error importing file system:', error);
                        return false;
                    }
                },
                
                rebuildStructure() {
                    this.structure = {};
                    
                    for (let i = 0; i < localStorage.length; i++) {
                        const key = localStorage.key(i);
                        if (key.startsWith('xp7_fs_')) {
                            const path = key.substring(7).replace(/_/g, '/');
                            const dir = path.substring(0, path.lastIndexOf('/')) || '/';
                            const file = path.substring(path.lastIndexOf('/') + 1);
                            
                            if (!this.structure[dir]) {
                                this.structure[dir] = [];
                            }
                            
                            if (!this.structure[dir].includes(file)) {
                                this.structure[dir].push(file);
                            }
                        }
                    }
                    
                    this.saveStructure();
                },
                
                async processACTFile(content) {
                    try {
                        const data = JSON.parse(content);
                        
                        if (!data.type || data.type !== 'update') {
                            throw new Error('Archivo .act inv√°lido');
                        }
                        
                        const actKey = 'xp7_act_' + Date.now();
                        const updateData = {
                            ...data,
                            installed: new Date().toISOString(),
                            version: data.version || '1.0.0',
                            id: actKey,
                            name: data.name || 'Actualizaci√≥n sin nombre',
                            description: data.description || 'Sin descripci√≥n'
                        };
                        
                        localStorage.setItem(actKey, JSON.stringify(updateData));
                        
                        // Guardar tambi√©n como archivo en el sistema
                        const fileName = 'update_' + Date.now() + '.act';
                        await this.writeFile('/System/Updates/' + fileName, content);
                        
                        return {
                            success: true,
                            message: 'Actualizaci√≥n "' + updateData.name + '" instalada correctamente',
                            data: updateData
                        };
                    } catch (error) {
                        console.error('Error procesando archivo .act:', error);
                        return {
                            success: false,
                            message: 'Error procesando archivo .act: ' + error.message
                        };
                    }
                },
                
                async installACTFileUsingFS() {
                    if (!('showOpenFilePicker' in window)) {
                        return {
                            success: false,
                            message: 'File System API no disponible en tu navegador'
                        };
                    }
                    
                    try {
                        const [fileHandle] = await window.showOpenFilePicker({
                            types: [{
                                description: 'Archivos de actualizaci√≥n',
                                accept: {
                                    'application/json': ['.act']
                                }
                            }],
                            multiple: false
                        });
                        
                        const file = await fileHandle.getFile();
                        const content = await file.text();
                        
                        const result = await this.processACTFile(content);
                        
                        return result;
                    } catch (error) {
                        if (error.name !== 'AbortError') {
                            console.error('Error al seleccionar archivo:', error);
                            return {
                                success: false,
                                message: 'Error al seleccionar archivo: ' + error.message
                            };
                        }
                        return {
                            success: false,
                            message: 'Selecci√≥n cancelada'
                        };
                    }
                },
                
                getInstalledUpdates() {
                    const updates = [];
                    
                    for (let i = 0; i < localStorage.length; i++) {
                        const key = localStorage.key(i);
                        if (key.startsWith('xp7_act_')) {
                            try {
                                const update = JSON.parse(localStorage.getItem(key));
                                updates.push({
                                    key: key,
                                    ...update,
                                    size: update.size || 'Desconocido'
                                });
                            } catch (e) {
                                console.warn('Error parsing update:', key, e);
                            }
                        }
                    }
                    
                    return updates;
                },
                
                deleteUpdate(key) {
                    if (localStorage.getItem(key)) {
                        localStorage.removeItem(key);
                        return true;
                    }
                    return false;
                }
            },
            
            async init() {
                console.log('üöÄ Iniciando XP7 OS v' + this.version);
                
                await this.fileSystem.init();
                this.setupEvents();
                this.loadDefaultApps();
                this.startClock();
                
                // Inicializar sistema de fondos si est√° instalado
                if (localStorage.getItem('xp7_background_system_installed')) {
                    this.installBackgroundSystem();
                }
                
                setTimeout(() => {
                    document.getElementById('loading-screen').style.opacity = '0';
                    setTimeout(() => {
                        document.getElementById('loading-screen').style.display = 'none';
                        this.showNotification('XP7 OS', 
                            'Sistema iniciado correctamente', 
                            'success');
                    }, 500);
                }, 2000);
                
                this.initialized = true;
                console.log('‚úÖ XP7 OS inicializado correctamente');
            },
            
            loadDefaultApps() {
                this.apps = {
                    'explorer': {
                        name: 'Explorador de Archivos',
                        icon: 'üìÅ',
                        description: 'Navega y gestiona tus archivos',
                        category: 'Sistema',
                        launch: () => XP7Apps.openExplorer()
                    },
                    'notepad': {
                        name: 'Bloc de Notas',
                        icon: 'üìù',
                        description: 'Editor de texto simple',
                        category: 'Herramientas',
                        launch: () => XP7Apps.openNotepad()
                    },
                    'calculator': {
                        name: 'Calculadora',
                        icon: 'üßÆ',
                        description: 'Calculadora b√°sica',
                        category: 'Herramientas',
                        launch: () => XP7Apps.openCalculator()
                    },
                    'package-manager': {
                        name: 'Gestor de Paquetes',
                        icon: 'üì¶',
                        description: 'Instala y gestiona aplicaciones',
                        category: 'Sistema',
                        launch: () => XP7Apps.openPackageManager()
                    },
                    'storage-manager': {
                        name: 'Storage Manager',
                        icon: 'üíæ',
                        description: 'Gestiona el almacenamiento local',
                        category: 'Sistema',
                        launch: () => XP7Apps.openStorageManager()
                    },
                    'file-selector': {
                        name: 'Selector de Sistema de Archivos',
                        icon: 'üìÇ',
                        description: 'Selecciona c√≥mo almacenar tus archivos',
                        category: 'Herramientas',
                        launch: () => XP7Apps.openFileSelector()
                    },
                    'settings': {
                        name: 'Configuraci√≥n',
                        icon: '‚öôÔ∏è',
                        description: 'Ajustes del sistema',
                        category: 'Sistema',
                        launch: () => XP7Apps.openSettings()
                    },
                    'terminal': {
                        name: 'Terminal',
                        icon: 'üíª',
                        description: 'Terminal del sistema',
                        category: 'Herramientas',
                        launch: () => XP7Apps.openTerminal()
                    },
                    'act-manager': {
                        name: 'Gestor de ACT',
                        icon: 'üîÑ',
                        description: 'Gestiona archivos de actualizaci√≥n .act',
                        category: 'Sistema',
                        launch: () => XP7Apps.openACTManager()
                    },
                    'pak-creator': {
                        name: 'Creador de Paquetes',
                        icon: 'üì¶',
                        description: 'Crea archivos .pak para distribuir aplicaciones',
                        category: 'Herramientas',
                        launch: () => XP7Apps.openPakCreator()
                    }
                };
                
                this.updateDesktopIcons();
            },
            
            updateDesktopIcons() {
                const desktop = document.getElementById('desktop');
                desktop.innerHTML = '';
                
                // Mostrar todas las aplicaciones
                Object.entries(this.apps).forEach(([appId, app]) => {
                    const icon = document.createElement('div');
                    icon.className = 'desktop-icon';
                    icon.innerHTML = `
                        <div class="icon">${app.icon}</div>
                        <div class="name">${app.name}</div>
                    `;
                    icon.addEventListener('dblclick', () => XP7Apps.launch(appId));
                    desktop.appendChild(icon);
                });
            },
            
            setupEvents() {
                document.getElementById('start-btn').addEventListener('click', () => {
                    const menu = document.getElementById('start-menu');
                    menu.classList.toggle('active');
                });
                
                document.addEventListener('click', (e) => {
                    if (!e.target.closest('#start-menu') && !e.target.closest('#start-btn')) {
                        document.getElementById('start-menu').classList.remove('active');
                    }
                });
                
                document.querySelectorAll('.start-item').forEach(item => {
                    item.addEventListener('click', () => {
                        const app = item.dataset.app;
                        const action = item.dataset.action;
                        
                        if (app) {
                            XP7Apps.launch(app);
                        } else if (action) {
                            this.handleSystemAction(action);
                        }
                        
                        document.getElementById('start-menu').classList.remove('active');
                    });
                });
                
                document.addEventListener('mousemove', (e) => {
                    const cursor = document.getElementById('custom-cursor');
                    cursor.style.left = e.clientX + 'px';
                    cursor.style.top = e.clientY + 'px';
                    
                    const target = e.target;
                    if (target.tagName === 'BUTTON' || target.closest('button') || 
                        target.classList.contains('start-item') ||
                        target.classList.contains('window-control') ||
                        target.classList.contains('file-item') ||
                        target.classList.contains('desktop-icon')) {
                        cursor.style.transform = 'translate(-50%, -50%) scale(1.5)';
                        cursor.style.borderColor = '#2196f3';
                    } else {
                        cursor.style.transform = 'translate(-50%, -50%) scale(1)';
                        cursor.style.borderColor = '#4CAF50';
                    }
                });
                
                document.getElementById('file-input').addEventListener('change', async (e) => {
                    const files = Array.from(e.target.files);
                    if (files.length === 0) return;
                    
                    for (const file of files) {
                        const reader = new FileReader();
                        reader.onload = async (event) => {
                            const fileName = file.name;
                            const filePath = '/User/Downloads/' + fileName;
                            await this.fileSystem.writeFile(filePath, event.target.result);
                        };
                        reader.readAsText(file);
                    }
                    
                    this.showNotification('Archivos', files.length + ' archivo(s) subido(s)', 'info');
                    e.target.value = '';
                });
            },
            
            showNotification(title, message, type = 'info') {
                const notifications = document.getElementById('notifications');
                const id = 'notification-' + Date.now();
                
                const notification = document.createElement('div');
                notification.className = 'notification ' + type;
                notification.id = id;
                
                notification.innerHTML = `
                    <div class="notification-header">
                        <span class="notification-title">${title}</span>
                        <button class="notification-close" onclick="this.parentElement.parentElement.remove()">√ó</button>
                    </div>
                    <div class="notification-message">${message}</div>
                `;
                
                notifications.appendChild(notification);
                
                setTimeout(() => {
                    if (document.getElementById(id)) {
                        document.getElementById(id).remove();
                    }
                }, 5000);
            },
            
            handleSystemAction(action) {
                switch(action) {
                    case 'shutdown':
                        this.shutdown();
                        break;
                    case 'restart':
                        this.restart();
                        break;
                    case 'logout':
                        this.logout();
                        break;
                }
            },
            
            shutdown() {
                if (confirm('¬øEst√°s seguro de que quieres apagar el sistema?')) {
                    this.showNotification('Sistema', 'Apagando XP7 OS...', 'info');
                    setTimeout(() => {
                        document.body.innerHTML = `
                            <div style="
                                display: flex;
                                align-items: center;
                                justify-content: center;
                                height: 100vh;
                                background: #000;
                                color: #4CAF50;
                                font-size: 24px;
                            ">
                                üíª Sistema Apagado
                            </div>
                        `;
                    }, 1000);
                }
            },
            
            restart() {
                if (confirm('¬øEst√°s seguro de que quieres reiniciar el sistema?')) {
                    this.showNotification('Sistema', 'Reiniciando XP7 OS...', 'info');
                    setTimeout(() => {
                        window.location.reload();
                    }, 1000);
                }
            },
            
            logout() {
                if (confirm('¬øEst√°s seguro de que quieres cerrar sesi√≥n?')) {
                    this.showNotification('Sistema', 'Cerrando sesi√≥n...', 'info');
                    setTimeout(() => {
                        localStorage.clear();
                        window.location.reload();
                    }, 1000);
                }
            },
            
            startClock() {
                const updateTime = () => {
                    const now = new Date();
                    const timeElement = document.getElementById('time');
                    const dateElement = document.getElementById('date');
                    
                    timeElement.textContent = now.toLocaleTimeString('es-ES', { 
                        hour: '2-digit', 
                        minute: '2-digit' 
                    });
                    
                    dateElement.textContent = now.toLocaleDateString('es-ES');
                };
                
                updateTime();
                setInterval(updateTime, 1000);
            },
            
            // SISTEMA DE FONDOS DIN√ÅMICOS
            installBackgroundSystem: function() {
                console.log('üé® Inicializando sistema de fondos din√°micos...');
                
                // 1. EXTENDER EL SISTEMA DE ARCHIVOS PARA IM√ÅGENES
                XP7.fileSystem.supportedImageTypes = ['jpg', 'jpeg', 'png', 'gif', 'webp', 'svg'];
                XP7.fileSystem.supportedShaderTypes = ['glsl', 'frag', 'vert'];
                
                // M√©todo para cargar im√°genes
                XP7.fileSystem.loadImage = async function(path) {
                    return new Promise((resolve, reject) => {
                        if (this.mode === 'localStorage') {
                            const key = 'xp7_fs_' + path.replace(/\//g, '_');
                            const data = localStorage.getItem(key);
                            
                            if (!data) {
                                reject(new Error('Imagen no encontrada'));
                                return;
                            }
                            
                            const img = new Image();
                            img.onload = () => resolve(img);
                            img.onerror = reject;
                            img.src = data;
                        } else {
                            reject(new Error('Modo File System no soportado para im√°genes'));
                        }
                    });
                };
                
                // M√©todo para guardar im√°genes
                XP7.fileSystem.saveImage = async function(path, imageData) {
                    if (this.mode === 'localStorage') {
                        const key = 'xp7_fs_' + path.replace(/\//g, '_');
                        localStorage.setItem(key, imageData);
                        
                        const dir = path.substring(0, path.lastIndexOf('/')) || '/';
                        const file = path.substring(path.lastIndexOf('/') + 1);
                        
                        if (!this.structure[dir]) {
                            this.structure[dir] = [];
                        }
                        
                        if (!this.structure[dir].includes(file)) {
                            this.structure[dir].push(file);
                            this.saveStructure();
                        }
                        
                        return true;
                    }
                    return false;
                };
                
                // 2. SISTEMA DE SHADERS GLSL
                XP7.Shaders = {
                    shaders: {},
                    currentShader: null,
                    shaderProgram: null,
                    canvas: null,
                    ctx: null,
                    gl: null,
                    useWebGL: false,
                    animationId: null,
                    
                    // Shaders predefinidos
                    builtInShaders: {
                        'rainbow': {
                            name: 'Arco√≠ris',
                            type: 'fragment',
                            code: `precision mediump float;
uniform float time;
uniform vec2 resolution;

void main() {
    vec2 uv = gl_FragCoord.xy / resolution;
    vec3 color = 0.5 + 0.5 * cos(time + uv.xyx + vec3(0,2,4));
    gl_FragColor = vec4(color, 1.0);
}`
                        },
                        'matrix': {
                            name: 'Lluvia Matrix',
                            type: 'fragment',
                            code: `precision mediump float;
uniform float time;
uniform vec2 resolution;

void main() {
    vec2 uv = gl_FragCoord.xy / resolution;
    float speed = time * 0.5;
    
    // Efecto de lluvia de caracteres
    float rain = sin(uv.x * 50.0 + speed * 3.0) * 0.5 + 0.5;
    float trail = mod(uv.y + speed, 0.2) * 5.0;
    
    vec3 color = vec3(0.0, rain * trail, 0.0);
    gl_FragColor = vec4(color, 1.0);
}`
                        },
                        'nebula': {
                            name: 'Nebulosa',
                            type: 'fragment',
                            code: `precision mediump float;
uniform float time;
uniform vec2 resolution;

float noise(vec2 p) {
    return sin(p.x * 10.0) * sin(p.y * 10.0);
}

void main() {
    vec2 uv = gl_FragCoord.xy / resolution;
    vec3 color = vec3(0.0);
    
    for(float i = 0.0; i < 3.0; i++) {
        float t = time * (0.3 + i * 0.1);
        vec2 pos = uv + vec2(cos(t + i), sin(t + i)) * 0.3;
        float n = noise(pos * 3.0);
        color += vec3(
            0.5 + 0.5 * sin(n + i * 2.0),
            0.3 + 0.3 * sin(n + i * 3.0),
            0.7 + 0.3 * cos(n + i * 1.0)
        ) * 0.3;
    }
    
    gl_FragColor = vec4(color, 1.0);
}`
                        },
                        'fire': {
                            name: 'Fuego',
                            type: 'fragment',
                            code: `precision mediump float;
uniform float time;
uniform vec2 resolution;

void main() {
    vec2 uv = gl_FragCoord.xy / resolution;
    uv.y += time * 0.5;
    
    float value = sin(uv.x * 10.0 + time) * 0.5 + 0.5;
    value *= sin(uv.y * 20.0 + time * 2.0) * 0.5 + 0.5;
    
    vec3 color = vec3(
        1.0,
        value * 0.5,
        0.0
    );
    
    gl_FragColor = vec4(color * (1.0 - uv.y), 1.0);
}`
                        },
                        'water': {
                            name: 'Agua',
                            type: 'fragment',
                            code: `precision mediump float;
uniform float time;
uniform vec2 resolution;

void main() {
    vec2 uv = gl_FragCoord.xy / resolution;
    
    float wave = sin(uv.x * 20.0 + time * 2.0) * 0.1;
    wave += sin(uv.y * 15.0 + time * 1.5) * 0.05;
    
    vec3 color = vec3(
        0.1,
        0.3 + wave * 0.5,
        0.8 + wave * 0.2
    );
    
    gl_FragColor = vec4(color, 1.0);
}`
                        }
                    },
                    
                    // Inicializar sistema de shaders
                    init: function() {
                        console.log('üé® Inicializando sistema de shaders...');
                        
                        // Cargar shaders guardados
                        const savedShaders = localStorage.getItem('xp7_shaders');
                        if (savedShaders) {
                            this.shaders = JSON.parse(savedShaders);
                        }
                        
                        // A√±adir shaders predefinidos
                        Object.assign(this.shaders, this.builtInShaders);
                        
                        // Inicializar canvas para shaders
                        this.initShaderCanvas();
                    },
                    
                    initShaderCanvas: function() {
                        const canvas = document.createElement('canvas');
                        canvas.id = 'shader-canvas';
                        canvas.style.position = 'fixed';
                        canvas.style.top = '0';
                        canvas.style.left = '0';
                        canvas.style.width = '100%';
                        canvas.style.height = '100%';
                        canvas.style.zIndex = '0';
                        canvas.style.pointerEvents = 'none';
                        document.body.appendChild(canvas);
                        
                        this.canvas = canvas;
                        this.ctx = canvas.getContext('2d');
                        this.gl = canvas.getContext('webgl') || canvas.getContext('experimental-webgl');
                        
                        if (!this.gl) {
                            console.warn('WebGL no disponible, usando canvas 2D');
                            this.useWebGL = false;
                        } else {
                            this.useWebGL = true;
                        }
                        
                        // Ajustar tama√±o del canvas
                        this.resizeCanvas();
                        window.addEventListener('resize', () => this.resizeCanvas());
                    },
                    
                    resizeCanvas: function() {
                        if (this.canvas) {
                            this.canvas.width = window.innerWidth;
                            this.canvas.height = window.innerHeight;
                        }
                    },
                    
                    // Aplicar shader
                    applyShader: function(shaderName) {
                        if (!this.shaders[shaderName]) {
                            console.error('Shader no encontrado:', shaderName);
                            return;
                        }
                        
                        this.currentShader = shaderName;
                        
                        // Detener animaci√≥n previa
                        if (this.animationId) {
                            cancelAnimationFrame(this.animationId);
                        }
                        
                        // Iniciar renderizado
                        this.startRendering();
                        
                        XP7.showNotification('Shaders', `Shader "${shaderName}" aplicado`, 'success');
                    },
                    
                    startRendering: function() {
                        if (!this.currentShader) return;
                        
                        let lastTime = 0;
                        
                        const render = (time) => {
                            const deltaTime = (time - lastTime) * 0.001;
                            lastTime = time;
                            
                            this.renderCanvas2D(time * 0.001);
                            this.animationId = requestAnimationFrame(render);
                        };
                        
                        this.animationId = requestAnimationFrame(render);
                    },
                    
                    renderCanvas2D: function(time) {
                        const ctx = this.ctx;
                        const width = this.canvas.width;
                        const height = this.canvas.height;
                        const shader = this.shaders[this.currentShader];
                        
                        // Limpiar canvas
                        ctx.clearRect(0, 0, width, height);
                        
                        // Efectos b√°sicos en 2D seg√∫n el shader
                        if (this.currentShader === 'rainbow') {
                            // Efecto arco√≠ris
                            for (let x = 0; x < width; x += 20) {
                                for (let y = 0; y < height; y += 20) {
                                    const hue = (time * 100 + x + y) % 360;
                                    ctx.fillStyle = `hsl(${hue}, 100%, 50%)`;
                                    ctx.fillRect(x, y, 20, 20);
                                }
                            }
                        } else if (this.currentShader === 'matrix') {
                            // Efecto Matrix
                            ctx.fillStyle = 'rgba(0, 20, 0, 0.1)';
                            ctx.fillRect(0, 0, width, height);
                            
                            ctx.fillStyle = '#0f0';
                            ctx.font = '16px monospace';
                            
                            for (let i = 0; i < 100; i++) {
                                const x = (Math.sin(time + i * 0.1) * 0.5 + 0.5) * width;
                                const y = (time * 100 + i * 10) % height;
                                
                                const chars = '01abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ';
                                const char = chars[Math.floor(Math.random() * chars.length)];
                                
                                ctx.fillText(char, x, y);
                            }
                        } else if (this.currentShader === 'fire') {
                            // Efecto fuego
                            const gradient = ctx.createLinearGradient(0, 0, 0, height);
                            gradient.addColorStop(0, '#ff0000');
                            gradient.addColorStop(0.5, '#ff8800');
                            gradient.addColorStop(1, '#ffff00');
                            
                            ctx.fillStyle = gradient;
                            ctx.fillRect(0, 0, width, height);
                            
                            // Part√≠culas de fuego
                            ctx.fillStyle = '#fff';
                            for (let i = 0; i < 50; i++) {
                                const x = (Math.sin(time + i) * 0.5 + 0.5) * width;
                                const y = height - (time * 100 + i * 5) % height;
                                const size = Math.sin(time + i) * 5 + 5;
                                
                                ctx.beginPath();
                                ctx.arc(x, y, size, 0, Math.PI * 2);
                                ctx.fill();
                            }
                        } else if (this.currentShader === 'water') {
                            // Efecto agua
                            ctx.fillStyle = '#006994';
                            ctx.fillRect(0, 0, width, height);
                            
                            // Ondas
                            ctx.strokeStyle = 'rgba(255, 255, 255, 0.3)';
                            ctx.lineWidth = 2;
                            
                            for (let i = 0; i < 5; i++) {
                                ctx.beginPath();
                                for (let x = 0; x < width; x += 10) {
                                    const y = height/2 + Math.sin(x * 0.01 + time + i) * 20;
                                    ctx.lineTo(x, y);
                                }
                                ctx.stroke();
                            }
                        } else {
                            // Efecto por defecto
                            const hue = (time * 50) % 360;
                            ctx.fillStyle = `hsl(${hue}, 100%, 50%)`;
                            ctx.fillRect(0, 0, width, height);
                        }
                    },
                    
                    // Guardar shader personalizado
                    saveShader: function(name, code, type = 'fragment') {
                        this.shaders[name] = { name, code, type };
                        localStorage.setItem('xp7_shaders', JSON.stringify(this.shaders));
                        XP7.showNotification('Shaders', `Shader "${name}" guardado`, 'success');
                    },
                    
                    // Eliminar shader
                    deleteShader: function(name) {
                        if (this.shaders[name] && !this.builtInShaders[name]) {
                            delete this.shaders[name];
                            localStorage.setItem('xp7_shaders', JSON.stringify(this.shaders));
                            XP7.showNotification('Shaders', `Shader "${name}" eliminado`, 'info');
                            return true;
                        }
                        return false;
                    },
                    
                    // Detener shader
                    stop: function() {
                        if (this.animationId) {
                            cancelAnimationFrame(this.animationId);
                            this.animationId = null;
                        }
                        
                        // Limpiar canvas
                        if (this.ctx) {
                            this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
                        }
                    }
                };
                
                // 3. SISTEMA DE FONDOS
                XP7.Background = {
                    currentBackground: null,
                    backgroundType: 'color',
                    backgrounds: [],
                    
                    init: function() {
                        console.log('üé® Inicializando sistema de fondos...');
                        
                        // Cargar fondos guardados
                        const savedBackgrounds = localStorage.getItem('xp7_backgrounds');
                        if (savedBackgrounds) {
                            this.backgrounds = JSON.parse(savedBackgrounds);
                        }
                        
                        // Cargar configuraci√≥n actual
                        const config = localStorage.getItem('xp7_background_config');
                        if (config) {
                            const { type, value } = JSON.parse(config);
                            this.setBackground(type, value, false);
                        } else {
                            // Fondo por defecto
                            this.setBackground('gradient', 'linear-gradient(135deg, #0f2027, #203a43, #2c5364)', false);
                        }
                    },
                    
                    // Establecer fondo
                    setBackground: function(type, value, showNotification = true) {
                        this.backgroundType = type;
                        this.currentBackground = value;
                        
                        // Guardar configuraci√≥n
                        localStorage.setItem('xp7_background_config', JSON.stringify({ type, value }));
                        
                        // Aplicar fondo
                        this.applyBackground();
                        
                        if (showNotification) {
                            XP7.showNotification('Fondo', 'Fondo actualizado', 'success');
                        }
                    },
                    
                    applyBackground: function() {
                        const body = document.body;
                        const shaderCanvas = document.getElementById('shader-canvas');
                        
                        // Ocultar shader canvas por defecto
                        if (shaderCanvas) {
                            shaderCanvas.style.display = 'none';
                        }
                        
                        switch(this.backgroundType) {
                            case 'color':
                                body.style.background = this.currentBackground;
                                body.style.backgroundImage = 'none';
                                if (shaderCanvas) shaderCanvas.style.display = 'none';
                                break;
                                
                            case 'image':
                                body.style.backgroundImage = `url("${this.currentBackground}")`;
                                body.style.backgroundSize = 'cover';
                                body.style.backgroundPosition = 'center';
                                body.style.backgroundAttachment = 'fixed';
                                if (shaderCanvas) shaderCanvas.style.display = 'none';
                                break;
                                
                            case 'shader':
                                // Ocultar imagen de fondo
                                body.style.backgroundImage = 'none';
                                body.style.background = '#000';
                                
                                // Mostrar y aplicar shader
                                if (shaderCanvas) {
                                    shaderCanvas.style.display = 'block';
                                    XP7.Shaders.applyShader(this.currentBackground);
                                }
                                break;
                                
                            case 'gradient':
                                body.style.background = this.currentBackground;
                                body.style.backgroundImage = 'none';
                                if (shaderCanvas) shaderCanvas.style.display = 'none';
                                break;
                        }
                    },
                    
                    // Agregar imagen de fondo
                    addImageBackground: async function(file) {
                        return new Promise((resolve, reject) => {
                            const reader = new FileReader();
                            reader.onload = (e) => {
                                const imageData = e.target.result;
                                const fileName = `background_${Date.now()}.${file.name.split('.').pop()}`;
                                const path = `/User/Backgrounds/${fileName}`;
                                
                                // Crear directorio si no existe
                                if (!XP7.fileSystem.structure['/User/Backgrounds']) {
                                    XP7.fileSystem.structure['/User/Backgrounds'] = [];
                                    XP7.fileSystem.saveStructure();
                                }
                                
                                XP7.fileSystem.saveImage(path, imageData)
                                    .then(() => {
                                        const background = {
                                            name: file.name,
                                            path: path,
                                            type: 'image',
                                            data: imageData,
                                            date: new Date().toISOString()
                                        };
                                        
                                        this.backgrounds.push(background);
                                        localStorage.setItem('xp7_backgrounds', JSON.stringify(this.backgrounds));
                                        
                                        resolve(background);
                                    })
                                    .catch(reject);
                            };
                            reader.readAsDataURL(file);
                        });
                    },
                    
                    // Eliminar fondo
                    removeBackground: function(index) {
                        if (index >= 0 && index < this.backgrounds.length) {
                            this.backgrounds.splice(index, 1);
                            localStorage.setItem('xp7_backgrounds', JSON.stringify(this.backgrounds));
                            return true;
                        }
                        return false;
                    }
                };
                
                // 4. APLICACIONES NUEVAS
                XP7.apps['background-manager'] = {
                    name: 'Gestor de Fondos',
                    icon: 'üé®',
                    description: 'Gestiona im√°genes, shaders y efectos de fondo',
                    category: 'Sistema',
                    launch: () => XP7Apps.openBackgroundManager()
                };
                
                XP7.apps['shader-editor'] = {
                    name: 'Editor de Shaders',
                    icon: 'üîÑ',
                    description: 'Crea y edita shaders GLSL personalizados',
                    category: 'Herramientas',
                    launch: () => XP7Apps.openShaderEditor()
                };
                
                XP7.apps['gallery'] = {
                    name: 'Galer√≠a de Fondos',
                    icon: 'üñºÔ∏è',
                    description: 'Explora y aplica fondos predefinidos',
                    category: 'Personalizaci√≥n',
                    launch: () => XP7Apps.openGallery()
                };
                
                // 5. ACTUALIZAR INTERFAZ DE SISTEMA
                const updateStartMenu = () => {
                    const startMenu = document.getElementById('start-menu');
                    if (startMenu) {
                        const startContent = startMenu.querySelector('.start-content');
                        if (startContent) {
                            // Verificar si ya existe la categor√≠a Personalizaci√≥n
                            const existingColumns = startContent.querySelectorAll('.start-column');
                            let hasPersonalization = false;
                            
                            existingColumns.forEach(column => {
                                if (column.querySelector('h3') && column.querySelector('h3').textContent === 'Personalizaci√≥n') {
                                    hasPersonalization = true;
                                }
                            });
                            
                            if (!hasPersonalization) {
                                // A√±adir categor√≠a de Personalizaci√≥n
                                const personalizationColumn = document.createElement('div');
                                personalizationColumn.className = 'start-column';
                                personalizationColumn.innerHTML = `
                                    <h3>Personalizaci√≥n</h3>
                                    <div class="start-item" data-app="background-manager">
                                        <span class="start-icon">üé®</span>
                                        <span class="start-text">Gestor de Fondos</span>
                                    </div>
                                    <div class="start-item" data-app="shader-editor">
                                        <span class="start-icon">üîÑ</span>
                                        <span class="start-text">Editor de Shaders</span>
                                    </div>
                                    <div class="start-item" data-app="gallery">
                                        <span class="start-icon">üñºÔ∏è</span>
                                        <span class="start-text">Galer√≠a</span>
                                    </div>
                                `;
                                
                                startContent.appendChild(personalizationColumn);
                                
                                // Actualizar event listeners
                                document.querySelectorAll('.start-item[data-app]').forEach(item => {
                                    item.addEventListener('click', (e) => {
                                        if (!e.target.closest('.start-item')) return;
                                        const app = item.dataset.app;
                                        XP7Apps.launch(app);
                                        document.getElementById('start-menu').classList.remove('active');
                                    });
                                });
                            }
                        }
                    }
                };
                
                // 6. A√ëADIR ICONOS AL ESCRITORIO
                const addDesktopIcons = () => {
                    const desktop = document.getElementById('desktop');
                    if (desktop) {
                        // Verificar si ya existen los iconos
                        const existingIcons = Array.from(desktop.querySelectorAll('.desktop-icon .name'))
                            .map(span => span.textContent);
                        
                        const newApps = [
                            { id: 'background-manager', name: 'Gestor de Fondos', icon: 'üé®' },
                            { id: 'shader-editor', name: 'Editor de Shaders', icon: 'üîÑ' },
                            { id: 'gallery', name: 'Galer√≠a de Fondos', icon: 'üñºÔ∏è' }
                        ];
                        
                        newApps.forEach(app => {
                            if (!existingIcons.includes(app.name)) {
                                const icon = document.createElement('div');
                                icon.className = 'desktop-icon';
                                icon.innerHTML = `
                                    <div class="icon">${app.icon}</div>
                                    <div class="name">${app.name}</div>
                                `;
                                icon.addEventListener('dblclick', () => XP7Apps.launch(app.id));
                                desktop.appendChild(icon);
                            }
                        });
                    }
                };
                
                // 7. INICIALIZAR TODO
                setTimeout(() => {
                    XP7.Shaders.init();
                    XP7.Background.init();
                    updateStartMenu();
                    addDesktopIcons();
                    
                    console.log('‚úÖ Sistema de fondos instalado correctamente');
                    XP7.showNotification('Sistema de Fondos', 
                        'Sistema de fondos din√°micos instalado correctamente', 
                        'success');
                }, 1000);
            }
        };

        const XP7Window = {
            windows: [],
            
            create(options) {
                const windowId = 'window_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                const windowElement = document.createElement('div');
                windowElement.className = 'window';
                windowElement.id = windowId;
                windowElement.style.width = (options.width || 600) + 'px';
                windowElement.style.height = (options.height || 400) + 'px';
                windowElement.style.left = options.left || '50px';
                windowElement.style.top = options.top || '50px';
                windowElement.style.zIndex = XP7.currentZIndex++;
                
                windowElement.innerHTML = `
                    <div class="window-header">
                        <div class="window-title">
                            <span>${options.icon || 'üíª'}</span>
                            <span>${options.title || 'Ventana'}</span>
                        </div>
                        <div class="window-controls">
                            <button class="window-control minimize" title="Minimizar">üóï</button>
                            <button class="window-control maximize" title="Maximizar">üóó</button>
                            <button class="window-control close" title="Cerrar">‚úï</button>
                        </div>
                    </div>
                    <div class="window-content">${options.content || ''}</div>
                `;
                
                document.getElementById('windows-container').appendChild(windowElement);
                
                const header = windowElement.querySelector('.window-header');
                const minimizeBtn = windowElement.querySelector('.minimize');
                const maximizeBtn = windowElement.querySelector('.maximize');
                const closeBtn = windowElement.querySelector('.close');
                
                let isDragging = false;
                let dragOffset = { x: 0, y: 0 };
                
                header.addEventListener('mousedown', (e) => {
                    isDragging = true;
                    dragOffset = {
                        x: e.clientX - windowElement.offsetLeft,
                        y: e.clientY - windowElement.offsetTop
                    };
                    windowElement.style.zIndex = XP7.currentZIndex++;
                });
                
                document.addEventListener('mousemove', (e) => {
                    if (isDragging) {
                        windowElement.style.left = (e.clientX - dragOffset.x) + 'px';
                        windowElement.style.top = (e.clientY - dragOffset.y) + 'px';
                    }
                });
                
                document.addEventListener('mouseup', () => {
                    isDragging = false;
                });
                
                minimizeBtn.addEventListener('click', () => {
                    windowElement.style.display = 'none';
                    setTimeout(() => {
                        windowElement.style.display = 'block';
                    }, 1000);
                });
                
                maximizeBtn.addEventListener('click', () => {
                    if (windowElement.classList.contains('maximized')) {
                        windowElement.classList.remove('maximized');
                        windowElement.style.width = (options.width || 600) + 'px';
                        windowElement.style.height = (options.height || 400) + 'px';
                        windowElement.style.left = options.left || '50px';
                        windowElement.style.top = options.top || '50px';
                    } else {
                        windowElement.classList.add('maximized');
                        windowElement.style.width = 'calc(100vw - 20px)';
                        windowElement.style.height = 'calc(100vh - 60px)';
                        windowElement.style.left = '10px';
                        windowElement.style.top = '10px';
                    }
                });
                
                closeBtn.addEventListener('click', () => {
                    windowElement.remove();
                    const index = this.windows.indexOf(windowId);
                    if (index > -1) {
                        this.windows.splice(index, 1);
                    }
                });
                
                windowElement.addEventListener('mousedown', () => {
                    windowElement.style.zIndex = XP7.currentZIndex++;
                });
                
                this.windows.push(windowId);
                return windowElement;
            }
        };

        const XP7Apps = {
            launch(appId) {
                // Primero verifica si es una aplicaci√≥n del sistema
                switch(appId) {
                    case 'explorer':
                        this.openExplorer();
                        break;
                    case 'notepad':
                        this.openNotepad();
                        break;
                    case 'calculator':
                        this.openCalculator();
                        break;
                    case 'package-manager':
                        this.openPackageManager();
                        break;
                    case 'storage-manager':
                        this.openStorageManager();
                        break;
                    case 'file-selector':
                        this.openFileSelector();
                        break;
                    case 'settings':
                        this.openSettings();
                        break;
                    case 'terminal':
                        this.openTerminal();
                        break;
                    case 'act-manager':
                        this.openACTManager();
                        break;
                    case 'background-manager':
                        this.openBackgroundManager();
                        break;
                    case 'shader-editor':
                        this.openShaderEditor();
                        break;
                    case 'gallery':
                        this.openGallery();
                        break;
                    case 'pak-creator':
                        this.openPakCreator();
                        break;
                    default:
                        // Si no es una aplicaci√≥n del sistema, verifica si es una aplicaci√≥n personalizada
                        if (XP7.apps[appId]) {
                            // Si la aplicaci√≥n tiene una funci√≥n launch, usarla
                            const app = XP7.apps[appId];
                            if (app.launch && typeof app.launch === 'function') {
                                app.launch();
                            } else {
                                // Si no, crear una ventana gen√©rica
                                this.openCustomApp(appId);
                            }
                        } else {
                            XP7.showNotification('Error', 'Aplicaci√≥n "' + appId + '" no encontrada', 'error');
                        }
                }
            },
            
            openCustomApp(appId) {
                const app = XP7.apps[appId];
                if (!app) {
                    XP7.showNotification('Error', 'Aplicaci√≥n no encontrada', 'error');
                    return;
                }
                
                // Crear una ventana gen√©rica para aplicaciones personalizadas
                const window = XP7Window.create({
                    title: app.name,
                    icon: app.icon,
                    width: app.width || 600,
                    height: app.height || 400,
                    content: `
                        <div style="padding: 20px; height: 100%; overflow: auto;">
                            <h2>${app.name}</h2>
                            <p>${app.description || 'Aplicaci√≥n personalizada'}</p>
                            <div style="margin-top: 20px;">
                                ${app.content || '<p>Aplicaci√≥n instalada correctamente</p>'}
                            </div>
                        </div>
                    `
                });
            },
            
            async openExplorer() {
                try {
                    const entries = await XP7.fileSystem.listDirectory('/');
                    
                    const fileList = entries.map(entry => {
                        return `
                            <div class="file-item" data-name="${entry.name}" data-kind="${entry.kind}">
                                <div class="file-icon">${entry.icon}</div>
                                <div class="file-name">${entry.name}</div>
                                <div class="file-info">${entry.kind === 'directory' ? 'Carpeta' : entry.type}</div>
                            </div>
                        `;
                    }).join('');
                    
                    const window = XP7Window.create({
                        title: 'Explorador de Archivos',
                        icon: 'üìÅ',
                        width: 800,
                        height: 500,
                        content: `
                            <div class="explorer">
                                <div class="explorer-toolbar">
                                    <button class="btn-primary" id="explorer-back">‚Üê</button>
                                    <button class="btn-primary" id="explorer-forward">‚Üí</button>
                                    <input type="text" id="explorer-path" value="/" style="flex: 1; background: rgba(255,255,255,0.1); border: none; color: white; padding: 5px 10px; border-radius: 3px;">
                                    <button class="btn-secondary" id="explorer-refresh">‚Üª</button>
                                    <button class="btn-primary" id="explorer-new-folder">üìÅ Nuevo</button>
                                    <button class="btn-primary" id="explorer-upload">üì§ Subir</button>
                                    <button class="btn-secondary" id="explorer-mode">
                                        ${XP7.fileSystem.mode === 'localStorage' ? 'üíæ' : 'üìÇ'}
                                    </button>
                                </div>
                                <div class="explorer-content">
                                    <div class="explorer-sidebar">
                                        <h3>Ubicaciones</h3>
                                        <div class="pm-list">
                                            <div class="pm-item active" data-path="/">
                                                <span>üè†</span> Ra√≠z
                                            </div>
                                            <div class="pm-item" data-path="/System">
                                                <span>‚öôÔ∏è</span> Sistema
                                            </div>
                                            <div class="pm-item" data-path="/Apps">
                                                <span>üì¶</span> Aplicaciones
                                            </div>
                                            <div class="pm-item" data-path="/User">
                                                <span>üë§</span> Usuario
                                            </div>
                                            <div class="pm-item" data-path="/User/Documents">
                                                <span>üìÑ</span> Documentos
                                            </div>
                                            <div class="pm-item" data-path="/System/Updates">
                                                <span>üîÑ</span> Actualizaciones
                                            </div>
                                        </div>
                                    </div>
                                    <div class="explorer-main">
                                        <h3>Archivos y Carpetas</h3>
                                        <div class="file-list" id="explorer-files">
                                            ${fileList}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `
                    });
                    
                    // El resto del c√≥digo del explorador...
                    // (Por brevedad, mantengo la funcionalidad b√°sica)
                    
                } catch (error) {
                    XP7.showNotification('Error', 'No se pudo abrir el explorador: ' + error.message, 'error');
                }
            },
            
            openNotepad() {
                const window = XP7Window.create({
                    title: 'Bloc de Notas',
                    icon: 'üìù',
                    width: 600,
                    height: 400,
                    content: `
                        <div class="editor">
                            <div class="editor-toolbar">
                                <button class="btn-primary" id="notepad-new">
                                    <span>üìÑ</span> Nuevo
                                </button>
                                <button class="btn-primary" id="notepad-save">
                                    <span>üíæ</span> Guardar
                                </button>
                                <button class="btn-secondary" id="notepad-open">
                                    <span>üìÇ</span> Abrir
                                </button>
                            </div>
                            <div class="editor-content">
                                <textarea id="notepad-textarea" placeholder="Escribe aqu√≠..." style="width: 100%; height: 300px; background: rgba(255,255,255,0.05); color: white; border: none; padding: 10px; font-family: monospace;"></textarea>
                            </div>
                        </div>
                    `
                });
                
                const content = window.querySelector('.window-content');
                const textarea = content.querySelector('#notepad-textarea');
                
                content.querySelector('#notepad-new').addEventListener('click', () => {
                    textarea.value = '';
                });
                
                content.querySelector('#notepad-save').addEventListener('click', async () => {
                    const content = textarea.value;
                    if (!content.trim()) {
                        XP7.showNotification('Notepad', 'El documento est√° vac√≠o', 'warning');
                        return;
                    }
                    
                    const fileName = prompt('Nombre del archivo:', 'documento.txt');
                    if (fileName) {
                        await XP7.fileSystem.writeFile('/User/Documents/' + fileName, content);
                        XP7.showNotification('Notepad', 'Archivo "' + fileName + '" guardado', 'success');
                    }
                });
                
                content.querySelector('#notepad-open').addEventListener('click', () => {
                    const input = document.createElement('input');
                    input.type = 'file';
                    input.accept = '.txt,.js,.json,.html,.css';
                    
                    input.addEventListener('change', async (e) => {
                        const file = e.target.files[0];
                        if (file) {
                            const reader = new FileReader();
                            reader.onload = (event) => {
                                textarea.value = event.target.result;
                                XP7.showNotification('Notepad', 'Archivo "' + file.name + '" cargado', 'info');
                            };
                            reader.readAsText(file);
                        }
                    });
                    
                    input.click();
                });
            },
            
            openCalculator() {
                let currentInput = '0';
                let previousInput = '';
                let operation = null;
                
                const window = XP7Window.create({
                    title: 'Calculadora',
                    icon: 'üßÆ',
                    width: 320,
                    height: 450,
                    content: `
                        <div class="calculator">
                            <div class="calc-display" id="calc-display">0</div>
                            <div class="calc-buttons">
                                <button class="calc-button clear" data-action="clear">C</button>
                                <button class="calc-button" data-action="delete">‚å´</button>
                                <button class="calc-button operator" data-action="divide">√∑</button>
                                <button class="calc-button operator" data-action="multiply">√ó</button>
                                
                                <button class="calc-button" data-number="7">7</button>
                                <button class="calc-button" data-number="8">8</button>
                                <button class="calc-button" data-number="9">9</button>
                                <button class="calc-button operator" data-action="subtract">‚àí</button>
                                
                                <button class="calc-button" data-number="4">4</button>
                                <button class="calc-button" data-number="5">5</button>
                                <button class="calc-button" data-number="6">6</button>
                                <button class="calc-button operator" data-action="add">+</button>
                                
                                <button class="calc-button" data-number="1">1</button>
                                <button class="calc-button" data-number="2">2</button>
                                <button class="calc-button" data-number="3">3</button>
                                <button class="calc-button operator" data-action="equals" style="grid-row: span 2;">=</button>
                                
                                <button class="calc-button" data-number="0" style="grid-column: span 2;">0</button>
                                <button class="calc-button" data-action="decimal">.</button>
                            </div>
                        </div>
                    `
                });
                
                const content = window.querySelector('.window-content');
                const display = content.querySelector('#calc-display');
                
                function updateDisplay() {
                    display.textContent = currentInput;
                }
                
                function appendNumber(number) {
                    if (currentInput === '0' || currentInput === 'Error') {
                        currentInput = number;
                    } else {
                        currentInput += number;
                    }
                    updateDisplay();
                }
                
                function chooseOperation(op) {
                    if (currentInput === '') return;
                    if (previousInput !== '') {
                        compute();
                    }
                    operation = op;
                    previousInput = currentInput;
                    currentInput = '';
                }
                
                function compute() {
                    let computation;
                    const prev = parseFloat(previousInput);
                    const current = parseFloat(currentInput);
                    
                    if (isNaN(prev) || isNaN(current)) return;
                    
                    switch (operation) {
                        case '+':
                            computation = prev + current;
                            break;
                        case '-':
                            computation = prev - current;
                            break;
                        case '√ó':
                            computation = prev * current;
                            break;
                        case '√∑':
                            if (current === 0) {
                                currentInput = 'Error';
                                updateDisplay();
                                return;
                            }
                            computation = prev / current;
                            break;
                        default:
                            return;
                    }
                    
                    currentInput = computation.toString();
                    operation = undefined;
                    previousInput = '';
                    updateDisplay();
                }
                
                function clearCalculator() {
                    currentInput = '0';
                    previousInput = '';
                    operation = undefined;
                    updateDisplay();
                }
                
                function deleteLast() {
                    if (currentInput.length === 1) {
                        currentInput = '0';
                    } else {
                        currentInput = currentInput.slice(0, -1);
                    }
                    updateDisplay();
                }
                
                content.querySelectorAll('[data-number]').forEach(button => {
                    button.addEventListener('click', () => {
                        appendNumber(button.dataset.number);
                    });
                });
                
                content.querySelectorAll('[data-action]').forEach(button => {
                    button.addEventListener('click', () => {
                        const action = button.dataset.action;
                        
                        switch (action) {
                            case 'clear':
                                clearCalculator();
                                break;
                            case 'delete':
                                deleteLast();
                                break;
                            case 'decimal':
                                if (!currentInput.includes('.')) {
                                    currentInput += '.';
                                    updateDisplay();
                                }
                                break;
                            case 'add':
                                chooseOperation('+');
                                break;
                            case 'subtract':
                                chooseOperation('-');
                                break;
                            case 'multiply':
                                chooseOperation('√ó');
                                break;
                            case 'divide':
                                chooseOperation('√∑');
                                break;
                            case 'equals':
                                compute();
                                break;
                        }
                    });
                });
            },
            
            openPackageManager() {
                const window = XP7Window.create({
                    title: 'Gestor de Paquetes',
                    icon: 'üì¶',
                    width: 700,
                    height: 500,
                    content: `
                        <div class="package-manager">
                            <div class="pm-header">
                                <h1><span>üì¶</span> Gestor de Paquetes XP7</h1>
                                <div class="pm-actions">
                                    <button class="btn-primary" id="install-pak">
                                        üì• Instalar .PAK
                                    </button>
                                    <button class="btn-secondary" id="refresh-packages">
                                        ‚Üª Actualizar
                                    </button>
                                </div>
                            </div>
                            <div class="pm-body">
                                <div class="pm-sidebar">
                                    <h3>Categor√≠as</h3>
                                    <div class="pm-list">
                                        <div class="pm-item active" data-category="all">
                                            <span>üì¶</span> Todos
                                        </div>
                                        <div class="pm-item" data-category="system">
                                            <span>‚öôÔ∏è</span> Sistema
                                        </div>
                                        <div class="pm-item" data-category="apps">
                                            <span>üíª</span> Aplicaciones
                                        </div>
                                        <div class="pm-item" data-category="custom">
                                            <span>üé®</span> Personalizadas
                                        </div>
                                    </div>
                                </div>
                                <div class="pm-content">
                                    <h3>Aplicaciones Instaladas</h3>
                                    <div id="packages-list" style="margin-top: 10px;">
                                        <p style="color: rgba(255,255,255,0.5); text-align: center; padding: 20px;">
                                            Cargando aplicaciones...
                                        </p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `
                });
                
                const content = window.querySelector('.window-content');
                
                function loadPackages() {
                    const packagesList = content.querySelector('#packages-list');
                    const apps = XP7.apps;
                    
                    if (Object.keys(apps).length === 0) {
                        packagesList.innerHTML = `
                            <p style="color: rgba(255,255,255,0.5); text-align: center; padding: 20px;">
                                No hay aplicaciones instaladas
                            </p>
                        `;
                        return;
                    }
                    
                    let html = '';
                    Object.entries(apps).forEach(([id, app]) => {
                        html += `
                            <div class="pm-item" style="margin-bottom: 10px;">
                                <div style="display: flex; align-items: center; gap: 10px; width: 100%;">
                                    <div style="font-size: 24px;">${app.icon}</div>
                                    <div style="flex: 1;">
                                        <div style="font-weight: 500;">${app.name}</div>
                                        <div style="font-size: 12px; color: rgba(255,255,255,0.6);">
                                            ${app.description || 'Sin descripci√≥n'}
                                            <div style="font-size: 10px; margin-top: 2px; color: #4CAF50;">
                                                ID: ${id}
                                            </div>
                                        </div>
                                    </div>
                                    <div>
                                        <button class="btn-secondary launch-app-btn" data-app="${id}"
                                                style="padding: 3px 8px; font-size: 12px;">
                                            Abrir
                                        </button>
                                    </div>
                                </div>
                            </div>
                        `;
                    });
                    
                    packagesList.innerHTML = html;
                    
                    // A√±adir event listeners a los botones de abrir
                    packagesList.querySelectorAll('.launch-app-btn').forEach(btn => {
                        btn.addEventListener('click', () => {
                            const appId = btn.dataset.app;
                            XP7Apps.launch(appId);
                        });
                    });
                }
                
                // CORREGIDO: Funci√≥n de instalaci√≥n de paquetes .pak
                content.querySelector('#install-pak').addEventListener('click', () => {
                    const input = document.createElement('input');
                    input.type = 'file';
                    input.accept = '.pak,.json';
                    
                    input.addEventListener('change', async (e) => {
                        const file = e.target.files[0];
                        if (!file) return;
                        
                        const reader = new FileReader();
                        reader.onload = async (event) => {
                            try {
                                let pakData;
                                
                                // Intentar parsear como JSON
                                try {
                                    pakData = JSON.parse(event.target.result);
                                } catch (parseError) {
                                    throw new Error('El archivo no es un JSON v√°lido');
                                }
                                
                                // Validar campos obligatorios
                                const requiredFields = ['name', 'icon'];
                                for (const field of requiredFields) {
                                    if (!pakData[field]) {
                                        throw new Error(`Campo requerido faltante: ${field}`);
                                    }
                                }
                                
                                // Si no tiene ID, generarlo del nombre
                                const appId = pakData.id || pakData.name
                                    .toLowerCase()
                                    .replace(/[^a-z0-9]/g, '-')
                                    .replace(/-+/g, '-')
                                    .replace(/^-|-$/g, '');
                                
                                // Si ya existe, a√±adir timestamp
                                const finalAppId = XP7.apps[appId] ? 
                                    `${appId}-${Date.now()}` : appId;
                                
                                // Crear la aplicaci√≥n
                                XP7.apps[finalAppId] = {
                                    name: pakData.name,
                                    icon: pakData.icon,
                                    description: pakData.description || 'Aplicaci√≥n instalada desde paquete .pak',
                                    category: pakData.category || 'Aplicaciones',
                                    width: pakData.width || 600,
                                    height: pakData.height || 400,
                                    content: pakData.content || `
                                        <div style="padding: 20px;">
                                            <h2>${pakData.name}</h2>
                                            <p>${pakData.description || 'Aplicaci√≥n instalada correctamente'}</p>
                                            ${pakData.author ? `<p><small>Autor: ${pakData.author}</small></p>` : ''}
                                            ${pakData.version ? `<p><small>Versi√≥n: ${pakData.version}</small></p>` : ''}
                                        </div>
                                    `
                                };
                                
                                // Actualizar el escritorio
                                XP7.updateDesktopIcons();
                                
                                // Recargar la lista de paquetes
                                loadPackages();
                                
                                // Mostrar notificaci√≥n de √©xito
                                XP7.showNotification('Paquete Instalado', 
                                    `"${pakData.name}" instalado correctamente (ID: ${finalAppId})`, 
                                    'success');
                                    
                                // Guardar el paquete en el sistema de archivos
                                try {
                                    const pakFileName = finalAppId + '.pak';
                                    await XP7.fileSystem.writeFile(`/Apps/${pakFileName}`, event.target.result);
                                } catch (fsError) {
                                    console.warn('No se pudo guardar el archivo .pak:', fsError);
                                }
                                
                            } catch (error) {
                                console.error('Error instalando paquete:', error);
                                XP7.showNotification('Error', 
                                    `Error instalando paquete: ${error.message}`, 
                                    'error');
                            }
                        };
                        
                        reader.readAsText(file);
                    });
                    
                    input.click();
                });
                
                content.querySelector('#refresh-packages').addEventListener('click', loadPackages);
                
                content.querySelectorAll('.pm-item[data-category]').forEach(item => {
                    item.addEventListener('click', () => {
                        content.querySelectorAll('.pm-item').forEach(i => i.classList.remove('active'));
                        item.classList.add('active');
                        loadPackages();
                    });
                });
                
                loadPackages();
            },
            
            openStorageManager() {
                const window = XP7Window.create({
                    title: 'Storage Manager',
                    icon: 'üíæ',
                    width: 700,
                    height: 500,
                    content: `
                        <div style="padding: 20px;">
                            <h2>üíæ Storage Manager</h2>
                            <p style="color: rgba(255,255,255,0.7); margin-bottom: 20px;">
                                Gesti√≥n de almacenamiento local del sistema
                            </p>
                            
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                                <div style="padding: 15px; background: rgba(255,255,255,0.05); border-radius: 8px;">
                                    <h3 style="color: #4CAF50; margin-bottom: 10px;">üìä Almacenamiento</h3>
                                    <div id="storage-info">
                                        <p>Cargando informaci√≥n...</p>
                                    </div>
                                </div>
                                
                                <div style="padding: 15px; background: rgba(255,255,255,0.05); border-radius: 8px;">
                                    <h3 style="color: #2196F3; margin-bottom: 10px;">üìÅ Sistema de Archivos</h3>
                                    <div id="fs-info">
                                        <p>Modo: <strong>${XP7.fileSystem.mode}</strong></p>
                                        <p>Directorios: <span id="dir-count">0</span></p>
                                        <p>Archivos: <span id="file-count">0</span></p>
                                        <p>Tama√±o total: <span id="total-size">0 KB</span></p>
                                    </div>
                                </div>
                            </div>
                            
                            <div style="margin: 20px 0;">
                                <h3 style="color: #ff9800; margin-bottom: 10px;">üõ†Ô∏è Herramientas</h3>
                                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px;">
                                    <button class="btn-primary" id="btn-refresh">
                                        üîÑ Actualizar
                                    </button>
                                    <button class="btn-secondary" id="btn-export">
                                        üì§ Exportar Todo
                                    </button>
                                    <button class="btn-secondary" id="btn-import">
                                        üì• Importar
                                    </button>
                                    <button class="btn-secondary" id="btn-cleanup">
                                        üßπ Limpiar Cache
                                    </button>
                                    <button class="btn-secondary" id="btn-structure">
                                        üìã Ver Estructura
                                    </button>
                                    <button class="btn-danger" id="btn-reset">
                                        üóëÔ∏è Restablecer
                                    </button>
                                </div>
                            </div>
                        </div>
                    `
                });
                
                const content = window.querySelector('.window-content');
                
                function updateStorageInfo() {
                    try {
                        const info = XP7.fileSystem.getStorageInfo();
                        const structure = XP7.fileSystem.structure;
                        
                        const storageHTML = `
                            <div style="margin-bottom: 10px;">
                                <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                                    <span>Uso:</span>
                                    <span><strong>${info.usedMB} MB</strong> / ${info.maxMB} MB</span>
                                </div>
                                <div style="width: 100%; height: 10px; background: rgba(255,255,255,0.1); border-radius: 5px; overflow: hidden;">
                                    <div style="width: ${info.percentage}%; height: 100%; background: linear-gradient(90deg, #4CAF50, #45a049); border-radius: 5px;"></div>
                                </div>
                                <div style="margin-top: 5px; font-size: 11px; color: rgba(255,255,255,0.6);">
                                    ${info.percentage}% utilizado
                                </div>
                            </div>
                            <p style="margin-top: 10px;">Archivos del sistema: <strong>${info.fileCount}</strong></p>
                        `;
                        
                        content.querySelector('#storage-info').innerHTML = storageHTML;
                        
                        const dirCount = Object.keys(structure).length;
                        let totalFiles = 0;
                        Object.values(structure).forEach(files => {
                            totalFiles += files.length;
                        });
                        
                        content.querySelector('#dir-count').textContent = dirCount;
                        content.querySelector('#file-count').textContent = totalFiles;
                        content.querySelector('#total-size').textContent = info.usedMB + ' MB';
                        
                    } catch (error) {
                        console.error('Error updating storage info:', error);
                    }
                }
                
                content.querySelector('#btn-refresh').addEventListener('click', () => {
                    updateStorageInfo();
                    XP7.showNotification('Storage Manager', 'Informaci√≥n actualizada', 'info');
                });
                
                content.querySelector('#btn-export').addEventListener('click', () => {
                    try {
                        const exportData = XP7.fileSystem.exportFileSystem();
                        const blob = new Blob([exportData], { type: 'application/json' });
                        const url = URL.createObjectURL(blob);
                        
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = 'xp7-backup-' + new Date().toISOString().split('T')[0] + '.json';
                        document.body.appendChild(a);
                        a.click();
                        document.body.removeChild(a);
                        
                        URL.revokeObjectURL(url);
                        
                        XP7.showNotification('Exportaci√≥n', 'Sistema de archivos exportado', 'success');
                    } catch (error) {
                        XP7.showNotification('Error', 'No se pudo exportar', 'error');
                    }
                });
                
                content.querySelector('#btn-import').addEventListener('click', () => {
                    const input = document.createElement('input');
                    input.type = 'file';
                    input.accept = '.json';
                    
                    input.addEventListener('change', (e) => {
                        const file = e.target.files[0];
                        if (!file) return;
                        
                        const reader = new FileReader();
                        reader.onload = (event) => {
                            try {
                                const success = XP7.fileSystem.importFileSystem(event.target.result);
                                
                                if (success) {
                                    updateStorageInfo();
                                    XP7.showNotification('Importaci√≥n', 'Sistema importado', 'success');
                                } else {
                                    XP7.showNotification('Error', 'Formato inv√°lido', 'error');
                                }
                            } catch (error) {
                                XP7.showNotification('Error', 'Error importando', 'error');
                            }
                        };
                        
                        reader.readAsText(file);
                    });
                    
                    input.click();
                });
                
                updateStorageInfo();
            },
            
            openFileSelector() {
                const fsAvailable = 'showDirectoryPicker' in window;
                const isFileSystemMode = XP7.fileSystem.mode === 'fileSystem';
                
                const fsWindow = XP7Window.create({
                    title: 'Selector de Sistema de Archivos',
                    icon: 'üìÇ',
                    width: 600,
                    height: 450,
                    content: `
                        <div class="fs-selector">
                            <h2>üìÇ Selector de Sistema de Archivos</h2>
                            <p style="color: rgba(255,255,255,0.7); margin-bottom: 20px;">
                                Elige c√≥mo quieres almacenar tus archivos
                            </p>
                            
                            <div class="fs-option ${XP7.fileSystem.mode === 'localStorage' ? 'selected' : ''}" id="option-local">
                                <div class="fs-option-icon">üíæ</div>
                                <div class="fs-option-info">
                                    <div class="fs-option-title">Local Storage (Actual)</div>
                                    <div class="fs-option-desc">Archivos guardados en el navegador. Se pierden al limpiar cache.</div>
                                </div>
                                <span class="fs-status ${XP7.fileSystem.mode === 'localStorage' ? 'available' : ''}">
                                    ${XP7.fileSystem.mode === 'localStorage' ? '‚úÖ Activo' : ''}
                                </span>
                            </div>
                            
                            <div class="fs-option ${isFileSystemMode ? 'selected' : ''}" id="option-fsapi">
                                <div class="fs-option-icon">üìÇ</div>
                                <div class="fs-option-info">
                                    <div class="fs-option-title">File System API</div>
                                    <div class="fs-option-desc">Accede a archivos reales en tu computadora. Solo Chrome/Edge.</div>
                                </div>
                                <span class="fs-status ${fsAvailable ? 'available' : 'unavailable'}">
                                    ${fsAvailable ? (isFileSystemMode ? '‚úÖ Activo' : '‚úÖ Disponible') : '‚ùå No disponible'}
                                </span>
                            </div>
                            
                            <div id="fs-status-info" style="margin-top: 20px; padding: 15px; background: rgba(255,255,255,0.05); border-radius: 8px;">
                                <h3 style="color: #4CAF50; margin-bottom: 10px;">Estado Actual</h3>
                                <p id="current-mode">Modo: <strong>${XP7.fileSystem.mode}</strong></p>
                                ${isFileSystemMode && XP7.fileSystem.directoryHandle ? 
                                  '<p>Directorio: <strong>' + XP7.fileSystem.directoryHandle.name + '</strong></p>' : 
                                  ''}
                                <p id="fs-capabilities">${fsAvailable ? 
                                  '<span style="color: #4CAF50;">‚úÖ File System API disponible</span>' : 
                                  '<span style="color: #f44336;">‚ùå File System API no disponible en este navegador</span>'}</p>
                            </div>
                            
                            <div style="margin-top: 20px; display: flex; gap: 10px; justify-content: center;">
                                <button class="btn-primary" id="btn-activate-fs" 
                                        ${!fsAvailable || isFileSystemMode ? 'disabled' : ''}>
                                    üöÄ Activar File System API
                                </button>
                                <button class="btn-secondary" id="btn-switch-local"
                                        ${XP7.fileSystem.mode === 'localStorage' ? 'disabled' : ''}>
                                    üîÑ Cambiar a Local Storage
                                </button>
                            </div>
                            
                            ${XP7.fileSystem.mode === 'localStorage' ? `
                            <div style="margin-top: 20px; padding: 15px; background: rgba(255,255,255,0.05); border-radius: 8px;">
                                <h3 style="color: #2196F3; margin-bottom: 10px;">‚ö†Ô∏è Advertencia</h3>
                                <p>En Local Storage, tus archivos se guardan en el navegador y pueden perderse si limpias el cache. 
                                Te recomendamos exportar regularmente tus datos.</p>
                                <div style="margin-top: 10px; display: flex; gap: 10px;">
                                    <button class="btn-secondary" id="btn-export-data">üì§ Exportar Datos</button>
                                    <button class="btn-secondary" id="btn-import-data">üì• Importar Datos</button>
                                </div>
                            </div>
                            ` : ''}
                        </div>
                    `
                });
                
                const content = fsWindow.querySelector('.window-content');
                
                content.querySelector('#btn-activate-fs').addEventListener('click', async () => {
                    try {
                        XP7.showNotification('File System', 'Selecciona un directorio para usar...', 'info');
                        const handle = await XP7.fileSystem.enableFileSystemAPI();
                        const migrate = confirm('¬øDeseas migrar tus archivos existentes al nuevo directorio?');
                        if (migrate) {
                            XP7.showNotification('Migraci√≥n', 'Migrando archivos...', 'info');
                        }
                        XP7.showNotification('File System', 
                            'File System API activada en: ' + handle.name, 
                            'success');
                        fsWindow.querySelector('.window-control.close').click();
                    } catch (error) {
                        if (error.name !== 'AbortError') {
                            XP7.showNotification('Error', 'No se pudo activar File System API: ' + error.message, 'error');
                        }
                    }
                });
                
                content.querySelector('#btn-switch-local').addEventListener('click', () => {
                    if (confirm('¬øCambiar a Local Storage?\n\nNota: Los archivos f√≠sicos permanecer√°n en tu directorio seleccionado, pero el sistema usar√° Local Storage.')) {
                        XP7.fileSystem.mode = 'localStorage';
                        XP7.fileSystem.directoryHandle = null;
                        localStorage.setItem('xp7_fs_mode', 'localStorage');
                        XP7.showNotification('File System', 'Cambiado a Local Storage', 'success');
                        fsWindow.querySelector('.window-control.close').click();
                    }
                });
                
                if (content.querySelector('#btn-export-data')) {
                    content.querySelector('#btn-export-data').addEventListener('click', () => {
                        const exportData = XP7.fileSystem.exportFileSystem();
                        const blob = new Blob([exportData], { type: 'application/json' });
                        const url = URL.createObjectURL(blob);
                        
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = 'xp7-backup-' + new Date().toISOString().split('T')[0] + '.json';
                        document.body.appendChild(a);
                        a.click();
                        document.body.removeChild(a);
                        
                        URL.revokeObjectURL(url);
                        XP7.showNotification('Exportaci√≥n', 'Datos exportados correctamente', 'success');
                    });
                }
                
                if (content.querySelector('#btn-import-data')) {
                    content.querySelector('#btn-import-data').addEventListener('click', () => {
                        const input = document.createElement('input');
                        input.type = 'file';
                        input.accept = '.json';
                        
                        input.addEventListener('change', (e) => {
                            const file = e.target.files[0];
                            if (!file) return;
                            
                            const reader = new FileReader();
                            reader.onload = (event) => {
                                try {
                                    const success = XP7.fileSystem.importFileSystem(event.target.result);
                                    if (success) {
                                        XP7.showNotification('Importaci√≥n', 'Datos importados correctamente', 'success');
                                    } else {
                                        XP7.showNotification('Error', 'Formato de archivo inv√°lido', 'error');
                                    }
                                } catch (error) {
                                    XP7.showNotification('Error', 'Error importando: ' + error.message, 'error');
                                }
                            };
                            
                            reader.readAsText(file);
                        });
                        
                        input.click();
                    });
                }
            },
            
            openSettings() {
                const window = XP7Window.create({
                    title: 'Configuraci√≥n',
                    icon: '‚öôÔ∏è',
                    width: 600,
                    height: 400,
                    content: `
                        <div style="padding: 20px;">
                            <h2>‚öôÔ∏è Configuraci√≥n del Sistema</h2>
                            <p style="color: rgba(255,255,255,0.7); margin-bottom: 20px;">
                                Ajustes y configuraci√≥n de XP7 OS
                            </p>
                            
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                                <div style="padding: 15px; background: rgba(255,255,255,0.05); border-radius: 8px;">
                                    <h3 style="color: #4CAF50; margin-bottom: 10px;">Sistema</h3>
                                    <p>Versi√≥n: <strong>${XP7.version}</strong></p>
                                    <p>Navegador: <strong>${navigator.userAgent.split(' ')[0] || 'Unknown'}</strong></p>
                                    <p>Apps instaladas: <strong>${Object.keys(XP7.apps).length}</strong></p>
                                </div>
                                
                                <div style="padding: 15px; background: rgba(255,255,255,0.05); border-radius: 8px;">
                                    <h3 style="color: #2196F3; margin-bottom: 10px;">Almacenamiento</h3>
                                    <div id="settings-storage">
                                        <p>Cargando...</p>
                                    </div>
                                </div>
                            </div>
                            
                            <div style="margin-top: 20px;">
                                <h3 style="color: #ff9800; margin-bottom: 10px;">Opciones</h3>
                                <div style="display: flex; flex-direction: column; gap: 10px;">
                                    <button class="btn-secondary" id="btn-reset-desktop">
                                        üîÑ Restablecer Escritorio
                                    </button>
                                    <button class="btn-secondary" id="btn-clear-cache">
                                        üßπ Limpiar Cache
                                    </button>
                                    <button class="btn-danger" id="btn-factory-reset">
                                        üè≠ Restablecimiento de F√°brica
                                    </button>
                                </div>
                            </div>
                        </div>
                    `
                });
                
                const content = window.querySelector('.window-content');
                
                function updateStorageInfo() {
                    const info = XP7.fileSystem.getStorageInfo();
                    content.querySelector('#settings-storage').innerHTML = `
                        <p>Modo: <strong>${XP7.fileSystem.mode}</strong></p>
                        <p>Usado: <strong>${info.usedMB} MB</strong> / ${info.maxMB} MB</p>
                        <p>Archivos: <strong>${info.fileCount}</strong></p>
                        <div style="width: 100%; height: 6px; background: rgba(255,255,255,0.1); border-radius: 3px; margin: 5px 0;">
                            <div style="width: ${info.percentage}%; height: 100%; background: #2196F3; border-radius: 3px;"></div>
                        </div>
                    `;
                }
                
                updateStorageInfo();
                
                content.querySelector('#btn-reset-desktop').addEventListener('click', () => {
                    if (confirm('¬øRestablecer iconos del escritorio?')) {
                        XP7.updateDesktopIcons();
                        XP7.showNotification('Configuraci√≥n', 'Escritorio restablecido', 'info');
                    }
                });
                
                content.querySelector('#btn-clear-cache').addEventListener('click', () => {
                    if (confirm('¬øLimpiar cache del sistema?')) {
                        let count = 0;
                        for (let i = 0; i < localStorage.length; i++) {
                            const key = localStorage.key(i);
                            if (!key.startsWith('xp7_')) {
                                localStorage.removeItem(key);
                                count++;
                            }
                        }
                        updateStorageInfo();
                        XP7.showNotification('Configuraci√≥n', 'Cache limpiado (' + count + ' items)', 'info');
                    }
                });
                
                content.querySelector('#btn-factory-reset').addEventListener('click', () => {
                    if (confirm('‚ö†Ô∏è ¬øRESTABLECIMIENTO DE F√ÅBRICA?\n\nSe eliminar√°n TODOS los datos.\nEsta acci√≥n NO se puede deshacer.')) {
                        localStorage.clear();
                        XP7.showNotification('Configuraci√≥n', 'Sistema restablecido. Recargando...', 'warning');
                        setTimeout(() => {
                            window.location.reload();
                        }, 2000);
                    }
                });
            },
            
            openTerminal() {
                const window = XP7Window.create({
                    title: 'Terminal',
                    icon: 'üíª',
                    width: 700,
                    height: 500,
                    content: `
                        <div style="height: 100%; background: #000; color: #0f0; font-family: monospace; font-size: 14px; padding: 10px; overflow: auto; display: flex; flex-direction: column;">
                            <div style="margin-bottom: 10px;">
                                <div>XP7 Terminal v1.0.0</div>
                                <div>Type 'help' for available commands</div>
                                <div>&nbsp;</div>
                            </div>
                            <div id="terminal-output" style="flex: 1; overflow-y: auto; margin-bottom: 10px;"></div>
                            <div style="display: flex; border-top: 1px solid #0f0; padding-top: 5px;">
                                <span style="color: #0f0; margin-right: 5px;">user@xp7:~$ </span>
                                <input type="text" id="terminal-input" style="flex: 1; background: transparent; border: none; color: #0f0; font-family: monospace; outline: none;" autofocus>
                            </div>
                        </div>
                    `
                });
                
                const content = window.querySelector('.window-content');
                const input = content.querySelector('#terminal-input');
                const output = content.querySelector('#terminal-output');
                
                const commands = {
                    help: () => {
                        return `Available commands:
- help: Show this help message
- clear: Clear the terminal
- echo [text]: Echo text
- ver: Show system version
- ls: List files
- date: Show current date and time
- storage: Show storage information
- apps: List installed apps
- updates: Show installed updates
- mode: Show current filesystem mode`;
                    },
                    clear: () => {
                        output.innerHTML = '';
                        return '';
                    },
                    echo: (args) => {
                        return args.join(' ');
                    },
                    ver: () => {
                        return 'XP7 OS v' + XP7.version;
                    },
                    ls: async () => {
                        try {
                            const entries = await XP7.fileSystem.listDirectory('/');
                            if (entries.length === 0) return 'No files found';
                            return entries.map(entry => {
                                return entry.icon + ' ' + entry.name;
                            }).join('\n');
                        } catch (error) {
                            return 'Error: ' + error.message;
                        }
                    },
                    date: () => {
                        return new Date().toString();
                    },
                    storage: () => {
                        const info = XP7.fileSystem.getStorageInfo();
                        return 'Storage: ' + info.usedMB + ' MB / ' + info.maxMB + ' MB (' + info.percentage + '%)\nFiles: ' + info.fileCount + '\nMode: ' + XP7.fileSystem.mode;
                    },
                    apps: () => {
                        const apps = XP7.apps;
                        if (Object.keys(apps).length === 0) return 'No apps installed';
                        return Object.values(apps).map(app => {
                            return app.icon + ' ' + app.name + ' - ' + app.description;
                        }).join('\n');
                    },
                    updates: () => {
                        const updates = XP7.fileSystem.getInstalledUpdates();
                        if (updates.length === 0) return 'No updates installed';
                        return updates.map(update => {
                            return 'üîÑ ' + (update.name || 'Unnamed update') + ' v' + (update.version || '1.0.0');
                        }).join('\n');
                    },
                    mode: () => {
                        return 'Filesystem mode: ' + XP7.fileSystem.mode;
                    }
                };
                
                const processCommand = async (command) => {
                    const parts = command.trim().split(' ');
                    const cmd = parts[0].toLowerCase();
                    const args = parts.slice(1);
                    
                    if (commands[cmd]) {
                        if (cmd === 'ls' || cmd === 'storage' || cmd === 'apps' || cmd === 'updates') {
                            return await commands[cmd]();
                        }
                        return commands[cmd](args);
                    } else if (cmd) {
                        return 'Command not found: ' + cmd + '. Type \'help\' for available commands.';
                    }
                    
                    return '';
                };
                
                const addOutput = (text) => {
                    const line = document.createElement('div');
                    line.textContent = text;
                    output.appendChild(line);
                    output.scrollTop = output.scrollHeight;
                };
                
                input.addEventListener('keypress', async (e) => {
                    if (e.key === 'Enter') {
                        const command = input.value.trim();
                        input.value = '';
                        
                        addOutput('$ ' + command);
                        
                        const result = await processCommand(command);
                        if (result) {
                            addOutput(result);
                        }
                        
                        addOutput('');
                    }
                });
            },
            
            openACTManager() {
                const window = XP7Window.create({
                    title: 'Gestor de Archivos .ACT',
                    icon: 'üîÑ',
                    width: 700,
                    height: 500,
                    content: `
                        <div style="padding: 20px;">
                            <h2>üîÑ Gestor de Archivos de Actualizaci√≥n (.ACT)</h2>
                            <p style="color: rgba(255,255,255,0.7); margin-bottom: 20px;">
                                Instala y gestiona actualizaciones del sistema usando File System API
                            </p>
                            
                            <div style="margin-bottom: 20px; padding: 15px; background: rgba(255,255,255,0.05); border-radius: 8px;">
                                <h3 style="color: #4CAF50; margin-bottom: 10px;">Instalar .ACT</h3>
                                <p style="margin-bottom: 15px;">Instala archivos de actualizaci√≥n .act desde tu sistema local o usando File System API.</p>
                                <div style="display: flex; gap: 10px;">
                                    <button class="btn-primary" id="install-act-fs">
                                        üì• Instalar .ACT (File System API)
                                    </button>
                                    <button class="btn-secondary" id="install-act-local">
                                        üìÇ Instalar .ACT (Local)
                                    </button>
                                </div>
                            </div>
                            
                            <div style="margin-bottom: 20px; padding: 15px; background: rgba(255,255,255,0.05); border-radius: 8px;">
                                <h3 style="color: #2196F3; margin-bottom: 10px;">Actualizaciones Instaladas</h3>
                                <div id="act-list">
                                    <p style="color: rgba(255,255,255,0.5); text-align: center; padding: 20px;">
                                        Cargando actualizaciones...
                                    </p>
                                </div>
                            </div>
                        </div>
                    `
                });
                
                const content = window.querySelector('.window-content');
                
                function loadACTList() {
                    const updates = XP7.fileSystem.getInstalledUpdates();
                    const actList = content.querySelector('#act-list');
                    
                    if (updates.length === 0) {
                        actList.innerHTML = `
                            <p style="color: rgba(255,255,255,0.5); text-align: center; padding: 20px;">
                                No hay actualizaciones instaladas
                            </p>
                        `;
                        return;
                    }
                    
                    let html = '';
                    updates.forEach(update => {
                        html += `
                            <div class="pm-item" data-key="${update.key}" style="margin-bottom: 10px;">
                                <div style="display: flex; align-items: center; gap: 10px; width: 100%;">
                                    <div style="font-size: 24px;">üîÑ</div>
                                    <div style="flex: 1;">
                                        <div style="font-weight: 500;">${update.name || 'Actualizaci√≥n sin nombre'}</div>
                                        <div style="font-size: 12px; color: rgba(255,255,255,0.6);">
                                            Versi√≥n: ${update.version || '1.0.0'} | 
                                            Instalado: ${new Date(update.installed).toLocaleDateString()}
                                            ${update.description ? '<br>' + update.description : ''}
                                        </div>
                                    </div>
                                    <div>
                                        <button class="btn-danger btn-delete-act" data-key="${update.key}" 
                                                style="padding: 3px 8px; font-size: 12px;">
                                            üóëÔ∏è
                                        </button>
                                    </div>
                                </div>
                            </div>
                        `;
                    });
                    
                    actList.innerHTML = html;
                    
                    actList.querySelectorAll('.btn-delete-act').forEach(btn => {
                        btn.addEventListener('click', (e) => {
                            e.stopPropagation();
                            const key = btn.dataset.key;
                            if (confirm('¬øEliminar esta actualizaci√≥n?')) {
                                if (XP7.fileSystem.deleteUpdate(key)) {
                                    loadACTList();
                                    XP7.showNotification('ACT Manager', 'Actualizaci√≥n eliminada', 'success');
                                }
                            }
                        });
                    });
                }
                
                content.querySelector('#install-act-fs').addEventListener('click', async () => {
                    XP7.showNotification('ACT Manager', 'Intentando usar File System API...', 'info');
                    
                    const result = await XP7.fileSystem.installACTFileUsingFS();
                    
                    if (result.success) {
                        XP7.showNotification('ACT Manager', result.message, 'success');
                        loadACTList();
                    } else {
                        XP7.showNotification('Error', result.message, 'error');
                    }
                });
                
                content.querySelector('#install-act-local').addEventListener('click', () => {
                    const input = document.createElement('input');
                    input.type = 'file';
                    input.accept = '.act,.json';
                    
                    input.addEventListener('change', async (e) => {
                        const file = e.target.files[0];
                        if (!file) return;
                        
                        const reader = new FileReader();
                        reader.onload = async (event) => {
                            const result = await XP7.fileSystem.processACTFile(event.target.result);
                            
                            if (result.success) {
                                XP7.showNotification('ACT Manager', result.message, 'success');
                                loadACTList();
                            } else {
                                XP7.showNotification('Error', result.message, 'error');
                            }
                        };
                        
                        reader.readAsText(file);
                    });
                    
                    input.click();
                });
                
                loadACTList();
            },
            
            // Gestor de Fondos
            openBackgroundManager: function() {
                const window = XP7Window.create({
                    title: 'Gestor de Fondos',
                    icon: 'üé®',
                    width: 800,
                    height: 600,
                    content: `
                        <div style="padding: 20px; height: 100%; overflow: auto;">
                            <h2>üé® Gestor de Fondos XP7</h2>
                            <p style="color: rgba(255,255,255,0.7); margin-bottom: 20px;">
                                Gestiona im√°genes, shaders y efectos de fondo
                            </p>
                            
                            <div style="display: grid; grid-template-columns: 250px 1fr; gap: 20px; height: calc(100% - 100px);">
                                <!-- Panel lateral -->
                                <div style="background: rgba(255,255,255,0.05); border-radius: 8px; padding: 15px;">
                                    <h3 style="color: #4CAF50; margin-bottom: 15px;">Tipos de Fondo</h3>
                                    <div style="display: flex; flex-direction: column; gap: 10px;">
                                        <button class="btn-secondary active" data-tab="images">
                                            üñºÔ∏è Im√°genes
                                        </button>
                                        <button class="btn-secondary" data-tab="shaders">
                                            üîÑ Shaders
                                        </button>
                                        <button class="btn-secondary" data-tab="colors">
                                            üé® Colores
                                        </button>
                                        <button class="btn-secondary" data-tab="gradients">
                                            üåà Gradientes
                                        </button>
                                    </div>
                                    
                                    <div style="margin-top: 20px;">
                                        <h4 style="color: #2196F3; margin-bottom: 10px;">Fondo Actual</h4>
                                        <div id="current-bg-preview" style="width: 100%; height: 60px; border-radius: 5px; border: 2px solid rgba(255,255,255,0.1);"></div>
                                        <div id="current-bg-info" style="margin-top: 5px; font-size: 11px; color: rgba(255,255,255,0.6);">
                                            Cargando...
                                        </div>
                                    </div>
                                    
                                    <div style="margin-top: 20px;">
                                        <button class="btn-primary" id="upload-bg-image" style="width: 100%; margin-bottom: 10px;">
                                            üì§ Subir Imagen
                                        </button>
                                        <button class="btn-secondary" id="reset-bg" style="width: 100%;">
                                            üîÑ Restablecer
                                        </button>
                                    </div>
                                </div>
                                
                                <!-- Contenido principal -->
                                <div style="background: rgba(255,255,255,0.05); border-radius: 8px; padding: 15px; overflow-y: auto;">
                                    <div id="tab-content">
                                        <p style="text-align: center; padding: 50px; color: rgba(255,255,255,0.5);">
                                            Selecciona una categor√≠a
                                        </p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `
                });
                
                const content = window.querySelector('.window-content');
                
                // Funciones para las pesta√±as
                const tabs = {
                    images: `
                        <h3>üñºÔ∏è Im√°genes de Fondo</h3>
                        <p style="margin-bottom: 15px;">Sube y gestiona im√°genes para el fondo</p>
                        
                        <div id="images-grid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 10px; margin-top: 20px;">
                            <div style="text-align: center; grid-column: 1 / -1; color: rgba(255,255,255,0.5); padding: 40px;">
                                <p>No hay im√°genes guardadas</p>
                                <p style="font-size: 12px;">Sube im√°genes usando el bot√≥n "Subir Imagen"</p>
                            </div>
                        </div>
                    `,
                    
                    shaders: `
                        <h3>üîÑ Shaders GLSL</h3>
                        <p style="margin-bottom: 15px;">Aplica efectos shader avanzados al fondo</p>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 20px;">
                            <div>
                                <h4 style="color: #4CAF50;">Shaders Predefinidos</h4>
                                <div id="builtin-shaders" style="display: flex; flex-direction: column; gap: 10px; margin-top: 10px;">
                                    <!-- Se cargan din√°micamente -->
                                </div>
                            </div>
                            
                            <div>
                                <h4 style="color: #2196F3;">Shaders Personalizados</h4>
                                <div id="custom-shaders" style="margin-top: 10px;">
                                    <p style="color: rgba(255,255,255,0.5); text-align: center; padding: 20px;">
                                        No hay shaders personalizados
                                    </p>
                                </div>
                            </div>
                        </div>
                    `,
                    
                    colors: `
                        <h3>üé® Colores S√≥lidos</h3>
                        <p style="margin-bottom: 15px;">Selecciona un color s√≥lido para el fondo</p>
                        
                        <div style="display: grid; grid-template-columns: repeat(8, 1fr); gap: 10px; margin-top: 20px;">
                            ${['#0f2027', '#203a43', '#2c5364', '#0d47a1', '#004d40', '#311b92', '#bf360c', '#212121',
                               '#4CAF50', '#2196F3', '#FF9800', '#9C27B0', '#E91E63', '#00BCD4', '#8BC34A', '#FF5722']
                               .map(color => `
                                <div class="color-option" style="background: ${color}; height: 40px; border-radius: 5px; cursor: pointer; border: 2px solid transparent;" data-color="${color}"></div>
                            `).join('')}
                        </div>
                        
                        <div style="margin-top: 20px;">
                            <h4>Selector de Color Personalizado</h4>
                            <input type="color" id="color-picker" value="#0f2027" style="width: 100%; height: 40px; border: none; border-radius: 5px; margin-bottom: 10px;">
                            <button class="btn-primary" id="apply-custom-color" style="width: 100%;">
                                Aplicar Color Personalizado
                            </button>
                        </div>
                    `,
                    
                    gradients: `
                        <h3>üåà Gradientes</h3>
                        <p style="margin-bottom: 15px;">Aplica gradientes elegantes al fondo</p>
                        
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin-top: 20px;">
                            ${[
                                {name: 'Noche Estrellada', gradient: 'linear-gradient(135deg, #0f2027, #203a43, #2c5364)'},
                                {name: 'Amanecer', gradient: 'linear-gradient(135deg, #ff7e5f, #feb47b)'},
                                {name: 'Oc√©ano', gradient: 'linear-gradient(135deg, #2196F3, #21CBF3)'},
                                {name: 'Bosque', gradient: 'linear-gradient(135deg, #4CAF50, #2E7D32)'},
                                {name: 'Atardecer', gradient: 'linear-gradient(135deg, #FF9800, #E91E63)'},
                                {name: 'Galaxia', gradient: 'linear-gradient(135deg, #0d0d2b, #1a1a40, #4a0080)'}
                            ].map(g => `
                                <div class="gradient-option" style="background: ${g.gradient}; height: 80px; border-radius: 8px; cursor: pointer; padding: 10px; display: flex; align-items: flex-end;" data-gradient="${g.gradient}">
                                    <span style="background: rgba(0,0,0,0.7); padding: 3px 8px; border-radius: 3px; font-size: 12px;">${g.name}</span>
                                </div>
                            `).join('')}
                        </div>
                    `
                };
                
                // Cargar pesta√±a
                function loadTab(tabName) {
                    const tabContent = content.querySelector('#tab-content');
                    tabContent.innerHTML = tabs[tabName] || '<p>Pesta√±a no encontrada</p>';
                    
                    // Actualizar botones activos
                    content.querySelectorAll('[data-tab]').forEach(btn => {
                        btn.classList.toggle('active', btn.dataset.tab === tabName);
                    });
                    
                    // Inicializar contenido espec√≠fico de la pesta√±a
                    if (tabName === 'images') loadImages();
                    if (tabName === 'shaders') loadShaders();
                    if (tabName === 'colors') initColorPicker();
                    if (tabName === 'gradients') initGradients();
                }
                
                // Cargar im√°genes
                async function loadImages() {
                    const grid = content.querySelector('#images-grid');
                    const backgrounds = XP7.Background.backgrounds;
                    
                    if (backgrounds.length === 0) {
                        grid.innerHTML = `
                            <div style="text-align: center; grid-column: 1 / -1; color: rgba(255,255,255,0.5); padding: 40px;">
                                <p>No hay im√°genes guardadas</p>
                                <p style="font-size: 12px;">Sube im√°genes usando el bot√≥n "Subir Imagen"</p>
                            </div>
                        `;
                        return;
                    }
                    
                    let html = '';
                    backgrounds.forEach((bg, index) => {
                        if (bg.type === 'image') {
                            html += `
                                <div class="image-item" data-index="${index}" style="border-radius: 5px; overflow: hidden; cursor: pointer; border: 2px solid rgba(255,255,255,0.1);">
                                    <div style="height: 100px; background: url('${bg.data}') center/cover;"></div>
                                    <div style="padding: 8px; background: rgba(0,0,0,0.7); font-size: 11px; display: flex; justify-content: space-between;">
                                        <span style="white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${bg.name}</span>
                                        <button class="apply-image-btn" data-index="${index}" style="background: rgba(76,175,80,0.3); border: none; color: white; padding: 2px 6px; border-radius: 3px; font-size: 10px; cursor: pointer;">Aplicar</button>
                                    </div>
                                </div>
                            `;
                        }
                    });
                    
                    grid.innerHTML = html || '<div style="grid-column: 1 / -1; text-align: center; padding: 20px;">No hay im√°genes</div>';
                    
                    // A√±adir event listeners
                    grid.querySelectorAll('.image-item').forEach(item => {
                        item.addEventListener('click', (e) => {
                            if (!e.target.classList.contains('apply-image-btn')) {
                                const index = parseInt(item.dataset.index);
                                const bg = backgrounds[index];
                                if (bg) {
                                    XP7.Background.setBackground('image', bg.data);
                                    updateCurrentBgPreview();
                                }
                            }
                        });
                    });
                    
                    grid.querySelectorAll('.apply-image-btn').forEach(btn => {
                        btn.addEventListener('click', (e) => {
                            e.stopPropagation();
                            const index = parseInt(btn.dataset.index);
                            const bg = backgrounds[index];
                            if (bg) {
                                XP7.Background.setBackground('image', bg.data);
                                updateCurrentBgPreview();
                            }
                        });
                    });
                }
                
                // Cargar shaders
                function loadShaders() {
                    const builtinDiv = content.querySelector('#builtin-shaders');
                    const customDiv = content.querySelector('#custom-shaders');
                    
                    if (builtinDiv) {
                        builtinDiv.innerHTML = Object.entries(XP7.Shaders.builtInShaders)
                            .map(([id, shader]) => `
                                <div style="background: rgba(255,255,255,0.05); padding: 10px; border-radius: 5px; cursor: pointer; display: flex; justify-content: space-between; align-items: center;"
                                     data-shader="${id}">
                                    <div>
                                        <div style="font-weight: 500;">${shader.name}</div>
                                        <div style="font-size: 11px; color: rgba(255,255,255,0.6);">Shader GLSL</div>
                                    </div>
                                    <button class="apply-shader-btn" data-shader="${id}" style="background: rgba(76,175,80,0.3); border: none; color: white; padding: 3px 8px; border-radius: 3px; font-size: 11px; cursor: pointer;">Aplicar</button>
                                </div>
                            `).join('');
                        
                        // A√±adir event listeners
                        builtinDiv.querySelectorAll('.apply-shader-btn').forEach(btn => {
                            btn.addEventListener('click', () => {
                                const shaderId = btn.dataset.shader;
                                XP7.Background.setBackground('shader', shaderId);
                                updateCurrentBgPreview();
                            });
                        });
                    }
                }
                
                // Inicializar selector de color
                function initColorPicker() {
                    const picker = content.querySelector('#color-picker');
                    const applyBtn = content.querySelector('#apply-custom-color');
                    
                    if (picker && applyBtn) {
                        applyBtn.addEventListener('click', () => {
                            XP7.Background.setBackground('color', picker.value);
                            updateCurrentBgPreview();
                        });
                    }
                    
                    // Colores predefinidos
                    content.querySelectorAll('.color-option').forEach(option => {
                        option.addEventListener('click', () => {
                            const color = option.dataset.color;
                            XP7.Background.setBackground('color', color);
                            updateCurrentBgPreview();
                        });
                    });
                }
                
                // Inicializar gradientes
                function initGradients() {
                    content.querySelectorAll('.gradient-option').forEach(option => {
                        option.addEventListener('click', () => {
                            const gradient = option.dataset.gradient;
                            XP7.Background.setBackground('gradient', gradient);
                            updateCurrentBgPreview();
                        });
                    });
                }
                
                // Actualizar vista previa del fondo actual
                function updateCurrentBgPreview() {
                    const preview = content.querySelector('#current-bg-preview');
                    const info = content.querySelector('#current-bg-info');
                    
                    if (preview && info) {
                        const config = XP7.Background;
                        
                        switch(config.backgroundType) {
                            case 'color':
                                preview.style.background = config.currentBackground;
                                preview.style.backgroundImage = 'none';
                                info.textContent = `Color s√≥lido: ${config.currentBackground}`;
                                break;
                                
                            case 'image':
                                preview.style.backgroundImage = `url("${config.currentBackground}")`;
                                preview.style.backgroundSize = 'cover';
                                info.textContent = 'Imagen personalizada';
                                break;
                                
                            case 'shader':
                                const shader = XP7.Shaders.shaders[config.currentBackground];
                                preview.style.background = 'linear-gradient(135deg, #4CAF50, #2196F3)';
                                preview.style.backgroundImage = 'none';
                                info.textContent = shader ? `Shader: ${shader.name}` : 'Shader activado';
                                break;
                                
                            case 'gradient':
                                preview.style.background = config.currentBackground;
                                preview.style.backgroundImage = 'none';
                                info.textContent = 'Gradiente personalizado';
                                break;
                        }
                    }
                }
                
                // Subir imagen
                content.querySelector('#upload-bg-image').addEventListener('click', () => {
                    const input = document.createElement('input');
                    input.type = 'file';
                    input.accept = 'image/*';
                    
                    input.addEventListener('change', async (e) => {
                        const file = e.target.files[0];
                        if (file) {
                            try {
                                XP7.showNotification('Fondos', 'Subiendo imagen...', 'info');
                                
                                await XP7.Background.addImageBackground(file);
                                loadTab('images');
                                
                                XP7.showNotification('Fondos', 'Imagen subida correctamente', 'success');
                            } catch (error) {
                                XP7.showNotification('Error', 'Error subiendo imagen', 'error');
                            }
                        }
                    });
                    
                    input.click();
                });
                
                // Restablecer fondo
                content.querySelector('#reset-bg').addEventListener('click', () => {
                    if (confirm('¬øRestablecer al fondo por defecto?')) {
                        XP7.Background.setBackground('gradient', 'linear-gradient(135deg, #0f2027, #203a43, #2c5364)');
                        updateCurrentBgPreview();
                    }
                });
                
                // Event listeners para pesta√±as
                content.querySelectorAll('[data-tab]').forEach(btn => {
                    btn.addEventListener('click', () => {
                        loadTab(btn.dataset.tab);
                    });
                });
                
                // Inicializar
                loadTab('images');
                updateCurrentBgPreview();
            },
            
            // Editor de Shaders
            openShaderEditor: function() {
                const window = XP7Window.create({
                    title: 'Editor de Shaders',
                    icon: 'üîÑ',
                    width: 800,
                    height: 600,
                    content: `
                        <div style="height: 100%; display: flex; flex-direction: column;">
                            <div style="padding: 20px; border-bottom: 1px solid rgba(255,255,255,0.1);">
                                <h2>üîÑ Editor de Shaders GLSL</h2>
                                <p style="color: rgba(255,255,255,0.7);">Crea y edita shaders para fondos personalizados</p>
                            </div>
                            
                            <div style="flex: 1; display: flex; padding: 20px; gap: 20px; overflow: hidden;">
                                <!-- Editor -->
                                <div style="flex: 1; display: flex; flex-direction: column;">
                                    <div style="margin-bottom: 10px;">
                                        <h3>üìù C√≥digo GLSL</h3>
                                    </div>
                                    <textarea id="shader-code" spellcheck="false" 
                                        style="flex: 1; background: #1e1e1e; color: #d4d4d4; 
                                               font-family: 'Courier New', monospace; font-size: 14px; 
                                               padding: 15px; border: 1px solid rgba(255,255,255,0.1); 
                                               border-radius: 5px; resize: none;"
                                        placeholder="Escribe tu c√≥digo GLSL aqu√≠...">
precision mediump float;
uniform float time;
uniform vec2 resolution;

void main() {
    vec2 uv = gl_FragCoord.xy / resolution;
    vec3 color = vec3(uv, 0.5 + 0.5 * sin(time));
    gl_FragColor = vec4(color, 1.0);
}</textarea>
                                    
                                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px;">
                                        <input type="text" id="shader-name" placeholder="Nombre del shader" 
                                            style="background: rgba(255,255,255,0.1); border: none; color: white; 
                                                   padding: 8px 12px; border-radius: 3px;">
                                        <button class="btn-primary" id="shader-save" style="width: 100%;">
                                            üíæ Guardar Shader
                                        </button>
                                    </div>
                                </div>
                                
                                <!-- Vista previa -->
                                <div style="flex: 1; display: flex; flex-direction: column;">
                                    <div style="margin-bottom: 10px; display: flex; justify-content: space-between;">
                                        <h3>üëÅÔ∏è Vista Previa</h3>
                                        <div>
                                            <button class="btn-secondary" id="preview-play">‚ñ∂Ô∏è</button>
                                            <button class="btn-secondary" id="preview-pause" style="margin-left: 5px;">‚è∏Ô∏è</button>
                                        </div>
                                    </div>
                                    
                                    <div style="flex: 1; background: rgba(0,0,0,0.3); border-radius: 5px; 
                                                overflow: hidden; position: relative;">
                                        <canvas id="shader-preview" width="400" height="300" style="width: 100%; height: 100%;"></canvas>
                                        <div id="preview-info" style="position: absolute; bottom: 10px; left: 10px; 
                                             background: rgba(0,0,0,0.7); padding: 5px 10px; border-radius: 3px; 
                                             font-size: 11px;">
                                            Vista previa activa
                                        </div>
                                    </div>
                                    
                                    <button class="btn-primary" id="apply-shader" style="margin-top: 10px; width: 100%;">
                                        üé® Aplicar como Fondo
                                    </button>
                                </div>
                            </div>
                        </div>
                    `
                });
                
                const content = window.querySelector('.window-content');
                
                // Variables para vista previa
                let isPreviewPlaying = true;
                let previewTime = 0;
                let previewInterval = null;
                
                // Inicializar vista previa
                function initPreview() {
                    const canvas = content.querySelector('#shader-preview');
                    const ctx = canvas.getContext('2d');
                    
                    // Funci√≥n de renderizado
                    function render() {
                        if (!isPreviewPlaying) return;
                        
                        const code = content.querySelector('#shader-code').value;
                        const width = canvas.width;
                        const height = canvas.height;
                        
                        ctx.clearRect(0, 0, width, height);
                        
                        // Renderizar efecto b√°sico basado en el c√≥digo
                        if (code.includes('sin(time)')) {
                            // Efecto de onda
                            for (let x = 0; x < width; x += 10) {
                                for (let y = 0; y < height; y += 10) {
                                    const value = Math.sin(previewTime + x * 0.01 + y * 0.01) * 0.5 + 0.5;
                                    ctx.fillStyle = `rgb(${value * 255}, ${(1-value) * 255}, 150)`;
                                    ctx.fillRect(x, y, 10, 10);
                                }
                            }
                        } else {
                            // Efecto por defecto
                            const hue = (previewTime * 50) % 360;
                            ctx.fillStyle = `hsl(${hue}, 100%, 50%)`;
                            ctx.fillRect(0, 0, width, height);
                        }
                        
                        previewTime += 0.05;
                    }
                    
                    // Iniciar loop de animaci√≥n
                    previewInterval = setInterval(render, 50);
                }
                
                // Guardar shader
                function saveShader() {
                    const name = content.querySelector('#shader-name').value.trim();
                    const code = content.querySelector('#shader-code').value;
                    
                    if (!name) {
                        XP7.showNotification('Error', 'Ingresa un nombre para el shader', 'error');
                        return;
                    }
                    
                    if (!code.trim()) {
                        XP7.showNotification('Error', 'El c√≥digo del shader est√° vac√≠o', 'error');
                        return;
                    }
                    
                    XP7.Shaders.saveShader(name, code, 'fragment');
                    content.querySelector('#shader-name').value = '';
                }
                
                // Aplicar shader
                function applyShader() {
                    const name = content.querySelector('#shader-name').value.trim();
                    const code = content.querySelector('#shader-code').value;
                    
                    if (!name || !code.trim()) {
                        XP7.showNotification('Error', 'Primero guarda el shader con un nombre', 'error');
                        return;
                    }
                    
                    // Guardar primero
                    saveShader();
                    
                    // Aplicar como fondo
                    XP7.Background.setBackground('shader', name);
                }
                
                // Event listeners
                content.querySelector('#shader-save').addEventListener('click', saveShader);
                content.querySelector('#apply-shader').addEventListener('click', applyShader);
                content.querySelector('#preview-play').addEventListener('click', () => {
                    isPreviewPlaying = true;
                });
                content.querySelector('#preview-pause').addEventListener('click', () => {
                    isPreviewPlaying = false;
                });
                
                // Inicializar
                initPreview();
            },
            
            // Galer√≠a de Fondos
            openGallery: function() {
                const predefinedBackgrounds = [
                    { name: 'Espacio Profundo', type: 'gradient', value: 'linear-gradient(135deg, #0c0c2d, #1a1a3d, #2d2d5c)' },
                    { name: 'Aurora Boreal', type: 'gradient', value: 'linear-gradient(135deg, #00c9ff, #92fe9d)' },
                    { name: 'Oc√©ano', type: 'color', value: '#006994' },
                    { name: 'Bosque', type: 'color', value: '#228B22' },
                    { name: 'Atardecer', type: 'gradient', value: 'linear-gradient(135deg, #ff7e5f, #feb47b)' },
                    { name: 'Matrix', type: 'shader', value: 'matrix' },
                    { name: 'Nebulosa', type: 'shader', value: 'nebula' },
                    { name: 'Fuego', type: 'shader', value: 'fire' },
                    { name: 'Agua', type: 'shader', value: 'water' }
                ];
                
                const window = XP7Window.create({
                    title: 'Galer√≠a de Fondos',
                    icon: 'üñºÔ∏è',
                    width: 700,
                    height: 500,
                    content: `
                        <div style="height: 100%; display: flex; flex-direction: column;">
                            <div style="padding: 20px; border-bottom: 1px solid rgba(255,255,255,0.1);">
                                <h2>üñºÔ∏è Galer√≠a de Fondos XP7</h2>
                                <p style="color: rgba(255,255,255,0.7);">Explora y aplica fondos predefinidos</p>
                            </div>
                            
                            <div style="flex: 1; padding: 20px; overflow-y: auto;">
                                <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 15px;" id="gallery-grid">
                                    ${predefinedBackgrounds.map((bg, index) => `
                                        <div class="gallery-item" data-index="${index}" style="background: ${bg.type === 'shader' ? 'linear-gradient(135deg, #4CAF50, #2196F3)' : bg.value}; height: 120px; border-radius: 8px; cursor: pointer; overflow: hidden; border: 2px solid rgba(255,255,255,0.1); position: relative;">
                                            <div style="position: absolute; bottom: 0; left: 0; right: 0; background: rgba(0,0,0,0.7); padding: 10px;">
                                                <div style="font-weight: 500; font-size: 14px;">${bg.name}</div>
                                                <div style="font-size: 11px; color: rgba(255,255,255,0.6); margin-top: 2px;">
                                                    ${bg.type === 'shader' ? 'Shader GLSL' : bg.type}
                                                </div>
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        </div>
                    `
                });
                
                const content = window.querySelector('.window-content');
                
                // Aplicar fondo desde galer√≠a
                content.querySelectorAll('.gallery-item').forEach((item, index) => {
                    item.addEventListener('click', () => {
                        const bg = predefinedBackgrounds[index];
                        if (bg) {
                            XP7.Background.setBackground(bg.type, bg.value);
                            XP7.showNotification('Galer√≠a', `Fondo "${bg.name}" aplicado`, 'success');
                        }
                    });
                    
                    // Efecto hover
                    item.addEventListener('mouseenter', () => {
                        item.style.transform = 'translateY(-5px)';
                        item.style.boxShadow = '0 10px 20px rgba(0,0,0,0.3)';
                    });
                    
                    item.addEventListener('mouseleave', () => {
                        item.style.transform = 'translateY(0)';
                        item.style.boxShadow = 'none';
                    });
                });
            },
            
            // Creador de Paquetes
            openPakCreator: function() {
                const window = XP7Window.create({
                    title: 'Creador de Paquetes .pak',
                    icon: 'üì¶',
                    width: 700,
                    height: 600,
                    content: `
                        <div style="padding: 20px; height: 100%; overflow: auto;">
                            <h2>üì¶ Creador de Paquetes XP7</h2>
                            <p style="color: rgba(255,255,255,0.7); margin-bottom: 20px;">
                                Crea archivos .pak para distribuir tus aplicaciones
                            </p>
                            
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                                <div style="background: rgba(255,255,255,0.05); padding: 15px; border-radius: 8px;">
                                    <h3 style="color: #4CAF50; margin-bottom: 10px;">üìù Informaci√≥n B√°sica</h3>
                                    <div style="display: flex; flex-direction: column; gap: 10px;">
                                        <input type="text" id="pak-name" placeholder="Nombre de la aplicaci√≥n" 
                                               style="background: rgba(255,255,255,0.1); border: none; color: white; padding: 8px 12px; border-radius: 3px;">
                                        <input type="text" id="pak-icon" placeholder="Icono (emoji o texto)" 
                                               style="background: rgba(255,255,255,0.1); border: none; color: white; padding: 8px 12px; border-radius: 3px;">
                                        <input type="text" id="pak-description" placeholder="Descripci√≥n" 
                                               style="background: rgba(255,255,255,0.1); border: none; color: white; padding: 8px 12px; border-radius: 3px;">
                                        <input type="text" id="pak-author" placeholder="Autor" 
                                               style="background: rgba(255,255,255,0.1); border: none; color: white; padding: 8px 12px; border-radius: 3px;">
                                    </div>
                                </div>
                                
                                <div style="background: rgba(255,255,255,0.05); padding: 15px; border-radius: 8px;">
                                    <h3 style="color: #2196F3; margin-bottom: 10px;">‚öôÔ∏è Configuraci√≥n</h3>
                                    <div style="display: flex; flex-direction: column; gap: 10px;">
                                        <input type="text" id="pak-version" placeholder="Versi√≥n (ej: 1.0.0)" value="1.0.0"
                                               style="background: rgba(255,255,255,0.1); border: none; color: white; padding: 8px 12px; border-radius: 3px;">
                                        <input type="text" id="pak-category" placeholder="Categor√≠a" value="Aplicaciones"
                                               style="background: rgba(255,255,255,0.1); border: none; color: white; padding: 8px 12px; border-radius: 3px;">
                                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                                            <input type="number" id="pak-width" placeholder="Ancho" value="600"
                                                   style="background: rgba(255,255,255,0.1); border: none; color: white; padding: 8px 12px; border-radius: 3px;">
                                            <input type="number" id="pak-height" placeholder="Alto" value="400"
                                                   style="background: rgba(255,255,255,0.1); border: none; color: white; padding: 8px 12px; border-radius: 3px;">
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div style="margin-bottom: 20px;">
                                <h3 style="color: #FF9800; margin-bottom: 10px;">üíª Contenido HTML</h3>
                                <textarea id="pak-content" placeholder="Contenido HTML de tu aplicaci√≥n..." 
                                          style="width: 100%; height: 200px; background: rgba(255,255,255,0.1); color: white; border: none; padding: 10px; border-radius: 5px; font-family: monospace;"
                                          spellcheck="false">&lt;div style="padding: 20px;"&gt;
    &lt;h2&gt;Mi Aplicaci√≥n&lt;/h2&gt;
    &lt;p&gt;Contenido de mi aplicaci√≥n personalizada.&lt;/p&gt;
    &lt;button onclick="alert('¬°Hola!')" style="background: #4CAF50; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer;"&gt;
        Click aqu√≠
    &lt;/button&gt;
&lt;/div&gt;</textarea>
                            </div>
                            
                            <div style="display: flex; gap: 10px;">
                                <button class="btn-primary" id="generate-pak">
                                    üé® Generar .pak
                                </button>
                                <button class="btn-secondary" id="preview-pak">
                                    üëÅÔ∏è Vista Previa
                                </button>
                                <button class="btn-secondary" id="load-template">
                                    üìã Cargar Plantilla
                                </button>
                            </div>
                            
                            <div id="pak-output" style="margin-top: 20px; display: none;">
                                <h3>üìÑ Resultado del Paquete</h3>
                                <pre id="pak-json" style="background: rgba(0,0,0,0.3); padding: 10px; border-radius: 5px; overflow: auto; font-size: 12px; max-height: 200px;"></pre>
                                <button class="btn-primary" id="download-pak" style="margin-top: 10px;">
                                    üíæ Descargar .pak
                                </button>
                            </div>
                        </div>
                    `
                });
                
                const content = window.querySelector('.window-content');
                
                // Generar paquete
                content.querySelector('#generate-pak').addEventListener('click', () => {
                    const pakData = {
                        type: "application",
                        id: document.getElementById('pak-name').value
                            .toLowerCase()
                            .replace(/[^a-z0-9]/g, '-')
                            .replace(/-+/g, '-')
                            .replace(/^-|-$/g, ''),
                        name: document.getElementById('pak-name').value || "Sin nombre",
                        icon: document.getElementById('pak-icon').value || "üì±",
                        description: document.getElementById('pak-description').value || "",
                        author: document.getElementById('pak-author').value || "",
                        version: document.getElementById('pak-version').value || "1.0.0",
                        category: document.getElementById('pak-category').value || "Aplicaciones",
                        width: parseInt(document.getElementById('pak-width').value) || 600,
                        height: parseInt(document.getElementById('pak-height').value) || 400,
                        content: document.getElementById('pak-content').value || "<div></div>",
                        files: [],
                        dependencies: []
                    };
                    
                    // Validar campos obligatorios
                    if (!pakData.name || !pakData.icon) {
                        XP7.showNotification('Error', 'Nombre e icono son obligatorios', 'error');
                        return;
                    }
                    
                    // Mostrar resultado
                    const outputDiv = content.querySelector('#pak-output');
                    const jsonPre = content.querySelector('#pak-json');
                    
                    jsonPre.textContent = JSON.stringify(pakData, null, 2);
                    outputDiv.style.display = 'block';
                    
                    XP7.showNotification('Paquete', 'Paquete generado correctamente', 'success');
                });
                
                // Descargar paquete
                content.querySelector('#download-pak').addEventListener('click', () => {
                    const pakData = JSON.parse(content.querySelector('#pak-json').textContent);
                    const blob = new Blob([JSON.stringify(pakData, null, 2)], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = pakData.id + '.pak';
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    
                    URL.revokeObjectURL(url);
                    XP7.showNotification('Descarga', 'Paquete .pak descargado', 'success');
                });
                
                // Vista previa
                content.querySelector('#preview-pak').addEventListener('click', () => {
                    const contentHTML = document.getElementById('pak-content').value;
                    const previewWindow = XP7Window.create({
                        title: 'Vista Previa de Aplicaci√≥n',
                        icon: 'üëÅÔ∏è',
                        width: 600,
                        height: 400,
                        content: contentHTML || '<div style="padding:20px;"><p>No hay contenido para previsualizar</p></div>'
                    });
                });
                
                // Cargar plantilla
                content.querySelector('#load-template').addEventListener('click', () => {
                    const template = {
                        name: "Mi Aplicaci√≥n Personalizada",
                        icon: "üé®",
                        description: "Una aplicaci√≥n personalizada para XP7 OS",
                        author: "Desarrollador XP7",
                        version: "1.0.0",
                        category: "Personalizadas",
                        content: `<div style="padding: 20px;">
    <h2>¬°Bienvenido a mi aplicaci√≥n!</h2>
    <p>Esta es una aplicaci√≥n personalizada creada con el Creador de Paquetes.</p>
    <div style="margin-top: 20px;">
        <button onclick="alert('¬°Hola desde XP7!')" 
                style="background: #4CAF50; color: white; border: none; 
                       padding: 10px 20px; border-radius: 5px; cursor: pointer;">
            Haz clic aqu√≠
        </button>
    </div>
</div>`
                    };
                    
                    document.getElementById('pak-name').value = template.name;
                    document.getElementById('pak-icon').value = template.icon;
                    document.getElementById('pak-description').value = template.description;
                    document.getElementById('pak-author').value = template.author;
                    document.getElementById('pak-version').value = template.version;
                    document.getElementById('pak-category').value = template.category;
                    document.getElementById('pak-content').value = template.content;
                    
                    XP7.showNotification('Plantilla', 'Plantilla cargada', 'info');
                });
            }
        };

        // Inicializar el sistema cuando se cargue la p√°gina
        document.addEventListener('DOMContentLoaded', () => {
            XP7.init();
        });
    </script>
</body>
</html>
