<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>XP7 OS - Sistema Operativo Web</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            user-select: none;
        }

        body {
            background: linear-gradient(135deg, #0f2027, #203a43, #2c5364);
            color: #fff;
            overflow: hidden;
            height: 100vh;
            width: 100vw;
            position: relative;
        }

        #taskbar {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 40px;
            background: rgba(20, 25, 30, 0.95);
            backdrop-filter: blur(10px);
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 10px;
            z-index: 1000;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .taskbar-left {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .taskbar-right {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .start-button {
            background: linear-gradient(135deg, #4CAF50, #45a049);
            border: none;
            color: white;
            padding: 6px 15px;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .start-button:hover {
            background: linear-gradient(135deg, #45a049, #3d8b40);
            transform: translateY(-1px);
            box-shadow: 0 3px 8px rgba(0,0,0,0.2);
        }

        .running-apps {
            display: flex;
            gap: 5px;
        }

        .running-app {
            background: rgba(255, 255, 255, 0.1);
            padding: 4px 10px;
            border-radius: 3px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
            max-width: 120px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .running-app:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .running-app.active {
            background: rgba(76, 175, 80, 0.3);
            border-bottom: 2px solid #4CAF50;
        }

        #system-tray {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 12px;
        }

        .clock, .date {
            padding: 2px 5px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 3px;
        }

        .start-menu {
            position: fixed;
            bottom: 40px;
            left: 10px;
            width: 500px;
            height: 500px;
            background: rgba(25, 30, 35, 0.98);
            backdrop-filter: blur(20px);
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.4);
            z-index: 999;
            display: none;
            overflow: hidden;
            animation: fadeIn 0.2s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .start-menu.active {
            display: block;
        }

        .start-header {
            padding: 20px;
            background: linear-gradient(135deg, rgba(76, 175, 80, 0.2), rgba(69, 160, 73, 0.1));
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .user-icon {
            font-size: 40px;
            background: rgba(255, 255, 255, 0.1);
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .user-name {
            font-size: 18px;
            font-weight: 500;
        }

        .start-content {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            padding: 20px;
            height: calc(100% - 180px);
            overflow-y: auto;
        }

        .start-column h3 {
            margin-bottom: 10px;
            color: #4CAF50;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .start-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 12px;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.2s ease;
            margin-bottom: 5px;
        }

        .start-item:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: translateX(5px);
        }

        .start-icon {
            font-size: 20px;
            width: 24px;
            text-align: center;
        }

        .start-text {
            font-size: 14px;
        }

        .start-footer {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            padding: 15px 20px;
            background: rgba(20, 25, 30, 0.9);
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .search-box {
            display: flex;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 5px;
            overflow: hidden;
        }

        .search-box input {
            flex: 1;
            background: transparent;
            border: none;
            padding: 8px 15px;
            color: white;
            font-size: 14px;
        }

        .search-box input::placeholder {
            color: rgba(255, 255, 255, 0.5);
        }

        .search-box button {
            background: rgba(76, 175, 80, 0.2);
            border: none;
            color: white;
            padding: 8px 15px;
            cursor: pointer;
            transition: background 0.2s ease;
        }

        .search-box button:hover {
            background: rgba(76, 175, 80, 0.3);
        }

        .desktop {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: calc(100% - 40px);
            z-index: 2;
            padding: 20px;
            display: flex;
            flex-wrap: wrap;
            align-content: flex-start;
            gap: 20px;
        }

        .desktop-icon {
            width: 80px;
            height: 80px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            border-radius: 5px;
            transition: all 0.2s ease;
            padding: 10px;
        }

        .desktop-icon:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: scale(1.05);
        }

        .desktop-icon .icon {
            font-size: 32px;
            margin-bottom: 5px;
        }

        .desktop-icon .name {
            font-size: 12px;
            text-align: center;
            word-break: break-word;
        }

        #windows-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 100;
        }

        .window {
            position: absolute;
            min-width: 300px;
            min-height: 200px;
            background: rgba(30, 35, 40, 0.98);
            backdrop-filter: blur(20px);
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.4);
            overflow: hidden;
            pointer-events: all;
            z-index: 101;
            resize: both;
            animation: windowFadeIn 0.2s ease;
        }

        @keyframes windowFadeIn {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }

        .window.maximized {
            resize: none;
        }

        .window-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 15px;
            background: rgba(20, 25, 30, 0.95);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            cursor: move;
            user-select: none;
        }

        .window-title {
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 500;
            font-size: 14px;
        }

        .window-controls {
            display: flex;
            gap: 5px;
        }

        .window-control {
            width: 30px;
            height: 30px;
            border: none;
            border-radius: 3px;
            background: transparent;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }

        .window-control:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .window-control.minimize:hover {
            background: rgba(255, 193, 7, 0.2);
        }

        .window-control.maximize:hover {
            background: rgba(33, 150, 243, 0.2);
        }

        .window-control.close:hover {
            background: rgba(244, 67, 54, 0.2);
        }

        .window-content {
            padding: 15px;
            height: calc(100% - 50px);
            overflow: auto;
        }

        .btn-primary, .btn-secondary, .btn-danger {
            padding: 8px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 14px;
            transition: all 0.2s ease;
        }

        .btn-primary {
            background: linear-gradient(135deg, #4CAF50, #45a049);
            color: white;
        }

        .btn-primary:hover {
            background: linear-gradient(135deg, #45a049, #3d8b40);
            transform: translateY(-1px);
            box-shadow: 0 3px 8px rgba(0,0,0,0.2);
        }

        .btn-secondary {
            background: rgba(33, 150, 243, 0.2);
            color: white;
            border: 1px solid rgba(33, 150, 243, 0.5);
        }

        .btn-secondary:hover {
            background: rgba(33, 150, 243, 0.3);
        }

        .btn-danger {
            background: rgba(244, 67, 54, 0.2);
            color: white;
            border: 1px solid rgba(244, 67, 54, 0.5);
        }

        .btn-danger:hover {
            background: rgba(244, 67, 54, 0.3);
        }

        #notifications {
            position: fixed;
            top: 20px;
            right: 20px;
            width: 300px;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .notification {
            background: rgba(25, 30, 35, 0.95);
            backdrop-filter: blur(10px);
            border-left: 4px solid #4CAF50;
            padding: 15px;
            border-radius: 5px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            animation: slideIn 0.3s ease;
            transform-origin: top right;
        }

        .notification.error {
            border-left-color: #f44336;
        }

        .notification.warning {
            border-left-color: #ff9800;
        }

        .notification.info {
            border-left-color: #2196f3;
        }

        .notification.success {
            border-left-color: #4CAF50;
        }

        .notification-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 5px;
        }

        .notification-title {
            font-weight: 500;
            font-size: 14px;
        }

        .notification-close {
            background: none;
            border: none;
            color: white;
            cursor: pointer;
            font-size: 16px;
            opacity: 0.7;
            transition: opacity 0.2s;
        }

        .notification-close:hover {
            opacity: 1;
        }

        .notification-message {
            font-size: 13px;
            color: rgba(255, 255, 255, 0.8);
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%) scale(0.8);
                opacity: 0;
            }
            to {
                transform: translateX(0) scale(1);
                opacity: 1;
            }
        }

        .loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #0f2027, #203a43);
            z-index: 10000;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: opacity 0.5s ease;
        }

        .loading-content {
            text-align: center;
        }

        .loading-logo {
            font-size: 60px;
            font-weight: bold;
            color: #4CAF50;
            margin-bottom: 20px;
            text-shadow: 0 0 20px rgba(76, 175, 80, 0.5);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        .loading-text {
            font-size: 18px;
            margin-bottom: 30px;
            color: rgba(255, 255, 255, 0.8);
        }

        .loading-bar {
            width: 300px;
            height: 4px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 2px;
            overflow: hidden;
            margin-bottom: 20px;
        }

        .loading-progress {
            height: 100%;
            background: linear-gradient(90deg, #4CAF50, #45a049);
            border-radius: 2px;
            width: 0%;
            animation: loading 2s ease-in-out infinite;
        }

        .loading-version {
            font-size: 14px;
            color: rgba(255, 255, 255, 0.5);
        }

        @keyframes loading {
            0% { width: 0%; }
            50% { width: 100%; }
            100% { width: 0%; }
        }

        .explorer {
            height: 100%;
            display: flex;
            flex-direction: column;
        }

        .explorer-toolbar {
            display: flex;
            gap: 5px;
            padding: 10px;
            background: rgba(255, 255, 255, 0.05);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .explorer-content {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        .explorer-sidebar {
            width: 200px;
            background: rgba(255, 255, 255, 0.05);
            border-right: 1px solid rgba(255, 255, 255, 0.1);
            padding: 10px;
            overflow-y: auto;
        }

        .explorer-main {
            flex: 1;
            padding: 15px;
            overflow-y: auto;
        }

        .file-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 10px;
        }

        .file-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 10px;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.2s ease;
            text-align: center;
        }

        .file-item:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .file-item.selected {
            background: rgba(33, 150, 243, 0.2);
            border: 1px solid rgba(33, 150, 243, 0.5);
        }

        .file-icon {
            font-size: 32px;
            margin-bottom: 5px;
        }

        .file-name {
            font-size: 12px;
            word-break: break-all;
            margin-bottom: 3px;
        }

        .file-info {
            font-size: 10px;
            color: rgba(255, 255, 255, 0.6);
        }

        .package-manager {
            height: 100%;
            display: flex;
            flex-direction: column;
        }

        .pm-header {
            padding: 15px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .pm-header h1 {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 20px;
            margin-bottom: 15px;
        }

        .pm-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .pm-body {
            flex: 1;
            display: flex;
            padding: 15px;
            gap: 20px;
            overflow: hidden;
        }

        .pm-sidebar {
            width: 200px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 5px;
            padding: 15px;
            overflow-y: auto;
        }

        .pm-content {
            flex: 1;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 5px;
            padding: 15px;
            overflow-y: auto;
        }

        .pm-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .pm-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .pm-item:hover {
            background: rgba(255, 255, 255, 0.15);
            transform: translateX(5px);
        }

        .pm-item.active {
            background: rgba(76, 175, 80, 0.2);
            border-left: 3px solid #4CAF50;
        }

        .calculator {
            padding: 20px;
        }

        .calc-display {
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 15px;
            text-align: right;
            font-size: 24px;
            min-height: 60px;
            display: flex;
            align-items: center;
            justify-content: flex-end;
            overflow: hidden;
            font-family: monospace;
        }

        .calc-buttons {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
        }

        .calc-button {
            padding: 15px;
            border: none;
            border-radius: 5px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            font-size: 18px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .calc-button:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .calc-button.operator {
            background: rgba(255, 152, 0, 0.2);
        }

        .calc-button.operator:hover {
            background: rgba(255, 152, 0, 0.3);
        }

        .calc-button.equals {
            background: rgba(76, 175, 80, 0.2);
            grid-column: span 2;
        }

        .calc-button.equals:hover {
            background: rgba(76, 175, 80, 0.3);
        }

        .calc-button.clear {
            background: rgba(244, 67, 54, 0.2);
        }

        .calc-button.clear:hover {
            background: rgba(244, 67, 54, 0.3);
        }

        .editor {
            height: 100%;
            display: flex;
            flex-direction: column;
        }

        .editor-toolbar {
            display: flex;
            gap: 5px;
            padding: 10px;
            background: rgba(255, 255, 255, 0.05);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            flex-wrap: wrap;
        }

        .editor-content {
            flex: 1;
            position: relative;
        }

        #editor-textarea {
            width: 100%;
            height: 100%;
            background: transparent;
            border: none;
            color: white;
            font-family: monospace;
            font-size: 14px;
            padding: 15px;
            resize: none;
            outline: none;
        }

        #context-menu {
            position: fixed;
            background: rgba(30, 35, 40, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 5px 0;
            min-width: 180px;
            z-index: 10001;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            display: none;
            animation: fadeIn 0.2s ease;
        }

        .context-menu-item {
            padding: 10px 15px;
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 14px;
            color: rgba(255, 255, 255, 0.9);
        }

        .context-menu-item:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .context-menu-item.delete {
            color: #f44336;
        }

        .context-menu-item.delete:hover {
            background: rgba(244, 67, 54, 0.1);
        }

        .context-menu-separator {
            height: 1px;
            background: rgba(255, 255, 255, 0.1);
            margin: 5px 0;
        }

        @media (max-width: 768px) {
            .start-menu {
                width: calc(100% - 20px);
                height: 70vh;
            }
            
            .start-content {
                grid-template-columns: 1fr;
            }
            
            .window {
                min-width: 90vw !important;
                min-height: 50vh !important;
                left: 5vw !important;
                top: 5vh !important;
                resize: none;
            }
            
            .pm-body {
                flex-direction: column;
            }
            
            .pm-sidebar {
                width: 100%;
            }
        }

        .fs-selector {
            padding: 20px;
            height: 100%;
            overflow-y: auto;
        }

        .fs-option {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 15px;
            margin: 10px 0;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .fs-option:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: translateX(5px);
        }

        .fs-option.selected {
            background: rgba(76, 175, 80, 0.2);
            border: 2px solid #4CAF50;
        }

        .fs-option-icon {
            font-size: 32px;
        }

        .fs-option-info {
            flex: 1;
        }

        .fs-option-title {
            font-weight: 500;
            font-size: 16px;
            margin-bottom: 5px;
        }

        .fs-option-desc {
            font-size: 12px;
            color: rgba(255, 255, 255, 0.7);
        }

        .fs-status {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 3px;
            font-size: 11px;
            font-weight: bold;
            margin-left: 10px;
        }

        .fs-status.available {
            background: rgba(76, 175, 80, 0.3);
            color: #4CAF50;
        }

        .fs-status.unavailable {
            background: rgba(244, 67, 54, 0.3);
            color: #f44336;
        }

        #custom-cursor {
            position: fixed;
            width: 20px;
            height: 20px;
            border: 2px solid #4CAF50;
            border-radius: 50%;
            pointer-events: none;
            z-index: 10000;
            transform: translate(-50%, -50%);
            transition: transform 0.1s ease, border-color 0.2s ease;
            mix-blend-mode: difference;
        }

        #shader-canvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 0;
            pointer-events: none;
            display: none;
        }

        .resize-handle {
            position: absolute;
            width: 10px;
            height: 10px;
            background: rgba(76, 175, 80, 0.5);
            border-radius: 50%;
            z-index: 102;
            display: none;
        }

        .window:not(.maximized) .resize-handle {
            display: block;
        }

        .resize-handle.nw {
            top: -5px;
            left: -5px;
            cursor: nw-resize;
        }

        .resize-handle.ne {
            top: -5px;
            right: -5px;
            cursor: ne-resize;
        }

        .resize-handle.sw {
            bottom: -5px;
            left: -5px;
            cursor: sw-resize;
        }

        .resize-handle.se {
            bottom: -5px;
            right: -5px;
            cursor: se-resize;
        }

        .resize-handle.n {
            top: -5px;
            left: 50%;
            transform: translateX(-50%);
            cursor: n-resize;
        }

        .resize-handle.s {
            bottom: -5px;
            left: 50%;
            transform: translateX(-50%);
            cursor: s-resize;
        }

        .resize-handle.w {
            left: -5px;
            top: 50%;
            transform: translateY(-50%);
            cursor: w-resize;
        }

        .resize-handle.e {
            right: -5px;
            top: 50%;
            transform: translateY(-50%);
            cursor: e-resize;
        }

        .app-minimized {
            display: none !important;
        }

        .system-modal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(30, 35, 40, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.5);
            z-index: 2000;
            padding: 30px;
            min-width: 300px;
            max-width: 500px;
            animation: fadeIn 0.3s ease;
        }

        .system-modal h2 {
            color: #4CAF50;
            margin-bottom: 15px;
            text-align: center;
        }

        .system-modal p {
            margin-bottom: 20px;
            color: rgba(255, 255, 255, 0.8);
            text-align: center;
        }

        .system-modal-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 20px;
        }

        .drag-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(76, 175, 80, 0.1);
            border: 3px dashed #4CAF50;
            z-index: 9999;
            display: none;
            pointer-events: none;
        }

        .drag-overlay.active {
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            color: #4CAF50;
        }

        .toast {
            position: fixed;
            bottom: 60px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(25, 30, 35, 0.95);
            backdrop-filter: blur(10px);
            padding: 12px 20px;
            border-radius: 5px;
            border-left: 4px solid #4CAF50;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            z-index: 1001;
            animation: slideUp 0.3s ease;
            max-width: 80%;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateX(-50%) translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateX(-50%) translateY(0);
            }
        }

        .progress-bar {
            width: 100%;
            height: 6px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
            overflow: hidden;
            margin: 10px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #4CAF50, #45a049);
            border-radius: 3px;
            width: 0%;
            transition: width 0.3s ease;
        }
    </style>
</head>
<body>
    <div id="shader-canvas"></div>
    
    <div id="taskbar">
        <div class="taskbar-left">
            <button id="start-btn" class="start-button">
                <i class="fas fa-play" style="font-size: 12px;"></i>
                <span>Inicio</span>
            </button>
            <div id="running-apps" class="running-apps"></div>
        </div>
        <div class="taskbar-right">
            <div id="system-tray">
                <span id="volume-icon" title="Volumen">üîä</span>
                <span id="network-icon" title="Red">üåê</span>
                <span id="time" class="clock">00:00</span>
                <span id="date" class="date">01/01/2024</span>
            </div>
        </div>
    </div>
    
    <div id="start-menu" class="start-menu">
        <div class="start-header">
            <div class="user-info">
                <div class="user-icon"><i class="fas fa-user"></i></div>
                <div class="user-name">Usuario XP7</div>
            </div>
        </div>
        <div class="start-content">
            <div class="start-column">
                <h3>Programas</h3>
                <div class="start-item" data-app="explorer">
                    <span class="start-icon"><i class="fas fa-folder"></i></span>
                    <span class="start-text">Explorador</span>
                </div>
                <div class="start-item" data-app="notepad">
                    <span class="start-icon"><i class="fas fa-file-alt"></i></span>
                    <span class="start-text">Bloc de Notas</span>
                </div>
                <div class="start-item" data-app="calculator">
                    <span class="start-icon"><i class="fas fa-calculator"></i></span>
                    <span class="start-text">Calculadora</span>
                </div>
                <div class="start-item" data-app="package-manager">
                    <span class="start-icon"><i class="fas fa-box"></i></span>
                    <span class="start-text">Gestor de Paquetes</span>
                </div>
                <div class="start-item" data-app="act-manager">
                    <span class="start-icon"><i class="fas fa-sync-alt"></i></span>
                    <span class="start-text">Gestor de ACT</span>
                </div>
            </div>
            <div class="start-column">
                <h3>Herramientas</h3>
                <div class="start-item" data-app="storage-manager">
                    <span class="start-icon"><i class="fas fa-hdd"></i></span>
                    <span class="start-text">Storage Manager</span>
                </div>
                <div class="start-item" data-app="file-selector">
                    <span class="start-icon"><i class="fas fa-folder-open"></i></span>
                    <span class="start-text">Selector de Sistema de Archivos</span>
                </div>
                <div class="start-item" data-app="settings">
                    <span class="start-icon"><i class="fas fa-cog"></i></span>
                    <span class="start-text">Configuraci√≥n</span>
                </div>
                <div class="start-item" data-app="terminal">
                    <span class="start-icon"><i class="fas fa-terminal"></i></span>
                    <span class="start-text">Terminal</span>
                </div>
            </div>
            <div class="start-column">
                <h3>Sistema</h3>
                <div class="start-item" data-action="shutdown">
                    <span class="start-icon"><i class="fas fa-power-off"></i></span>
                    <span class="start-text">Apagar</span>
                </div>
                <div class="start-item" data-action="restart">
                    <span class="start-icon"><i class="fas fa-redo"></i></span>
                    <span class="start-text">Reiniciar</span>
                </div>
                <div class="start-item" data-action="logout">
                    <span class="start-icon"><i class="fas fa-sign-out-alt"></i></span>
                    <span class="start-text">Cerrar Sesi√≥n</span>
                </div>
            </div>
        </div>
        <div class="start-footer">
            <div class="search-box">
                <input type="text" id="start-search" placeholder="Buscar programas y archivos...">
                <button id="search-btn"><i class="fas fa-search"></i></button>
            </div>
        </div>
    </div>
    
    <div id="desktop" class="desktop"></div>
    
    <div id="windows-container"></div>
    
    <div id="custom-cursor"></div>
    
    <div id="notifications"></div>
    
    <div id="context-menu">
        <div class="context-menu-item" data-action="open">
            <i class="fas fa-folder-open"></i> Abrir
        </div>
        <div class="context-menu-item" data-action="rename">
            <i class="fas fa-edit"></i> Renombrar
        </div>
        <div class="context-menu-item" data-action="properties">
            <i class="fas fa-info-circle"></i> Propiedades
        </div>
        <div class="context-menu-separator"></div>
        <div class="context-menu-item delete" data-action="delete">
            <i class="fas fa-trash"></i> Eliminar
        </div>
    </div>
    
    <div id="loading-screen" class="loading-screen">
        <div class="loading-content">
            <div class="loading-logo">XP7 OS</div>
            <div class="loading-text">Iniciando sistema...</div>
            <div class="loading-bar">
                <div class="loading-progress"></div>
            </div>
            <div class="loading-version">Versi√≥n 3.0.0</div>
        </div>
    </div>

    <input type="file" id="file-input" style="display: none;" multiple>
    <input type="file" id="act-input" style="display: none;" accept=".act,.json">
    <input type="file" id="pak-input" style="display: none;" accept=".pak,.json">

    <div id="drag-overlay" class="drag-overlay"></div>

    <script>
        // ============================================
        // SISTEMA XP7 OS - VERSI√ìN COMPLETA
        // ACTs y PAKs al 100% funcionando
        // ============================================

        class XP7System {
            constructor() {
                this.version = '3.0.0';
                this.initialized = false;
                this.windows = new Map();
                this.apps = new Map();
                this.currentZIndex = 100;
                this.runningApps = new Map();
                this.nextWindowId = 1;
                this.activeWindow = null;
                
                // Sistema de archivos mejorado
                this.fileSystem = {
                    mode: 'localStorage',
                    directoryHandle: null,
                    structure: {},
                    currentPath: '/',
                    
                    async init() {
                        console.log('üíæ Sistema de archivos iniciando...');
                        
                        // Cargar modo
                        const savedMode = localStorage.getItem('xp7_fs_mode');
                        if (savedMode) this.mode = savedMode;
                        
                        // Cargar estructura
                        const savedStructure = localStorage.getItem('xp7_fs_structure');
                        if (savedStructure) {
                            try {
                                this.structure = JSON.parse(savedStructure);
                            } catch (e) {
                                console.error('Error cargando estructura:', e);
                                this.createDefaultStructure();
                            }
                        } else {
                            this.createDefaultStructure();
                        }
                        
                        // Crear directorios base
                        this.ensureDirectories();
                        this.ensureSystemFiles();
                        
                        // Cargar ACTs y PAKs instalados
                        this.loadInstalledUpdates();
                        this.loadInstalledPackages();
                        
                        console.log('‚úÖ Sistema de archivos listo');
                        return true;
                    },
                    
                    createDefaultStructure() {
                        this.structure = {
                            '/': ['System', 'Apps', 'User'],
                            '/System': ['config.json', 'packages.json', 'updates.json'],
                            '/Apps': [],
                            '/User': ['Documents', 'Downloads', 'Desktop', 'Backgrounds'],
                            '/User/Documents': [],
                            '/User/Downloads': [],
                            '/User/Desktop': [],
                            '/User/Backgrounds': []
                        };
                        this.saveStructure();
                    },
                    
                    ensureDirectories() {
                        const requiredDirs = ['/System', '/Apps', '/User', '/User/Documents', 
                                            '/User/Downloads', '/User/Desktop', '/User/Backgrounds'];
                        requiredDirs.forEach(dir => {
                            if (!this.structure[dir]) this.structure[dir] = [];
                        });
                        this.saveStructure();
                    },
                    
                    ensureSystemFiles() {
                        const systemFiles = {
                            '/System/config.json': JSON.stringify({
                                version: '3.0.0',
                                name: 'XP7 OS',
                                created: new Date().toISOString(),
                                fileSystem: this.mode
                            }, null, 2),
                            '/System/packages.json': '[]',
                            '/System/updates.json': '[]'
                        };
                        
                        Object.entries(systemFiles).forEach(([path, content]) => {
                            if (!this.fileExists(path)) {
                                this.writeFile(path, content);
                            }
                        });
                    },
                    
                    loadInstalledUpdates() {
                        const updates = this.getInstalledUpdates();
                        console.log(`üì¶ Updates instalados: ${updates.length}`);
                    },
                    
                    loadInstalledPackages() {
                        const packages = this.getInstalledPackages();
                        console.log(`üì¶ Paquetes instalados: ${packages.length}`);
                    },
                    
                    async readFile(path) {
                        if (this.mode === 'localStorage') {
                            const key = 'xp7_fs_' + this.normalizePath(path);
                            return localStorage.getItem(key);
                        }
                        return null;
                    },
                    
                    async writeFile(path, content) {
                        if (this.mode === 'localStorage') {
                            const key = 'xp7_fs_' + this.normalizePath(path);
                            localStorage.setItem(key, content);
                            
                            // Actualizar estructura
                            const dir = path.substring(0, path.lastIndexOf('/')) || '/';
                            const filename = path.substring(path.lastIndexOf('/') + 1);
                            
                            if (!this.structure[dir]) this.structure[dir] = [];
                            if (!this.structure[dir].includes(filename)) {
                                this.structure[dir].push(filename);
                                this.saveStructure();
                            }
                            
                            return true;
                        }
                        return false;
                    },
                    
                    fileExists(path) {
                        if (this.mode === 'localStorage') {
                            const key = 'xp7_fs_' + this.normalizePath(path);
                            return localStorage.getItem(key) !== null;
                        }
                        return false;
                    },
                    
                    async listDirectory(path = '/') {
                        const entries = [];
                        
                        if (this.mode === 'localStorage') {
                            // Directorios
                            Object.keys(this.structure).forEach(dirPath => {
                                if (dirPath.startsWith(path + '/') && dirPath !== path) {
                                    const relPath = dirPath.substring(path.length + 1);
                                    if (!relPath.includes('/')) {
                                        entries.push({
                                            name: relPath,
                                            path: dirPath,
                                            kind: 'directory',
                                            type: 'directory',
                                            icon: 'üìÅ'
                                        });
                                    }
                                }
                            });
                            
                            // Archivos
                            if (this.structure[path]) {
                                this.structure[path].forEach(filename => {
                                    entries.push({
                                        name: filename,
                                        path: path + '/' + filename,
                                        kind: 'file',
                                        type: this.getFileType(filename),
                                        icon: this.getFileIcon(filename),
                                        size: this.getFileSize(path + '/' + filename)
                                    });
                                });
                            }
                        }
                        
                        return entries.sort((a, b) => {
                            if (a.kind === 'directory' && b.kind !== 'directory') return -1;
                            if (a.kind !== 'directory' && b.kind === 'directory') return 1;
                            return a.name.localeCompare(b.name);
                        });
                    },
                    
                    getFileType(filename) {
                        const ext = filename.split('.').pop().toLowerCase();
                        const types = {
                            'txt': 'text', 'js': 'javascript', 'json': 'json',
                            'html': 'html', 'css': 'css', 'pak': 'package',
                            'act': 'update', 'png': 'image', 'jpg': 'image',
                            'pdf': 'document'
                        };
                        return types[ext] || 'unknown';
                    },
                    
                    getFileIcon(filename) {
                        const type = this.getFileType(filename);
                        const icons = {
                            'text': 'üìÑ', 'javascript': 'üìú', 'json': 'üìã',
                            'html': 'üåê', 'css': 'üé®', 'package': 'üì¶',
                            'update': 'üîÑ', 'image': 'üñºÔ∏è', 'directory': 'üìÅ',
                            'unknown': 'üìÑ'
                        };
                        return icons[type] || 'üìÑ';
                    },
                    
                    getFileSize(path) {
                        if (this.mode === 'localStorage') {
                            const key = 'xp7_fs_' + this.normalizePath(path);
                            const content = localStorage.getItem(key);
                            return content ? content.length : 0;
                        }
                        return 0;
                    },
                    
                    normalizePath(path) {
                        return path.replace(/\//g, '_').replace(/^_/, '');
                    },
                    
                    saveStructure() {
                        localStorage.setItem('xp7_fs_structure', JSON.stringify(this.structure));
                    },
                    
                    getStorageInfo() {
                        let totalSize = 0;
                        let fileCount = 0;
                        
                        for (let i = 0; i < localStorage.length; i++) {
                            const key = localStorage.key(i);
                            if (key.startsWith('xp7_fs_')) {
                                const value = localStorage.getItem(key);
                                totalSize += key.length + (value ? value.length : 0);
                                fileCount++;
                            }
                        }
                        
                        const maxSize = 5 * 1024 * 1024;
                        const usedMB = (totalSize / 1024 / 1024).toFixed(2);
                        const maxMB = (maxSize / 1024 / 1024).toFixed(2);
                        const percentage = ((totalSize / maxSize) * 100).toFixed(1);
                        
                        return {
                            used: totalSize,
                            usedMB: usedMB,
                            max: maxSize,
                            maxMB: maxMB,
                            percentage: percentage,
                            fileCount: fileCount
                        };
                    },
                    
                    // ============ SISTEMA DE ACTs ============
                    async processACTFile(content) {
                        try {
                            console.log('üì¶ Procesando archivo ACT...');
                            const data = JSON.parse(content);
                            
                            // Validar que sea un ACT v√°lido
                            if (!data.type || data.type !== 'update') {
                                throw new Error('Archivo ACT inv√°lido: type debe ser "update"');
                            }
                            
                            if (!data.name || !data.version) {
                                throw new Error('Archivo ACT inv√°lido: faltan campos requeridos');
                            }
                            
                            const actId = 'act_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                            const updateData = {
                                ...data,
                                id: actId,
                                installed: new Date().toISOString(),
                                status: 'installed'
                            };
                            
                            // Guardar en localStorage
                            localStorage.setItem(`xp7_update_${actId}`, JSON.stringify(updateData));
                            
                            // Guardar en sistema de archivos
                            const fileName = `update_${data.name.replace(/[^a-z0-9]/gi, '_')}_${data.version}.act`;
                            await this.writeFile(`/System/${fileName}`, content);
                            
                            // Ejecutar acciones del ACT
                            if (data.actions && Array.isArray(data.actions)) {
                                for (const action of data.actions) {
                                    await this.executeACTAction(action, data);
                                }
                            }
                            
                            return {
                                success: true,
                                message: `ACT "${data.name}" v${data.version} instalado correctamente`,
                                data: updateData
                            };
                            
                        } catch (error) {
                            console.error('‚ùå Error procesando ACT:', error);
                            return {
                                success: false,
                                message: 'Error: ' + error.message
                            };
                        }
                    },
                    
                    async executeACTAction(action, actData) {
                        try {
                            console.log(`‚ñ∂Ô∏è Ejecutando acci√≥n: ${action.type}`);
                            
                            switch(action.type) {
                                case 'executeCode':
                                    if (action.code) {
                                        // Ejecutar c√≥digo JavaScript
                                        try {
                                            const func = new Function(action.code);
                                            func();
                                        } catch (e) {
                                            console.error('Error ejecutando c√≥digo:', e);
                                        }
                                    }
                                    break;
                                    
                                case 'addApp':
                                    if (action.appId && action.appData) {
                                        // Agregar aplicaci√≥n al sistema
                                        if (window.XP7 && window.XP7.addApp) {
                                            window.XP7.addApp(action.appId, action.appData);
                                        }
                                    }
                                    break;
                                    
                                case 'injectCSS':
                                    if (action.content) {
                                        // Inyectar CSS
                                        const style = document.createElement('style');
                                        style.textContent = action.content;
                                        document.head.appendChild(style);
                                    }
                                    break;
                                    
                                case 'modifySystem':
                                    // Aqu√≠ puedes agregar m√°s tipos de modificaciones
                                    console.log('Modificaci√≥n del sistema:', action);
                                    break;
                            }
                            
                        } catch (error) {
                            console.error('Error ejecutando acci√≥n:', error);
                        }
                    },
                    
                    // ============ SISTEMA DE PAKs ============
                    async processPAKFile(content) {
                        try {
                            console.log('üì¶ Procesando archivo PAK...');
                            const data = JSON.parse(content);
                            
                            // Validar que sea un PAK v√°lido
                            if (!data.type || data.type !== 'application') {
                                throw new Error('Archivo PAK inv√°lido: type debe ser "application"');
                            }
                            
                            if (!data.name || !data.icon || !data.content) {
                                throw new Error('Archivo PAK inv√°lido: faltan campos requeridos');
                            }
                            
                            const appId = data.id || data.name.toLowerCase().replace(/[^a-z0-9]/g, '-');
                            const appData = {
                                id: appId,
                                name: data.name,
                                icon: data.icon,
                                description: data.description || 'Aplicaci√≥n instalada desde PAK',
                                category: data.category || 'Aplicaciones',
                                version: data.version || '1.0.0',
                                author: data.author || 'Desconocido',
                                width: data.width || 600,
                                height: data.height || 400,
                                content: data.content,
                                installed: new Date().toISOString(),
                                type: 'pak'
                            };
                            
                            // Guardar en localStorage
                            localStorage.setItem(`xp7_app_${appId}`, JSON.stringify(appData));
                            
                            // Guardar en sistema de archivos
                            const fileName = `${appId}.pak`;
                            await this.writeFile(`/Apps/${fileName}`, content);
                            
                            // Agregar al sistema
                            if (window.XP7 && window.XP7.addApp) {
                                window.XP7.addApp(appId, {
                                    name: appData.name,
                                    icon: appData.icon,
                                    description: appData.description,
                                    category: appData.category,
                                    launch: () => window.XP7.openPakApp(appData)
                                });
                            }
                            
                            return {
                                success: true,
                                message: `PAK "${data.name}" instalado correctamente`,
                                data: appData
                            };
                            
                        } catch (error) {
                            console.error('‚ùå Error procesando PAK:', error);
                            return {
                                success: false,
                                message: 'Error: ' + error.message
                            };
                        }
                    },
                    
                    getInstalledUpdates() {
                        const updates = [];
                        for (let i = 0; i < localStorage.length; i++) {
                            const key = localStorage.key(i);
                            if (key.startsWith('xp7_update_')) {
                                try {
                                    const update = JSON.parse(localStorage.getItem(key));
                                    updates.push(update);
                                } catch (e) {
                                    console.warn('Error parseando update:', key);
                                }
                            }
                        }
                        return updates;
                    },
                    
                    getInstalledPackages() {
                        const packages = [];
                        for (let i = 0; i < localStorage.length; i++) {
                            const key = localStorage.key(i);
                            if (key.startsWith('xp7_app_')) {
                                try {
                                    const app = JSON.parse(localStorage.getItem(key));
                                    packages.push(app);
                                } catch (e) {
                                    console.warn('Error parseando app:', key);
                                }
                            }
                        }
                        return packages;
                    },
                    
                    async deleteUpdate(updateId) {
                        localStorage.removeItem(`xp7_update_${updateId}`);
                        return true;
                    },
                    
                    async deletePackage(appId) {
                        localStorage.removeItem(`xp7_app_${appId}`);
                        return true;
                    }
                };
                
                // Aplicaciones por defecto
                this.defaultApps = {
                    'explorer': {
                        name: 'Explorador',
                        icon: 'üìÅ',
                        description: 'Explorador de archivos',
                        category: 'Sistema',
                        launch: () => this.openApp('explorer')
                    },
                    'notepad': {
                        name: 'Bloc de Notas',
                        icon: 'üìù',
                        description: 'Editor de texto',
                        category: 'Herramientas',
                        launch: () => this.openApp('notepad')
                    },
                    'calculator': {
                        name: 'Calculadora',
                        icon: 'üßÆ',
                        description: 'Calculadora b√°sica',
                        category: 'Herramientas',
                        launch: () => this.openApp('calculator')
                    },
                    'package-manager': {
                        name: 'Gestor de Paquetes',
                        icon: 'üì¶',
                        description: 'Instalar y gestionar PAKs',
                        category: 'Sistema',
                        launch: () => this.openApp('package-manager')
                    },
                    'act-manager': {
                        name: 'Gestor de ACT',
                        icon: 'üîÑ',
                        description: 'Instalar y gestionar ACTs',
                        category: 'Sistema',
                        launch: () => this.openApp('act-manager')
                    },
                    'storage-manager': {
                        name: 'Storage Manager',
                        icon: 'üíæ',
                        description: 'Gestionar almacenamiento',
                        category: 'Sistema',
                        launch: () => this.openApp('storage-manager')
                    },
                    'file-selector': {
                        name: 'Selector de Archivos',
                        icon: 'üìÇ',
                        description: 'Seleccionar sistema de archivos',
                        category: 'Herramientas',
                        launch: () => this.openApp('file-selector')
                    },
                    'settings': {
                        name: 'Configuraci√≥n',
                        icon: '‚öôÔ∏è',
                        description: 'Configuraci√≥n del sistema',
                        category: 'Sistema',
                        launch: () => this.openApp('settings')
                    },
                    'terminal': {
                        name: 'Terminal',
                        icon: 'üíª',
                        description: 'Terminal del sistema',
                        category: 'Herramientas',
                        launch: () => this.openApp('terminal')
                    }
                };
            }
            
            async init() {
                console.log('üöÄ XP7 OS v' + this.version + ' iniciando...');
                
                try {
                    // Inicializar sistema de archivos
                    await this.fileSystem.init();
                    
                    // Cargar aplicaciones
                    this.loadApps();
                    
                    // Configurar eventos
                    this.setupEvents();
                    
                    // Iniciar reloj
                    this.startClock();
                    
                    // Actualizar escritorio
                    this.updateDesktop();
                    
                    // Ocultar pantalla de carga
                    setTimeout(() => {
                        document.getElementById('loading-screen').style.opacity = '0';
                        setTimeout(() => {
                            document.getElementById('loading-screen').style.display = 'none';
                            this.showNotification('XP7 OS', 'Sistema iniciado correctamente', 'success');
                            this.initialized = true;
                            console.log('‚úÖ XP7 OS listo');
                        }, 500);
                    }, 2000);
                    
                } catch (error) {
                    console.error('Error inicializando:', error);
                    this.showNotification('Error', 'Error al iniciar el sistema', 'error');
                }
            }
            
            loadApps() {
                // Cargar apps por defecto
                Object.entries(this.defaultApps).forEach(([id, app]) => {
                    this.apps.set(id, app);
                });
                
                // Cargar PAKs instalados
                const installedPackages = this.fileSystem.getInstalledPackages();
                installedPackages.forEach(pkg => {
                    this.apps.set(pkg.id, {
                        name: pkg.name,
                        icon: pkg.icon,
                        description: pkg.description,
                        category: pkg.category || 'Aplicaciones',
                        launch: () => this.openPakApp(pkg)
                    });
                });
                
                console.log(`üì± Aplicaciones cargadas: ${this.apps.size}`);
            }
            
            addApp(id, appData) {
                this.apps.set(id, appData);
                this.updateDesktop();
                this.showNotification('Aplicaci√≥n', `"${appData.name}" instalada`, 'success');
            }
            
            setupEvents() {
                // Bot√≥n de inicio
                document.getElementById('start-btn').addEventListener('click', (e) => {
                    e.stopPropagation();
                    const menu = document.getElementById('start-menu');
                    menu.classList.toggle('active');
                });
                
                // Cerrar men√∫ al hacer clic fuera
                document.addEventListener('click', (e) => {
                    if (!e.target.closest('#start-menu') && !e.target.closest('#start-btn')) {
                        document.getElementById('start-menu').classList.remove('active');
                    }
                });
                
                // Items del men√∫ inicio
                document.querySelectorAll('.start-item').forEach(item => {
                    item.addEventListener('click', () => {
                        const app = item.dataset.app;
                        const action = item.dataset.action;
                        
                        if (app) {
                            this.openApp(app);
                        } else if (action) {
                            this.handleSystemAction(action);
                        }
                        
                        document.getElementById('start-menu').classList.remove('active');
                    });
                });
                
                // Inputs de archivos
                document.getElementById('file-input').addEventListener('change', (e) => {
                    this.handleFileUpload(e.target.files);
                });
                
                document.getElementById('act-input').addEventListener('change', (e) => {
                    this.handleACTUpload(e.target.files[0]);
                });
                
                document.getElementById('pak-input').addEventListener('change', (e) => {
                    this.handlePAKUpload(e.target.files[0]);
                });
                
                // Drag and drop
                document.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    document.getElementById('drag-overlay').classList.add('active');
                });
                
                document.addEventListener('dragleave', (e) => {
                    if (!e.relatedTarget || e.relatedTarget.nodeType === 3) {
                        document.getElementById('drag-overlay').classList.remove('active');
                    }
                });
                
                document.addEventListener('drop', async (e) => {
                    e.preventDefault();
                    document.getElementById('drag-overlay').classList.remove('active');
                    
                    const files = Array.from(e.dataTransfer.files);
                    if (files.length > 0) {
                        await this.handleDroppedFiles(files);
                    }
                });
            }
            
            updateDesktop() {
                const desktop = document.getElementById('desktop');
                desktop.innerHTML = '';
                
                // Agrupar por categor√≠a
                const appsByCategory = {};
                this.apps.forEach((app, id) => {
                    const category = app.category || 'Otros';
                    if (!appsByCategory[category]) {
                        appsByCategory[category] = [];
                    }
                    appsByCategory[category].push({ id, ...app });
                });
                
                // Mostrar apps
                Object.keys(appsByCategory).forEach(category => {
                    appsByCategory[category].forEach(app => {
                        const icon = document.createElement('div');
                        icon.className = 'desktop-icon';
                        icon.innerHTML = `
                            <div class="icon">${app.icon}</div>
                            <div class="name">${app.name}</div>
                        `;
                        icon.addEventListener('dblclick', () => {
                            if (app.launch) app.launch();
                        });
                        desktop.appendChild(icon);
                    });
                });
            }
            
            async openApp(appId) {
                console.log(`üì± Abriendo: ${appId}`);
                
                if (!this.apps.has(appId)) {
                    this.showNotification('Error', `App "${appId}" no encontrada`, 'error');
                    return;
                }
                
                const app = this.apps.get(appId);
                
                // Si ya est√° abierta, traer al frente
                if (this.runningApps.has(appId)) {
                    const windowId = this.runningApps.get(appId);
                    const windowEl = document.getElementById(windowId);
                    if (windowEl) {
                        windowEl.style.zIndex = ++this.currentZIndex;
                        this.activeWindow = windowId;
                        this.updateTaskbar();
                        return;
                    }
                }
                
                // Crear ventana seg√∫n app
                switch(appId) {
                    case 'explorer':
                        await this.openExplorer();
                        break;
                    case 'notepad':
                        this.openNotepad();
                        break;
                    case 'calculator':
                        this.openCalculator();
                        break;
                    case 'package-manager':
                        this.openPackageManager();
                        break;
                    case 'act-manager':
                        this.openACTManager();
                        break;
                    case 'storage-manager':
                        this.openStorageManager();
                        break;
                    case 'file-selector':
                        this.openFileSelector();
                        break;
                    case 'settings':
                        this.openSettings();
                        break;
                    case 'terminal':
                        this.openTerminal();
                        break;
                    default:
                        // App personalizada
                        this.openCustomApp(appId, app);
                }
                
                this.updateTaskbar();
            }
            
            // ============ APLICACIONES ============
            
            async openExplorer() {
                const windowId = `window_${this.nextWindowId++}`;
                this.runningApps.set('explorer', windowId);
                
                const entries = await this.fileSystem.listDirectory('/');
                
                const windowEl = this.createWindow({
                    id: windowId,
                    title: 'Explorador',
                    icon: 'üìÅ',
                    width: 800,
                    height: 500,
                    content: `
                        <div class="explorer">
                            <div class="explorer-toolbar">
                                <button class="btn-primary" id="back-btn"><i class="fas fa-arrow-left"></i></button>
                                <button class="btn-primary" id="forward-btn"><i class="fas fa-arrow-right"></i></button>
                                <button class="btn-primary" id="up-btn"><i class="fas fa-arrow-up"></i></button>
                                <input type="text" id="path-input" value="/" style="flex:1;margin:0 10px;padding:5px;background:rgba(255,255,255,0.1);border:none;color:white;border-radius:3px;">
                                <button class="btn-primary" id="refresh-btn"><i class="fas fa-sync-alt"></i></button>
                                <button class="btn-primary" id="upload-btn"><i class="fas fa-upload"></i></button>
                            </div>
                            <div class="explorer-content">
                                <div class="explorer-sidebar">
                                    <h3 style="margin-bottom:10px;">Ubicaciones</h3>
                                    <div class="pm-list">
                                        <div class="pm-item active" data-path="/"><i class="fas fa-home"></i> Inicio</div>
                                        <div class="pm-item" data-path="/User/Documents"><i class="fas fa-file"></i> Documentos</div>
                                        <div class="pm-item" data-path="/User/Downloads"><i class="fas fa-download"></i> Descargas</div>
                                        <div class="pm-item" data-path="/Apps"><i class="fas fa-box"></i> Aplicaciones</div>
                                        <div class="pm-item" data-path="/System"><i class="fas fa-cog"></i> Sistema</div>
                                    </div>
                                </div>
                                <div class="explorer-main">
                                    <h3 id="current-path">Archivos en /</h3>
                                    <div class="file-list" id="file-list">
                                        ${entries.map(entry => `
                                            <div class="file-item" data-path="${entry.path}" data-kind="${entry.kind}">
                                                <div class="file-icon">${entry.icon}</div>
                                                <div class="file-name">${entry.name}</div>
                                                <div class="file-info">${entry.kind === 'directory' ? 'Carpeta' : entry.type}</div>
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>
                            </div>
                        </div>
                    `
                });
                
                this.setupExplorerEvents(windowEl);
            }
            
            setupExplorerEvents(windowEl) {
                const content = windowEl.querySelector('.window-content');
                
                content.querySelector('#upload-btn').addEventListener('click', () => {
                    document.getElementById('file-input').click();
                });
                
                content.querySelector('#refresh-btn').addEventListener('click', async () => {
                    const pathInput = content.querySelector('#path-input');
                    const currentPath = pathInput.value;
                    const entries = await this.fileSystem.listDirectory(currentPath);
                    
                    const fileList = content.querySelector('#file-list');
                    fileList.innerHTML = entries.map(entry => `
                        <div class="file-item" data-path="${entry.path}" data-kind="${entry.kind}">
                            <div class="file-icon">${entry.icon}</div>
                            <div class="file-name">${entry.name}</div>
                            <div class="file-info">${entry.kind === 'directory' ? 'Carpeta' : entry.type}</div>
                        </div>
                    `).join('');
                });
            }
            
            openNotepad() {
                const windowId = `window_${this.nextWindowId++}`;
                this.runningApps.set('notepad', windowId);
                
                this.createWindow({
                    id: windowId,
                    title: 'Bloc de Notas',
                    icon: 'üìù',
                    width: 600,
                    height: 400,
                    content: `
                        <div class="editor">
                            <div class="editor-toolbar">
                                <button class="btn-primary" id="new-btn"><i class="fas fa-file"></i></button>
                                <button class="btn-primary" id="save-btn"><i class="fas fa-save"></i></button>
                            </div>
                            <div class="editor-content">
                                <textarea id="notepad-text" placeholder="Escribe aqu√≠..." style="width:100%;height:100%;background:transparent;color:white;border:none;padding:10px;font-family:monospace;font-size:14px;resize:none;outline:none;"></textarea>
                            </div>
                        </div>
                    `
                });
            }
            
            openCalculator() {
                const windowId = `window_${this.nextWindowId++}`;
                this.runningApps.set('calculator', windowId);
                
                this.createWindow({
                    id: windowId,
                    title: 'Calculadora',
                    icon: 'üßÆ',
                    width: 320,
                    height: 450,
                    content: `
                        <div class="calculator">
                            <div class="calc-display" id="calc-display">0</div>
                            <div class="calc-buttons">
                                <button class="calc-button clear" data-action="clear">C</button>
                                <button class="calc-button" data-action="clear-entry">CE</button>
                                <button class="calc-button" data-action="backspace">‚å´</button>
                                <button class="calc-button operator" data-action="divide">√∑</button>
                                
                                <button class="calc-button" data-number="7">7</button>
                                <button class="calc-button" data-number="8">8</button>
                                <button class="calc-button" data-number="9">9</button>
                                <button class="calc-button operator" data-action="multiply">√ó</button>
                                
                                <button class="calc-button" data-number="4">4</button>
                                <button class="calc-button" data-number="5">5</button>
                                <button class="calc-button" data-number="6">6</button>
                                <button class="calc-button operator" data-action="subtract">‚àí</button>
                                
                                <button class="calc-button" data-number="1">1</button>
                                <button class="calc-button" data-number="2">2</button>
                                <button class="calc-button" data-number="3">3</button>
                                <button class="calc-button operator" data-action="add">+</button>
                                
                                <button class="calc-button" data-number="0" style="grid-column:span 2;">0</button>
                                <button class="calc-button" data-action="decimal">.</button>
                                <button class="calc-button operator" data-action="equals">=</button>
                            </div>
                        </div>
                    `
                });
                
                // L√≥gica de calculadora
                const windowEl = document.getElementById(windowId);
                const display = windowEl.querySelector('#calc-display');
                let currentInput = '0';
                let previousInput = '';
                let operation = null;
                
                function updateDisplay() {
                    display.textContent = currentInput;
                }
                
                windowEl.querySelectorAll('[data-number]').forEach(btn => {
                    btn.addEventListener('click', () => {
                        if (currentInput === '0') {
                            currentInput = btn.dataset.number;
                        } else {
                            currentInput += btn.dataset.number;
                        }
                        updateDisplay();
                    });
                });
                
                windowEl.querySelectorAll('[data-action]').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const action = btn.dataset.action;
                        
                        switch(action) {
                            case 'clear':
                                currentInput = '0';
                                previousInput = '';
                                operation = null;
                                break;
                            case 'clear-entry':
                                currentInput = '0';
                                break;
                            case 'backspace':
                                if (currentInput.length > 1) {
                                    currentInput = currentInput.slice(0, -1);
                                } else {
                                    currentInput = '0';
                                }
                                break;
                            case 'decimal':
                                if (!currentInput.includes('.')) {
                                    currentInput += '.';
                                }
                                break;
                            case 'add':
                            case 'subtract':
                            case 'multiply':
                            case 'divide':
                                previousInput = currentInput;
                                operation = action;
                                currentInput = '0';
                                break;
                            case 'equals':
                                if (operation && previousInput) {
                                    const prev = parseFloat(previousInput);
                                    const current = parseFloat(currentInput);
                                    let result = 0;
                                    
                                    switch(operation) {
                                        case 'add': result = prev + current; break;
                                        case 'subtract': result = prev - current; break;
                                        case 'multiply': result = prev * current; break;
                                        case 'divide': result = prev / current; break;
                                    }
                                    
                                    currentInput = result.toString();
                                    operation = null;
                                    previousInput = '';
                                }
                                break;
                        }
                        
                        updateDisplay();
                    });
                });
                
                updateDisplay();
            }
            
            openPackageManager() {
                const windowId = `window_${this.nextWindowId++}`;
                this.runningApps.set('package-manager', windowId);
                
                const packages = this.fileSystem.getInstalledPackages();
                
                this.createWindow({
                    id: windowId,
                    title: 'Gestor de Paquetes',
                    icon: 'üì¶',
                    width: 700,
                    height: 500,
                    content: `
                        <div class="package-manager">
                            <div class="pm-header">
                                <h1><i class="fas fa-box"></i> Gestor de Paquetes</h1>
                                <div class="pm-actions">
                                    <button class="btn-primary" id="install-pak-btn">
                                        <i class="fas fa-download"></i> Instalar PAK
                                    </button>
                                    <button class="btn-secondary" id="refresh-btn">
                                        <i class="fas fa-sync-alt"></i> Actualizar
                                    </button>
                                </div>
                            </div>
                            <div class="pm-body">
                                <div class="pm-sidebar">
                                    <h3>Filtros</h3>
                                    <div class="pm-list">
                                        <div class="pm-item active" data-filter="all">Todos</div>
                                        <div class="pm-item" data-filter="system">Sistema</div>
                                        <div class="pm-item" data-filter="tools">Herramientas</div>
                                        <div class="pm-item" data-filter="apps">Aplicaciones</div>
                                    </div>
                                </div>
                                <div class="pm-content">
                                    <h3>Paquetes Instalados (${packages.length})</h3>
                                    <div id="packages-list" style="margin-top:15px;">
                                        ${packages.length === 0 ? `
                                            <div style="text-align:center;padding:40px;color:rgba(255,255,255,0.5);">
                                                <i class="fas fa-box-open" style="font-size:48px;margin-bottom:20px;"></i>
                                                <p>No hay paquetes instalados</p>
                                            </div>
                                        ` : packages.map(pkg => `
                                            <div class="pm-item" style="margin-bottom:10px;">
                                                <div style="display:flex;align-items:center;gap:15px;">
                                                    <div style="font-size:32px;">${pkg.icon}</div>
                                                    <div style="flex:1;">
                                                        <div style="font-weight:500;">${pkg.name}</div>
                                                        <div style="font-size:12px;color:rgba(255,255,255,0.6);">
                                                            ${pkg.description || 'Sin descripci√≥n'}
                                                            <div style="margin-top:5px;">
                                                                <span style="background:rgba(76,175,80,0.2);padding:2px 6px;border-radius:3px;font-size:10px;">
                                                                    v${pkg.version || '1.0.0'}
                                                                </span>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <div>
                                                        <button class="btn-danger delete-pak-btn" data-id="${pkg.id}" style="padding:5px 10px;font-size:12px;">
                                                            <i class="fas fa-trash"></i>
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>
                            </div>
                        </div>
                    `
                });
                
                const windowEl = document.getElementById(windowId);
                const content = windowEl.querySelector('.window-content');
                
                content.querySelector('#install-pak-btn').addEventListener('click', () => {
                    document.getElementById('pak-input').click();
                });
                
                content.querySelector('#refresh-btn').addEventListener('click', () => {
                    windowEl.querySelector('.window-control.close').click();
                    this.openApp('package-manager');
                });
                
                content.querySelectorAll('.delete-pak-btn').forEach(btn => {
                    btn.addEventListener('click', async () => {
                        const appId = btn.dataset.id;
                        if (confirm(`¬øEliminar "${appId}"?`)) {
                            await this.fileSystem.deletePackage(appId);
                            this.apps.delete(appId);
                            this.updateDesktop();
                            windowEl.querySelector('.window-control.close').click();
                            this.openApp('package-manager');
                            this.showNotification('Paquete', 'Paquete eliminado', 'info');
                        }
                    });
                });
            }
            
            openACTManager() {
                const windowId = `window_${this.nextWindowId++}`;
                this.runningApps.set('act-manager', windowId);
                
                const updates = this.fileSystem.getInstalledUpdates();
                
                this.createWindow({
                    id: windowId,
                    title: 'Gestor de ACT',
                    icon: 'üîÑ',
                    width: 700,
                    height: 500,
                    content: `
                        <div style="padding:20px;height:100%;overflow-y:auto;">
                            <h2><i class="fas fa-sync-alt"></i> Gestor de ACT</h2>
                            <p style="color:rgba(255,255,255,0.7);margin-bottom:30px;">
                                Instala y gestiona archivos ACT de actualizaci√≥n
                            </p>
                            
                            <div style="margin-bottom:30px;padding:20px;background:rgba(255,255,255,0.05);border-radius:10px;">
                                <h3 style="color:#4CAF50;margin-bottom:15px;">
                                    <i class="fas fa-download"></i> Instalar ACT
                                </h3>
                                <p style="margin-bottom:15px;">
                                    Los archivos ACT contienen actualizaciones del sistema.
                                </p>
                                <button class="btn-primary" id="install-act-btn" style="min-width:200px;">
                                    <i class="fas fa-file-import"></i> Instalar Archivo ACT
                                </button>
                            </div>
                            
                            <div>
                                <h3 style="color:#2196F3;margin-bottom:15px;">
                                    <i class="fas fa-history"></i> ACTs Instalados (${updates.length})
                                </h3>
                                ${updates.length === 0 ? `
                                    <div style="text-align:center;padding:40px;color:rgba(255,255,255,0.5);">
                                        <i class="fas fa-sync" style="font-size:48px;margin-bottom:20px;"></i>
                                        <p>No hay ACTs instalados</p>
                                    </div>
                                ` : `
                                    <div style="display:flex;flex-direction:column;gap:10px;">
                                        ${updates.map(update => `
                                            <div class="pm-item" style="margin-bottom:10px;">
                                                <div style="display:flex;align-items:center;gap:15px;">
                                                    <div style="font-size:32px;"><i class="fas fa-sync-alt"></i></div>
                                                    <div style="flex:1;">
                                                        <div style="font-weight:500;">${update.name}</div>
                                                        <div style="font-size:12px;color:rgba(255,255,255,0.6);">
                                                            ${update.description || 'Sin descripci√≥n'}
                                                            <div style="margin-top:5px;">
                                                                <span style="background:rgba(33,150,243,0.2);padding:2px 6px;border-radius:3px;font-size:10px;">
                                                                    v${update.version || '1.0.0'}
                                                                </span>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <div>
                                                        <button class="btn-danger delete-act-btn" data-id="${update.id}" style="padding:5px 10px;font-size:12px;">
                                                            <i class="fas fa-trash"></i>
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>
                                        `).join('')}
                                    </div>
                                `}
                            </div>
                        </div>
                    `
                });
                
                const windowEl = document.getElementById(windowId);
                const content = windowEl.querySelector('.window-content');
                
                content.querySelector('#install-act-btn').addEventListener('click', () => {
                    document.getElementById('act-input').click();
                });
                
                content.querySelectorAll('.delete-act-btn').forEach(btn => {
                    btn.addEventListener('click', async () => {
                        const updateId = btn.dataset.id;
                        if (confirm('¬øEliminar este ACT?')) {
                            await this.fileSystem.deleteUpdate(updateId);
                            windowEl.querySelector('.window-control.close').click();
                            this.openApp('act-manager');
                            this.showNotification('ACT', 'ACT eliminado', 'info');
                        }
                    });
                });
            }
            
            openStorageManager() {
                const windowId = `window_${this.nextWindowId++}`;
                this.runningApps.set('storage-manager', windowId);
                
                const storageInfo = this.fileSystem.getStorageInfo();
                
                this.createWindow({
                    id: windowId,
                    title: 'Storage Manager',
                    icon: 'üíæ',
                    width: 600,
                    height: 400,
                    content: `
                        <div style="padding:20px;">
                            <h2><i class="fas fa-hdd"></i> Storage Manager</h2>
                            
                            <div style="margin:30px 0;padding:20px;background:rgba(255,255,255,0.05);border-radius:10px;">
                                <h3 style="color:#4CAF50;margin-bottom:15px;">Uso de Almacenamiento</h3>
                                <div style="text-align:center;">
                                    <div style="width:150px;height:150px;margin:0 auto 20px;border-radius:50%;background:conic-gradient(#4CAF50 0% ${storageInfo.percentage}%, rgba(255,255,255,0.1) ${storageInfo.percentage}% 100%);display:flex;align-items:center;justify-content:center;">
                                        <div style="width:100px;height:100px;background:rgba(30,35,40,0.95);border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:24px;font-weight:bold;">
                                            ${storageInfo.percentage}%
                                        </div>
                                    </div>
                                    <div style="font-size:24px;font-weight:bold;color:#4CAF50;">
                                        ${storageInfo.usedMB} MB
                                    </div>
                                    <div style="font-size:14px;color:rgba(255,255,255,0.6);">
                                        de ${storageInfo.maxMB} MB utilizados
                                    </div>
                                </div>
                            </div>
                            
                            <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px;">
                                <button class="btn-primary" id="export-btn">
                                    <i class="fas fa-file-export"></i> Exportar Todo
                                </button>
                                <button class="btn-danger" id="reset-btn">
                                    <i class="fas fa-trash"></i> Restablecer
                                </button>
                            </div>
                        </div>
                    `
                });
                
                const windowEl = document.getElementById(windowId);
                const content = windowEl.querySelector('.window-content');
                
                content.querySelector('#export-btn').addEventListener('click', () => {
                    this.exportAllData();
                });
                
                content.querySelector('#reset-btn').addEventListener('click', () => {
                    if (confirm('‚ö†Ô∏è ¬øRestablecer sistema?\n\nSe eliminar√°n todos los datos.')) {
                        localStorage.clear();
                        this.showNotification('Sistema', 'Restablecido. Recargando...', 'warning');
                        setTimeout(() => location.reload(), 2000);
                    }
                });
            }
            
            openFileSelector() {
                const windowId = `window_${this.nextWindowId++}`;
                this.runningApps.set('file-selector', windowId);
                
                this.createWindow({
                    id: windowId,
                    title: 'Selector de Archivos',
                    icon: 'üìÇ',
                    width: 500,
                    height: 400,
                    content: `
                        <div class="fs-selector">
                            <h2><i class="fas fa-folder-open"></i> Sistema de Archivos</h2>
                            <p style="color:rgba(255,255,255,0.7);margin-bottom:30px;">
                                Selecciona el modo de almacenamiento
                            </p>
                            
                            <div class="fs-option ${this.fileSystem.mode === 'localStorage' ? 'selected' : ''}" id="option-local">
                                <div class="fs-option-icon"><i class="fas fa-database"></i></div>
                                <div class="fs-option-info">
                                    <div class="fs-option-title">Local Storage</div>
                                    <div class="fs-option-desc">Almacena en el navegador (5MB max)</div>
                                </div>
                                <span class="fs-status ${this.fileSystem.mode === 'localStorage' ? 'available' : ''}">
                                    ${this.fileSystem.mode === 'localStorage' ? '‚úÖ Activo' : ''}
                                </span>
                            </div>
                            
                            <div style="margin-top:30px;text-align:center;">
                                <button class="btn-primary" id="save-fs-btn" style="min-width:200px;">
                                    <i class="fas fa-save"></i> Guardar Configuraci√≥n
                                </button>
                            </div>
                        </div>
                    `
                });
                
                const windowEl = document.getElementById(windowId);
                const content = windowEl.querySelector('.window-content');
                
                content.querySelector('#save-fs-btn').addEventListener('click', () => {
                    this.showNotification('Sistema', 'Configuraci√≥n guardada', 'success');
                    windowEl.querySelector('.window-control.close').click();
                });
            }
            
            openSettings() {
                const windowId = `window_${this.nextWindowId++}`;
                this.runningApps.set('settings', windowId);
                
                this.createWindow({
                    id: windowId,
                    title: 'Configuraci√≥n',
                    icon: '‚öôÔ∏è',
                    width: 500,
                    height: 400,
                    content: `
                        <div style="padding:20px;">
                            <h2><i class="fas fa-cog"></i> Configuraci√≥n</h2>
                            
                            <div style="margin:30px 0;">
                                <h3 style="color:#4CAF50;margin-bottom:15px;">Informaci√≥n del Sistema</h3>
                                <div style="background:rgba(255,255,255,0.05);padding:15px;border-radius:5px;">
                                    <div><strong>Versi√≥n:</strong> ${this.version}</div>
                                    <div><strong>Aplicaciones:</strong> ${this.apps.size}</div>
                                    <div><strong>Archivos:</strong> ${this.fileSystem.getStorageInfo().fileCount}</div>
                                </div>
                            </div>
                            
                            <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;">
                                <button class="btn-secondary" id="clear-cache-btn">
                                    <i class="fas fa-broom"></i> Limpiar Cache
                                </button>
                                <button class="btn-secondary" id="export-config-btn">
                                    <i class="fas fa-save"></i> Exportar Config
                                </button>
                            </div>
                        </div>
                    `
                });
                
                const windowEl = document.getElementById(windowId);
                const content = windowEl.querySelector('.window-content');
                
                content.querySelector('#clear-cache-btn').addEventListener('click', () => {
                    let count = 0;
                    for (let i = 0; i < localStorage.length; i++) {
                        const key = localStorage.key(i);
                        if (!key.startsWith('xp7_')) {
                            localStorage.removeItem(key);
                            count++;
                        }
                    }
                    this.showNotification('Cache', `${count} items limpiados`, 'info');
                });
                
                content.querySelector('#export-config-btn').addEventListener('click', () => {
                    this.exportConfiguration();
                });
            }
            
            openTerminal() {
                const windowId = `window_${this.nextWindowId++}`;
                this.runningApps.set('terminal', windowId);
                
                this.createWindow({
                    id: windowId,
                    title: 'Terminal',
                    icon: 'üíª',
                    width: 700,
                    height: 500,
                    content: `
                        <div style="height:100%;display:flex;flex-direction:column;background:#000;color:#0f0;font-family:monospace;font-size:14px;">
                            <div style="padding:10px;border-bottom:1px solid #0f0;">
                                <strong>XP7 Terminal v1.0.0</strong>
                            </div>
                            <div id="terminal-output" style="flex:1;padding:10px;overflow-y:auto;white-space:pre-wrap;">Bienvenido a XP7 Terminal. Escribe "help" para comandos.</div>
                            <div style="padding:10px;border-top:1px solid #0f0;display:flex;align-items:center;">
                                <span style="color:#0f0;margin-right:10px;">user@xp7:~$</span>
                                <input type="text" id="terminal-input" style="flex:1;background:transparent;border:none;color:#0f0;font-family:monospace;font-size:14px;outline:none;" autofocus>
                            </div>
                        </div>
                    `
                });
            }
            
            openCustomApp(appId, appData) {
                const windowId = `window_${this.nextWindowId++}`;
                this.runningApps.set(appId, windowId);
                
                this.createWindow({
                    id: windowId,
                    title: appData.name,
                    icon: appData.icon,
                    width: appData.width || 600,
                    height: appData.height || 400,
                    content: appData.content || `
                        <div style="padding:20px;text-align:center;">
                            <div style="font-size:48px;margin-bottom:20px;">${appData.icon}</div>
                            <h2>${appData.name}</h2>
                            <p style="color:rgba(255,255,255,0.7);margin-top:10px;">
                                ${appData.description || 'Aplicaci√≥n personalizada'}
                            </p>
                        </div>
                    `
                });
            }
            
            openPakApp(pakData) {
                this.openCustomApp(pakData.id, pakData);
            }
            
            // ============ SISTEMA DE VENTANAS ============
            
            createWindow(options) {
                const windowEl = document.createElement('div');
                windowEl.className = 'window';
                windowEl.id = options.id;
                windowEl.style.width = options.width + 'px';
                windowEl.style.height = options.height + 'px';
                windowEl.style.left = '50px';
                windowEl.style.top = '50px';
                windowEl.style.zIndex = this.currentZIndex++;
                
                windowEl.innerHTML = `
                    <div class="window-header">
                        <div class="window-title">
                            <span>${options.icon}</span>
                            <span>${options.title}</span>
                        </div>
                        <div class="window-controls">
                            <button class="window-control minimize"><i class="fas fa-window-minimize"></i></button>
                            <button class="window-control maximize"><i class="fas fa-window-maximize"></i></button>
                            <button class="window-control close"><i class="fas fa-times"></i></button>
                        </div>
                    </div>
                    <div class="window-content">${options.content}</div>
                `;
                
                document.getElementById('windows-container').appendChild(windowEl);
                this.windows.set(options.id, windowEl);
                this.activeWindow = options.id;
                
                this.setupWindowEvents(windowEl);
                return windowEl;
            }
            
            setupWindowEvents(windowEl) {
                const header = windowEl.querySelector('.window-header');
                const minimizeBtn = windowEl.querySelector('.minimize');
                const maximizeBtn = windowEl.querySelector('.maximize');
                const closeBtn = windowEl.querySelector('.close');
                
                let isDragging = false;
                let dragOffset = { x: 0, y: 0 };
                
                header.addEventListener('mousedown', (e) => {
                    isDragging = true;
                    dragOffset = {
                        x: e.clientX - windowEl.offsetLeft,
                        y: e.clientY - windowEl.offsetTop
                    };
                    windowEl.style.zIndex = this.currentZIndex++;
                    this.activeWindow = windowEl.id;
                    this.updateTaskbar();
                });
                
                document.addEventListener('mousemove', (e) => {
                    if (isDragging) {
                        windowEl.style.left = (e.clientX - dragOffset.x) + 'px';
                        windowEl.style.top = (e.clientY - dragOffset.y) + 'px';
                    }
                });
                
                document.addEventListener('mouseup', () => {
                    isDragging = false;
                });
                
                minimizeBtn.addEventListener('click', () => {
                    windowEl.classList.add('app-minimized');
                    this.updateTaskbar();
                });
                
                maximizeBtn.addEventListener('click', () => {
                    if (windowEl.classList.contains('maximized')) {
                        windowEl.classList.remove('maximized');
                        windowEl.style.width = '600px';
                        windowEl.style.height = '400px';
                        windowEl.style.left = '50px';
                        windowEl.style.top = '50px';
                    } else {
                        windowEl.classList.add('maximized');
                        windowEl.style.width = 'calc(100vw - 20px)';
                        windowEl.style.height = 'calc(100vh - 60px)';
                        windowEl.style.left = '10px';
                        windowEl.style.top = '10px';
                    }
                });
                
                closeBtn.addEventListener('click', () => {
                    // Encontrar appId
                    const appId = Array.from(this.runningApps.entries())
                        .find(([id, winId]) => winId === windowEl.id)?.[0];
                    if (appId) this.runningApps.delete(appId);
                    
                    windowEl.remove();
                    this.windows.delete(windowEl.id);
                    this.updateTaskbar();
                });
                
                windowEl.addEventListener('mousedown', () => {
                    windowEl.style.zIndex = this.currentZIndex++;
                    this.activeWindow = windowEl.id;
                    this.updateTaskbar();
                });
            }
            
            updateTaskbar() {
                const runningAppsEl = document.getElementById('running-apps');
                runningAppsEl.innerHTML = '';
                
                this.runningApps.forEach((windowId, appId) => {
                    if (this.apps.has(appId)) {
                        const app = this.apps.get(appId);
                        const windowEl = this.windows.get(windowId);
                        const isActive = this.activeWindow === windowId;
                        const isMinimized = windowEl?.classList.contains('app-minimized');
                        
                        const appEl = document.createElement('div');
                        appEl.className = `running-app ${isActive ? 'active' : ''}`;
                        appEl.title = app.name;
                        appEl.innerHTML = `
                            <span>${app.icon} ${app.name}</span>
                        `;
                        
                        appEl.addEventListener('click', () => {
                            const win = this.windows.get(windowId);
                            if (win) {
                                if (win.classList.contains('app-minimized')) {
                                    win.classList.remove('app-minimized');
                                }
                                win.style.zIndex = this.currentZIndex++;
                                this.activeWindow = windowId;
                                this.updateTaskbar();
                            }
                        });
                        
                        runningAppsEl.appendChild(appEl);
                    }
                });
            }
            
            // ============ SISTEMA DE ARCHIVOS ============
            
            async handleFileUpload(files) {
                for (const file of files) {
                    const reader = new FileReader();
                    reader.onload = async (event) => {
                        await this.fileSystem.writeFile(`/User/Downloads/${file.name}`, event.target.result);
                    };
                    reader.readAsText(file);
                }
                this.showNotification('Archivos', `${files.length} archivo(s) subido(s)`, 'success');
            }
            
            async handleACTUpload(file) {
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = async (event) => {
                    const result = await this.fileSystem.processACTFile(event.target.result);
                    
                    if (result.success) {
                        this.showNotification('ACT', result.message, 'success');
                        // Recargar ACT Manager si est√° abierto
                        if (this.runningApps.has('act-manager')) {
                            const windowId = this.runningApps.get('act-manager');
                            const windowEl = this.windows.get(windowId);
                            if (windowEl) {
                                windowEl.querySelector('.window-control.close').click();
                                setTimeout(() => this.openApp('act-manager'), 500);
                            }
                        }
                    } else {
                        this.showNotification('Error', result.message, 'error');
                    }
                };
                reader.readAsText(file);
            }
            
            async handlePAKUpload(file) {
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = async (event) => {
                    const result = await this.fileSystem.processPAKFile(event.target.result);
                    
                    if (result.success) {
                        this.showNotification('PAK', result.message, 'success');
                        // Recargar Package Manager si est√° abierto
                        if (this.runningApps.has('package-manager')) {
                            const windowId = this.runningApps.get('package-manager');
                            const windowEl = this.windows.get(windowId);
                            if (windowEl) {
                                windowEl.querySelector('.window-control.close').click();
                                setTimeout(() => this.openApp('package-manager'), 500);
                            }
                        }
                    } else {
                        this.showNotification('Error', result.message, 'error');
                    }
                };
                reader.readAsText(file);
            }
            
            async handleDroppedFiles(files) {
                const actFiles = files.filter(f => f.name.endsWith('.act'));
                const pakFiles = files.filter(f => f.name.endsWith('.pak'));
                const otherFiles = files.filter(f => !f.name.endsWith('.act') && !f.name.endsWith('.pak'));
                
                if (actFiles.length > 0) {
                    for (const file of actFiles) {
                        await this.handleACTUpload(file);
                    }
                }
                
                if (pakFiles.length > 0) {
                    for (const file of pakFiles) {
                        await this.handlePAKUpload(file);
                    }
                }
                
                if (otherFiles.length > 0) {
                    await this.handleFileUpload(otherFiles);
                }
            }
            
            // ============ UTILIDADES ============
            
            showNotification(title, message, type = 'info') {
                const notifications = document.getElementById('notifications');
                const id = 'notification-' + Date.now();
                
                const notification = document.createElement('div');
                notification.className = `notification ${type}`;
                notification.id = id;
                
                notification.innerHTML = `
                    <div class="notification-header">
                        <span class="notification-title">${title}</span>
                        <button class="notification-close" onclick="this.parentElement.parentElement.remove()">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div class="notification-message">${message}</div>
                `;
                
                notifications.appendChild(notification);
                
                setTimeout(() => {
                    if (document.getElementById(id)) {
                        document.getElementById(id).remove();
                    }
                }, 5000);
            }
            
            handleSystemAction(action) {
                switch(action) {
                    case 'shutdown':
                        if (confirm('¬øApagar el sistema?')) {
                            this.showNotification('Sistema', 'Apagando...', 'info');
                            setTimeout(() => {
                                document.body.innerHTML = `
                                    <div style="display:flex;align-items:center;justify-content:center;height:100vh;background:#000;color:#4CAF50;font-size:24px;">
                                        <i class="fas fa-power-off" style="margin-right:15px;"></i>
                                        Sistema Apagado
                                    </div>
                                `;
                            }, 1000);
                        }
                        break;
                    case 'restart':
                        if (confirm('¬øReiniciar el sistema?')) {
                            this.showNotification('Sistema', 'Reiniciando...', 'info');
                            setTimeout(() => location.reload(), 1000);
                        }
                        break;
                    case 'logout':
                        if (confirm('¬øCerrar sesi√≥n?')) {
                            this.showNotification('Sistema', 'Cerrando sesi√≥n...', 'info');
                            setTimeout(() => location.reload(), 1000);
                        }
                        break;
                }
            }
            
            startClock() {
                const updateTime = () => {
                    const now = new Date();
                    const timeEl = document.getElementById('time');
                    const dateEl = document.getElementById('date');
                    
                    timeEl.textContent = now.toLocaleTimeString('es-ES', { 
                        hour: '2-digit', 
                        minute: '2-digit' 
                    });
                    
                    dateEl.textContent = now.toLocaleDateString('es-ES');
                };
                
                updateTime();
                setInterval(updateTime, 1000);
            }
            
            exportAllData() {
                try {
                    const exportData = {};
                    for (let i = 0; i < localStorage.length; i++) {
                        const key = localStorage.key(i);
                        exportData[key] = localStorage.getItem(key);
                    }
                    
                    const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `xp7-backup-${new Date().toISOString().split('T')[0]}.json`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    
                    URL.revokeObjectURL(url);
                    this.showNotification('Exportaci√≥n', 'Datos exportados', 'success');
                } catch (error) {
                    this.showNotification('Error', 'No se pudo exportar', 'error');
                }
            }
            
            exportConfiguration() {
                const config = {
                    version: this.version,
                    fileSystem: {
                        mode: this.fileSystem.mode,
                        structure: this.fileSystem.structure
                    },
                    apps: Array.from(this.apps.entries()).map(([id, app]) => ({
                        id,
                        name: app.name,
                        icon: app.icon
                    }))
                };
                
                const blob = new Blob([JSON.stringify(config, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                
                const a = document.createElement('a');
                a.href = url;
                a.download = `xp7-config-${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                
                URL.revokeObjectURL(url);
                this.showNotification('Configuraci√≥n', 'Configuraci√≥n exportada', 'success');
            }
        }

        // Inicializar el sistema
        const XP7 = new XP7System();

        // Iniciar cuando el DOM est√© cargado
        document.addEventListener('DOMContentLoaded', () => {
            XP7.init();
        });

        // Exponer XP7 globalmente
        window.XP7 = XP7;
        console.log('üåç XP7 OS listo para usar');
        // ============================================
// PARCHE PARA XP7 3.0.0 - ARREGLA ACTs
// ============================================

// 1. Arreglar addApp
if (XP7 && XP7.addApp) {
  const originalAddApp = XP7.addApp;
  XP7.addApp = function(id, appData) {
    console.log('üîÑ Parche addApp ejecutado para:', id);
    
    // Si appData es string, convertirlo a objeto
    if (typeof appData === 'string') {
      try {
        appData = JSON.parse(appData);
      } catch(e) {
        appData = {
          name: id,
          icon: 'üì±',
          description: 'App',
          category: 'Apps',
          launch: function() {
            XP7.showNotification('App', id + ' loaded', 'info');
          }
        };
      }
    }
    
    // Asegurar que launch sea funci√≥n
    if (typeof appData.launch === 'string') {
      try {
        appData.launch = new Function('return ' + appData.launch)();
      } catch(e) {
        appData.launch = function() {
          const winId = 'window_' + XP7.nextWindowId++;
          XP7.runningApps.set(id, winId);
          XP7.createWindow({
            id: winId,
            title: appData.name || id,
            icon: appData.icon || 'üì±',
            width: 400,
            height: 300,
            content: '<div style="padding:20px;text-align:center;"><h2>' + (appData.name || id) + '</h2><p>' + (appData.description || '') + '</p></div>'
          });
        };
      }
    }
    
    // Llamar al original
    return originalAddApp.call(this, id, appData);
  };
  console.log('‚úÖ Parche addApp instalado');
}

// 2. Cargar ACTs al iniciar
setTimeout(function() {
  if (XP7 && XP7.fileSystem) {
    console.log('üîÑ Cargando ACTs al inicio...');
    const updates = XP7.fileSystem.getInstalledUpdates();
    console.log('üì¶ ACTs encontrados:', updates.length);
    
    updates.forEach(update => {
      if (update.actions) {
        update.actions.forEach(action => {
          if (action.type === 'addApp' && action.appId) {
            console.log('‚ûï Procesando app de ACT:', action.appId);
            if (XP7.addApp) {
              XP7.addApp(action.appId, action.appData);
            }
          }
        });
      }
    });
  }
}, 3000);

// 3. Agregar app de prueba manualmente
setTimeout(function() {
  if (XP7 && !XP7.apps.has('test-app-manual')) {
    XP7.apps.set('test-app-manual', {
      name: 'Test Manual',
      icon: '‚úÖ',
      description: 'App agregada manualmente',
      category: 'Test',
      launch: function() {
        const winId = 'window_' + XP7.nextWindowId++;
        XP7.runningApps.set('test-app-manual', winId);
        XP7.createWindow({
          id: winId,
          title: 'Test Manual',
          icon: '‚úÖ',
          width: 400,
          height: 300,
          content: '<div style="padding:30px;text-align:center;"><h2>¬°Funciona!</h2><p>Esta app fue agregada manualmente</p></div>'
        });
      }
    });
    
    if (XP7.updateDesktop) {
      XP7.updateDesktop();
      console.log('‚úÖ Test app manual agregada');
    }
  }
}, 2000);

console.log('üéØ PARCHE XP7 3.0.0 INSTALADO');
        if(!window.IE) window.IE={};

IE.search=function(q){
 q=q.trim();
 let f=document.getElementById("ie6-frame");
 if(!f){
  f=document.createElement("iframe");
  f.id="ie6-frame";
  f.style.width="100%";
  f.style.height="100%";
  f.style.border="0";
  document.getElementById("desktop").appendChild(f);
 }

 if(q.startsWith("http")){
  f.src=q;
 }else if(q.length>6 && !q.includes(" ")){
  f.src="https://www.youtube-nocookie.com/embed/"+q+"?autoplay=1&controls=1&rel=0";
 }else{
  f.src="https://es.wikipedia.org/wiki/"+encodeURIComponent(q.replace(/ /g,"_"));
 }
};

IE.fav=function(){
 alert("‚≠ê Favoritos guardados en el coraz√≥n de Windows XP");
};

IE.back=function(){history.back();};
IE.forward=function(){history.forward();};
IE.open=function(u){window.open(u,"_blank");};

        
};
    </script>
</body>
</html>
